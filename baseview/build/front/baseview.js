var labradorView;(()=>{"use strict";var e={d:(t,i)=>{for(var s in i)e.o(i,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:i[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{Entry:()=>je,behaviours:()=>i});var i={};e.r(i),e.d(i,{adnuntiusAd:()=>v,apsis_submit:()=>_,article:()=>F,articleCalendar:()=>T,articleFooter:()=>C,articleHeader:()=>D,articleList:()=>x,articleMeta:()=>$,articlesByTag:()=>M,articlescroller:()=>A,authorBox:()=>O,bodytext:()=>I,byline:()=>P,changelog:()=>j,chart:()=>Se,comments:()=>R,factbox:()=>q,frontContent:()=>H,front_rows:()=>N,globalChangelog:()=>U,googleAd:()=>z,googleCSE:()=>B,graphic:()=>J,grid:()=>Fe,image:()=>W,infiniteScroll:()=>De,jwplayer:()=>he,labradorSearch:()=>Y,livefeed:()=>ke,markup:()=>Q,mobiltests:()=>Z,motortests:()=>X,newsletter_submit:()=>ee,notice:()=>_e,noticeHeader:()=>we,page_article:()=>h,page_front:()=>f,page_gallery:()=>b,page_notice:()=>y,parallax:()=>te,remoteproduction:()=>fe,row:()=>be,scrollbox:()=>ye,simplestream:()=>ie,slideshow:()=>se,tablebox:()=>ne,tagboard:()=>oe,text_multiline:()=>le,timeline:()=>ve,tips_box:()=>re,topcomments:()=>me,toplist:()=>de,tvguide:()=>ge,twitter:()=>ce,userFeedback:()=>pe,vimond:()=>Te,vp:()=>Ce,youtube:()=>ue});class s{static getSiteStyles(e,t=[]){const i=lab_api.v1.config.get(`site_styles.${e}`)||t;return Sys.logger.debug(`ViewSupport: Found ${Array.isArray(i)?i.length:0} stylesheet(s) for site "${e}".`),i}static getSiteStylesWithFallback(e,t=[]){const i=this.getSiteStyles(e,null);if(null===i){t.push(e);const i=lab_api.v1.config.get("lab_fallback_site",{site:e});if(i&&!t.includes(i))return this.getSiteStylesWithFallback(i,t)}return i||[]}static getSiteScripts(e,t,i){const s=this.filterScriptListByPageType(lab_api.v1.config.get(`site_scripts.${e}`)||[],t,i);return Sys.logger.debug(`ViewSupport: Found ${s.length} script-path(s) for site "${e}".`),s}static getSiteScriptsWithFallback(e,t,i,s=[]){let a=this.getSiteScripts(e,t,i);if(s.length&&(a=this.removeWithInheritFalse(a)),!a.length){s.push(e);const a=lab_api.v1.config.get("lab_fallback_site",{site:e});if(a&&!s.includes(a))return this.getSiteScriptsWithFallback(a,t,i,s).filter(e=>!1!==e.inherit)}return a}static getCommonScripts(e,t,i=!1){const s=this.filterScriptListByPageType(lab_api.v1.config.get("site_scripts_common")||[],e,t,i);return Sys.logger.debug(`ViewSupport: Found ${s.length} common ${i?"script-path(s)":"JS modules"}`),s}static filterScriptListByPageType(e,t,i,s=!1){return e.filter(e=>(!e.isModule&&!s||e.isModule&&s)&&(!e.pageType||e.pageType===t)&&(!i||i&&!e.skipEditor))}static removeWithInheritFalse(e){return Array.isArray(e)&&e.length>0?e.filter(e=>!1!==e.inherit):e}static getSiteFilesForContentboxes(e,t,i,s=[]){const a=[],n=lab_api.v1.model.query.getModelTypes();Sys.logger.debug(`ViewSupport sitefiles: Will register ${i}-file(s) for contentbox-types ${n.join(", ")}.`);for(const e of n){const t=lab_api.v1.config.get(`contentbox_settings.${e}.require.${i}`);if(Array.isArray(t))for(const n of t)a.includes(n)||s.includes(n)||(Sys.logger.debug(`ViewSupport sitefiles: Will include ${i}-file "${n}" for contentbox "${e}".`),a.push(n))}return Sys.logger.debug(`ViewSupport sitefiles: Finished registering ${i}-file(s). Found ${a.length} file(s).`),a}}class a{constructor(e){this.api=e,this.pageType=this.api.v1.model.root.getType()}get media(){return{getLogo:(e=this.api.v1.viewport.getName())=>{const t=this.api.v1.config.get("logo")||{},i=t.uploadedFileUrl?{src:t.uploadedFileUrl,href:t.default.href,type:"img",size:{width:t.logoWidth},title:t.default.title,isCustom:!0}:t[e]||t.default||null;return i&&("img"===i.type?i.is_img=!0:"svg"===i.type&&(i.is_svg=!0)),{current:i,sm:t.uploadedFileUrl?{src:t.uploadedFileUrl,href:t.default.href,size:{width:t.logoWidth},title:t.default.title,isCustom:!0}:t.standalone||t.mailmojo||null,mm:t.uploadedMailmojoFileUrl?{src:t.uploadedMailmojoFileUrl,href:t.default.href,size:{width:t.mailmojoLogoWidth},title:t.default.title,isCustom:!0}:t.mailmojo||t.standalone||null}}}}get menus(){return{get:({section:e,defaultSection:t}={},i)=>{const s={},a=Object.values(this.api.v1.config.get("menus")||{});if(a.length<1)return null;const n=i=>{i.forEach(i=>{i.selected=i.section===e||i.section===t,"target"in i||(i.target="_self"),"selector"in i||(i.selector=""),"children"in i||(i.children=[]),i.children.length>0&&(i.hasChildren=!0,n(i.children))})};return a.forEach(e=>{n(e.menuItems);const t=e.type||e.menuName;s[t]={items:e.menuItems,type:e.type,selector:e.selector||"",menuName:e.menuName||"",showMenuName:e.showMenuNameOnDesktop||e.showMenuNameOnMobile||!1,showMenuNameOnDesktop:e.showMenuNameOnDesktop||"",showMenuNameOnMobile:e.showMenuNameOnMobile||""}}),i?s[i]:s}}}get misc(){return{}}get resources(){const e={required:[],getProgressReader:()=>(e.required.push({url:"/view-resources/public/common/ReadProgress.js",requireDom:!1}),{active:!0,minElementCount:lab_api.v1.config.get("displayReadProgress.minElementCount")||25}),getSiteFiles(t,i,a,n,o){const l=s.getSiteScriptsWithFallback(a,n,o),r=s.getCommonScripts(n,o);return e.required.push(...l,...r),{js:s.getSiteFilesForContentboxes(t,i,"js",e.required.map(e=>e.url)),css:s.getSiteFilesForContentboxes(t,i,"css")}},getModules:(e,t,i,a,n)=>s.getCommonScripts(a,n,!0)},t={get:e=>{const i=(lab_api.v1.config.get("analytics.kilkaya")||[]).map(e=>{const t={...e};return t.id&&"string"==typeof t.id&&t.id.trim().endsWith(".js")&&(t.url=t.id),t});let s=this.api.v1.config.get("analytics.adnuntiusConnect");s&&"object"==typeof s&&!Array.isArray(s)&&Object.keys(s).length&&(s=new Array(s));const a={google:this.api.v1.config.get("analytics.google.tracking_id"),google_gtm:this.api.v1.config.get("analytics.google.gtm"),comscore:this.api.v1.config.get("analytics.comscore.comscore_id"),adnuntiusConnect:s,adnuntiusConnectCMP:this.api.v1.config.get("analytics.adnuntiusConnectCMP"),kilkaya:i,kilkayaSettings:this.api.v1.config.get("analytics.kilkayaSettings"),io:this.api.v1.config.get("analytics.io.tracking_id")},n=t.getDataLayer(e);return n.dataLayer&&(a.dataLayer=n.dataLayer),n.usesJWTCookieData&&(a.usesJWTCookieData=n.usesJWTCookieData),a},getDataLayer:e=>{const t=this.api.v1.config.get("analytics.google.dataLayer");let i=!1;if(t&&Array.isArray(t)&&t.length){t.forEach(t=>{let s=null;switch(t.source){case"fixed":s=(t.value||"").trim();break;case"config":s=this.api.v1.properties.get(t.value);break;case"jwtcookie":t.isJWTCookie=!0,s=t.value,i=!0;break;case"article_authors":s=`${(e.bylinesStringCommaSeparated||"").replace(/"/g,"")}`;break;case this.pageType.replace("page_",""):s=this.api.v1.model.query.getRootModel().get(t.value);break;default:Sys.logger.warn(`Unsupported dataLayer source: "${t.source}"`)}t.value=null===s?"":s.toString()});const s=t.map(e=>e.value.length>0).lastIndexOf(!0);t[s]&&(t[s].last=!0)}return{dataLayer:t,usesJWTCookieData:i}}};return{scripts:e,analytics:t}}get settings(){return{get:(e={})=>{const t=this.api.v1.config.get(`page_settings.${e.pageType}.social.display`)||{},i=this.api.v1.model.query.getRootModel().get("fields.show_social_bodytext_before"),s=this.api.v1.model.query.getRootModel().get("fields.show_social_bodytext_after"),a=this.api.v1.model.query.getRootModel().get("fields.show_social_header");null!==i&&(t.bodytext_before=!!i),null!==s&&(t.bodytext_after=!!s),null!==a&&(t.header=!!a);const n=this.api.v1.config.get(`page_settings.${e.pageType}.social.items`)||{},o=this.api.v1.config.get(`page_settings.${e.pageType}.showTags`),l=Object.keys(n).filter(e=>!!n[e].display).map(t=>({name:t,icon:n[t].icon||"",url:e.socialLinks[t]||"",shareText:this.api.v1.locale.get(`socialMedia.shareText.${t}`,{noRender:!0,fallbackValue:""}),isButton:n[t].isButton||!1}));return{page_type:e.pageType,social:{display:{bodytext_before:l.length>0&&!!t.bodytext_before,bodytext_after:l.length>0&&!!t.bodytext_after,header:l.length>0&&!!t.header},items:l},showTags:!1!==o}}}}}class n{static getStyleDefinitions(e){const t=e.v1.properties.get("site.alias"),i=e.v1.config.get("style_definitions",t),s=[];(i.rules||[]).forEach(e=>s.push(e)),(i.fontface||[]).forEach(e=>{const t=`.font-${(Array.isArray(e.family)?e.family[0]:e.family).replace(/ /g,"")}`;s.push(n.getFamilyDefinition(t,e.family));const i={light:{keys:["light","200","100","300"],used:!1},normal:{keys:["regular","normal","400","500"],used:!1},bold:{keys:["bold","600","700"],used:!1},black:{keys:["black","800","900"],used:!1}};e.variants.forEach(e=>{for(const a of Object.keys(i)){const o=i[a];o&&!o.used&&o.keys.indexOf(e)>-1&&(s.push(n.getWeightDefinition(t,e,a)),o.used=!0)}})});const a={fontface:i.fontface||[],parsedRules:n.CSSRuleParser(s)};return a.hasRules=!!a.parsedRules.length,a}static getFamilyDefinition(e,t){return{selector:e,declarations:[{key:"font-family",value:(Array.isArray(t)?`${t.map(e=>`"${e}"`).join(", ")}`:`"${t}"`)+" !important"}]}}static getWeightDefinition(e,t,i){let s=t;return"regular"===t&&(s="normal"),{selector:`${e}.font-weight-${i}`,declarations:[{key:"font-weight",value:`${s} !important`}]}}static CSSRuleParser(e){const t=[];return e.forEach(e=>{let i,s,a=`${e.selector} { `;e.declarations.forEach(e=>{"font-size-desktop"===e.key?"default"!==e.value&&(a+=`font-size: ${e.value.slice(0,-2)/16}rem; `):"font-size-mobile"===e.key?"default"!==e.value&&(i=`calc(0.262vw * ${e.value.slice(0,-2)})`):"line-height-desktop"===e.key?"default"!==e.value&&(a+=`line-height: ${e.value}; `):"line-height-mobile"===e.key?"default"!==e.value&&(s=e.value):"font-family"===e.key?e.value.includes("!important")?a+=`${e.key}: ${e.value}; `:a+=`${e.key}: "${e.value}"; `:"color"===e.key||"text-decoration"===e.key?"default"!==e.value&&(a+=`${e.key}: ${e.value}; `):a+=`${e.key}: ${e.value}; `}),a+="}",(i||s)&&(a+=`@media (max-width: 767px) { .resp_fonts ${e.selector} {`,i&&(a+=`font-size: ${i}; `),s&&(a+=`line-height: ${s}; `),a+="} }"),t.push(a)}),t}static getInlineCSS(e,t){return[{key:"custom_properties",value:e.v1.config.get("css_build.custom_properties",{site:t})||""},{key:"background_colors",value:e.v1.config.get("css_build.background_colors",{site:t})||""},{key:"background_colors_opacity",value:e.v1.config.get("css_build.background_colors_opacity",{site:t})||""},{key:"border_colors",value:e.v1.config.get("css_build.border_colors",{site:t})||""},{key:"font_colors",value:e.v1.config.get("css_build.font_colors",{site:t})||""},{key:"image_gradient",value:e.v1.config.get("css_build.image_gradient",{site:t})||""}]}static getCssVariables(e){const t=e.v1.config.get("custom_css_variables")||{},i={no_viewport:[],desktop:[],mobile:[]};for(const e of Object.keys(t))for(const s of Object.keys(t[e]))i[s].push({key:e,value:(t[e][s]||{}).value});return i}}const o={sunday:{en:"sunday",sv:"söndag",dk:"søndag",no:"søndag",nl:"zondag",kl:"sapaat"},monday:{en:"monday",sv:"måndag",dk:"mandag",no:"mandag",nl:"maandag",kl:"ataasinngorneq"},tuesday:{en:"tuesday",sv:"tisdag",dk:"tirsdag",no:"tirsdag",nl:"dinsdag",kl:"marlunngorneq"},wednesday:{en:"wednesday",sv:"onsdag",dk:"onsdag",no:"onsdag",nl:"woensdag",kl:"pingasunngorneq"},thursday:{en:"thursday",sv:"torsdag",dk:"torsdag",no:"torsdag",nl:"donderdag",kl:"sisamanngorneq"},friday:{en:"friday",sv:"fredag",dk:"fredag",no:"fredag",nl:"vrijdag",kl:"tallimanngorneq"},saturday:{en:"saturday",sv:"lördag",dk:"lørdag",no:"lørdag",nl:"zaterdag",kl:"arfininngorneq"},january:{en:"January",sv:"januari",dk:"januar",no:"januar",nl:"januari",kl:"ukiortaarsiorneq"},february:{en:"February",sv:"februari",dk:"februar",no:"februar",nl:"februari",kl:"ukiortaami"},march:{en:"March",sv:"mars",dk:"marts",no:"mars",nl:"maart",kl:"marsi"},april:{en:"April",sv:"april",dk:"april",no:"april",nl:"april",kl:"apriili"},may:{en:"May",sv:"maj",dk:"maj",no:"mai",nl:"mei",kl:"maajii"},june:{en:"June",sv:"juni",dk:"juni",no:"juni",nl:"juni",kl:"juuni"},july:{en:"July",sv:"juli",dk:"juli",no:"juli",nl:"juli",kl:"juuli"},august:{en:"August",sv:"augusti",dk:"august",no:"august",nl:"augustus",kl:"aggusti"},september:{en:"September",sv:"september",dk:"september",no:"september",nl:"september",kl:"septembari"},october:{en:"October",sv:"oktober",dk:"oktober",no:"oktober",nl:"oktober",kl:"oktobari"},november:{en:"November",sv:"november",dk:"november",no:"november",nl:"november",kl:"novembari"},december:{en:"December",sv:"december",dk:"december",no:"desember",nl:"december",kl:"decembari"},ago:{en:"ago",sv:"sedan",dk:"siden",no:"siden",nl:"geleden",kl:"matuma siorna"},now:{en:"now",sv:"nu",dk:"nu",no:"nå",nl:"nu",kl:"maanna"},min:{en:"min"},minutes:{en:"minutes",sv:"minuter",dk:"minutter",no:"minutter",nl:"minuten",kl:"minutsi"},hour:{en:"hour",sv:"timme",dk:"time",no:"time",nl:"uur",kl:"akunnera"},hours:{en:"hours",sv:"timmar",dk:"timer",no:"timer",nl:"uren",kl:"akunnerit"},day:{en:"day",sv:"dag",dk:"dag",no:"dag",nl:"dag",kl:"ulloq"},days:{en:"days",sv:"dagar",dk:"dage",no:"dager",nl:"dagen",kl:"ullut"},monthdayyear:{en:"{{MMMM}} {{DD}}. {{YYYY}}",sv:"{{DD}}/{{MM}} {{YYYY}}",dk:"{{DD}}/{{MM}} {{YYYY}}",no:"{{DD}}/{{MM}} {{YYYY}}",nl:"{{DD}}/{{MM}} {{YYYY}}"},hourminute:{en:"{{HH}}:{{mm}}"}};class l{constructor(e="en",t="en"){this.fallbackLanguage=t,this.language=e||t,this.words=o,this.timezone=this.getTimezone()}getTimezone(){const e=lab_api.v1.config.get("timezone");return void 0===e||Number.isNaN(e)||Number.isNaN(parseFloat(e))?1:parseInt(e,10)}str(e){let{language:t}=this;return e in this.words?(t in this.words[e]||(t=this.fallbackLanguage),t in this.words[e]?this.words[e][t]:null):null}format(e,t){return Mustache.render(t,{YYYY:()=>e.getFullYear(),YY:()=>`${e.getFullYear()}`.slice(-2),MM:()=>(e.getMonth()<9?"0":"")+(e.getMonth()+1),M:()=>e.getMonth()+1,D:()=>e.getDate(),DD:()=>(e.getDate()<10?"0":"")+e.getDate(),H:()=>e.getHours(),HH:()=>(e.getHours()<10?"0":"")+e.getHours(),m:()=>e.getMinutes(),mm:()=>(e.getMinutes()<10?"0":"")+e.getMinutes(),s:()=>e.getSeconds(),ss:()=>(e.getSeconds()<10?"0":"")+e.getSeconds(),dddd:()=>this.weekday(e,!1),ddd:()=>this.weekday(e,!1,3),MMMM:()=>this.monthName(e,!1),MMM:()=>this.monthName(e,!1,3),W:()=>this.weekNumber(e,!0,!0),WW:()=>this.weekNumber(e,!0,!1)})}utcFormat(e,t){const i=this.correctDate(e);return Mustache.render(t,{YYYY:()=>i.getUTCFullYear(),YY:()=>`${i.getUTCFullYear()}`.slice(-2),MM:()=>(i.getUTCMonth()<9?"0":"")+(i.getUTCMonth()+1),M:()=>i.getUTCMonth()+1,D:()=>i.getUTCDate(),DD:()=>(i.getUTCDate()<10?"0":"")+i.getUTCDate(),H:()=>i.getUTCHours(),HH:()=>(i.getUTCHours()<10?"0":"")+i.getUTCHours(),h:()=>this.twelveHourClock(i),hh:()=>this.twelveHourClock(i,!0),m:()=>i.getUTCMinutes(),mm:()=>(i.getUTCMinutes()<10?"0":"")+i.getUTCMinutes(),s:()=>i.getUTCSeconds(),ss:()=>(i.getUTCSeconds()<10?"0":"")+i.getUTCSeconds(),a:()=>i.getUTCHours()<12?"a.m.":"p.m.",A:()=>i.getUTCHours()<12?"A.M.":"P.M.",dddd:()=>this.weekday(i,!0),ddd:()=>this.weekday(i,!0,3),MMMM:()=>this.monthName(i,!0),MMM:()=>this.monthName(i,!0,3),W:()=>this.weekNumber(i,!0,!0),WW:()=>this.weekNumber(i,!0,!1)})}formattedDate(e,t,i=!0,s=!0){let a=t||"";return a=a.replace("Y",e.getFullYear()),a=a.replace("m",(i&&e.getMonth()<9?"0":"")+(e.getMonth()+1)),a=a.replace("d",(i&&e.getDate()<10?"0":"")+e.getDate()),a=a.replace("H",(s&&e.getHours()<10?"0":"")+e.getHours()),a=a.replace("i",(s&&e.getMinutes()<10?"0":"")+e.getMinutes()),a=a.replace("s",e.getSeconds()),a=a.replace("l",this.weekday(e,!1)),a=a.replace("D",this.weekday(e,!1,3)),a=a.replace("F",this.monthName(e,!1)),a=a.replace("M",this.monthName(e,!1,3)),a}formattedUtcDate(e,t,i=!0,s=!0){const a=this.correctDate(e);let n=t||"";return n=n.replace("Y",a.getUTCFullYear()),n=n.replace("m",(i&&a.getUTCMonth()<9?"0":"")+(a.getUTCMonth()+1)),n=n.replace("d",(i&&a.getUTCDate()<10?"0":"")+a.getUTCDate()),n=n.replace("H",(s&&a.getUTCHours()<10?"0":"")+a.getUTCHours()),n=n.replace("i",(s&&a.getUTCMinutes()<10?"0":"")+a.getUTCMinutes()),n=n.replace("s",a.getUTCSeconds()),n=n.replace("l",this.weekday(a,!0)),n=n.replace("D",this.weekday(a,!0,3)),n=n.replace("F",this.monthName(a,!0)),n=n.replace("M",this.monthName(a,!0,3)),n}correctDate(e){return this.manipulateTime(e,this.isSummerTime(e)?this.timezone+1:this.timezone)}utcDate(e){return this.unmanipulateTime(e,this.isSummerTime(e)?this.timezone+1:this.timezone)}timestampToDate(e){return new Date(1e3*e)}toTimestamp(e){return Math.round(e.getTime()/1e3)}parseDate(e){const t=e.substr(0,4),i=e.substr(4,2)-1,s=e.substr(6,2),a=new Date(t,i,s),n=a.getFullYear()==t,o=a.getMonth()==i,l=a.getDate()==s;return n&&o&&l?a:"invalid date"}weekday(e,t=!1,i=9){return([this.str("sunday"),this.str("monday"),this.str("tuesday"),this.str("wednesday"),this.str("thursday"),this.str("friday"),this.str("saturday")][t?e.getUTCDay():e.getDay()]||"").substr(0,i)}monthName(e,t=!1,i=10){return([this.str("january"),this.str("february"),this.str("march"),this.str("april"),this.str("may"),this.str("june"),this.str("july"),this.str("august"),this.str("september"),this.str("october"),this.str("november"),this.str("december")][t?e.getUTCMonth():e.getMonth()]||"").substr(0,i)}weekNumber(e,t=!1,i=!0){const s=new Date(e.valueOf()),a=((t?e.getUTCDay():e.getDay())+6)%7;s.setDate(s.getDate()-a+3);const n=s.valueOf();s.setMonth(0,1),4!==s.getDay()&&s.setMonth(0,1+(4-s.getDay()+7)%7);const o=1+Math.ceil((n-s)/6048e5);return(!i&&o<10?"0":"")+o}timestampToNiceDate(e,t=!1){const i={ago:t?"":this.str("ago"),now:this.str("now"),minute:t?this.str("min"):this.str("minutes"),minutes:t?this.str("min"):this.str("minutes"),hour:this.str("hour"),hours:this.str("hours"),day:this.str("day"),days:this.str("days")},s=(new Date).getTime(),a=new Date(1e3*e).getTime()-0,n=parseInt((s-a)/1e3/60,10);return n<60?n<1?i.now:1==n?`1 ${i.minute} ${i.ago}`:`${n} ${i.minutes} ${i.ago}`:n<1440?1==parseInt(n/60,10)?`1 ${i.hour} ${i.ago}`:`${parseInt(n/60,10)} ${i.hours} ${i.ago}`:parseInt(n/1440,10)<30?1==parseInt(n/1440,10)?`1 ${i.day} ${i.ago}`:`${parseInt(n/1440,10)} ${i.days} ${i.ago}`:this.format(this.timestampToDate(e),this.str("monthdayyear"))}isSummerTime(e){function t(e,t){const i=new Date,s=new Date(Date.UTC(t||i.getFullYear(),e+1,0)),a=s.getDay();return new Date(Date.UTC(s.getFullYear(),s.getMonth(),s.getDate()-a))}const i=e||new Date,s=t(2,i.getFullYear());s.setHours(1);const a=t(9,i.getFullYear());return s.setHours(1),i.getTime()>=s.getTime()&&i.getTime()<a.getTime()}manipulateTime(e,t){return new Date(e.getTime()+60*t*60*1e3)}unmanipulateTime(e,t){return new Date(e.getTime()-60*t*60*1e3)}twelveHourClock(e,t=!1){const i=e.getUTCHours();let s;return 0===i||12===i?s=12:(s=i<12?i:i-12,t&&s<10&&(s=`0${s}`)),s}}class r{static getAdnuntiusSettings(e,t,i,s,a,n=!1,o=!1){Sys.logger.debug(`[AdsHelper.getAdnuntiusSettings] Called with disableSkyscraper=${n}, disableTopBanner=${o}`);const r=(e.v1.config.get("contentbox_settings.adnuntiusAd.bidding")||{}).enabled||!1;function d(e,t){let i="";return r&&e.prebidConfig&&(i=JSON.parse(e.prebidConfig),Array.isArray(i)&&([i]=i),i=JSON.stringify(i)),{...e,prebidConfig:i,metadata:t.metadata||[]}}const g=e.v1.config.get("contentbox_settings.adnuntiusAd.formats")||[],c=e.v1.config.getView(`insertDynamic.${e.v1.model.root.getType().replace("page_","")}.${i.getViewport()}`,a.alias)||[],p=e.v1.model.query.getChildrenOfType(t,"adnuntiusAd",!0,!0),u=[];for(const e of c){const[t]=g.filter(t=>e.content_data.fields.format===t.format);t&&(!1===e.placement.key.includes("skyscraper_")&&"topbanner"!==e.placement.key||e.placement.key.includes("skyscraper_")&&!n||"topbanner"===e.placement.key&&!o)&&u.push(d(t,e))}for(const e of p){const[t]=g.filter(t=>e.get("fields.format")===t.format);t&&u.push(d(t,e))}const h=(new l).utcFormat(new Date,"&tag=week_{{ W }}_{{ YYYY }}");return{enabled:g.length>0,lazyload:e.v1.config.get("contentbox_settings.adnuntiusAd.lazyload")||!1,adUnits:u,spacingTop:e.v1.config.get("contentbox_settings.adnuntiusAd.spacingTop")||120,fetchMarginPercent:s.fetchMarginPercent||150,renderMarginPercent:s.renderMarginPercent||150,bidding:{enabled:r},hideOnTabletWidth:s.hideOnTabletWidth||1316,refreshdelay:e.v1.config.get("contentbox_settings.adnuntiusAd.refreshdelay")||5,refreshcount:e.v1.config.get("contentbox_settings.adnuntiusAd.refreshcount")||1,connectLoading:e.v1.config.get("contentbox_settings.adnuntiusAd.connectLoading")||!1,contkitEnabled:e.v1.config.get("contentbox_settings.adnuntiusAd.contkitEnabled")||!1,newsletter:{targeting:h}}}static getGoogleSettings(e,t,i,s,a,n=!1,o=!1){function l(e,t){const{sizes:i=[],fluid:s=!1}=e,a=i.map(e=>`[${e.width},${e.height}]`);return s&&a.push('"fluid"'),{...e,sizesString:`[${a.join(", ")}]`,metadata:t.metadata||[]}}Sys.logger.debug(`[AdsHelper.getGoogleSettings] Called with disableSkyscraper=${n}, disableTopBanner=${o}`);const r=e.v1.config.get("contentbox_settings.googleAd.formats")||[],d=e.v1.config.get("contentbox_settings.googleAd.anchor")||{enabled:!1,code:"",type:"TOP_ANCHOR"},g=e.v1.config.getView(`insertDynamic.${e.v1.model.root.getType().replace("page_","")}.${i.getViewport()}`,a.alias)||[],c=e.v1.model.query.getChildrenOfType(t,"googleAd",!0,!0),p=[];for(const e of g){const[t]=r.filter(t=>e.content_data.fields.format===t.format),i=e.placement.key,s=t&&(!1===i.includes("skyscraper_")&&"topbanner"!==i||i.includes("skyscraper_")&&!n||"topbanner"===i&&!o);Sys.logger.debug(`[AdsHelper.getGoogleSettings] Placement: ${i}, Format: ${t?t.format:"not found"}, ShouldInclude: ${s}`),s&&p.push(l(t,e))}Sys.logger.debug(`[AdsHelper.getGoogleSettings] Found ${c.length} manual Google Ad(s)`);for(const e of c){const[t]=r.filter(t=>e.get("fields.format")===t.format);t&&(Sys.logger.debug(`[AdsHelper.getGoogleSettings] Adding manual ad with format: ${t.format}`),p.push(l(t,e)))}return Sys.logger.debug(`[AdsHelper.getGoogleSettings] Final visibleUnits count: ${p.length}, formats: ${p.map(e=>e.format).join(", ")}`),{enabled:r.length>0,lazyload:s.lazyload||!1,spacingTop:e.v1.config.get("contentbox_settings.googleAd.spacingTop")||120,fetchMarginPercent:s.fetchMarginPercent||150,renderMarginPercent:s.renderMarginPercent||150,adUnits:p,anchor:d,dfpid:s.dfpid||!1,debugmode:s.debugmode||!1,disableInitialLoad:s.disableInitialLoad||!1,bidding:s.bidding,hideOnTabletWidth:s.hideOnTabletWidth||1316}}}class d{constructor({pageType:e="",canonical:t="",isTagpage:i=!1,isTagpageWithFrontpage:s=!1,tagpagePath:a="/tag/",publishedUrl:n=""}={}){this.settings={pageType:e,canonical:t,isTagpage:i,isTagpageWithFrontpage:s,tagpagePath:a,publishedUrl:n},this.cache={seoData:null},this.imageServer=lab_api.v1.properties.get("image_server")}getStructuredData(e){return e.get("fields.jsonld_json")?e.get("fields.custom_jsonld"):"front"===this.settings.pageType?this.generateFrontData(e):"article"===this.settings.pageType||"notice"===this.settings.pageType?this.generateArticleData(e):null}generateSiteData(e){return{"@context":"http://schema.org","@type":"WebSite",name:lab_api.v1.properties.get("site.display_name"),url:lab_api.v1.properties.get("site.domain")||""}}generateFrontData(e){const t=this.getSEOData(e);return{"@context":"https://schema.org","@type":"WebPage",name:t.title,description:t.description}}generateArticleData(e){const t=this.getSEOData(e),i={"@context":"https://schema.org","@type":"NewsArticle",headline:t.title||e.get("fields.title"),description:t.description,mainEntityOfPage:{"@id":this.settings.publishedUrl},availableLanguage:[{"@type":"Language",alternateName:t.language}],image:lab_api.v1.model.query.getChildrenOfType(e,"image",!0).map(e=>{const t=e.get("fields.imageurl")||`${this.imageServer}/?imageId=${e.get("instance_of")}`;return t.endsWith("width=")?`${t}1200`:`${t}&width=1200`}),keywords:(e.get("tags")||[]).join(", "),author:lab_api.v1.model.query.getChildrenOfType(e,"byline",!0).map(e=>{let t=e.get("fields.firstname");"Byline first name"===t&&(t="");let i=e.get("fields.lastname");"Byline last name"===i&&(i="");const s={"@type":"Person",name:`${t} ${i}`},a=e.get("fields.public_url");a&&(s.url=a);const n=(e.children||[]).filter(e=>"image"===e.type)[0];n&&(s.image={"@type":"ImageObject",url:`${n.get("fields.imageurl")}&width=250`});const o=e.get("fields.public_email");return o&&(s.email=o),s}),publisher:{"@type":"Organization",name:lab_api.v1.properties.get("site.display_name"),logo:{"@type":"ImageObject",url:lab_api.v1.config.get("logo.default.src")}}};return e.get("fields.published")&&(i.datePublished=new Date(1e3*parseInt(e.get("fields.published"),10)).toISOString()),e.get("fields.modified")&&(i.dateModified=new Date(1e3*parseInt(e.get("fields.modified"),10)).toISOString()),"1"===e.get("fields.paywall")&&(i.isAccessibleForFree=!0,i.hasPart={"@type":"WebPageElement",isAccessibleForFree:!1,cssSelector:".teaserContent"}),i}getSEOData(e){if(this.cache.seoData)return this.cache.seoData;let t,i,s;if("article"===this.settings.pageType||"notice"===this.settings.pageType)i=lab_api.v1.util.string.sanitizeString(e.get("fields.seotitle")||e.get("fields.title")||""),s=lab_api.v1.util.string.sanitizeString(e.get("fields.seodescription")||e.get("fields.subtitle")||""),t=e.get("fields.seolanguage")||lab_api.v1.config.get("contentLanguage");else{if(this.settings.isTagpage&&!this.settings.isTagpageWithFrontpage){const e=this.settings.tagpagePath.replace(/\//g,""),t=(this.settings.canonical.split(this.settings.tagpagePath)[1]||"").split("/").filter(e=>!!e),s={tag:t[t.length-1],tags:t,tagPath:e};i=lab_api.v1.locale.get("tags.title_text",{data:s})}else i=lab_api.v1.util.string.sanitizeString(e.get("fields.seotitle")||e.get("fields.name")||"");s=lab_api.v1.util.string.sanitizeString(e.get("fields.seodescription")||"")}return this.cache.seoData={title:i.charAt(0).toUpperCase()+i.slice(1),description:s,language:t},this.cache.seoData}}class g{static prepareForTemplate(e,t,i){const s={meta:{head_top:[],head_bottom:[]},script:{head_top:[],head_bottom:[],body_top:[],body_bottom:[]},style:{head_top:[],head_bottom:[]},link:{head_top:[],head_bottom:[]}},a=e.filter(e=>!(e.pageType&&e.pageType!==t||e.skipEditor&&i));for(const e of Object.keys(s))for(const t of Object.keys(s[e]))s.meta[t]=a.filter(e=>"meta"===e.tag).filter(e=>e.placement===t).map(e=>this.createCustomTag(e)),s.script[t]=a.filter(e=>"script"===e.tag).filter(e=>e.placement===t).map(e=>this.createCustomTag(e)),s.style[t]=a.filter(e=>"style"===e.tag).filter(e=>e.placement===t).map(e=>this.createCustomTag(e)),s.link[t]=a.filter(e=>"link"===e.tag).filter(e=>e.placement===t).map(e=>this.createCustomTag(e));return console.log(s),s}static createCustomTag(e){switch(e.tag){case"link":return this.createLinkTag(e);case"script":return this.createScriptTag(e);case"style":return this.createStyleTag(e);default:return this.createMetaTag(e)}}static fetchDynamicAttribute(e){return lab_api.v1.view.render({model:lab_api.v1.model.query.getRootModel(),template:e})||null}static parseAttributes(e){return e.filter(e=>!!e.key).map(e=>e.value?`${e.key}="${e.value.match(/\{\{.*\}\}/g)?this.fetchDynamicAttribute(e.value):e.value}"`:e.key).join(" ")}static parseVariables(e){return e.replace(/\{\{\{?.*?\}\}\}?/g,this.fetchDynamicAttribute)}static createLinkTag(e){return`<link ${this.parseAttributes(e.attributes)}>`}static createScriptTag(e){return`<script ${this.parseAttributes(e.attributes)}>${e.value?this.parseVariables(e.value):""}<\/script>`}static createMetaTag(e){return`<meta ${this.parseAttributes(e.attributes)}>`}static createStyleTag(e){return`<style ${this.parseAttributes(e.attributes)}>${e.value?this.parseVariables(e.value):""}</style>`}}class c{static buildConfig(e){return{viewConfig:{config:{customer:{paywall:{label:lab_api.v1.config.get("paywall.label")||{}},image:{defaultAspectRatio:lab_api.v1.config.get("image.defaultAspectRatio")||void 0}}}}}}}class p{constructor(e,t){this.api=e,this.page=t}set(e,t){const i=this.export(e,t),s=t.get("type").replace("page_",""),a=this.api.v1.app.mode.isEditor();for(const t of Object.keys(i))e.setFiltered(t,i[t]);e.setFiltered("customTags",g.prepareForTemplate(this.api.v1.config.get("customTags")||[],s,a))}export(e,t){const i={},a=new Date,o=t.get("type").replace("page_",""),l=t.get("id"),g=this.api.v1.site.getSite().domain||this.api.v1.properties.get("customer_front_url"),p=g+t.get("fields.published_url"),u=encodeURIComponent(p),h=this.api.v1.properties.get("image_server"),f=this.api.v1.app.mode.isEditor(),m=this.getCanonicalUrl(e,o,l,g),y=this.api.v1.config.get("tagPagePath")||"/tag/",b="front"===o&&(p.endsWith(y.slice(0,-1))||p.indexOf(y)>-1),v=b&&!p.endsWith(y.slice(0,-1));i.customer_front_url=g,i.isEditMode=f,i.url=p,i.urlEncoded=u,i.specificUrl=m,i.image_server=h,i.pageType=o,i.pageId=l,i.is_article="article"===o,i.is_notice="notice"===o,i.is_front="front"===o,i.is_gallery="gallery"===o,i.is_infiniteArticle="infinitescroll"===t.get("fields.page_template_alias"),i.section=t.get("primaryTags.section")||t.get("fields.defaultsection"),i.device=this.api.v1.viewport.getName(),i.cmsVersion=this.api.v1.properties.get("app.version"),i.front_api_url=this.api.v1.properties.get("front_api_url"),i.xUaDevice=this.api.v1.properties.get("xUaDevice"),i.favicons=this.api.v1.config.get("favicons"),i.faviconList=this.api.v1.config.get("faviconList"),i.skipDefaultFont=this.api.v1.config.get("skipDefaultFont"),i.isDebug=this.api.v1.util.request.hasQueryParam("debug"),i.staticUrl=this.getStaticUrl(e,o,l,g),i.customMetatags=this.getCustomMetatags(),i.footerSettings=this.api.v1.config.get("page_settings.footer"),i.rssDescriptionPrefix=this.api.v1.config.get("viewports.rss.descriptionPrefix"),i.is_tagpage=b,i.contentLanguage=lab_api.v1.config.get("contentLanguage");const _=this.page.media.getLogo(t.getViewport());i.logo=_.current,i.logo_sm=_.sm,i.logo_mm=_.mm,i.misc=this.api.v1.config.get("misc");const k={active:!1,lang:this.api.v1.config.get("google_translate")};k.lang&&Array.isArray(k.lang)&&k.lang.length&&(k.active=!0),i.google_translate=k;const w=new d({pageType:o,canonical:m,isTagpage:b,isTagpageWithFrontpage:v,tagpagePath:y,publishedUrl:p}),S=w.generateSiteData(e),F=w.getStructuredData(e);i.jsonld=JSON.stringify([S,F]);const T=w.getSEOData(e);if(i.seotitle=T.title,i.seodescription=T.description,i.seolanguage=T.language,"article"===o||"notice"===o){const t=e.get("fields.sometitle")||e.get("fields.teaserTitle")||e.get("fields.title");t&&(i.sometitle=this.api.v1.util.string.stripTags(t));const s=e.get("fields.teaserTitle")||e.get("fields.title")||"";s&&(i.kilkayaTitle=this.api.v1.util.string.stripTags(s));const a=e.get("fields.teaserKicker")||e.get("fields.kicker")||"";a&&(i.kilkayaKicker=this.api.v1.util.string.stripTags(a));const n=e.get("fields.somedescription")||e.get("fields.teaserSubtitle")||e.get("fields.subtitle");if(n&&n.length>0)i.somedescription=this.api.v1.util.string.stripTags(n);else{let t=e.get("fields.bodytext")||"";t=this.api.v1.util.string.stripTags(t),i.somedescription=`${t.substring(0,100)} ...`}}else if("front"===o){const t=e.get("fields.someimage");null!=t&&""!==t&&(i.someimage=`${h}/${t}.webp?width=1200&height=630`),i.sometitle=e.get("fields.sometitle")||e.get("fields.name"),i.somedescription=e.get("fields.somedescription")||""}if(this.isAuthorPage(e.get("fields.hostpath"))){const t=e.get("fields.author_json");if(t){const e=[t.fields.firstname||"",t.fields.lastname||""].filter(Boolean).join(" "),s=this.api.v1.properties.get("site.display_name")||"";e&&(i.sometitle=`${e} - ${s}`,i.seotitle=`${e} - ${s}`)}}if(i.social={facebook:`https://www.facebook.com/sharer.php?u=${u}`,twitter:`https://twitter.com/intent/tweet?url=${u}`,mail:`mailto:?subject=${encodeURIComponent(this.api.v1.util.string.stripTags(t.get("fields.title")))}&body=${encodeURIComponent(this.api.v1.util.string.stripTags(t.get("fields.subtitle")))}%0D${u}`,linkedin:`https://www.linkedin.com/sharing/share-offsite/?url=${u}`,threads:`https://threads.net/intent/post?text=${u}`,copyLink:`navigator.clipboard.writeText("${p}");`,glimta:`https://glimta.com/unlock?link=${u}`,talandeWebb:"ReachDeck.panel.toggleBar();",bluesky:`https://bsky.app/intent/compose?text=${encodeURIComponent(`${i.sometitle}\n`)}${u}`,reddit:`https://www.reddit.com/submit?url=${u}&title=${encodeURIComponent(i.sometitle)}`,whatsapp:`https://api.whatsapp.com/send?text=${encodeURIComponent(`${i.sometitle}\n${p}`)}`},"article"===o){const t=this.api.v1.config.get("page_settings.article.ignoredTags")||[],s=this.api.v1.config.get("page_settings.article.ignoredTagPrefix")||[],a=(e.get("tags")||[]).filter(e=>!t.includes(e)).filter(e=>{for(const t of s)if(e.startsWith(t))return!1;return!0});i.tagsString=a.toString();let n="";a.forEach((e,t)=>{n+=`"${e.replace('"',"'")}"`,t<a.length-1&&(n+=", ")}),i.tagsStringCommaSeparated=n;const o=this.api.v1.model.query.getChildrenOfType(e,"byline",!0);if(o){const e=o.map(e=>`"${e.get("fields.firstname")} ${e.get("fields.lastname")}"`).join(", ");i.bylinesStringCommaSeparated=e}}"article"===o&&(e.get("fields.published")&&(i.published=new Date(1e3*parseInt(e.get("fields.published"),10)).toISOString(),i.publishedTimestamp=e.get("fields.published")),e.get("fields.hidefromfp_time")&&(i.hidefromfp_time=new Date(1e3*parseInt(e.get("fields.hidefromfp_time"),10)).toISOString())),i.site=this.api.v1.site.getSite(),i.siteJSON=JSON.stringify(i.site),i["site.domain_no_protocol"]=i.site.domain.split("://").pop(),i.siteAlias=i.site.alias,i.fullUrl=i.site.domain,i[`site_is_${i.siteAlias}`]=!0;const C=this.page.resources;if(!f&&i.is_article&&this.api.v1.config.get("displayReadProgress.active")&&t.get("fields.displayReadProgress")&&(i.readProgress=C.scripts.getProgressReader()),i.siteStylesheetList=s.getSiteStylesWithFallback(i.siteAlias),Sys.logger.debug(`ViewSupport: Will include ${i.siteStylesheetList.length} configured stylesheet(s): "${i.siteStylesheetList.join(", ")}".`),i.siteFiles=C.scripts.getSiteFiles(e,t,i.siteAlias,o,f),i.modules=C.scripts.getModules(e,t,i.siteAlias,o,f),!f){i.analytics=C.analytics.get(i),i.widgets={strossle:this.api.v1.config.get("widgets.strossle.strossle_id")},i.consent={cookieconsent:this.api.v1.config.get("consent.cookieconsent.show"),cookieconsent_culture:this.api.v1.config.get("consent.cookieconsent.culture")||"NB"},this.api.v1.config.get("cookieConsent.enabled")&&C.scripts.required.push({url:"/view-resources/public/common/cookieConsent.js",requireDom:!1}),"desktop"===this.api.v1.viewport.getName()&&t.get("fields.style_slidein")&&(i.style_slidein=!0,C.scripts.required.push({url:"/view-resources/public/common/SlideIn/SlideIn.js",requireDom:!1}));const s=this.api.v1.config.get("adEnvironment")||{},a="1"===t.get("fields.hideAds"),n="1"===t.get("fields.hideSkyscraperAds")||!1,o="1"===t.get("fields.hideTopBannerAd")||"1"===e.get("fields.hideTopBannerAd")||!1;if(Sys.logger.debug(`[PageData] Ad settings: hideAds=${a}, disableSkyscraper=${n}, disableTopBanner=${o}, adEnv=${s.name||"none"}`),!a&&s&&"adnuntius"===s.name)try{i.adnuntius=r.getAdnuntiusSettings(this.api,e,t,s,i.site,n,o)}catch(e){Sys.logger.warn(`[PageData] Failed to prepare Adnuntius ads: ${e.toString()}`)}if(!a&&s&&"google"===s.name)try{i.googleAds=r.getGoogleSettings(this.api,e,t,s,i.site,n,o)}catch(e){Sys.logger.warn(`[PageData] Failed to prepare Google ads: ${e.toString()}`)}i.adEnvironment={...s},i.adEnvironment[`is_${s.name}`]=!0;const l="google"===s.name&&s.bidding&&s.bidding.provider&&s.bidding.provider.name?s.bidding.provider.name:"none";i.adEnvironment[`is_provider_${l}`]=!0}if(this.api.v1.util.request.hasQueryParam("fontpreview")&&(i.fontpreview=this.api.v1.util.request.getQueryParam("fontpreview"),i.analytics=null),i.page_settings=this.page.settings.get({pageType:"notice"===o||"gallery"===o?"article":o,socialLinks:i.social}),"article"===o){const s=this.api.v1.config.get("comments_provider.hideCommentsIfPaywall")||!1,a=this.api.v1.properties.get("paywall")||{},n=lab_api.v1.app.mode.isFront()&&a.active&&!a.hasAccess&&s,r=!1===f&&!1===n;if(t.get("fields.showcomments")&&!n){if(this.api.v1.config.get("comments_provider.facebook")){const e=this.api.v1.config.get("comments_provider.facebook.app_id");e&&(i.facebook={display:r,displayPlaceholder:f,appId:e,pageId:l,url:i.fullUrl+("article"===o?`/a/${l}`:"")},i.displayComments=!0)}if(this.api.v1.config.get("comments_provider.disqus")){const e=this.api.v1.config.get("comments_provider.disqus.enable"),t=this.api.v1.config.get("comments_provider.disqus.script");e&&(i.disqus={display:r,displayPlaceholder:f,canonical:m,pageId:l,script:t},i.displayComments=!0)}const t=this.api.v1.config.get("comments_provider.commento");t&&t.enable&&(i.commento={display:r,displayPlaceholder:f,canonical:m,usePageId:t.usePageId,pageId:l,script:t.script,cssOverride:t.cssOverride,descriptionText:t.descriptionText},i.displayComments=!0);const s=lab_api.v1.config.get("comments_provider.hyvor");if(s&&s.websiteId){const t=e.get("fields.published")||0;i.hyvor={display:r,displayPlaceholder:f,websiteId:s.websiteId,pageId:t>1646908200&&l},s.hidePageIdBeforeDate&&t<s.hidePageIdBeforeDate&&(i.hyvor.pageId=""),i.displayComments=!0}const a=lab_api.v1.config.get("comments_provider.ifragasatt");a&&(i.ifragasatt={display:r,displayPlaceholder:f,customerId:a.customer_id,articleId:`article${l}`},i.displayComments=!0)}}i.menus=this.page.menus.get({defaultSection:t.get("fields.defaultsection"),section:t.get("primaryTags.section")}),i.style_definitions=n.getStyleDefinitions(this.api),i.css_build=n.getInlineCSS(this.api),i.css_variables=n.getCssVariables(this.api),i.contact=this.api.v1.config.get("contact");const D=!!t.get("fields.norobots"),x=t.get("fields.hidefromfp_time"),$=Math.round(a.getTime()/1e3);if(i.norobots=D||x&&x<=$||!1,"article"===o&&this.api.v1.config.get("embeddable.active")&&(i.embeddable={active:!0,display:!!t.get("fields.displayEmbedButton")&&"embed"!==i.device,aboveBodytext:!!t.get("fields.displayEmbedButtonAboveBodytext")&&"embed"!==i.device,isFullContent:this.api.v1.util.request.getQueryString().indexOf("lab_content=full")>-1,hasParallax:this.api.v1.model.query.hasChildOfType(e,"parallax",!0)}),Sys.logger.debug(`ViewSupport: Will include ${C.scripts.required.length} configured script(s): "${C.scripts.required.map(e=>e.url).join(", ")}".`),C.scripts.required.forEach(e=>{if(!e.placeholderKey&&e.requireDom&&(e.placeholderKey="requireDom"),e.placeholderKey){const{placeholderKey:t}=e;e.placeholderKey={},e.placeholderKey[t]=!0}}),i.siteScriptList=C.scripts.required,i.paywall=this.getPaywallInfo(e,f),i.simplestreamEnabled=lab_api.v1.config.get("contentbox_settings.simplestream")||!1,"mailmojo"===i.device&&this.setDefaultMailmojoData(e,t),"article"===o){const t=lab_api.v1.config.get("page_settings.article.ageWarnings");if(Array.isArray(t)){const i=e.get("fields.published");if(i){const s=this.getAgeWarningItem(i,t);s&&e.setFiltered("ageWarning",s)}}}i.featureFlags={responsive_mobile_fonts:!lab_api.v1.util.featureFlags.enabled("Disable responsive mobile fonts",o)},i.clientSideConfig=JSON.stringify(c.buildConfig(this.api));const M=e.get("fields.hostpath");return i.shouldRenderCanonical=!("labrador/http-404"===M||"labrador/http-410"===M),i}getAgeWarningItem(e,t){const i=Object.values(t).filter(e=>!!e.years&&!!e.label).sort((e,t)=>t.years-e.years),s=new Date(1e3*e),a=Date.now()-s,n=new Date(a),o=Math.abs(n.getUTCFullYear()-1970);for(const e of i)if(o>=e.years)return e;return null}setDefaultMailmojoData(e,t){const i=lab_api.v1.config.get("lang")||"no";e.setFiltered("lang",i)}getCanonicalUrl(e,t,i,s,a){const n=e.get("fields.lab_canonical");if(n)return n;if("front"===t){const t=e.get("fields.hostpath");return"index"===t?`${s}/`:this.isAuthorPage(t)?`${s}/${this.getAuthorPageCanonical(e)}`:`${s}/${t}`}return`${s+e.get("fields.published_url")}`}getStaticUrl(e,t,i,s){if("front"===t){const t=lab_api.v1.util.request.getHeader("X-Labrador-404-Referer");if(t)return`${s}${t}`;const i=e.get("fields.hostpath");return i?`${s}/${"index"===i?"":i}`:`${s+e.get("fields.published_url")}`}return`${lab_api.v1.properties.get("site").domain}/a/${i}`}getCustomMetatags(){const e=lab_api.v1.config.get("customMetatags")||[],t=lab_api.v1.config.get("customMetatagsKeyVal")||[],i=[];for(const t of e){const e=Object.keys(t).map(e=>({key:e,value:t[e]}));i.push(e)}for(const e of t)e.length&&i.push(e);return i}getPaywallInfo(e,t){const i=lab_api.v1.properties.get("paywall"),s=!t&&"1"===e.get("fields.paywall"),a=lab_api.v1.config.get("paywall.provider",{site:lab_api.v1.site.getSite().alias})||"internal",n=(!t&&e.get("fields.paywallSalesImage"),!t&&s&&i.hasAccess&&"1"===e.get("fields.paywallShareable"));let o;if("1"===e.get("fields.paywallShareable")){o=lab_api.v1.config.getConfig("pages.localisation.data.items.paywall.items.shareableArticle.items")||{};for(const e of Object.keys(o))o[e]=lab_api.v1.locale.get(`paywall.shareableArticle.${e}`)||""}const l={display:!0,...this.api.v1.config.get("paywall.label")},r=this.api.v1.config.get("paywall.label.text.content"),d=this.api.v1.config.get("paywall.label.icon.content"),g={text:{content:null==r?"Plus":this.api.v1.config.get("paywall.label.text.content")},icon:{content:null==d?"fi-plus":this.api.v1.config.get("paywall.label.icon.content")}};return Object.assign(l,g),l.display&&e.setFiltered("paywallLabel",l),{enabled:s,settings:i,provider:a,shareable:n,shareableArticle:o,hasAccess:!s||!i.active||i.hasAccess,hidePaywallOffers:this.api.v1.util.request.hasQueryValue("lab_opts","paywall_loginonly"),paywallSalesImage:e.get("fields.paywallSalesImage"),paywallSalesPitchContent:e.get("fields.paywallSalesPitchContent"),paywallSalesPitchTitle:e.get("fields.paywallSalesPitchTitle"),paywallLayoutType:e.get("fields.paywallPreview.paywallLayoutType"),requiredProducts:JSON.stringify(this.api.v1.properties.get("app.paywall.requiredProducts")||[])}}isAuthorPage(e){const t=this.api.v1.config.get("authorPages")||{},i=t.path||"author";return!!(e&&t.enabled&&e.startsWith(`${i}/`))}getAuthorPagePath(){return(this.api.v1.config.get("authorPages")||{}).path||"author"}getAuthorPageSlug(e){const t=e.get("fields.author_json");if(t)return t.fields.slug}getAuthorPageId(e){const t=e.get("fields.author_json");if(t)return t.fields.id}getAuthorPageCanonical(e){const t=this.getAuthorPagePath(),i=this.getAuthorPageSlug(e),s=this.getAuthorPageId(e);return`${t}/${i||s}`}}class u{static parseCss(e,t="filtered.autodata"){const i=e.get(t);if(i&&"object"==typeof i)return[Object.values(i.cssObject||{}).join(" "),i.cssString||"",(i.cssArray||[]).join(" ")].join(" ").trim()}static parseAttributes(e){const t=e.get("filtered.autodata.attributesObject");if(t&&"object"==typeof t)return Object.keys(t).map(e=>({key:e,value:t[e]}))}static parseCustomData(e){const t=e.get("filtered.autodata.custom");if(!t||"object"!=typeof t)return;const i={};for(const e of Object.keys(t))i[e]=Object.keys(t[e]).map(i=>({key:i,value:t[e][i]}));return i}static parseCustomDataFromFeed(e,t){const i=lab_api.v1.config.get(`${t}.autodata.mapping`)||{};if(!i||"object"!=typeof i)return;const s={labels:[]};if(i.labels)for(const t of Object.keys(i.labels))e[i.labels[t]]&&s.labels.push({key:t,value:e[i.labels[t]]});return s}}class h{constructor(e){this.api=e,this.pageData=new p(this.api,new a(this.api))}onReady(e,t){this.pageData.set(e,t),e.setFiltered("autodata_css",u.parseCss(e)),e.setFiltered("autodata_attributes",u.parseAttributes(e)),e.setFiltered("autodata_custom",u.parseCustomData(e))}}class f{constructor(e){this.api=e,this.pageData=new p(this.api,new a(this.api))}onReady(e,t){this.pageData.set(e,t)}}class m extends l{constructor({languageCode:e}={}){super("en"),this.languageCode=e||lab_api.v1.config.get("contentLanguage")}str(e,{data:t,noRender:i}={}){return lab_api.v1.locale.get(`dates.${e}`,{data:t,noRender:i})}timestampToNiceDate(e,t=!1){const i=(new Date).getTime(),s=new Date(1e3*e).getTime()-0,a=parseInt((i-s)/1e3/60,10);if(a<60)return a<1?this.str("now"):this.str("durationSince",{data:{count:a,period:t?this.str("min"):1===a?this.str("minute"):this.str("minutes"),ago:t?"":this.str("ago")}});if(a<1440){const e=parseInt(a/60,10);return this.str("durationSince",{data:{count:e,period:1===e?this.str("hour"):this.str("hours"),ago:t?"":this.str("ago")}})}if(parseInt(a/1440,10)<30){const e=parseInt(a/1440,10);return this.str("durationSince",{data:{count:e,period:1===e?this.str("day"):this.str("days"),ago:t?"":this.str("ago")}})}return this.format(this.timestampToDate(e),this.str("monthdayyear",{noRender:!0}))}}class y{constructor(e){this.api=e,this.pageData=new p(this.api,new a(this.api)),this.dateTimeHelper=new m}onReady(e,t){this.pageData.set(e,t);const i=e.get("fields.modified"),s=e.get("fields.published"),a=i||s;if(null!=a){const t=new Date(1e3*a);e.setFiltered("niceDate",this.dateTimeHelper.timestampToNiceDate(a)),e.setFiltered("publishedDate",this.dateTimeHelper.utcFormat(t,`${this.api.v1.locale.get("dates.monthdayyear",{noRender:!0})} ${this.api.v1.locale.get("dates.hourminute",{noRender:!0})}`)),e.setFiltered("isoDate",t.toISOString()),e.setFiltered("date",{published:{isoDate:s?new Date(1e3*s).toISOString():null},modified:{isoDate:i?new Date(1e3*i).toISOString():null}})}if(e.setFiltered("tagPagePath",this.api.v1.config.get("tagPagePath")||"/tag/"),e.get("filtered.hasInsertedRelatedContent"))return;const n=e.get("tags")||[],o={type:"text_singleline",contentdata:{fields:{text:this.api.v1.locale.get("notice.relatedContent.header"),elementType:"h2"}}};this.api.v1.model.insert.atPath({path:"dropZone/",data:{type:"row",metadata:{spaceOutsideTop:"large",spaceOutsideBottom:"medium"},children:[o,{type:"livefeed",contentdata:{id:122,fields:{tags:n.join(","),maxNoticesCount:20}},metadata:{blacklist:[e.get("id")]},width:66.66},{type:"frontContent",contentdata:{fields:{organizer:"RowsAndColumns",source:"lab-api-site",tags_allow:!0,tags_useOr:!0,tags_string:n.join(","),hide_kicker:!0,hide_subtitle:!0,layout_rowCount:"20",layout_columnCount:"1",size_active:!0,size_title:24}},width:33.33}],state:{isNonPersistent:!0}}}),e.setFiltered("hasInsertedRelatedContent",!0)}}class b{constructor(e){this.api=e,this.pageData=new p(this.api,new a(this.api)),this.isFront=this.api.v1.app.mode.isFront();const t=this.api.v1.config.get("page_settings.gallery")||{};this.gallerySettings={displayHeader:this.api.v1.util.defaults.true(t.displayHeader),displayFooter:this.api.v1.util.defaults.true(t.displayFooter),pageBackgroundColor:t.pageBackgroundColor||"#000000",pageTextColor:t.pageTextColor||"#ffffff",logImageView:this.api.v1.util.defaults.false(t.logImageView)}}onReady(e,t){if(!this.isFront)return;const i=this.api.v1.model.query.getChildOfType(e,"slideshow");if(!i)return void Sys.logger.warn("[Gallery] No slideshow found, skipping gallery setup ...");const s=t.getViewport();e.set("id",e.get("fields.parent_node_id")),e.set("fields.published_url",`/gallery/${e.getId()}/${i.getId()}`),this.pageData.set(e,t),i.set("fields.gallery_active",!1),i.set("width",100,{viewport:"mobile"}),i.set("width",100,{viewport:"desktop"});const a=this.api.v1.view.getView(i,t.getViewport());a.set("metadata.displayPreview",!0),i.set("metadata.hasFullWidth",!1,{viewport:"mobile"}),i.set("metadata.hasFullWidth",!1,{viewport:"desktop"}),"mobile"===s?a.set("fields.aspectRatio",1):a.set("fields.aspectRatio",.75);const n=`${this.api.v1.locale.get("gallery.label")} - ${i.get("fields.title")||i.getId()}`,o=`${i.get("fields.description")||"[description]"}`;e.set("filtered.title",i.get("fields.title")||this.api.v1.locale.get("gallery.label")),e.set("filtered.seotitle",n),e.set("filtered.sometitle",n),e.set("filtered.seodescription",o),e.set("filtered.somedescription",o),e.set("filtered.gallerySettings",this.gallerySettings),e.set("filtered.imageCount",i.children.length)}}class v{constructor(e){this.api=e}onRender(e,t){const i=this.api.v1.config.get("contentbox_settings.adnuntiusAd.formats")||[],s=e.get("fields.format"),a=i.filter(e=>e.format===s)[0]||{};if(e.setFiltered("adData",a),e.setFiltered("isDebug",this.api.v1.util.request.hasQueryParam("debug")||e.get("metadata.isDebug")),!this.api.v1.app.mode.isEditor()){const t=e.parent&&!0===e.parent.get("metadata.hideOnTablet")&&"tablet"===this.api.v1.config.get("xUaDevice");e.setFiltered("hideOnTablet",t)}if(this.api.v1.app.mode.isEditor()){const t=this.api.v1.model.root.getType().replace("page_",""),a=[];i.forEach(e=>{if(e.selectable&&e.selectable.indexOf(t)>-1||e.selectableOn&&!0===e.selectableOn[t])if(e.format===s){const t={...e};t.selected=!0,a.push(t)}else a.push(e)}),e.setFiltered("formatConfigKeys",a)}const n=this.api.v1.config.get("contentbox_settings.adnuntiusAd.label")||"Annonse",o=e.get("fields.label")||n;if(e.setFiltered("label",o),e.setFiltered("displayLabel",o&&(e.get("metadata.css")||"").includes("display-label")),(e.get("metadata.css")||"").includes("sticky")){const t=`top: ${this.api.v1.config.get("contentbox_settings.adnuntiusAd.spacingTop")||120}px;`;e.setFiltered("spacingTop",t)}}}class _{constructor(e){this.api=e}onRender(e){const t=this.api.v1.config.get("contentbox_settings.apsis_submit");t&&e.setFiltered("apsis",t)}}class k{static textElements(e,t){const i={top:[],floating:[],bottom:[],positions:{kicker:"",title:""}};let s="",a="";if(e.get("metadata.showKicker")&&(t||e.get("fields.kicker")||e.get("fields.origin_data_json.teaserKicker")||e.get("fields.origin_data_json.kicker"))&&(e.get("metadata.floatingKicker")?(i.floating.push("kicker"),i.positions.kicker="floating",s="floating"):e.get("metadata.kickerBelowImage")?(i.bottom.push("kicker"),i.positions.kicker="below",s="bottom"):(i.top.push("kicker"),i.positions.kicker="above",s="top")),e.get("metadata.hideTitle")||!t&&!e.get("fields.title")||(e.get("metadata.floatingTitle")?(i.floating.push("title"),i.positions.title="floating",a="floating"):e.get("metadata.titleAboveImage")?(i.top.push("title"),i.positions.title="above",a="top"):(i.bottom.push("title"),i.positions.title="below",a="bottom")),e.get("metadata.kickerBelowTitle")&&e.get("metadata.showKicker")&&a){if(s){const e=i[s].indexOf("kicker");-1!==e&&i[s].splice(e,1)}const e=i[a],t=e.indexOf("title");-1!==t?e.splice(t+1,0,"kicker"):e.push("kicker"),i.positions.kicker="belowTitle",s=a}return!e.get("metadata.hidesubtitle")&&(t||e.get("fields.subtitle")||e.get("fields.origin_data_json.teaserSubtitle"))&&(e.get("metadata.floatingSubtitle")?i.floating.push("subtitle"):e.get("metadata.subtitleAboveImage")?i.top.push("subtitle"):i.bottom.push("subtitle")),i}}class w{static convertToIso639(e){let t="";return e&&(t=3===e.length?e.toLowerCase():e.includes("-")?e.split("-")[0].toLowerCase():e.toLowerCase()),t}}class S{static autoSizeText(e,t){if(!e)return"";let i={};i=t||{regex:{},formats:{default:{maxWordLength:15,minLineLength:3,ranges:[{maxCharacters:1/0,numberOfLines:1}]}}};const s={1:100,2:70,3:50,4:45,5:40,6:35,7:30,8:26,9:22,10:20,11:18,12:17,13:16,14:15,15:14,16:13,17:12,18:11,19:10,20:9,21:8,22:7,23:6,24:5,25:4},a=e.innerHTML.replace(/&nbsp;/,"");if(e.querySelector("br")||e.querySelector(".auto-font-size-line-br")){const t=this.handleBreaks(a);e.innerHTML="",t.forEach((i,s)=>{e.innerHTML+=`<span class="auto-font-size-line${s<t.length?" auto-font-size-line-br":""}">${i} </span>`})}else{const i=this.removeHTMLTags(a),s=this.splitSentence(i,t,"default");e.innerHTML="";for(const t of s)e.innerHTML+=`<span class="auto-font-size-line">${t} </span>`}const n=e.querySelectorAll(".auto-font-size-line"),o=e.clientWidth;for(const e of n){const t=s[e.innerText.length]||5;e.clientWidth<o?this.enlargeTitle(e,o,t):e.clientWidth>o&&this.shrinkTitle(e,o,t)}return e.innerHTML}static handleBreaks(e){let t=this.removeHTMLTags(e).split(/<br\s*[^>]*>/gi);return t=t.filter(e=>e.trim().length>0),t}static removeFontSize(e){const t=e.innerHTML;return e.innerHTML=this.removeHTMLTags(t),this.removeHTMLTags(t)}static removeHTMLTags(e){let t=e.replace(/<span class="auto-font-size-hyphen">-<\/span>\s?/g,"");return t=t.replace(/<span class="[^"]*\bauto-font-size-line-br\b[^"]*"[^>]*>(.*?)<\/span>/g,"$1<br>"),t=t.replace(/<span class="[^"]*\bauto-font-size-line\b[^"]*"[^>]*>(.*?)<\/span>/g,"$1"),t=t.replace(/<span[^>]*>([^<]*)<\/span>/g,"$1"),t=t.replace(/(\r\n|\n|\r)/g,""),t}static enlargeTitle(e,t,i,s=100){let a=i;for(;e.clientWidth<t&&a<=s;)a+=1,e.style.setProperty("--lab-auto-font-size",`${a}cqi`);for(;e.clientWidth>=t||a>s;)a-=.1,e.style.setProperty("--lab-auto-font-size",`${a}cqi`)}static shrinkTitle(e,t,i){let s=i;for(;e.clientWidth>t;)s-=.1,e.style.setProperty("--lab-auto-font-size",`${s}cqi`)}static splitSentence(e,t,i){const s=e||"",{length:a}=s;if(!t||!t.formats||!t.formats[i])return[s];const n=this.findRules(t,i),o=this.findNumberOfLines(n.ranges,a)||1,l=n.maxWordLength||null,r=n.minLineLength||null,d=t.reges||{};return this.splitTextEvenly(e,o,l,r,d)||[]}static findRules(e,t){return{...e.formats[t]}}static findNumberOfLines(e,t){const i={maxLineLength:20,numberOfLines:1};for(const s of e)if(t<=s.maxCharacters){i.numberOfLines=s.numberOfLines,i.maxLineLength=s.maxCharacters/s.numberOfLines;break}return i}static checkRegex(e,t,i){let s=t;const a=[];return Array.from(Object.entries(e),([,e])=>e).forEach(e=>{const t=new RegExp(e,"g"),i=s.match(t);i&&a.push(...i)}),a.forEach(e=>{const t=e.replace(/ /g,i);s=s.replace(e,t)}),s}static splitStringIntoParts(e,t,i,s,a){const n=this.checkRegex(i,e,"___").split(" "),o=[];let l="";return n.forEach(e=>{const i=e.trim().replace(new RegExp("___","g")," ");if(i.includes("-"))l.length+i.length+1>t?(o.push(l),l=i):l+=(l.length>0?" ":"")+i;else{const e=this.splitWord(i,s);e.forEach((i,s)=>{l.length+i.length+1>t?(o.push(l),l=i):l+=(l.length>0?" ":"")+i,s<e.length-1&&(l+='<span class="auto-font-size-hyphen">-</span>')})}}),l.length>0&&o.push(l),o}static splitWord(e,t){if(!Number.isFinite(t)||t<=0)return[e];const i=[];let s=e;for(;s.length>t;){if(s.length>t&&s.length<=t+2){const e=Math.floor(s.length/2);i.push(s.substring(0,e)),s=s.substring(e);break}i.push(s.substring(0,t)),s=s.substring(t)}if(s.length>0)if(1===s.length&&i.length>0){const e=i.pop();i.push(e+s)}else i.push(s);return i}static splitTextEvenly(e,t,i,s,a){const n=e.trim(),o=Math.ceil(n.length/t.numberOfLines);let l=this.splitStringIntoParts(n,o,a,i,t.numberOfLines);if(s&&(l=this.mergeShortLines(l,s)),l.length>t.numberOfLines){const e=/<span class="auto-font-size-hyphen">-<\/span>$/,t=l.pop();e.test(l[l.length-1])?l[l.length-1]=l[l.length-1].replace(e,"")+t:l[l.length-1]+=` ${t}`}return l}static mergeShortLines(e,t){const i=[];for(let s=0;s<e.length;s++){let a=e[s].trim();a.length<t&&s<e.length-1&&(a+=` ${e[s+1]}`,s++),i.push(a)}if(i.length>1){const e=i[i.length-1];e.length<t&&(i[i.length-2]+=` ${e}`,i.pop())}return i}}class F{constructor(e){this.api=e,this.imageServer=this.api.v1.properties.get("image_server"),this.rootModel=this.api.v1.model.query.getRootModel(),this.domain=this.api.v1.site.getSite().domain||this.api.v1.properties.get("customer_front_url"),this.fallbackLanguage=this.api.v1.config.get("contentLanguage")||"",this.autoFontSizeConfig=this.api.v1.config.get("autoFontSize")||[],this.autoFontSizePageSettings=Boolean(!!this.rootModel&&this.rootModel.get("fields.autoFontSize")),this.hasAutoFontSize=this.autoFontSizePageSettings&&this.autoFontSizeConfig.enabled,this.autoFontSizeDone=!1,this.dateTimeHelper=new l(this.api.v1.config.get("lang")||void 0)}onInserted(e){if(this.api.v1.app.mode.isEditor()&&this.hasAutoFontSize){e.set("state.autoFontSizeReRender",!0,{notify:!1});const t=(e,t,i)=>{e.get("fields.title")===e.get("state.title")?e.set("state.autoFontSizeReRender",!1,{notify:!1}):(e.set("state.autoFontSizeReRender",!0,{notify:!1}),e.set("metadata.autoFontSizeDone",!1,{notify:!1}))};this.api.v1.model.bindings.bind(e,"fields.title",t)}}onReady(e,t){e.setFiltered("layout",k.textElements(t,this.api.v1.app.mode.isEditor()));let i=e.get("fields.published_url")||"";!/^https?/.test(i)&&i&&(i=this.domain+i),e.setFiltered("published_url",i),e.setFiltered("published_url_rss",i.replace(/&/g,"&amp;"))}onRender(e,t){const i=e.get("instance_of")||e.get("fields.origin_data_json.id"),s=e.get("fields.published")||e.get("fields.origin_data_json.published"),a=e.get("fields.origin_data_json.teaserTitle")||t.get("fields.title")||"",n=e.get("fields.origin_data_json.teaserSubtitle")||t.get("fields.subtitle")||"",o=e.get("fields.origin_data_json.published")||e.get("fields.published"),l=e.get("fields.origin_data_json.teaserKicker")||e.get("fields.origin_data_json.kicker")||t.get("fields.kicker"),r=e.get("fields.site_id")||e.get("fields.origin_data_json.site_id"),d=e.get("fields.origin_data_json.seolanguage")||e.get("fields.seolanguage")||this.fallbackLanguage,g=e.get("fields.origin_data_json.teaserAudio")||e.get("fields.audio"),c=e.get("fields.origin_data_json.teaserAudio_style_json")||e.get("fields.audioInfo")||{},p=e.get("fields.origin_data_json.addRelNoFollow")||e.get("fields.addRelNoFollow")||!1,h=e.get("fields.origin_data_json.addRelSponsored")||e.get("fields.addRelSponsored")||!1,f=e.get("fields.origin_data_json.addRelUgc")||e.get("fields.addRelUgc")||!1;e.setFiltered("published",s),e.setFiltered("title",a),e.setFiltered("kicker",l),e.setFiltered("subtitle",n),e.setFiltered("articleId",i),e.setFiltered("section",e.get("fields.origin_data_json.section_tag")||e.get("fields.section")||""),e.setFiltered("base_url",this.domain),e.setFiltered("published_sitemap",o),e.setFiltered("canonical_url",`${this.getSiteDomain(r)}/a/${i}`),e.setFiltered("tags",e.get("tags")||[]),e.setFiltered("languageIso639",w.convertToIso639(d));const m=(new Date).getTime()-1728e5;if(e.setFiltered("articleOutOfDate_sitemap",m>Math.floor(new Date(o).getTime())),e.setFiltered("addRelNoFollow",p),e.setFiltered("addRelSponsored",h),e.setFiltered("addRelUgc",f),!this.api.v1.config.get("showHiddenTagsOnFront")){const t=(this.api.v1.config.get("tagsToHide")||"").split(",").map(e=>e.trim())||[],i=(e.get("tags")||[]).filter(e=>!t.includes(e));e.setFiltered("tags",i)}if(r){const t=this.api.v1.site.getSiteById(r);t&&e.setFiltered("site_alias",t.alias)}if(g){const t={url:g};if(c){const e=JSON.parse(c);t.title=e.title||null,t.fileType=e.fileType||null,t.playTime=e.playTime||null}e.setFiltered("audio",t)}const y=e.get("fields.origin_data_json.showbylineonfp")||t.get("fields.displayByline")||!1;if(y){const i=t.get("fields.byline")||e.get("fields.origin_data_json.byline"),s=t.get("fields.bylineImage")||e.get("fields.origin_data_json.bylineImage"),a=(e.get("fields.origin_data_json.full_bylines")||e.get("fields.full_bylines_json")||[]).map(e=>({firstname:e.firstname,lastname:e.lastname,description:e.description,imageUrl:e.imageUrl?this.getImageUrl(`${e.imageUrl}&width=90&height=90`):""}));a.length||!i&&!s||a.push({firstname:i,lastname:"",imageUrl:s?this.getImageUrl(`${s}&width=90&height=90`):""}),e.setFiltered("bylines",a),s&&e.setFiltered("bylineImage",`${s}&width=90&height=90`)}e.setFiltered("displayByline",y);const b=t.get("fields.displayPublishedDate")||!1,v=this.api.v1.locale.get("dates.monthdayyear",{noRender:!0});if(e.setFiltered("displayPublishedDate",b),b)if(this.api.v1.app.mode.isEditor()&&!s)e.setFiltered("publishedDate",v);else if(this.api.v1.app.mode.isEditor()||s){const t=new Date(s),i=this.dateTimeHelper.format(t,v);e.setFiltered("publishedDate",i)}else e.setFiltered("displayPublishedDate",!1);let _=e.get("fields.origin_data_json.paywall")||e.get("fields.paywall")||!1;if(_=1===_||"1"===_||!0===_||null,_){const i={display:!0,displayInNewsletter:!0,...this.api.v1.config.get("paywall.label")},s=this.api.v1.config.get("paywall.label.text.content"),a=this.api.v1.config.get("paywall.label.icon.content"),n={text:{content:null==s?"Plus":this.api.v1.config.get("paywall.label.text.content")},icon:{content:null==a?"fi-plus":this.api.v1.config.get("paywall.label.icon.content")}};if(Object.assign(i,n),i.display){i.layout={noImage:!0,float:null};const s=this.api.v1.model.query.getChildOfType(e,"image")||this.api.v1.model.query.getChildOfType(e,"graphic");if(s&&s.get("instance_of")){const e=this.api.v1.view.getView(s,t.getViewport());i.layout.float=this.api.v1.config.get("paywall.label.labelPosition")||e.get("fields.float"),i.layout.noImage=!!t.get("metadata.hideimage")}e.setFiltered("paywallLabel",i)}}else e.setFiltered("paywallLabel",null);e.setFiltered("paywall",_);const k=e.get("metadata.tagPlacement")||"underImage";e.setFiltered("tagPlacement.underImage","underImage"===k),e.setFiltered("tagPlacement.underText","underText"===k);const S=e.get("metadata.sectionPlacement")||"floating";if(e.setFiltered("sectionPlacement.floating","floating"===S),e.setFiltered("sectionPlacement.underImage","underImage"===S),e.setFiltered("sectionPlacement.underText","underText"===S),e.setFiltered("articleWidth",t.getPixelWidth()),e.setFiltered("autodata_css",u.parseCss(e)),e.setFiltered("autodata_content_css",u.parseCss(e,"filtered.autodata_content")),e.setFiltered("autodata_attributes",u.parseAttributes(e)),e.setFiltered("autodata_custom",u.parseCustomData(e)),this.autoFontSizeConfig.enabled&&(this.autoFontSizeDone=e.get("metadata.autoFontSizeDone")),"newssitemap"===this.api.v1.viewport.getName()){const t=this.api.v1.model.query.getChildOfType(e,"image"),i=t.get("instance_of");if(this.imageServer&&t&&i){const t=`${this.imageServer}?imageId=${i}&format=webp&width=500`;e.setFiltered("headerImageUrl",t)}}}onRendered(e,t){if(this.api.v1.app.mode.isEditor()&&this.autoFontSizeConfig.enabled){const i=()=>{const e=t.getMarkup().querySelector(".headline");S.removeFontSize(e),this.api.v1.tool.off("ended",i)};if("desktop"===t.viewport&&this.hasAutoFontSize&&e.get("metadata.autoFontSizeEnabled")&&(this.api.v1.tool.on("started",t=>{"fields.title"===t.key&&t.model===e&&i()}),e.get("state.autoFontSizeReRender")&&e.get("fields.title")&&!this.autoFontSizeDone&&e.get("metadata.autoFontSizeEnabled"))){const i=t.getMarkup().querySelector(".headline"),s=S.autoSizeText(i,this.autoFontSizeConfig);e.set("state.autoFontSizeReRender",!1,{notify:!1}),e.set("state.title",s,{notify:!1}),e.set("metadata.autoFontSizeDone",!0,{notify:!1}),e.set("fields.title",s)}}}onCreated(e){this.hasAutoFontSize&&null===e.get("metadata.autoFontSizeEnabled")&&e.set("metadata.autoFontSizeEnabled",!0,{notify:!1})}getSiteDomain(e){if(!e)return"";const t=this.api.v1.site.getSiteById(e);return t?t.domain:""}getImageUrl(e){return e?e.startsWith("http")?e:this.imageServer+e:""}}class T{constructor(e){this.api=e}onViewHelper(e){const t=e.get("fields.site_id")||null,i=e.get("fields.articleCount")||6,s=`${(new l).formattedUtcDate(new Date,"Y-m-d")}T00:00:00Z`,a=`${this.api.v1.properties.get("front_api_url")}/api/v1/article/?`,n={orderBy:"calendar_start_date",order:"asc",site_id:t,limit:i,htmlText:1},o={visibility_status:"P",published:"[*%20NOW]",calendar_start_date:`[${s}%20TO%20*]`},r=[];for(const e in n)n[e]&&r.push(`${e}=${n[e]}`);const d=[];for(const e in o)o[e]&&d.push(`${e}:${o[e]}`);r.push(`query=${d.join("%20AND%20")}`);const g=a+r.join("&");e.setFiltered("url",g)}onRender(e,t){const i=t.get("external"),s=e.get("fields.site_id")||"",a=e.get("fields.displayImage"),n=e.get("fields.displayTitle")||null,o=e.get("fields.displaySubtitle"),l=this.api.v1.properties.get("image_server"),r=this.api.v1.config.get("contentbox_settings.articleCalendar.imageAspectRatio")||this.api.v1.config.get("image.defaultAspectRatio"),d=["width=420",`height=${Math.floor(420*r)}`,`format=${this.api.v1.image.getPreferredImageFormat()}`];if(this.api.v1.app.mode.isEditor()){const t={displayImage:!!a,displayTitle:null===n||!!n,displaySubtitle:!!o},i=[{value:"",name:"Any site"}];this.api.v1.site.getSites().forEach(e=>{i.push({value:e.id,name:e.display_name,selected:s&&e.id===parseInt(s,10)})}),t.site_ids=i,e.setFiltered("options",t)}if(i){const t=[];i.result.forEach(e=>{const i={url:e.published_url};n&&(i.title=e.teaserTitle||e.title),o&&(i.subtitle=e.teaserSubtitle||e.subtitle),a&&e.frontCropUrl&&(i.calendarimage=`${l}/${e.frontCropUrl}&${d.join("&")}`),t.push(i)}),e.setFiltered("data",t)}}}class C{constructor(e){this.api=e,this.ignoredTags=this.api.v1.config.get("page_settings.article.ignoredTags")||[],this.ignoredTagPrefix=this.api.v1.config.get("page_settings.article.ignoredTagPrefix")||[],this.adminIgnoredTags=this.api.v1.config.get("showHiddenTagsOnArticle")?[]:(this.api.v1.config.get("tagsToHide")||"").split(",").map(e=>e.trim())}onRender(e,t){const i=[...new Set([...this.ignoredTags,...this.adminIgnoredTags])],s=(this.api.v1.model.query.getRootModel().get("tags")||[]).filter(e=>!i.includes(e)).filter(e=>{for(const t of this.ignoredTagPrefix)if(e.startsWith(t))return!1;return!0});e.setFiltered("tags",s),e.setFiltered("tagPagePath",this.api.v1.config.get("tagPagePath")||"/tag/")}}class D{constructor(e){this.api=e}onInserted(e){e.get("metadata.hidecaption")&&(e.set("fields.displayCaption",!1,{save:!1}),e.set("metadata.hidecaption",null,{save:!1}))}onRender(e,t){const i=k.textElements(t,this.api.v1.app.mode.isEditor());if(e.setFiltered("layout",i),e.setFiltered("hasFloatingText",i.floating.length>0),this.api.v1.app.mode.isFront()){const t=e.get("fields.kicker");e.setFiltered("hideKicker",!t||t.includes("Click to add kicker"))}if(e.get("metadata.sectionLabelHasLink")){const t=this.api.v1.config.get("tagPagePath")||"/tag/",i=`${this.api.v1.site.getSite().domain}${t}${this.api.v1.model.query.getRootModel().get("primaryTags.section")}`;e.setFiltered("sectionLink",i)}const s=e.get("metadata.sectionPlacement")||"overImage";e.setFiltered("sectionPlacement.underImage","underImage"===s)}async onChildAdded(e,t){"image"===t.getType()&&this.api.v1.article.frontcrop.get().then(e=>{if(e)return;const i=t.get("instance_of");i?this.setFrontCrop(i):this.api.v1.model.bindings.bind(t,"instance_of",(e,t,i)=>{this.setFrontCrop(i)})}).catch(e=>{Sys.logger.warn(`[ArticleHeader] Failed to get front-crop: "${e.toString()}"`)})}setFrontCrop(e){const t={type:"image",contentdata:{instance_of:e,fields:{croph:100,cropw:100,x:0,y:0}}};this.api.v1.article.frontcrop.set({pano:t,height:t}).then(()=>{Sys.logger.debug("[ArticleHeader] Front-crop successfully set.")}).catch(e=>{Sys.logger.warn(`[ArticleHeader] Failed to set front-crop: "${e.toString()}"`)})}}class x{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor()}onRender(e,t){const i=t.getAbsoluteGridWidths(),s=e.get("fields.columnsDesktop")||this.getFallbackColumns(i.desktop||12),a=e.get("fields.columnsMobile")||1;if(e.setFiltered("columns",{desktop:s,mobile:a}),!this.isEditor)return;const n=e.get("fields.layout"),o=[{value:"default",label:"Horizontal",selected:"default"===n},{value:"vertical",label:"Vertical",selected:"vertical"===n}],l=e.get("fields.imageLayout"),r=[{value:"full",label:"100% width",selected:"full"===l},{value:"left",label:"Align Left",selected:"left"===l},{value:"right",label:"Align Right",selected:"right"===l}];e.setFiltered("layoutOptions",o),e.setFiltered("imageLayoutOptions",r)}getFallbackColumns(e){return e>=10?4:e>=7?3:e>=5?2:1}}class ${constructor(e){this.api=e}onRender(e,t){const i=lab_api.v1.config.get("contentLanguage")||"no",s={publishedLabel:"Publisert",unpublishedLabel:"(upublisert) Opprettet",modifiedLabel:"Sist oppdatert",readTimeLabel:"Lesetid",unifiedLabel:"",languageCode:i,niceDates:!1,dateFormat:"l d. F Y - H:i",dateFormatPrependZero:!0,timeFormatPrependZero:!0,template:"{{dddd}} {{DD}}. {{MMMM}} {{YYYY}} - {{HH}}:{{mm}}",useOldFormat:!1};"en"===i&&(s.publishedLabel="Published",s.unpublishedLabel="(unpublished) Created",s.modifiedLabel="Last updated",s.readTimeLabel="Read time",s.languageCode="en");const a=this.api.v1.config.get("contentbox_settings.articleMeta.date");if(a){for(const e in a)e&&void 0!==s[e]&&(s[e]=a[e]);"dateFormat"in a&&!("template"in a)&&(s.useOldFormat=!0)}const n=this.api.v1.locale.get("dates.dateTime",{noRender:!0,fallbackValue:null});n&&(s.template=n);const o=new m(s.languageCode);let l=s.publishedLabel,r=e.get("fields.published");const d=e.get("fields.modified")>=r?e.get("fields.modified"):null;e.setFiltered("unpublished",!1),r||(l=s.unpublishedLabel,e.setFiltered("unpublished",!0),r=e.get("fields.created"));let g=this.api.v1.config.get("contentbox_settings.articleMeta.hideModifiedDate");g||(g=e.get("fields.hidePublishedDate"));const c=e.get("fields.hidePublishedDate"),p=new Date(1e3*r),u=d?new Date(1e3*d):null,h={isoDate:p.toISOString(),label:l,timestamp:r,hide:c,formatted:""},f={isoDate:u?u.toISOString():"",label:s.modifiedLabel,timestamp:d,hide:g,formatted:""},y={hide:!0};(this.api.v1.config.get("contentbox_settings.articleMeta.displayUnifiedDate")||this.api.v1.config.get("articleMetaSettings.displayUnifiedDate"))&&(y.hide=!1,y.isoDate=(u||p).toISOString(),y.timestamp=d||r,y.label=s.unifiedLabel,y.formatted="",h.hide=!0,f.hide=!0),s.niceDates?(h.hide||(h.formatted=o.timestampToNiceDate(o.toTimestamp(p))),u&&!f.hide&&(f.formatted=o.timestampToNiceDate(o.toTimestamp(u))),y.hide||(y.formatted=o.timestampToNiceDate(o.toTimestamp(u||p)))):s.useOldFormat?(h.hide||(h.formatted=o.formattedUtcDate(p,s.dateFormat,s.dateFormatPrependZero,s.timeFormatPrependZero)),u&&!f.hide&&(f.formatted=o.formattedUtcDate(u,s.dateFormat,s.dateFormatPrependZero,s.timeFormatPrependZero)),y.hide||(y.formatted=o.formattedUtcDate(u||p,s.dateFormat,s.dateFormatPrependZero,s.timeFormatPrependZero))):(h.hide||(h.formatted=o.utcFormat(p,s.template)),u&&!f.hide&&(f.formatted=o.utcFormat(u,s.template)),y.hide||(y.formatted=o.utcFormat(u||p,s.template))),e.setFiltered("date",{published:h,modified:f,unified:y});const b=e.get("fields.readTime")||.5,{readTimeLabel:v}=s;e.setFiltered("readTime",b<1?"< 1 min":`${b} min`),e.setFiltered("readTimeLabel",v)}onInserted(e){}}class M{constructor(e){this.api=e,this.rootModel=this.api.v1.model.query.getRootModel(),this.isEditor=this.api.v1.app.mode.isEditor(),this.boundIds={},this.config=this.api.v1.config.get("contentbox_settings.articlesByTag")||{niceDates:!0,dateFormat:"{{ HH }}:{{ mm }} - {{ DD }}.{{ MM }}.{{ YYYY }}"},this.preferredImageFormat=lab_api.v1.image.getPreferredImageFormat()}onViewHelper(e,t){const i={image:!1,kicker:!1,title:!0,subtitle:!0,published:!1,counter:!1},s=[],a=e.get("fields.displayOptions_json")||{};for(const e of Object.keys(i))void 0!==a[e]&&(i[e]=!!a[e]);const n=e.get("fields.query_json")||{},o=void 0===n.site_id?this.api.v1.site.getSite().id:n.site_id,l=lab_api.v1.config.get("contentbox_settings.articlesByTag.imageAspectRatio")||lab_api.v1.config.get("image.defaultAspectRatio"),r=["width=200",`height=${Math.floor(200*l)}`];this.preferredImageFormat&&"jpg"!==this.preferredImageFormat&&r.push(`format=${this.preferredImageFormat}`),e.setFiltered("site_id",o),e.setFiltered("displayOptions",i),e.setFiltered("imageServer",this.api.v1.properties.get("image_server")),e.setFiltered("imgArgs",r.join("&")),e.setFiltered("orderBy","published"),e.setFiltered("tagPagePath",lab_api.v1.config.get("tagPagePath")||"/tag/"),e.setFiltered("limit",n.limit||10);const d=(e,t,i)=>{const s=[];Array.isArray(t)&&t.forEach(e=>{let t=e;t=t.replace(/([\(\)\s+])/g,"\\$1"),t=t.toLowerCase(),s.push(t)});const a=this.rootModel.get("id");let n;if(e.get("fields.useApiQuery")&&e.get("fields.apiQuery")){const t=e.get("fields.apiQuery").replace(/\b(AND|OR|NOT)\b/g,"__$1__").toLowerCase().replace(/__and__/g,"AND").replace(/__or__/g,"OR").replace(/__not__/g,"NOT");n=t.length?`(${t}) AND published:[* TO NOW] AND NOT id:${a}`:`published:[* TO NOW] AND NOT id:${a}`,n=n.replace(/""+/g,'"')}else n=s.length?`(tag:"${s.join('" OR tag:"')}") AND published:[* TO NOW] AND NOT id:${a}`:`published:[* TO NOW] AND NOT id:${a}`,n=n.replace(/""+/g,'"');"edit"===i&&(e.set("fields.query",n,{save:!1}),e.setFiltered("query",encodeURIComponent(n)),e.set("fields.selectedTags_json",t,{save:!1})),"published"===i&&(e.setFiltered("query",encodeURIComponent(n)),e.set("fields.selectedTags_json",t,{save:!1}))};if(!this.isEditor){e.setFiltered("lazyloadImages",lab_api.v1.config.get("imageLoading.lazy")||!1);const t=this.rootModel.get("primaryTags.section");let i=[];i=(this.rootModel.get("tags")||[]).filter(e=>e!==t),e.get("fields.usePageTags")?d(e,i,"published"):e.get("fields.useApiQuery")&&e.get("fields.apiQuery")?d(e,"","published"):e.setFiltered("query",encodeURIComponent(e.get("fields.query")))}if(this.isEditor){for(const e of Object.keys(i))s.push({name:e,value:i[e]});const t=[{value:"",name:"Any site"}];this.api.v1.site.getSites().forEach(e=>{t.push({value:e.id,name:e.display_name,selected:e.id==o})}),e.setFiltered("siteOptions",t),e.setFiltered("editDisplayOptions",s);const a=()=>{if(e.get("fields.useApiQuery"))d(e,"","edit");else{let t=[];if(e.get("fields.usePageTags")){const e=this.rootModel.get("primaryTags.section");t=(this.rootModel.get("tags")||[]).filter(t=>t!==e)}else(e.get("fields.tagsString")||"").split(",").forEach(e=>{const i=e.trim();i&&t.push(i)});d(e,t,"edit")}},n=()=>{e.set("fields.usePageTags",!1),a()},l=e.getGuid();this.boundIds[l]||(this.boundIds[l]=!0,this.api.v1.model.bindings.bind(this.rootModel,"tags",a),this.api.v1.model.bindings.bind(e,"fields.usePageTags",a),this.api.v1.model.bindings.bind(e,"fields.usePageTags",a),this.api.v1.model.bindings.bind(e,"fields.tagsString",n)),a()}}onRender(e,t){const i=t.get("fields.placeholder");e.setFiltered("placeholder",i||this.api.v1.locale.get("emptyState.noContentText",{noRender:!0}));const s=this.api.v1.config.get("lang")||"no",a=new l(s),n=t.get("external"),o=[];n&&n.result&&n.result.forEach(e=>{if("article"===e.type){const t=e.published||null,i=new Date(t);o.push({kicker:e.kicker,title:e.title,subtitle:e.subtitle,published_url:e.published_url,frontCropUrl:e.frontCropUrl,published:t,formatted:t&&this.config.niceDates?a.timestampToNiceDate(a.toTimestamp(i)):a.format(i,this.config.dateFormat)})}}),e.setFiltered("templateData",o)}onSettingsPanel(e,t,i){return{onDisplay:e=>{const t=e.markup.querySelector(".advancedToggle"),i=e.markup.querySelector(".advanced");t&&i&&t.addEventListener("click",e=>{const s=i.classList.contains("lab-hidden");i.classList.toggle("lab-hidden"),s?(t.classList.remove("labicon-pluss_slim"),t.classList.add("labicon-minus_slim")):(t.classList.remove("labicon-minus_slim"),t.classList.add("labicon-pluss_slim"))},!1)}}}}class A{constructor(e){this.api=e,this.front_api_url=this.api.v1.properties.get("front_api_url"),this.integration_url=this.api.v1.properties.get("integration_url"),this.config=this.api.v1.config.get("contentbox_settings.articlescroller")||{sources:{all:{src:`${this.front_api_url}/api/v1/article/?orderBy=published&query=visibility_status:P%20AND%20published:[*%20NOW]%20AND%20showonfp:1&site_id={{ data.site_id }}&limit={{ data.articleCount }}`,data_type:"labrador",is_default:!0}},imageAspectRatio:.5,visibleArticleCount:4,visibleArticleCountMobile:1},this.preferredImageFormat=lab_api.v1.image.getPreferredImageFormat(),this.isEditor=this.api.v1.app.mode.isEditor(),this.sourceList=this.getSourceList(),this.domain=this.api.v1.site.getSite().domain||this.api.v1.properties.get("customer_front_url")}onViewHelper(e){const t=e.get("fields.source")||this.getDefaultSource(this.sourceList),i=e.get("fields.site_id"),s=e.get("fields.articleCount")||10;let a=this.sourceList[t]&&this.sourceList[t].src?this.sourceList[t]:null;const n=e.get("fields.customSource");if(n&&(Sys.logger.debug("ArticleScroller: Will use custom source."),a=n),a&&a.src){let t=null;if(a.defaultsiteAlias){const e=this.api.v1.site.getSite(a.defaultsiteAlias);e&&(t=e.id)}const n=e.get("fields.dateLimitFrom"),o=e.get("fields.dateLimitTo"),r=(new l).formattedUtcDate(new Date,"Y-m-d");let d="";"today"===n&&(d=`calendar_start_date:[${r}T00:00:00Z%20TO%20*]%20AND%20`),"today"===o&&(d+=`calendar_end_date:[*%20TO%20${r}T23:59:59Z]%20AND%20`);const g={site_id:i||t,front_api_url:this.front_api_url,articleCount:s,dateQuery:d},c=Mustache.render(this.handleUrlVariables(a.src),{data:g});e.setFiltered("url",c)}else Sys.logger.warning(`ArticleScroller: Missing config for source "${t}". Cannot fetch data. Check config.`)}onRender(e,t){const i=e.get("fields.source")||this.getDefaultSource(this.sourceList),s={text:{content:"Pluss"},icon:{content:"fi-plus"},display:!0,...this.api.v1.config.get("paywall.label")};s.display&&e.setFiltered("paywallLabel",s);let a=e.get("fields.visibleArticleCount")||this.api.v1.config.get("contentbox_settings.articlescroller.visibleArticleCount")||4;const n=e.get("fields.visibleArticleCountMobile")||this.api.v1.config.get("contentbox_settings.articlescroller.visibleArticleCountMobile")||2,o=a,l=n,r=this.config.restrictHeight||!1,d=!!e.get("fields.hideImages"),g=!!e.get("fields.showAuthor"),c=!!e.get("fields.showPublishedDate"),p=!!e.get("fields.hideNavigation"),u=e.get("fields.transitionDuration")||4e3,h=(u/1e3/100*(e.get("fields.transitionStep")||15)).toFixed(2);"mobile"===t.viewport&&(a=n);let f=this.api.v1.view.getPixelDensityFactor();t.get("metadata.hasFullWidth")&&(f+=.2);const m={};m.aspectRatio=e.get("fields.aspectRatio")||this.api.v1.config.get("contentbox_settings.articlescroller.imageAspectRatio")||this.api.v1.config.get("image.defaultAspectRatio"),m.width=Math.ceil(this.api.v1.viewport.getWidth(t.viewport)/a),m.height=Math.floor(m.width*m.aspectRatio);const y=t.get("external"),b=e.get("fields.articleCount")||10,v=this.config.externalMappers||{},_=e.get("fields.customSource")||this.sourceList[i]||{};let k=this.mapExternalData(y,_.data_type,{aspectRatio:m.aspectRatio,imageServer:this.api.v1.properties.get("image_server"),width:Math.floor(m.width*f),height:Math.floor(m.height*f),baseUrl:_.baseUrl||"",hideImages:d,showAuthor:g,showPublishedDate:c},v);if(Array.isArray(k)&&k.length>0&&(k=k.slice(0,b)),a>k.length&&(a=k.length),a<1&&(a=1),e.setFiltered("useNavigation",!p&&k.length>a),e.setFiltered("visibleArticleCount",a),e.setFiltered("maxVisibleArticleCount",o),e.setFiltered("maxVisibleArticleCountMobile",l),e.setFiltered("restrictHeight",r),e.setFiltered("hideImages",d),e.setFiltered("showAuthor",g),e.setFiltered("showPublishedDate",c),e.setFiltered("transitionDuration",u),e.setFiltered("transitionStep",h),e.setFiltered("data",k),e.setFiltered("width",m.width),e.setFiltered("height",m.height),e.setFiltered("labels",this.config.labels||{buttonLeft:"Rull til venstre",buttonRight:"Rull til høyre"}),this.isEditor&&e.setFiltered("transitionDurationSeconds",u/1e3),this.isEditor){if(_.src){const t={},s=[];for(const e of Object.keys(this.sourceList))s.push({value:e,name:this.sourceList[e].display_name||e,selected:e===i});t.sources=s;const a=[{value:"",name:"Any site"}],n=parseInt(e.get("fields.site_id")||this.getSiteIdFromAlias(i),10);this.api.v1.site.getSites().forEach(e=>{a.push({value:e.id,name:e.display_name,selected:e.id===n})}),t.site_ids=a;const o=e.get("fields.dateLimitFrom"),l=e.get("fields.dateLimitTo");t.dateLimit={from:[{value:"today",name:"Today",selected:"today"===o}],to:[{value:"today",name:"Today",selected:"today"===l}]};const r=e.get("fields.layoutAlign");t.layout={align:[{value:"left",name:"Align Left",selected:"left"===r},{value:"centered",name:"Align centered",selected:"centered"===r},{value:"right",name:"Align right",selected:"right"===r}]};const d=this.api.v1.config.get("contentbox_settings.articlescroller.layout")||!1;d&&d.forEach(e=>{e&&void 0!==e.value&&(e.selected=e.value===r,e.value===r?e.selected=!0:e.selected=!1),t.layout.align.push(e)}),t.aspectRatio=m.aspectRatio,e.setFiltered("options",t)}}else e.setFiltered("lazyloadImages",this.api.v1.config.get("imageLoading.lazy")||!1)}onCreated(e){e.set("fields.skipLeadText",!0)}handleUrlVariables(e){return e.replace(/\{\{api\}\}/g,this.front_api_url).replace(/\{\{int\}\}/g,this.integration_url)}getSourceList(){const e={};for(const t of Object.keys(this.config.sources||{}))e[t]=this.config.sources[t];const t=this.api.v1.config.get("feeds")||{};for(const i of Object.keys(t))if("json"===t[i].format&&t[i].labrador_json){let s;try{s=new URL(t[i].url)}catch(e){s=null}const a=s?s.origin:this.domain;e[i]={src:t[i].url,data_type:(t[i].url||"").startsWith("{{api}}")?"labrador":"labrador_json",is_default:!1,baseUrl:a,display_name:t[i].display_name}}return e}getDefaultSource(e){for(const t of Object.keys(e))if(e[t].is_default)return t;const[t=null]=Object.keys(e)||[];return t}getSiteIdFromAlias(e){if(this.sourceList[e].defaultsiteAlias){const t=this.api.v1.site.getSite(this.sourceList[e].defaultsiteAlias);if(t)return t.id}return null}mapExternalData(e,t,i,s){switch(t){case"ntb":return this.mapNtb(e,i);case"advokatjobb":return this.mapAdvokatjobb(e,i);case"labrador_json":return this.mapLabradorJson(e,i);case"labrador_compliant":return this.mapLabradorCompliant(e,i);default:try{if(Object.keys(s).includes(t)){const a=s[t].split(".");let n=window;for(let e=0;e<a.length;e+=1)n=n[a[e]];let o=null;if(n&&(o=n(e,i),o))return o}}catch(e){Sys.logger.warning("Faulty extraMapper function.")}return this.mapLabrador(e,i)}}mapNtb(e,t){const i=[];return e.releases?(e.releases.forEach(e=>{let s=!1,a=null;!t.hideImages&&e.images.length&&(s=e.images[0].thumbnail_16_9||!1),e.logos.length&&(a=e.logos[0].thumbnail_original||!1),t.hideImages||s||!e.logos.length||(s=e.logos[0].thumbnail_16_9||!1);const n={url:`https://www.ntbinfo.no${e.url}`,title:e.title,subtitle:e.leadtext,image:s,iconImage:a};i.push(n)}),i):i}mapAdvokatjobb(e,t){const i=[];return e.Jobs?(e.Jobs.forEach(e=>{let s=!1,a="";e.Company&&(!t.hideImages&&e.Company.Logo&&(s=t.baseUrl+e.Company.Logo),e.Company.Name&&(a=`${e.Company.Name} - `));const n={url:t.baseUrl+e.Url,title:a+e.Title,subtitle:`${e.Location} - ${e.DueDate}`,image:s,iconImage:null};i.push(n)}),i):i}mapLabradorJson(e,t){const i=[];if(!e||!e.result)return i;const s=[`width=${t.width}`,`height=${t.height}`],a=this.api.v1.locale.get("dates.articleScrollerPublishedFormat",{noRender:!0}),n=this.api.v1.locale.get("dates.articleScrollerPublishedDatePrefix",{fallbackValue:""}),o=new l(this.api.v1.config.get("lang")||void 0);return e.result.forEach(e=>{const l=u.parseCustomDataFromFeed(e,"contentbox_settings.articlescroller"),r=o.format(new Date(e.published),a),d=n?`${n} ${r}`:r;let g="";e.url&&(g=0===e.url.indexOf("http")||0===e.url.indexOf("//")?e.url:t.baseUrl+e.url);const c={url:g,title:e.teaserTitle?e.teaserTitle:e.title,kicker:e.kicker||e.teaserKicker||"",subtitle:e.teaserSubtitle?e.teaserSubtitle:e.description,image:!(t.hideImages||!e.images||!e.images.length)&&`${e.images[0].url}${e.images[0].url.includes("?")?"&":"?"}${s.join("&")}`,autodata:l||"",section:e.section||"",paywall:!!e.paywall,author:e.byline||"",publishedDate:d};i.push(c)}),i}mapLabrador(e,t){const i=[];if(!e||!e.result)return i;const s=[`width=${t.width}`,`height=${t.height}`];this.preferredImageFormat&&"jpg"!==this.preferredImageFormat&&s.push(`format=${this.preferredImageFormat}`);const a=this.api.v1.locale.get("dates.articleScrollerPublishedFormat",{noRender:!0}),n=this.api.v1.locale.get("dates.articleScrollerPublishedDatePrefix",{fallbackValue:""}),o=new l(this.api.v1.config.get("lang")||void 0);return e.result.forEach(e=>{const l=u.parseCustomDataFromFeed(e,"contentbox_settings.articlescroller"),r=o.format(new Date(e.published),a),d=n?`${n} ${r}`:r,g={url:e.siteDomain+e.published_url,title:e.title,kicker:e.kicker||e.teaserKicker||"",subtitle:e.subtitle,image:!(t.hideImages||!e.frontCropUrl)&&`${t.imageServer}/${e.frontCropUrl}&${s.join("&")}`,autodata:l||"",section:e.section||"",paywall:!!e.paywall,author:e.byline||"",publishedDate:d};i.push(g)}),i}mapLabradorCompliant(e,t){const i=[];if(!e||!e.result)return i;const s=[`width=${t.width}`,`height=${t.height}`];return e.result.forEach(e=>{let a=!1;!t.hideImages&&e.images&&Array.isArray(e.images)&&e.images.length>0&&(a=`${t.imageServer}/?imageUrl=${e.images[0].url}&${s.join("&")}`);const n={url:e.url,title:e.title,kicker:e.kicker||"",subtitle:e.subtitle,section:e.section||"",image:a,paywall:!!e.paywall,author:e.byline||""};i.push(n)}),i}}class E{static defaultLineIndex=3;static filterBodytext(e,t){let i=lab_api.v1.config.get("paywall.bodytext.lineCount");null!==i&&!1!==i||(i=this.defaultLineIndex);const s=e.get("filtered.lineData");let{bodytext:a}=s;const n=s.indexRegister.reverse();return n.length<=i&&(i=n.length-1),n[i]&&(a=a.substring(0,n[i].charIndex)),a}static iterasPaywall(e,t){const i={id:e.id,offersTitle:e.offersTitle,alreadySubscribedText:e.alreadySubscribedText,alreadySubscribedLink:e.alreadySubscribedLink,offers:e.offers,offerButtonLink:e.offerButtonLink,offerButtonText:e.offerButtonText,offersSalesText:e.offersSalesText},s=e.extraPaywalls.find(e=>t.includes(e.triggerTag))||null;return s&&(i.id=s.id,i.offersTitle=s.offersTitle,i.alreadySubscribedText=s.alreadySubscribedText,i.alreadySubscribedLink=s.alreadySubscribedLink,i.offers=s.offers,i.offerButtonLink=s.offerButtonLink,i.offerButtonText=s.offerButtonText,i.offersSalesText=s.offersSalesText),i}}class I{constructor(e){this.api=e,this.isFront=this.api.v1.app.mode.isFront(),this.internal=this.api.v1.properties.get("paywall")||{};const t=this.api.v1.config.get("paywall")||{};this.provider=t.provider||"internal",this.displaySalesPosters=!1!==t.displaySalesPosters}onRender(e,t){const i=this.api.v1.config.get("newzware")||{},s=this.isFront&&"newzware"===this.provider&&!0===i.enabled,a={displaySalesPosters:this.displaySalesPosters,isInternal:"internal"===this.provider&&this.internal.active,active:this.isFront&&("internal"===this.provider?this.internal.active:!!Number(e.get("fields.paywall"))),access:!("internal"!==this.provider||!this.internal.active)&&this.internal.hasAccess,provider:this.provider,intro:"internal"!==this.provider?E.filterBodytext(e,t):void 0,bodytext:"internal"!==this.provider?e.get("filtered.bodytext"):void 0};if(!a.active||a.access||s||("internal"===this.provider?e.setFiltered("bodytext",E.filterBodytext(e,t)):e.setFiltered("bodytext","")),this.isFront&&"sesamy"===this.provider&&Number(e.get("fields.paywall"))){const t=this.api.v1.config.get("sesamy")||{};!0===this.internal.isProtected&&!0===t.enabled?e.setFiltered("bodytext",""):!1===t.enabled&&e.setFiltered("bodytext",e.get("fields.bodytext")),!0===this.internal.isProtected&&!1===this.internal.hasAccess&&!0===t.enabledProxyLock&&!0===t.enabled&&(a.bodytext="")}if("iteras"===this.provider&&a.active){const t=this.api.v1.config.get("iteras")||{},i=e.get("tags")||[];a.iteras=E.iterasPaywall(t,i)}e.setFiltered("paywall",a)}onRendered(e,t){if(!this.isFront){const i=t.getMarkup();if(i.children.length&&"P"!==i.children[i.children.length-1].tagName){const e=document.createElement("p");i.appendChild(e)}this.markCustomIndex(e.getPersistentChildren())}}markCustomIndex(e){for(const t of e){const e=t.getRaw("metadata.bodyTextIndex")||{};Object.values(e.vp||{}).filter(e=>Number.isInteger(e)).length>1&&this.markCustomIndexForModel(t)}}markCustomIndexForModel(e){for(const t of this.api.v1.viewport.getActive()){const i=this.api.v1.view.getView(e,t);if(!i.getExtraElement("customIndexElement")){const t=i.setExtraElement("customIndexElement",this.getCustomIndexElement(e,i));i.getMarkup().appendChild(t)}}}getCustomIndexElement(e,t){const i=document.createElement("span"),s=i=>{i&&(i.stopPropagation(),i.preventDefault()),this.removeCustomIndexElement(e),e.getParent()&&this.api.v1.model.addToRedrawQueue(e.getParent()),e.set("metadata.bodyTextIndex",void 0,{viewport:"mobile"}),this.api.v1.viewport.align(e,t)};i.addEventListener("click",s,!1),i.classList.add("labicon-line_index","is-customindex"),i.setAttribute("title",`${e.getType()} has custom placement. Click to remove on mobile`);const a=(t,n,o)=>{t.getParent()&&"bodytext"!==t.getParent().getType()&&(s(),i.remove(),this.api.v1.model.bindings.unbind(e,"path",a))};return this.api.v1.model.bindings.bind(e,"path",a),i}removeCustomIndexElement(e){for(const t of this.api.v1.view.getViews(e))t.unsetExtraElement("customIndexElement")}}class P{constructor(e){this.api=e,this.domain=this.api.v1.site.getSite().domain||this.api.v1.properties.get("customer_front_url"),this.authorPagesConfig=this.api.v1.config.get("authorPages")||{}}onId(e){const t=lab_api.v1.user.getField("favouriteBylineIds")||[],i=e.get("instance_of");i&&!t.includes(i)&&(t.unshift(i),lab_api.v1.user.setField("favouriteBylineIds",t.slice(0,5)))}onReady(e,t){const i=this.api.v1.model.query.getChildOfType(e,"image");i&&i.get("fields.width")&&i.set("fields.width",null,{save:!1,undoable:!1})}onRender(e,t){const i=this.api.v1.app.mode.isEditor(),s=this.api.v1.config.get("contentbox_settings.byline")||{},a=s.template||[],n={public_email:t.get("fields.public_email"),public_url:t.get("fields.public_url"),email:t.get("fields.email"),public_phone:t.get("fields.public_phone"),firstname:t.get("fields.firstname"),lastname:t.get("fields.lastname"),description:t.get("fields.description"),description2:t.get("fields.description2"),slug:t.get("fields.slug")};i||(n.firstname&&n.firstname.match(/^byline first name$/i)&&(n.firstname=""),n.lastname&&n.lastname.match(/^byline last name$/i)&&(n.lastname=""));const o={items:[],imageAbove:!!s.imageAbove,imageBelow:!s.imageAbove&&!!s.imageBelow};a.forEach(t=>{const a={url:null,parts:[]};if((t.keys||[]).forEach(e=>{if(n[e]&&n[e]!==`Click to edit ${e}`||i){let t,i=n[e];"description"===e&&s.enableDescriptionLength&&n[e]&&n[e].length>=s.descriptionLength&&(t=n[e],i=`${n[e].substring(0,s.descriptionLength)}...`),a.parts.push({key:e,value:i,title:t})}}),t.url){Array.isArray(t.url)||(t.url=[t.url]);for(let e of Object.keys(t.url))if(e=t.url[e],n[e]){let t=n[e];"public_email"===e&&(t=`mailto:${t}`),a.url=t;break}this.shouldUseAuthorPageUrl(n,e)&&(a.url=this.authorPageUrl(e))}a.parts.length&&o.items.push(a)}),e.setFiltered("default_color",s.default_color||""),e.setFiltered("data",o)}shouldUseAuthorPageUrl(e,t){if(this.authorPagesConfig.enabled&&(e.public_email||e.email)&&t.get("instance_of")){if(this.authorPagesConfig.enableForAll)return!0;if(this.authorPagesConfig.enabledAuthorIds&&this.authorPagesConfig.enabledAuthorIds.split(",").map(e=>parseInt(e.trim(),10)).includes(t.get("instance_of")))return!0}return!1}authorPageUrl(e){const t=e.get("instance_of"),i=e.get("instance_of_json")?JSON.parse(e.get("instance_of_json")):void 0,s=i&&i.fields.slug?i.fields.slug:void 0;return`${this.domain}/${this.authorPagesConfig.path||"author"}/${s||t||""}`}}class O{constructor(e){this.api=e,this.rootModel=this.api.v1.model.query.getRootModel(),this.isEditor=this.api.v1.app.mode.isEditor()}onReady(e,t){if(!this.isEditor){const t=this.rootModel.get("fields.author_json"),i=this.api.v1.model.query.getChildrenOfType(e,"image");if(t&&t.children.image){const s=t.children.image[0];let a=s.instance_of;if(!a&&s.imageurl){const[,e]=s.imageurl.match(/imageId=(\d+)/)||[];e&&(a=e)}if(i&&i.length>0){const t=i[0];t.set("instance_of",a),e.setFiltered("author_image",!0);const s=this.api.v1.view.getView(t);s&&(s.set("fields.croph",0),s.set("fields.cropw",0),s.set("fields.x",0),s.set("fields.y",0))}}else e.setFiltered("author_image",!1)}}onRender(e,t){const i=this.rootModel.get("fields.author_json"),s=t=>this.isEditor?"firstname"===t?e.get("fields.origin_data_json.full_name")||e.get("fields.full_name")||"":"lastname"===t?"":e.get(`fields.origin_data_json.${t}`)||e.get(`fields.${t}`)||"":i&&i.fields&&i.fields[t]?i.fields[t]:"",a=s("firstname"),n=s("lastname"),o=[a,n].filter(Boolean).join(" "),l=s("description"),r=s("description2"),d=s("public_phone"),g=s("public_url"),c=s("public_email"),p=e.get("fields.origin_data_json.hideDisplayName")||e.get("fields.hideDisplayName")||!1,u=e.get("fields.origin_data_json.hideDescription")||e.get("fields.hideDescription")||!1,h=e.get("fields.origin_data_json.hideExtendedDescription")||e.get("fields.hideExtendedDescription")||!1,f=e.get("fields.origin_data_json.hidePublicPhone")||e.get("fields.hidePublicPhone")||!1,m=e.get("fields.origin_data_json.hidePublicUrl")||e.get("fields.hidePublicUrl")||!1,y=e.get("fields.origin_data_json.hidePublicEmail")||e.get("fields.hidePublicEmail")||!1;this.isEditor&&e.setFiltered("author_image",!0),e.setFiltered("full_name",o),e.setFiltered("firstname",a),e.setFiltered("lastname",n),e.setFiltered("description",l),e.setFiltered("description2",r),e.setFiltered("public_phone",d),e.setFiltered("public_url",g),e.setFiltered("public_email",c),e.setFiltered("hideDisplayName",p),e.setFiltered("hideDescription",u),e.setFiltered("hideExtendedDescription",h),e.setFiltered("hidePublicPhone",f),e.setFiltered("hidePublicUrl",m),e.setFiltered("hidePublicEmail",y);const b=this.api.v1.model.query.getChildrenOfType(e,"image");if(b&&b.length>0){const e=b[0],t=this.api.v1.view.getView(e);t&&(t.set("fields.croph",0),t.set("fields.cropw",0),t.set("fields.x",0),t.set("fields.y",0))}const v={layout:[]};for(const e of["vertical","horizontal"])v.layout.push({name:e.charAt(0).toUpperCase()+e.slice(1),value:e,selected:e===t.get("fields.desktop_layout")||!t.get("fields.desktop_layout")&&"vertical"===e});const _={layout:[]};for(const e of["vertical","horizontal"])_.layout.push({name:e.charAt(0).toUpperCase()+e.slice(1),value:e,selected:e===t.get("fields.mobile_layout")||!t.get("fields.mobile_layout")&&"vertical"===e});e.setFiltered("adminDesktopView",v),e.setFiltered("adminMobileView",_);const k=t.get("fields.desktop_layout")||"vertical",w=t.get("fields.mobile_layout")||"vertical";e.setFiltered("desktop_layout",k),e.setFiltered("mobile_layout",w)}onSettingsPanel(){return{onSubmit:({view:e,formValues:t})=>{for(const i of Object.keys(t)){let s=t[i];i.startsWith("fields.hide")&&(s=!s),e.set(i,s)}}}}}class j{constructor(e){this.api=e,this.rootModel=this.api.v1.model.query.getRootModel(),this.boundModels=[]}onReady(e,t){this.api.v1.app.mode.isEditor()&&"desktop"===t.getViewport()&&!this.boundModels.includes(e)&&(this.api.v1.model.bindings.bind(this.rootModel,"fields.lab_changelog_json",()=>{this.api.v1.model.redraw(e)}),this.boundModels.push(e))}onRender(e,t){const i=this.rootModel.get("filtered.contentLanguage"),s=this.rootModel.get("fields.lab_changelog_json");if(s&&s.length>0){let t;t="string"==typeof s?JSON.parse(s):[...s],e.setFiltered("changelogHasContent",!0);const a=[];t.forEach(e=>{const t={time:new Date(1e3*e.time).toLocaleDateString(i),changelog:this.convertNewLines(e.changelog)};a.push(t)}),e.setFiltered("changelog",a)}else e.setFiltered("changelogHasContent",!1),e.setFiltered("changelog",[])}convertNewLines(e){return`<p>${e=(e=e.replace(/\n\n/g,"</p><p>")).replace(/\n/g,"<br>")}</p>`}}class R{constructor(e){this.api=e,this.dateTimeHelper=new l(this.api.v1.config.get("lang")),this.sources={disqus_most_popular:{source:"disqus",url:`${lab_api.v1.properties.get("integration_url")}/feed/disqus/?site=${lab_api.v1.properties.get("site.alias")}&action=popular`,name:"Most commented articles",description:""},hyvor_most_popular:{source:"hyvor",url:`${lab_api.v1.properties.get("integration_url")}/feed/hyvor/?site=${lab_api.v1.properties.get("site.alias")}&action=popular`,name:"Most commented articles",description:""},hyvor_recent:{source:"hyvor",url:`${lab_api.v1.properties.get("integration_url")}/feed/hyvor/?site=${lab_api.v1.properties.get("site.alias")}&action=recent`,name:"Recent comments",description:""}}}getSourceConfig(e,t){const i=lab_api.v1.config.get("comments_provider")||{},s=Object.keys(i).shift();let a;a="hyvor"===s?"hyvor_most_popular":"disqus_most_popular";const n=e.get("fields.source")||a,o=e.get("fields.title"),l=e.get("fields.description"),r=Math.min(parseInt(e.get("fields.limit")||"5",10),30),d=(lab_api.v1.config.get("contentbox_settings.comments.sources")||[]).filter(e=>void 0!==this.sources[e.type]&&this.sources[e.type].source===s),g=lab_api.v1.app.mode.isEditor();if(!d.length)return Sys.logger.warning(`comments: Missing required config "contentbox_settings.comments.sources". Options (type): ${Object.keys(this.sources).join(", ")}`),g&&e.setFiltered("error","Missing required source(s)."),null;const c={...this.sources[n],...d.filter(e=>e.type===n).pop()};return c.url+=`&limit=${r}`,o&&(c.name=o),l&&(c.description=l),c}onViewHelper(e,t){const i=this.getSourceConfig(e,t);i&&e.setFiltered("url",i.url)}onRender(e,t){const i=this.getSourceConfig(e,t);if(!i)return;const s=lab_api.v1.app.mode.isEditor(),a=lab_api.v1.config.get("comments_provider")||{},n=Object.keys(a).shift(),o="hyvor"===n?"hyvor_most_popular":"disqus_most_popular",l=e.get("fields.source")||o,r=e.get("fields.maxCharLength"),d=Math.min(parseInt(e.get("fields.limit")||"5",10),30),g=t.get("external"),c=g&&"string"==typeof g;c?(e.setFiltered("error","Error fetching data"),Sys.logger.warn(`Comments: Error fetching data from url: ${i.url}`)):e.setFiltered("error",null);const p=e=>{const t=e||"";return r?`${t.substring(0,r)} ${t.length>r?"...":""}`:t};if(g&&!c){let t=g;if("disqus_most_popular"===i.type&&(t=g.response.map(e=>({link:e.link,title:p(e.title)}))),"hyvor_most_popular"===i.type&&(t=g.data.map(e=>({link:e.url,title:p(e.title)}))),"hyvor_recent"===i.type){const e=i.items||{},s=e.date||{};t=g.data.map(t=>t.page&&t.page.url?{link:`${t.page.url}?ht-comment-id=${t.id}`,title:(e.titlePrefix||"")+p(t.page.title),user:t.user?t.user.name:"",date:this.dateTimeHelper.format(new Date(1e3*t.created_at),s.template||"")}:{})}e.setFiltered("data",t)}for(const t of Object.keys(this.sources))e.setFiltered(`is_${t}`,t===l);if(e.setFiltered("url",i.url),e.setFiltered("source",i),!s)return;const u=(lab_api.v1.config.get("contentbox_settings.comments.sources")||[]).filter(e=>void 0!==this.sources[e.type]&&this.sources[e.type].source===n).map(e=>({name:e.type,selected:e.type===l}));e.setFiltered("sourceList",u),e.setFiltered("limit",d)}}class L{static run(e){const t=e.options||lab_api.v1.config.get(e.configPath)||{},i=lab_api.v1.util.object.merge({kicker:null,kicker_editable:!1,expandable:{mobile:!0,desktop:!0},collapsable:{mobile:!0,desktop:!0},collapsedState:{mobile:!0,desktop:!1},needJs:!1,style:"fade"},t),s=[`style-${i.style}`];for(const e in i.expandable)i.expandable[e]&&s.push(`expandable-${e}`);for(const e in i.collapsable)i.collapsable[e]&&s.push(`collapsable-${e}`);return i.needJs=s.length>0,i.cssString=s.join(" "),i}}class q{constructor(e){this.api=e}onRender(e,t){e.setFiltered("options",L.run({configPath:"contentbox_settings.factbox"})),e.setFiltered("noContent",lab_api.v1.app.mode.isFront()&&!e.get("fields.title")&&!e.get("fields.bodytext"))}}class N{constructor(e){this.api=e}onSettingsPanel(){function e(e,t){const i=lab_api.v1.model.query.getRootModel().getId();return lab_api.v1.ui.element.getPageSelector({value:t?parseInt(t,10):null,siteId:e?parseInt(e,10):0,attributes:[{name:"name",value:"pageId"},{name:"id",value:"frontrows_pageId"}],pages:lab_api.v1.pages.front.getAll().filter(e=>e.nodeid!==i)})}return{onDisplay:({model:t,view:i,config:s,markup:a})=>{const n=t.get("fields.fragment_json")||{},o={siteselector:a.querySelector('[data-element="siteselector"]'),pageselector:a.querySelector('[data-element="pageselector"]')},l=lab_api.v1.ui.element.getSiteSelector({value:n.siteId?parseInt(n.siteId,10):null,attributes:[{name:"name",value:"siteId"},{name:"id",value:"frontrows_siteId"}]});let r=e(n.siteId||l.value,n.pageId);o.siteselector.appendChild(l),o.pageselector.appendChild(r),l.addEventListener("change",t=>{r.remove(),r=e(l.value),o.pageselector.appendChild(r)},!1)},onSubmit:({model:e,view:t,settings:i,markup:s,formValues:a})=>{e.resetExternalResource(),e.set("fields.fragment_json",a)}}}}class H{constructor(e){this.api=e}onRender(e,t){const i=this.api.v1.config.get("contentbox_settings.frontContent")||{},s=this.api.v1.properties.get("integration_url"),a=this.api.v1.properties.get("front_api_url"),n=Object.values(this.api.v1.config.get("feeds")||{}).filter(e=>!!e.labrador_json).map(e=>({identifier:e.display_name,name:e.display_name,type:e.url.includes("lab_viewport=json")?"DachserJson":"LabradorApi",url:e.url.replace("{{int}}",s).replace("{{api}}",a)})),o=(i.sources||[]).concat(n),l=e.get("fields.source"),r={...o.filter(e=>e.identifier===l).shift()||{}},d=e.get("fields.organizer"),g=this.api.v1.app.mode.isEditor(),c=e.get("fields.overrideUrlByTagsCookie",!0),p=void 0===c?!!i.overrideUrlByTagsCookie:!!c,u=((e,t)=>{const i=(e.get("fields.tags_string")||"").split(",").map(e=>e.trim()).filter(e=>!!e);return i.length?i:t.map(e=>e.tag)})(e,i.tagsArray||[]),h=((e,t)=>{const i={};for(const e of t)i[e.tag]=e.description;return e.map(e=>({tag:e,description:i[e]||e}))})(u,i.tagsArray||[]),f=e.get("fields.articleCount")||24,m={columnCount:parseFloat(e.get("fields.layout_columnCount")||3),rowCount:parseFloat(e.get("fields.layout_rowCount")||10),maxRowSize:parseFloat(e.get("fields.layout_maxRowSize")||3),minRowSize:parseFloat(e.get("fields.layout_minRowSize")||1),imageAspectRatio:parseFloat(e.get("fields.layout_imageAspectRatio")||.45),gridsize:parseFloat(e.get("fields.layout_gridsize")||12),hide_items:[]};e.get("fields.hide_title")&&m.hide_items.push("title"),e.get("fields.hide_subtitle")&&m.hide_items.push("subtitle"),e.get("fields.hide_image")&&m.hide_items.push("image"),e.get("fields.hide_kicker")&&m.hide_items.push("kicker");const y=[];e.get("fields.filterExisting")&&y.push({path:"contentdata.id",values:this.api.v1.model.query.getModelsByType("article").filter(e=>!!e.get("instance_of")).map(e=>String(e.get("instance_of")))});let b=f;["RandomRows"].includes(d)||(b=m.columnCount*m.rowCount||f);const v=e.get("fields.articleFetchCount")||b;e.setFiltered("source",r),e.setFiltered("articleCount",b),e.setFiltered("articleFetchCount",v),e.setFiltered("articleFilterList",JSON.stringify(y)),e.setFiltered("isDebug",this.api.v1.util.request.hasQueryParam("debug")),e.setFiltered("isEditor",g),e.setFiltered("isConfigured",b&&d&&r.identifier&&r.url&&r.type),e.setFiltered("viewport",this.api.v1.viewport.getName()),e.setFiltered("imageServer",this.api.v1.properties.get("image_server")),e.setFiltered("layout",JSON.stringify(m)),e.setFiltered("cookieOptions",{allow:p,cookieName:i.cookieName||"dachserFrontContentTags",tagsArray:h,tagsArrayString:JSON.stringify(h)}),e.setFiltered("tagOptions",{allow:!!e.get("fields.tags_allow")&&"LabradorApi"===r.type,useOr:!!e.get("fields.tags_useOr"),tags:u,tags_string:u.join(", "),tagsString:JSON.stringify(u)});const _=[];e.get("fields.size_active")&&(e.get("fields.size_title")&&_.push({path:"contentdata.fields.title.attributes.text_size.value",value:parseInt(e.get("fields.size_title"),10)}),e.get("fields.size_subtitle")&&_.push({path:"contentdata.fields.subtitle.attributes.text_size.value",value:parseInt(e.get("fields.size_subtitle"),10)}),e.get("fields.size_kicker")&&_.push({path:"contentdata.fields.kicker.attributes.text_size.value",value:parseInt(e.get("fields.size_kicker"),10)})),e.setFiltered("styleString",JSON.stringify(_)),g&&(r.url&&"LPStream"!==r.type&&(r.url=`${this.api.v1.properties.get("proxy")}?query=${encodeURIComponent(r.url)}`,e.setFiltered("source",r)),e.setFiltered("sourcesConfig",o))}}class U{constructor(e){this.api=e}onViewHelper(e,t){const i=this.api.v1.site.getSite().id;e.setFiltered("siteID",i)}onRender(e,t){const i=this.api.v1.model.query.getRootModel().get("filtered.contentLanguage"),s=t.get("external"),a=[];s&&s.result&&s.result.forEach(e=>{if("article"===e.type){let t;const s=e.lab_changelog_json||null;if("string"==typeof s){const e=this.stripJSON(s);e&&this.isValidJSON(e)&&(t=JSON.parse(e))}else t=s;t&&t.forEach(e=>{const t=new Date(1e3*e.time);e.time=t.toLocaleDateString(i),e.changelog=this.convertNewLines(e.changelog)}),a.push({title:e.title,published_url:e.published_url,changelog:t})}}),e.setFiltered("templateData",a)}stripJSON(e){return e.replace(/\\n/g,"\\n").replace(/\\'/g,"'").replace(/\\"/g,'"').replace(/\\&/g,"&").replace(/\\r/g,"\r").replace(/\\t/g,"\t").replace(/\\b/g,"\b").replace(/\\f/g,"\f")}isValidJSON(e){try{JSON.parse(e)}catch(e){return!1}return!0}convertNewLines(e){return`<p>${e=(e=e.replace(/\\n\\n/g,"</p><p>")).replace(/\\n/g,"<br>")}</p>`}}class z{constructor(e){this.api=e}onRender(e,t){const i=this.api.v1.model.query.getRootModel(),s=this.api.v1.config.get("contentbox_settings.googleAd.formats")||[],a=e.get("fields.format"),n=this.api.v1.config.get("adEnvironment")||{},o={bidding:n.bidding,hideOnTabletWidth:n.hideOnTabletWidth||1316,fetchMarginPercent:n.fetchMarginPercent||150,renderMarginPercent:n.renderMarginPercent||150};e.setFiltered("googleAds",o);const l=((e,t)=>{for(let i=0;i<t.length;i++)if(t[i].format===e)return{...t[i]};return{}})(a,s);if(l.key=e.get("metadata.key")||"row",o.bidding&&o.bidding.enabled&&o.bidding.provider&&o.bidding.provider.name&&"livewrapped"===o.bidding.provider.name){const e=()=>{const e=()=>(65536*(1+Math.random())||0).toString(16).substring(1);return`${e()+e()}-${e()}-${e()}-${e()}-${e()}${e()}${e()}`};l.code&&l.code.endsWith("-1")&&(l.code+=`_${e()}`)}"mpu_top"===l.code&&(l.isMpuTop=!0),e.setFiltered("adData",l),e.setFiltered("isDebug",this.api.v1.util.request.hasQueryParam("debug")||e.get("metadata.isDebug"));const r=this.api.v1.config.get("contentbox_settings.googleAd.label")||"Annonse",d=e.get("fields.label")||r;if(e.setFiltered("label",d),!this.api.v1.app.mode.isEditor()){const t=e.parent&&!0===e.parent.get("metadata.hideOnTablet")&&"tablet"===this.api.v1.properties.get("xUaDevice");e.setFiltered("hideOnTablet",t)}if(this.api.v1.app.mode.isEditor()){const t=i.get("type").replace("page_",""),a=[];s.forEach(e=>{(e.selectable&&e.selectable.indexOf(t)>-1||e.selectableOn&&!0===e.selectableOn[t])&&a.push(e)}),e.setFiltered("formatConfigKeys",a)}if((e.get("metadata.css")||"").includes("sticky")){const t=`top: ${this.api.v1.config.get("contentbox_settings.googleAd.spacingTop")||120}px;`;e.setFiltered("spacingTop",t)}}}class B{constructor(e){this.api=e}onRender(e,t){e.setFiltered("cse_id",e.get("fields.cse_id")||this.api.v1.config.get("contentbox_settings.googleCSE.cse_id"))}}class V{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor(),this.isFragmentMode=this.api.v1.app.mode.isFragmentMode(),this.lazyloadImages=!this.isEditor&&!!this.api.v1.config.get("imageLoading.lazy")}check(e,t){if(!this.lazyloadImages||t.getProperty("image.noLazy"))return!1;const i=lab_api.v1.model.query.getParentOfType(e,"row");return!(i&&!this.isFragmentMode&&i.getModelIndex()<5)}}class W{constructor(e){this.api=e,this.lazyloadHelper=new V(e),this.api.v1.app.mode.isEditor()&&(this.cropIds=[],this.rootModel=this.api.v1.model.query.getRootModel(),this.frontcropBinding=this.frontCropChanged.bind(this),this.api.v1.model.bindings.bind(this.rootModel,"frontCrop",this.frontcropBinding),this.frontcropBinding(this.rootModel,"frontCrop",this.rootModel.get("frontCrop")),this.api.v1.ns.set("imageFilter.preview",this.prepareVisualFilters)),this.isFragmentMode=this.api.v1.app.mode.isFragmentMode(),this.isEditorMode=this.api.v1.app.mode.isEditor(),this.boundModels=[]}onInserted(e,t){this.isEditorMode&&e.get("instance_of")&&(this.boundModels.includes(e)||(this.api.v1.model.bindings.bind(e,"fields.imageCaption",this.imageUpdater.bind(this)),this.api.v1.model.bindings.bind(e,"fields.byline",this.imageUpdater.bind(this)),this.boundModels.push(e)))}imageUpdater(e,t,i){if(!i)return;const s=e.get("instance_of");if(!s)return;const a=t.includes("imageCaption"),n=t.includes("byline");this.api.v1.util.httpClient.get(`/ajax/node/get-node?id=${s}`,{resetCache:!0}).then(t=>{const o=t.data,l=o&&o.fields&&o.fields.caption||"",r=o&&o.fields&&o.fields.byline||"",d=a&&!l,g=n&&!r;if(!d&&!g)return;const c=o&&o.fields&&o.fields.extra_metadata_json&&o.fields.extra_metadata_json.currentLanguage||this.api.v1.config.get("contentLanguage")||"en",p=JSON.parse(JSON.stringify(o&&o.fields&&o.fields.extra_metadata_json||{})),u={};if(p.aiMetadata||(p.aiMetadata={}),p.aiMetadata[c]||(p.aiMetadata[c]={}),d){const t=e.get("fields.extra_metadata_json.currentLanguage")||"",s=!t||t===c;!(p.aiMetadata&&p.aiMetadata[c]&&p.aiMetadata[c].caption)&&s&&(u.caption=i,p.aiMetadata[c].caption=i,u.extra_metadata_json=p)}if(g&&(u.byline=i),0===Object.keys(u).length)return;const h={type:"image",id:s,fields:u},f=new FormData;f.append("json[id]",s),f.append("json[type]","image"),f.append("json[structure]",null),f.append("json[node]",JSON.stringify([h])),this.api.v1.util.httpClient.request("/ajax/node/save-node-and-data",{body:f,method:"POST"}).then(()=>{Sys.logger.debug("[Image] Synced caption/byline to backend:",s)}).catch(e=>{Sys.logger.error("[Image] Error syncing to backend:",e)})}).catch(e=>{Sys.logger.error("[Image] Error fetching backend node:",e)})}onViewHelper(e,t){if(e.parent){this.prepareForSlideshow(e,t);const i=t.getViewport();if(this.api.v1.view.getView(e.parent,i).get("metadata.hasFullWidth")){const t="mobile"===i?600:1800;e.setFiltered(`width.${i}`,t)}else e.setFiltered(`width.${i}`,null);e.setFiltered("allowFullwidth","image"!==e.parent.getType())}}onRender(e,t){this.setVisualFilters(e,t),e.setFiltered("lazyloadImages",this.lazyloadHelper.check(e,t)),this.setCaptionOptions(e.getParent(),e,t);const i=t.get("fields.float");e.setFiltered("hasFloat",!!i&&"floatNone"!==i)}onRendered(e,t){if(!this.api.v1.app.mode.isEditor()||!this.cropIds.length)return;const i=parseInt(e.get("instance_of"),10);this.cropIds.includes(i)&&this.markFrontCrop(t,i)}setVisualFilters(e,t){e.setFiltered("filters",this.prepareVisualFilters(e,t))}prepareVisualFilters(e,t,i=!1){const s=[],a=e.get("metadata.filter_blur_active")?e.get("metadata.filter_blur_value")||0:null,n=e.get("metadata.filter_sepia_active")?e.get("metadata.filter_sepia_value")||0:null,o=e.get("metadata.filter_saturate_active")?e.get("metadata.filter_saturate_value")||1:null,l=e.get("metadata.filter_brightness_active")?e.get("metadata.filter_brightness_value")||1:null,r=e.get("metadata.filter_contrast_active")?e.get("metadata.filter_contrast_value")||1:null;return null!==a&&s.push(`blur(${a}px)`),null!==n&&s.push(`sepia(${n})`),null!==o&&s.push(`saturate(${o})`),null!==l&&s.push(`brightness(${l})`),null!==r&&s.push(`contrast(${r})`),i?{filter:s.join(" ")}:s.length?`filter: ${s.join(" ")};`:null}markFrontCrop(e,t){const i=document.createElement("span");i.classList.add("labicon-imgFrontCrop","is-frontcrop"),i.setAttribute("title","Image used as front crop. Click to edit"),i.addEventListener("click",e=>{e.stopPropagation(),e.preventDefault(),this.api.v1.apps.start("ArticleSettings")},!1),e.getMarkup().appendChild(i)}frontCropChanged(e,t,i){let s=this.getImages(this.cropIds);this.cropIds=[],this.updateImages(s),i&&(i.pano&&i.pano.instance_of&&this.cropIds.push(i.pano.instance_of),i.height&&i.height.instance_of&&!this.cropIds.includes(i.height.instance_of)&&this.cropIds.push(i.height.instance_of),s=this.getImages(this.cropIds),this.updateImages(s))}getImages(e){const t=[];for(const i of e)t.push(...this.api.v1.model.query.getModelsByKeyAndValue("instance_of",i));return t}updateImages(e){for(const t of e)this.api.v1.model.addToRedrawQueue(t)}setCaptionOptions(e,t,i){const s=e?this.api.v1.view.getView(e,i.getViewport()):null,a=(e,t,i)=>{if(e){const t=e.get(i);if(!t&&null!==t)return!1;if(t)return!0}return!!t.get(i)};let n=a(s,i,"fields.displayCaption"),o=n||null===i.get("fields.displayCaption")&&!i.get("metadata.hidecaption");!this.api.v1.app.mode.isFront()||t.get("fields.imageCaption")||t.get("fields.byline")||(n=!1,o=!1);const l=a(s,i,"fields.expandableCaption"),r=a(s,i,"fields.truncateCaption");let d=t.get("fields.imageCaption");!t.parent||i.getProperty("image.useCaptionForTitle")&&d||(d=t.parent.get("fields.title")||"");const g={title:d,display:n,displayDefault:o,truncate:r,expandable:l||r};t.setFiltered("captionOptions",g)}prepareForSlideshow(e,t){if(!e.parent||"slideshow"!==e.parent.getType())return;if(t.get("fields.whRatio"))return void e.setFiltered("whRatio",null);const i=e.get("fields.originalWidth"),s=e.get("fields.originalHeight");if(s&&i){const t=s/i;e.setFiltered("whRatio",t)}}}class J{constructor(e){this.api=e,this.lazyloadHelper=new V(e)}onRender(e,t){e.setFiltered("lazyloadImages",this.lazyloadHelper.check(e,t))}}class Y{constructor(e){this.api=e}onRender(e,t){["submitLabel","navLabel","nohitsLabel","searchPlaceholder","advancedOpenText","advancedCloseText","fromDateLabel","toDateLabel","tagLabel","authorLabel","allSitesLabel"].forEach(i=>{const s=this.api.v1.locale.get(`search.labradorSearch.${i}`,{noRender:!0,fallbackValue:null});e.setFiltered(i,t.get(`fields.${i}`)||s)});const i=lab_api.v1.properties.get("sites"),s=[],a=e.get("fields.allowedSites_json")||{},n=[];if(i.forEach(e=>{const t={alias:e.alias,id:e.id,displayName:e.display_name,selected:!1};s.push(t),a[e.alias]===`${e.id}`&&(t.selected=!0,n.push(t))}),0===n.length){const e=lab_api.v1.properties.get("site");s.forEach(t=>{t.id===e.id&&(t.selected=!0,n.push(t))})}const o=t.get("fields.orderBy")||"published",l=[{value:"published",label:"Published"},{value:"score",label:"Score"}];l.forEach(e=>{o&&o===e.value&&(e.selected=!0)});const r=parseInt(e.get("fields.desktopWidth")||100,10);e.setFiltered("desktopWidth",[100,50,33,25].map(e=>({key:e,value:e,selected:e===r}))),e.setFiltered("desktopWidth",[{key:"100% - 1 column",value:100,selected:100===r},{key:"50% - 2 columns",value:50,selected:50===r},{key:"33% - 3 columns",value:33,selected:33===r},{key:"25% - 4 columns",value:25,selected:25===r}]),e.setFiltered("sites",s),e.setFiltered("allowedSites",n),e.setFiltered("allowedSitesString",JSON.stringify(n||[])),e.setFiltered("orderByOptions",l)}}class G{static mediaQueries={desktop:"(min-width:1024px)",mobile:"(max-width: 1023px)"};static createStyle(e,t,i,s=this.mediaQueries){const a=[];for(const n of i){const i=s[n]?e.get(t,n):null;i&&a.push(`@media ${s[n]} { ${i.selector} { transform: translate(${i.x}px, ${i.y}px); } }`)}return`<style>${a.join("\n")}</style>`}}class K{validate(e=""){return new Promise((t,i)=>{try{const i=document.createElement("template");i.innerHTML=e.trim(),t(i.innerHTML.trim())}catch(e){i(e)}})}createElements(e){return[...document.createRange().createContextualFragment(e).children]}}class Q{constructor(e){this.api=e,this.validation={suggestedMarkup:null,isUnvalid:!1,error:""}}onRender(e,t){if(t.get("metadata.movableContent")&&e.setFiltered("movableStyle",G.createStyle(e,"metadata.contentPosition",["desktop","mobile"])),!this.api.v1.app.mode.isEditor()&&!0===this.api.v1.config.get("cookieConsent.enabled")){e.setFiltered("requiredCookieConsent",t.get("metadata.requiredCookieConsent")||!1);let i=t.get("fields.markup")||"";i=i.replace(/<\/script>/g,"<\\/script>"),e.setFiltered("markup_escaped",i)}}onSettingsPanel(e,t,i){return{onDisplay:i=>{const s=i.markup.querySelector("textarea");if(!s)return;const a=i.markup.querySelector('input[name="doValidate"]');if(a&&(a.addEventListener("change",t=>{e.set("fields.skipValidation",!t.target.checked||null)},!1),a.checked=!e.get("fields.skipValidation")),s.value=t.get("fields.markup"),this.validation.suggestedMarkup){s.value=this.validation.suggestedMarkup;const e=document.createElement("p");this.validation.isUnvalid?e.innerHTML=`<span style="color: red;">Markup is invalid. Please correct the markup and try again.</span><br>${this.validation.error}`:e.innerHTML="Validator has modified markup. Please review the suggested markup below.",s.before(e),this.validation.suggestedMarkup=null,this.validation.isUnvalid=!1,this.validation.error=""}i.markup.querySelector("textarea").focus(),s.addEventListener("keydown",e=>{if("Tab"===e.key){e.preventDefault();const[t,i]=[s.selectionStart,s.selectionEnd];s.setRangeText("    ",t,i,"end")}},!1)},onSubmit:({model:e,view:t,config:i,markup:s,modal:a,formValues:n})=>{n.doValidate?(new K).validate(n["fields.markup"]).then(s=>{if(n["fields.markup"].trim()!==s){this.validation.suggestedMarkup=s,this.validation.isUnvalid=!1;const a={...i};return a.defaultButtons=!1,a.container.state.warning=!0,void this.api.v1.ui.modal.panel(e,t,a)}t.set("fields.markup",s)}).catch(s=>{this.validation.suggestedMarkup=n["fields.markup"],this.validation.isUnvalid=!0,this.validation.error=s.message;const a={...i};a.defaultButtons=!1,a.container.state.error=!0,this.api.v1.ui.modal.panel(e,t,a)}):t.set("fields.markup",n["fields.markup"])}}}}class Z{constructor(e,t){this.api=e,this.rootModel=e.v1.model.query.getRootModel()}onViewHelper(e,t){const i=this.api.v1.site.getSite();e.setFiltered("siteId",i.id),e.setFiltered("testId",e.get("fields.testId"));const s={0:"Score + pros/cons",1:"Score + pros/cons + specs",2:"Score + specs",3:"Pros/cons + specs",4:"Score",5:"Pros/cons",6:"Specs"},a=e.get("fields.layoutOption")||"0",n={score:"0"===a||"1"===a||"2"===a||"4"===a,prosCons:"0"===a||"1"===a||"3"===a||"5"===a,specs:"1"===a||"2"===a||"3"===a||"6"===a};e.setFiltered("visible",n),e.setFiltered("isDebug",this.api.v1.util.request.hasQueryParam("debug"));const o=[];for(const e of Object.keys(s))o.push({key:e,value:s[e],selected:e===a});if(e.setFiltered("layoutOptions",o),e.setFiltered("apiEndpoint",s[a]),e.setFiltered("topScore","on"===e.get("fields.topScore")),e.setFiltered("recommended","on"===e.get("fields.recommended")),e.setFiltered("titleWithGrade","on"===e.get("fields.titleWithGrade")),e.setFiltered("titleWithFacts","on"===e.get("fields.titleWithFacts")),this.api.v1.app.mode.isEditor()){const t=[];let i=e.get("fields.score")||"0";i=parseInt(i,10);for(let e=1;e<11;e++)t.push({value:e,selected:i===e?"selected":""});e.setFiltered("scoreOptions",t)}}onRender(e,t){const i=t.get("external");if(!i)return;e.setFiltered("productName",i.namn?i.namn:""),e.setFiltered("pros",i.plus?i.plus:[]),e.setFiltered("cons",i.minus?i.minus:[]),e.setFiltered("structuredData",i.struktureradData?JSON.stringify(i.struktureradData):"");const s=[];i.betyg&&i.betyg.length&&i.betyg.forEach(e=>{let t=!1,i=!1,a=!1;e.v&&(t=e.v,parseInt(e.v,10)<11?a=`${e.v}0`:(a=e.v,i=!0)),s.push({key:e.n,score:t,scoreIsPercent:i,percent:a})}),e.setFiltered("score",s),e.setFiltered("recommended","Ja"===i.braköp||"on"===e.get("fields.recommended")),e.setFiltered("topScore","Ja"===i.toppbetyg||"on"===e.get("fields.topScore")),e.setFiltered("specifications",i.spec?i.spec:[])}onSettingsPanel(e){return this.model=e,{onDisplay:e=>{this.api.v1.apps.start("TextEdit").then(t=>{this.setupRichTextEditing(t,e.markup,this.model)}).catch(e=>{console.log(`Error loading TextEdit-app: ${e}`)})}}}setupRichTextEditing(e,t,i){for(const s of t.querySelectorAll("div.lab-input-text"))if(s&&s instanceof HTMLElement){const a=s.getAttribute("data-input-key")||"no-key";this.setupRichTextEditingForElement(e,t,s,a,i)}}setupRichTextEditingForElement(e,t,i,s,a){const n={};lab_api.v1.util.object.set(s,a.get(s),n),e.register({element:i,simulatedData:{type:"article",path:"",contentdata:n},toolSettings:{key:s,inlineOnly:!0,displayCharCount:!1,displaySelectionLength:!1,displayWordCount:!1,selectTextOnStart:!1,placeholder:"",attributes:{text_size:{active:!1}}},callbacks:{ended:(e,t)=>{this.model.set(e,t)}},menuSettings:{container:t,items:{bold:{group:"g2",icon:"labicon-text_bold",callback:"toggleAttribute",key:"font_weight",attributes:{class:"font-weight-bold"},value:!1,onValue:"font-weight-bold",offValue:!1,bindToSelection:"font_weight",title:"Font weight - Bold",hotkeys:[{key:"B",controlkeys:["labCtrlKey"],preventDefault:!0,overrideDisable:!0}]},italic:{group:"g2",icon:"labicon-text_italic",callback:"toggleAttribute",key:"italic",attributes:{class:"italic"},value:!1,onValue:"italic",offValue:!1,bindToSelection:"italic",title:"Italic",hotkeys:[{key:"i",controlkeys:["labCtrlKey"],preventDefault:!0,overrideDisable:!0}]},reset:{group:"g4",icon:"labicon-reset_style",callback:"reset",title:"Remove textformatting in selection for viewport"}}}})}}class X{constructor(e){this.api=e}onViewHelper(e,t){const i=this.api.v1.site.getSite();e.setFiltered("siteId",i.id),e.setFiltered("testId",e.get("fields.testId"));const s={summerTire:"tiresummertests",winterTire:"tirewintertests",food:"foodtests",hotel:"hoteltests",vehicle:"vehicletests"},a=e.get("fields.testType")||"vehicle",n="horizontal"===e.get("fields.displayDirection")?"horizontal":"vertical";e.setFiltered("displayDirection",n),e.setFiltered("displayDirectionOptions",[{value:"horizontal",selected:"horizontal"===n},{value:"vertical",selected:"vertical"===n}]),e.setFiltered("needSlider","horizontal"===n),e.setFiltered("isDebug",this.api.v1.util.request.hasQueryParam("debug"));const o=[];for(const e of Object.keys(s))o.push({value:e,selected:e===a});e.setFiltered("typeOptions",o),e.setFiltered("apiEndpoint",s[a])}onRender(e,t){const i=t.get("external");if(!i)return;const s=e.get("fields.testType")||"vehicle",a={vehicle:{comfort:"Komfort",design:"Design",driveability:"Kjøreegenskaper",environment:"Miljø og forbruk",equipment:"Utstyr",practicality:"Praktisk",price:"Pris",runningCosts:"Driftskostnader",security:"Sikkerhet",value:"Annenhåndsverdi"},food:{firstImpression:"Førsteinntrykk",menu:"Meny",taste:"Smak",price:"Pris",service:"Service",familyFriendly:"Barnevennlig",homemade:"Hjemmelaget",drinks:"Drikke",cleaning:"Renhold",lavatories:"Toaletter"},hotel:{location:"Beliggenhet",rooms:"Rom",standard:"Standard",beds:"Senger",breakfast:"Frokost",bathroom:"Bad",commonAreas:"Fellesområder",cleaning:"Renhold",value:"Valuta for pengene"},summerTire:{asphalt:"Tørr asfalt",asphaltWet:"Våt asfalt",grip:"Grep",breaking:"Bremselengde",driveability:"Kjøreegenskaper",aquaplaning:"Vannplaning",aquaplaningSwing:"Vannplaning sving",comfort:"Komfort",fuelConsumption:"Forbruk",noise:"Støy",other:"Annet"},winterTire:{snow:"Snø",ice:"Is",asphalt:"Tørr asfalt",asphaltWet:"Våt asfalt",breaking:"Bremselengde",driveability:"Kjøreegenskaper",aquaplaning:"Vannplaning",aquaplaningSwing:"Vannplaning sving",comfort:"Komfort",fuelConsumption:"Forbruk",noise:"Støy",grip:"Grep",acceleration:"Akselerasjon",other:"Annet",spikes:"Pigger",count:"Antall",spikeLengthBefore:"Piggutstikk etter innkjøring (mm)",spikeLengthAfter:"Piggutstikk etter snø/istest (mm)",weightKg:"Vekt",installationDescription:"Montering"}},n=[];if(s.indexOf("Tire")>0){const e=new l(this.api.v1.config.get("lang")),t=new Date(i.production.date),o=Number.isNaN(t.getTime())?i.production.date:e.formattedDate(t,"d/m Y");let r="";"winterTire"===s&&(r=`<span class="test-key-value"><span class="test-key">Pigger:</span><span class="test-value">${i.spikes&&i.spikes.isSpikes?i.spikes.count:"nei"}</span></span>`),i.description&&"string"==typeof i.description&&(i.description=i.description.replace(/\n/g,"<br>")),n.push({title:"Fakta",description:`\n                    <span class="test-key-value"><span class="test-key">Produksjonsland:</span><span class="test-value">${i.production.country||""}</span></span>\n                    <span class="test-key-value"><span class="test-key">Produksjonsdato:</span><span class="test-value">${o||""}</span></span>\n                    ${r}\n                    <p>${i.description||""}</p>\n                `}),i.description="",i.loadSpeedRating&&i.loadSpeedRating.length&&(i.description+=`<span class="test-key-value"><span class="test-key">Last- og hastighetsindeks:</span><span class="test-value">${i.loadSpeedRating}</span></span>`),i.shore&&i.shore.length&&(i.description+=`<span class="test-key-value"><span class="test-key">Hardhetstall</span><span class="test-value">${i.shore}</span></span>`),i.installationDescription&&i.installationDescription.length&&(i.description+=`<span class="test-key-value"><span class="test-key">Montering:</span><span class="test-value">${i.installationDescription}</span></span>`),Object.keys(a[s]).forEach(e=>{if(i[e]&&"object"==typeof i[e]&&Array.isArray(Object.keys(i[e]))&&Object.keys(i[e]).length>0){if("spikes"===e&&!i.spikes.isSpikes)return;let t="";Object.keys(i[e]).forEach(n=>{i[e][n]>0&&a[s][n]&&(t+=`<span class="test-key-value"><span class="test-key">${a[s][n]}:</span><span class="test-value">${i[e][n]}</span></span> `)}),n.push({title:a[s][e],description:t})}})}else Object.keys(a[s]).forEach(e=>{if(i[e]){const t={title:a[s][e],score:i[e].score,description:i[e].description};n.push(t)}});e.setFiltered("testSubject",i.name?i.name:null),e.setFiltered("totalScore",i.score?i.score:null),e.setFiltered("introduction",i.description?i.description:null),e.setFiltered("mappedCategories",n)}}class ee{constructor(e){this.api=e,this.signupText=e.v1.locale.get("newsletter.generic.signup"),this.yourEmailText=e.v1.locale.get("newsletter.generic.yourEmail"),this.subscribeButton=e.v1.locale.get("newsletter.generic.subscribeButton"),this.hiddenValue=e.v1.locale.get("newsletter.generic.hiddenValue")}onRender(e,t){const i=this.api.v1.config.get("contentbox_settings.newsletter_submit")||{},s=e.get("fields.newsletterDataAction")||("MAILMOJO_LENKE"===i.action?"":i.action)||"",a=e.get("fields.newsletterDataTitle"),n=e.get("fields.newsletterDataDescription"),o=e.get("fields.newsletterButtonText")||this.subscribeButton,l=e.get("fields.newsletterPlaceholder")||this.yourEmailText,r={provider:i.provider?i.provider:"mailmojo",title:a||(i.title?i.title:this.signupText),description:n||i.description||"",action:s,buttonText:o,placeholder:l,elements:i.elements?i.elements:[{type:"hidden",name:"tagsadditional",value:this.hiddenValue,class:"",placeholder:""},{type:"email",name:"email",value:"",class:"",placeholder:l},{type:"submit",name:"submit",value:o,class:"bg-secondary",placeholder:""}]};this.api.v1.app.mode.isFront()&&!r.action?e.setFiltered("newsletter_data",null):e.setFiltered("newsletter_data",r)}}class te{constructor(e){this.api=e}onRender(e,t){const i=this.api.v1.config.get("grid.total_grid_spans"),s=[];let a=!1;if(e.getChildren().forEach((e,n)=>{const o=[],l=[],r=this.api.v1.view.getView(e,t.getViewport()),d=r.get("metadata.parallax")||{};["scale","rotate","opacity","blur","sepia","brightness"].forEach(e=>{const t=d[e]||{};t.active&&(a=!0,o.push(JSON.stringify({name:e.replace(".","_"),startValue:t.startValue||0,endValue:t.endValue||100,startScrollPosition:t.startScrollPosition||0,endScrollPosition:t.endScrollPosition||100})))}),["perspective"].forEach(e=>{const t=d[e]||{};t.active&&(a=!0,l.push(JSON.stringify({name:e,value:t.value||0})))});const g=[this.api.v1.style.getStyle(e,r,"background_color"),this.api.v1.style.getStyle(e,r,"background_opacity")];s.push({index:n,type:e.getType(),sticky:!!d.sticky,fullwidth:!!d.fullwidth,height:d.height||"100",spaceBelow:d.spaceBelow||"0",position:d.position,horizontalAlign:d.horizontalAlign,verticalAlign:d.verticalAlign||"top",verticalPosition:d.verticalPosition||"auto",css:g.join(" "),grid:{desktop:this.api.v1.grid.percentToGrid(r.get("width",!1,"desktop"),i),mobile:this.api.v1.grid.percentToGrid(r.get("width",!1,"mobile"),i)},selector:`[data-parallax-layer="${n}"]`,hasAnimations:o.length>0||l.length>0,animations:o,staticAttributes:l})}),e.setFiltered("layers",s),e.setFiltered("elementCount",e.children.length),e.setFiltered("requireJs",a),e.setFiltered("isDebug",this.api.v1.util.request.hasQueryParam("debug")),!this.api.v1.app.mode.isEditor())return;e.setFiltered("displayNoContent",0===s.length),e.setFiltered("useReflow",!0);const n=Object.keys(t.getProperty("droppable.drop.sourceType")||{});e.setFiltered("supportedContentTypes",n)}}class ie{constructor(e){this.api=e}onRender(e,t){function i(e,t,i,s,a,n){return l(function(e,t){return e<<t|e>>>32-t}(l(l(t,e),l(s,n)),a),i)}function s(e,t,s,a,n,o,l){return i(t&s|~t&a,e,t,n,o,l)}function a(e,t,s,a,n,o,l){return i(t&a|s&~a,e,t,n,o,l)}function n(e,t,s,a,n,o,l){return i(t^s^a,e,t,n,o,l)}function o(e,t,s,a,n,o,l){return i(s^(t|~a),e,t,n,o,l)}function l(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}"page_article"===this.api.v1.model.query.getRootModel().getType()&&(this.api.v1.app.mode.isFront()&&!e.get("fields.caption")?e.setFiltered("displayCaption",!1):e.setFiltered("displayCaption",!0));const r=e.get("fields.uvid");let d=new Date;var g,c;d.setHours(d.getHours()+4),d=Math.floor(d.getTime()/1e3),e.setFiltered("dataAttributes",{type:e.get("fields.videoType")||"vod",id:e.get("fields.idString")||"GB001",token:(g=`${r}${d}boqCnvdBXwZTAaa7tMvKkte3MqaufjIZ`,c=function(e){for(var t,i="0123456789ABCDEF",s="",a=0;a<e.length;a++)t=e.charCodeAt(a),s+=i.charAt(t>>>4&15)+i.charAt(15&t);return s}(function(e){for(var t="",i=0;i<32*e.length;i+=8)t+=String.fromCharCode(e[i>>5]>>>i%32&255);return t}(function(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var i=1732584193,r=-271733879,d=-1732584194,g=271733878,c=0;c<e.length;c+=16){var p=i,u=r,h=d,f=g;r=o(r=o(r=o(r=o(r=n(r=n(r=n(r=n(r=a(r=a(r=a(r=a(r=s(r=s(r=s(r=s(r,d=s(d,g=s(g,i=s(i,r,d,g,e[c+0],7,-680876936),r,d,e[c+1],12,-389564586),i,r,e[c+2],17,606105819),g,i,e[c+3],22,-1044525330),d=s(d,g=s(g,i=s(i,r,d,g,e[c+4],7,-176418897),r,d,e[c+5],12,1200080426),i,r,e[c+6],17,-1473231341),g,i,e[c+7],22,-45705983),d=s(d,g=s(g,i=s(i,r,d,g,e[c+8],7,1770035416),r,d,e[c+9],12,-1958414417),i,r,e[c+10],17,-42063),g,i,e[c+11],22,-1990404162),d=s(d,g=s(g,i=s(i,r,d,g,e[c+12],7,1804603682),r,d,e[c+13],12,-40341101),i,r,e[c+14],17,-1502002290),g,i,e[c+15],22,1236535329),d=a(d,g=a(g,i=a(i,r,d,g,e[c+1],5,-165796510),r,d,e[c+6],9,-1069501632),i,r,e[c+11],14,643717713),g,i,e[c+0],20,-373897302),d=a(d,g=a(g,i=a(i,r,d,g,e[c+5],5,-701558691),r,d,e[c+10],9,38016083),i,r,e[c+15],14,-660478335),g,i,e[c+4],20,-405537848),d=a(d,g=a(g,i=a(i,r,d,g,e[c+9],5,568446438),r,d,e[c+14],9,-1019803690),i,r,e[c+3],14,-187363961),g,i,e[c+8],20,1163531501),d=a(d,g=a(g,i=a(i,r,d,g,e[c+13],5,-1444681467),r,d,e[c+2],9,-51403784),i,r,e[c+7],14,1735328473),g,i,e[c+12],20,-1926607734),d=n(d,g=n(g,i=n(i,r,d,g,e[c+5],4,-378558),r,d,e[c+8],11,-2022574463),i,r,e[c+11],16,1839030562),g,i,e[c+14],23,-35309556),d=n(d,g=n(g,i=n(i,r,d,g,e[c+1],4,-1530992060),r,d,e[c+4],11,1272893353),i,r,e[c+7],16,-155497632),g,i,e[c+10],23,-1094730640),d=n(d,g=n(g,i=n(i,r,d,g,e[c+13],4,681279174),r,d,e[c+0],11,-358537222),i,r,e[c+3],16,-722521979),g,i,e[c+6],23,76029189),d=n(d,g=n(g,i=n(i,r,d,g,e[c+9],4,-640364487),r,d,e[c+12],11,-421815835),i,r,e[c+15],16,530742520),g,i,e[c+2],23,-995338651),d=o(d,g=o(g,i=o(i,r,d,g,e[c+0],6,-198630844),r,d,e[c+7],10,1126891415),i,r,e[c+14],15,-1416354905),g,i,e[c+5],21,-57434055),d=o(d,g=o(g,i=o(i,r,d,g,e[c+12],6,1700485571),r,d,e[c+3],10,-1894986606),i,r,e[c+10],15,-1051523),g,i,e[c+1],21,-2054922799),d=o(d,g=o(g,i=o(i,r,d,g,e[c+8],6,1873313359),r,d,e[c+15],10,-30611744),i,r,e[c+6],15,-1560198380),g,i,e[c+13],21,1309151649),d=o(d,g=o(g,i=o(i,r,d,g,e[c+4],6,-145523070),r,d,e[c+11],10,-1120210379),i,r,e[c+2],15,718787259),g,i,e[c+9],21,-343485551),i=l(i,p),r=l(r,u),d=l(d,h),g=l(g,f)}return Array(i,r,d,g)}(function(e){for(var t=Array(e.length>>2),i=0;i<t.length;i++)t[i]=0;for(i=0;i<8*e.length;i+=8)t[i>>5]|=(255&e.charCodeAt(i/8))<<i%32;return t}(g),8*g.length))),c.toLowerCase()),expire:d})}}class se{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor()}onRender(e,t){const i=t.get("fields.aspectRatio")||t.getProperty("image.defaultAspectRatio")||this.api.v1.config.get("image.defaultAspectRatio")||.5;e.setFiltered("aspectRatio",100*i);const s=[];let a=0;for(const i of e.getChildren())if("image"===i.getType()||"placeholder_ad"===i.getType()){const e=this.api.v1.view.getView(i,t.getViewport()).getMarkupString();s.push({isImage:"image"===i.getType(),url:i.get("filtered.imageCleanUrl"),markup:e,index:a}),"image"===i.getType()&&a++}e.setFiltered("imageList",s),e.setFiltered("hasText",this.isEditor||!(!e.get("fields.title")&&!e.get("fields.description")))}}class ae{static tsvStringToTable(e){return e.split("\n").map(e=>e.split("\t").map(e=>e.trim()))}static tableToTSVString(e){return e?e.map(e=>e.join("\t")).join("\n"):null}static getMaxRowLength(e){const t=e.map(e=>e.filter(e=>-1===e.indexOf("|*")).length);return Math.max.apply(null,t)}static newCell(e){const t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return e?{style:e,content:t}:{content:t}}static newRow(e,t){return e?{style:e,row:t}:{row:t}}static tableToTemplateBody(e){const t=ae.getMaxRowLength(e);return e.filter(e=>""!==e.join("").trim()).map(e=>{let i=e.map(e=>{if(e.indexOf("|")>-1){const t=e.split("|");return ae.newCell(t[0],t[1])}return ae.newCell(null,e)});const s="*"===i[i.length-1].content?i[i.length-1].style:null;for(s&&(i=i.slice(0,i.length-1));i.length<t;)i.push(ae.newCell());return ae.newRow(s,i)})}static templateTableBodyToHeader(e,t){if(!e)return null;const i=e.shift();if(t)for(let t=0;t<i.row.length;t++){const s=e.map(e=>e[t]).filter(e=>/^[0-9, ]+$/.test(e)).length,a=e.map(e=>e[t]).filter(e=>Date.parse(e)).length,n=e.length;i.row[t].sortBy=s===n?"number":a===n?"date":"string"}return i}}class ne{constructor(e){this.api=e}onRender(e,t){const i=e.get("fields.tabledata"),s=e.get("fields.tableheader"),a=e.get("fields.tableheadersort");if((null==i||0===i.length)&&this.api.v1.app.mode.isEditor())return void e.setFiltered("missingData","Missing Data");const n=ae.tsvStringToTable(i),o=ae.tableToTemplateBody(n);e.setFiltered("missingData",!1),e.setFiltered("tabledata",ae.tableToTSVString(n)),e.setFiltered("header",s?ae.templateTableBodyToHeader(o,a):null),e.setFiltered("table",o)}}class oe{constructor(e){this.api=e}onRender(e,t){const i=this.api.v1.config.get("contentbox_settings.tagboard")||{},s=this.api.v1.app.mode.isEditor(),a={tagGroup1_label:e.get("fields.tagGroup1_label")||"",tagGroup1_tags:e.get("fields.tagGroup1_tags")||"",tagGroup2_label:e.get("fields.tagGroup2_label")||"",tagGroup2_tags:e.get("fields.tagGroup2_tags")||"",tagGroup3_label:e.get("fields.tagGroup3_label")||"",tagGroup3_tags:e.get("fields.tagGroup3_tags")||""},n=((e={})=>{const t=[],i=(e="")=>e.split(",").map(e=>e.trim().toLowerCase()).filter(e=>!!e);for(let s=1;s<=3;s++)e[`tagGroup${s}_tags`]&&t.push({label:e[`tagGroup${s}_label`],tags:i(e[`tagGroup${s}_tags`])});return t})(a);n.length&&Array.isArray(n)||Sys.logger.warning('tagboard: Missing required config "contentbox_settings.tagboard.tagGroups" (array). End user will not be able to filter results.');let o=e.get("fields.tagsGroupsDefaultVisible");null===o&&(o=this.api.v1.config.get("contentbox_settings.tagboard.tagsOptions.tagsGroupsDefaultVisible"));let l=e.get("fields.hideHitsPerTag");null===l&&(l=this.api.v1.config.get("contentbox_settings.tagboard.tagsOptions.hideHitsPerTag"));let r=e.get("fields.tagGroupInRows");null===r&&(r=this.api.v1.config.get("contentbox_settings.tagboard.tagsOptions.tagGroupInRows"));let d=e.get("fields.overrideUrlByTagsCookie");null===d&&(d=this.api.v1.config.get("contentbox_settings.tagboard.cookieOptions.allow"));const g=n.map(e=>e.tags),c=[].concat(...g),p=this.api.v1.properties.get("integration_url"),u=this.api.v1.properties.get("front_api_url"),h=Object.values(this.api.v1.config.get("feeds")||{}).filter(e=>!!e.labrador_json).map(e=>({identifier:e.display_name,name:e.display_name,type:e.url.includes("lab_viewport=json")?"DachserJson":"LabradorApi",url:e.url.replace("{{int}}",p).replace("{{api}}",u)})),f=(i.sources||[]).concat(h),m=e.get("fields.source"),y={...f.filter(e=>e.identifier===m).shift()||{}},b=e.get("fields.organizer"),v={columnCount:parseFloat(e.get("fields.layout_columnCount")||3),rowCount:parseFloat(e.get("fields.layout_rowCount")||10),maxRowSize:parseFloat(e.get("fields.layout_maxRowSize")||3),minRowSize:parseFloat(e.get("fields.layout_minRowSize")||1),imageAspectRatio:parseFloat(e.get("fields.layout_imageAspectRatio")||.45),gridsize:parseFloat(e.get("fields.layout_gridsize")||12),hide_items:[]};e.get("fields.hide_title")&&v.hide_items.push("title"),e.get("fields.hide_subtitle")&&v.hide_items.push("subtitle"),e.get("fields.hide_image")&&v.hide_items.push("image"),e.get("fields.hide_kicker")&&v.hide_items.push("kicker");const _=e.get("fields.articleCount")||24;let k=_;["RandomRows"].includes(b)||(k=v.columnCount*v.rowCount||_);const w=e.get("fields.articleFetchCount")||k,S=[];e.get("fields.filterExisting")&&S.push({path:"contentdata.id",values:this.api.v1.model.query.getModelsByType("article").filter(e=>!!e.get("instance_of")).map(e=>String(e.get("instance_of")))}),e.setFiltered("articleCount",k),e.setFiltered("articleFetchCount",w),e.setFiltered("articleFilterList",JSON.stringify(S)),e.setFiltered("tagArrayGroups",JSON.stringify(g)),e.setFiltered("tagGroups",n),e.setFiltered("tagGroupsObject",a),e.setFiltered("tagsGroupsDefaultVisible",o),e.setFiltered("hideHitsPerTag",l),e.setFiltered("tagGroupInRows",r),e.setFiltered("layout",JSON.stringify(v)),e.setFiltered("isConfigured",b&&y.identifier&&y.url&&y.type),e.setFiltered("source",y),e.setFiltered("isDebug",!0),e.setFiltered("siteId",e.get("fields.siteId")||""),e.setFiltered("viewport",this.api.v1.properties.get("device")),e.setFiltered("imageServer",this.api.v1.properties.get("image_server")),e.setFiltered("cookieOptions",{allow:d}),e.setFiltered("tagOptions",{allow:!0,tags:c,tags_string:c.join(", "),tagsString:JSON.stringify(c)});const F=[];e.get("fields.size_active")&&(e.get("fields.size_title")&&F.push({path:"contentdata.fields.title.attributes.text_size.value",value:parseInt(e.get("fields.size_title"),10)}),e.get("fields.size_subtitle")&&F.push({path:"contentdata.fields.subtitle.attributes.text_size.value",value:parseInt(e.get("fields.size_subtitle"),10)}),e.get("fields.size_kicker")&&F.push({path:"contentdata.fields.kicker.attributes.text_size.value",value:parseInt(e.get("fields.size_kicker"),10)})),e.setFiltered("styleString",JSON.stringify(F)),e.setFiltered("imageWidth",e.get("fields.imageWidth")||100),s&&e.setFiltered("sourcesConfig",f)}}class le{constructor(e){this.api=e}onRender(e,t){const i="center"===t.get("metadata.text_align");e.setFiltered("textCentered",i)}}class re{constructor(e){this.api=e}onRender(e,t){const i={tips:{cssClass:"tips_version",title:"Tips og innlegg",text:"Vi synes det er viktig med dine meninger",buttons:{tips:"Tips oss",debate:"Send innlegg"}},debate:{cssClass:"debate_version",title:"Har du noe på hjertet?",text:"Send oss et debattinnlegg, en kronikk eller en meningsytring. Alle innlegg signeres med fullt navn og tittel.",buttons:{tips:null,debate:"Send innlegg"}}},s=this.api.v1.config.get("contact.email")||{},a={tips:e.get("fields.email_tips"),debate:e.get("fields.email_debate"),version:e.get("fields.version")};a.tips&&(s.tips=a.tips),a.debate&&(s.debate=a.debate),e.setFiltered("content","tips"===a.version?i.tips:i.debate),e.setFiltered("version_is_tips","tips"===a.version),e.setFiltered("emails",s)}}class de{constructor(e){this.api=e,this.boundModels=[]}onViewHelper(e,t){const i=this.getDomain(e);e.setFiltered("domain",i);const s=e.get("fields.limit")||5;e.setFiltered("limit",s);const a=e.get("fields.tabs");a&&"default"!==a?(e.setFiltered("multi","-multi"),e.setFiltered("splitOn",`&splitOn=${a}`)):(e.setFiltered("multi",""),e.setFiltered("splitOn",""));const n=(e.get("fields.tagsSelected")||"").split(",").map(e=>e.trim().toLowerCase()).map(e=>e.replace(/ /g,"%20")).filter(e=>e.length>0);n.length>0?e.setFiltered("tags",`&tags=${n.join(",")}`):e.setFiltered("tags","");const o={display:!0,displayInNewsletter:!0,...this.api.v1.config.get("paywall.label")},l=this.api.v1.config.get("paywall.label.text.content"),r=this.api.v1.config.get("paywall.label.icon.content"),d={text:{content:null==l?"Plus":l},icon:{content:null==r?"fi-plus":r}};Object.assign(o,d),e.setFiltered("paywallLabel",o)}getDomain(e){const t=[];if(this.api.v1.site.getSites().forEach(i=>{if(e.get(`fields.domains_${i.alias}`)){let e=i.domain.replace(/^https?:\/\//,"");if(i.domain.includes("labdevs")&&i.domain_aliases&&i.domain_aliases.length>0){const t=i.domain_aliases.split("\n");e=t.length>0?this.getCleanDomain(t[0]):this.getCleanDomain(i.domain_aliases)}t.push(e)}}),0===t.length){const e=lab_api.v1.site.getSite();if(e){let i=e.domain;e.domain.includes("labdevs")&&(i=this.handleLabdevsDomain(e,i)),i=this.getCleanDomain(i),t.push(i)}}return t}onRender(e,t){const i=t.get("fields.placeholder");e.setFiltered("placeholder",i||this.api.v1.locale.get("emptyState.noContentText",{noRender:!0}));const s=e.get("fields.tabs")||"default",a=this.getDomain(e);e.get("fields.imageWidth")||e.set("fields.imageWidth",100),e.get("fields.imageHeight")||e.set("fields.imageHeight",100),e.get("fields.limit")||e.set("fields.limit",5);const n=e.get("fields.limit");e.get("fields.displayKicker")||e.set("fields.displayKicker","hideKicker"),e.get("fields.displayPaywall")||e.set("fields.displayPaywall","hidePaywallLabel");const o=t.get("external"),l=o&&"object"==typeof o?o:this.getPlaceholderData(n),r=this.handleResults(e,l,s);e.setFiltered("result",r);const d={domains:[],layout:[],tabs:[],displayKicker:[],displayPaywall:[]},g=[];let c;this.api.v1.site.getSites().forEach(t=>{if(!t.domain)return;let i=t.domain.replace(/^https?:\/\//,"");const s=!!e.get(`fields.domains_${t.alias}`),a=e.get("fields.tagsSelected")||"";for(let e of a.split(","))e=e.trim(),e&&e.length>0&&!g.includes(e)&&g.push(e);t.domain.includes("labdevs")&&(i=this.handleLabdevsDomain(t,i));const n={name:t.display_name,alias:t.alias,domain:i,selected:s,tags:g};d.domains.push(n)}),"tags"===s?c=g.map(e=>({displayName:e,domain:e})):"hostname"===s&&(c=a.map(e=>{const t=this.api.v1.site.getSites().find(t=>this.getCleanDomain(t.domain)===e||t.domain_aliases&&t.domain_aliases.includes(e));return{displayName:t?t.display_name:e,domain:e}}).filter(Boolean));const p=e.get("fields.tabsNames")?e.get("fields.tabsNames").split(","):[];if(c){const t=c.map((e,t)=>{const i=p[t]?p[t].trim():null;return{name:e.displayName,value:i||e.displayName,domain:e.domain}});e.setFiltered("tabData",t)}d.domains.some(e=>!0===e.selected)||d.domains.forEach(e=>{e.alias===this.api.v1.properties.get("site.alias")&&(e.selected=!0)});for(const e of["horizontal","vertical"])d.layout.push({name:e,value:e,selected:e===t.get("fields.layout")});for(const[e,i]of Object.entries({hideKicker:"Hide",aboveTitle:"Above title",rightOfTitle:"To the right"}))d.displayKicker.push({name:i,value:e,selected:e===t.get("fields.displayKicker")});for(const[e,i]of Object.entries({hidePaywallLabel:"Hide",rightOfTitle:"To the right",onImage:"On the image"}))d.displayPaywall.push({name:i,value:e,selected:e===t.get("fields.displayPaywall")});for(const[e,i]of Object.entries({default:"Single list (default)",hostname:"Tab for each site",tags:"Tab for each tag"}))d.tabs.push({name:i,value:e,selected:e===t.get("fields.tabs")});let u=e.get("fields.splitData")||[];if("string"==typeof u)try{u=JSON.parse(u)}catch(e){u=[]}d.splitData=u,d.splitDataJson=JSON.stringify(u),e.setFiltered("adminView",d)}handleResults(e,t,i){const s=[];if(!t||!t.data||0===Object.keys(t.data).length)return s;if(!e)return s;const a=!!e.get("fields.displayImages");e.setFiltered("displayImages",a);const n=!e.get("fields.hideDate"),o=new m;if("default"===i)try{t.data.forEach(t=>{const i=this.setOutputData(e,t,o,n,a);i&&s.push(i)})}catch(t){console.error("Error processing articles:",t),e.resetExternalResource()}else try{for(const i of Object.keys(t.data))t.data[i]&&t.data[i].length>0&&t.data[i].forEach(t=>{const l=this.setOutputData(e,t,o,n,a,i);l&&s.push(l)})}catch(t){console.error("Error processing articles:",t),e.resetExternalResource()}return s}setOutputData(e,t,i,s,a,n=null){const o=this.evaluateSiteAndSection(e,t),l=t.fields.published||null,r=o&&o.display_name&&o.display_name.length>0?o.display_name:null;return{name:r||t.fields.hostname||"",title:t.fields.title||"",kicker:t.fields.kicker,paywall:"1"===t.fields.paywall||1===t.fields.paywall,url:t.fields.published_url||t.fields.srcUrl,section:t.fields.section||"",tags:t.fields.tag||"",domain:t.fields.hostname||"",pageviews:t.fields.pageviews,published:l,niceDate:s&&l?i.timestampToNiceDate(i.toTimestamp(new Date(l))):"",cssClass:t.fields.cssClass||null,imageUrl:a?this.getImageUrl(e,t.fields.image):null,sourceDomain:t.fields.sourceDomain||t.fields.hostname,sourceDisplayName:t.fields.sourceDisplayName||r||t.fields.hostname,kilkayaKey:n||null}}getPlaceholderData(e){const t=[];for(let i=0;i<e;i++)t.push({fields:{cssClass:"dac-placeholder-text",type:"article"}});return{data:t}}getImageUrl(e,t){if(!t)return null;const i=e.get("fields.imageWidth")||100,s=e.get("fields.imageHeight")||100;let a=t.replace(/^https?:\/\//,"//");return a.includes("width=")&&a.includes("height=")?(a=a.replace(/width=\d+/,`width=${i}`),a=a.replace(/height=\d+/,`height=${s}`)):a+=`&width=${i}&height=${s}`,a}evaluateSiteAndSection(e,t){let i=this.api.v1.site.getSites().find(e=>this.getCleanDomain(e.domain)===t.fields.hostname);if(!i)for(const e of this.api.v1.site.getSites())if(e.domain_aliases&&e.domain_aliases.length>0&&e.domain_aliases.split("\n").map(e=>this.getCleanDomain(e.trim())).includes(t.fields.hostname)){i=e;break}if(!i&&t.fields.sourceDomain&&(i=this.api.v1.site.getSites().find(e=>this.getCleanDomain(e.domain)===t.fields.sourceDomain)),i){if(!e.get(`fields.domains_${i.alias}`))return!1;const s=e.get(`fields.domains_${i.alias}_sections`);if(!s||""===s)return i;const a=(s||"").split(",").map(e=>e.trim()).filter(Boolean);if(a&&a.length>0&&a.includes(t.fields.section))return i}return!1}getCleanDomain(e){return e?e.replace(/^https?:\/\//,""):""}handleLabdevsDomain(e,t){let i=t;if(e.domain_aliases&&e.domain_aliases.length>0){const t=e.domain_aliases.split("\n");t.length>0?i=this.getCleanDomain(t[0]):(i=e.domain_aliases,i=this.getCleanDomain(e.domain))}return i}}class ge{constructor(e){this.api=e}onRender(e,t){const i=t.get("external.tv");if(!i||!i.length)return;const s=i[0],a=new l(lab_api.v1.config.get("lang")),n=(e,t="d/m Y H:i")=>{const i=new Date(e);return a.formattedUtcDate(i,t)},o=e=>e.replace("00000+","00.000+"),r=e=>a.isSummerTime(e)?a.manipulateTime(e,1):e,d=e=>{const t=new Date(e);return`${t.getUTCFullYear()}${`0${t.getUTCMonth()+1}`.slice(-2)}${`0${t.getUTCDate()}`.slice(-2)}`},g=s.programme.filter(e=>{let t=new Date(o(e.start));return t=r(t),!(new Date(t.toUTCString().split(" ").slice(0,4).join(" "))<new Date((new Date).toUTCString().split(" ").slice(0,4).join(" ")))}).map(e=>{const t=r(new Date(o(e.start))).toUTCString();return{start:n(t,"H:i"),icon:e.icon[0].src,title:e.title[0]._,desc:e.desc[0]._,date:d(t)}}),c={};for(const e of g){if(!c[e.date]){const t=a.parseDate(e.date);c[e.date]={date:a.formattedDate(t,"d/m Y"),items:[]}}c[e.date].items.push(e)}e.setFiltered("tvguide",Object.values(c))}}class ce{constructor(e){this.api=e}onViewHelper(e,t){const i=e.get("fields.lang")||lab_api.v1.config.get("lang")||"no";e.setFiltered("lang",i)}}class pe{constructor(e){this.api=e}onRender(e,t){const i=this.api.v1.config.get("contact.email")||{},s=e.get("fields.email")||i.tips||"",a=e.get("fields.url")||"";e.setFiltered("email",s),e.setFiltered("url",a)}}class ue{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor()}onRender(e,t){let i="page_article"===this.api.v1.model.root.getType();if((this.api.v1.app.mode.isFront()&&!t.get("fields.caption")||e.getParent()&&!1===e.getParent().get("fields.displayCaption"))&&(i=!1),e.setFiltered("displayCaption",i),!this.api.v1.app.mode.isEditor()&&!0===this.api.v1.config.get("cookieConsent.enabled")){const t=this.api.v1.config.get("cookieConsent").contentboxes.filter(e=>"youtube"===e.name)[0];t&&(e.setFiltered("requiredCookieConsent",t.requiredConsent||!1),e.setFiltered("insufficientConsentMessage",t.insufficientConsentMessage||this.api.v1.config.get("cookieConsent.insufficientConsentMessage")||""))}const s=[],a=e.get("fields.video_start"),n=e.get("fields.video_end");a&&s.push(`start=${Math.round(a)}`),n&&s.push(`end=${Math.round(n)}`),s.length&&e.setFiltered("startstop",`?${s.join("&")}`)}onRendered(e,t){if(this.isEditor){const e=t.getMarkup().querySelector("iframe"),i=t.getMarkup().querySelector(".youtube-drag-handle");e&&i&&(i.addEventListener("mouseenter",t=>{e.style.pointerEvents="none"},!1),i.addEventListener("mouseleave",t=>{e.style.pointerEvents=""},!1))}}}class he{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor()}onRender(e,t){let i="page_article"===this.api.v1.model.root.getType();if(this.api.v1.app.mode.isFront()&&!t.get("fields.caption")&&(i=!1),e.setFiltered("displayCaption",i),!this.api.v1.app.mode.isEditor()&&!0===this.api.v1.config.get("cookieConsent.enabled")){const t=this.api.v1.config.get("cookieConsent").contentboxes.filter(e=>"jwplayer"===e.name)[0];t&&(e.setFiltered("requiredCookieConsent",t.requiredConsent||!1),e.setFiltered("insufficientConsentMessage",t.insufficientConsentMessage||this.api.v1.config.get("cookieConsent.insufficientConsentMessage")||""))}}onRendered(e,t){if(this.isEditor){const e=t.getMarkup().querySelector("iframe"),i=t.getMarkup().querySelector(".jwplayer-drag-handle");e&&i&&(i.addEventListener("mouseenter",t=>{e.style.pointerEvents="none"},!1),i.addEventListener("mouseleave",t=>{e.style.pointerEvents=""},!1))}}}class fe{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor()}onRender(e,t){let i="page_article"===this.api.v1.model.root.getType();if(this.api.v1.app.mode.isFront()&&!t.get("fields.caption")&&(i=!1),e.setFiltered("displayCaption",i),!this.api.v1.app.mode.isEditor()&&!0===this.api.v1.config.get("cookieConsent.enabled")){const t=this.api.v1.config.get("cookieConsent").contentboxes.filter(e=>"remoteproduction"===e.name)[0];t&&(e.setFiltered("requiredCookieConsent",t.requiredConsent||!1),e.setFiltered("insufficientConsentMessage",t.insufficientConsentMessage||this.api.v1.config.get("cookieConsent.insufficientConsentMessage")||""))}}onRendered(e,t){if(this.isEditor){const e=t.getMarkup().querySelector("iframe"),i=t.getMarkup().querySelector(".remoteproduction-drag-handle");e&&i&&(i.addEventListener("mouseenter",t=>{e.style.pointerEvents="none"},!1),i.addEventListener("mouseleave",t=>{e.style.pointerEvents=""},!1))}}}class me{constructor(e){this.api=e,this.domain=this.api.v1.site.getSite().domain||this.api.v1.properties.get("customer_front_url")}onViewHelper(e,t){e.setFiltered("domain",e.get("fields.domain")||this.domain.replace("https://",""))}onRender(e,t){const i=t.get("fields.placeholder");e.setFiltered("placeholder",i||this.api.v1.locale.get("emptyState.noContentText",{noRender:!0}));const s=t.get("external");if(!s)return;const a=new l(lab_api.v1.config.get("lang")),n=this.api.v1.config.get("contentbox_settings.topcomments.dateTemplate"),o=lab_api.v1.properties.get("image_server"),r=[],d=lab_api.v1.util.object.clone(s,!0);for(const e of d.mostRead||[]){const t=new Date(e.fields.published);e.fields.image&&(e.fields.image=e.fields.image.replace("http://","https://"),e.resizedImage=`${e.fields.image}&width=63&height=63`),e.fields.readableDate=a.utcFormat(t,n),r.push(e)}e.setFiltered("mostRead",r);const g=[];for(const e of d.latest||[]){const t=new Date(e.published);e.readableDate=a.utcFormat(t,n),e.extId?e.disqusId=e.extId.replace("khrono-","node/"):e.disqusId=e.id,e.frontCropUrl&&(e.resizedImage=`${o}/${e.frontCropUrl}&width=63&height=63`),g.push(e)}e.setFiltered("latest",g);let c=e.get("fields.selectedTab")||"latest";"mobile"===lab_api.v1.viewport.getName()&&e.get("fields.hideResultOnMobile")&&(c="");const p={};["mostRead","topComments","latest"].forEach(e=>{p[e]=e===c}),e.setFiltered("selectedTabs",p),e.setFiltered("isDebug",this.api.v1.util.request.hasQueryParam("debug"))}}class ye{constructor(e){this.api=e}onChildAdded(e,t){if("article"!==t.getType())return;const i=(e,t,i)=>{if(t)for(const s of Object.keys(t))s.includes("viewports_json")||(t[s]&&"object"==typeof t[s]?e.setRaw((i||"")+s,t[s]):e.set((i||"")+s,t[s]))};i(t,this.api.v1.config.get("contentbox_settings.scrollbox.dataForAddedChild.article.metadata"),"metadata."),i(t,this.api.v1.config.get("contentbox_settings.scrollbox.dataForAddedChild.article.contentdata")),t.children.length&&"image"===t.children[0].getType()&&i(t.children[0],this.api.v1.config.get("contentbox_settings.scrollbox.dataForAddedChild.article.children.image.contentdata"))}}class be{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor()}onInserted(e){if(!this.isEditor){const t=e.get("metadata.visibleAfterDate");if(t){const i=this.stringToDate(t);if(i){const s=(new Date).getTime();i.getTime()>s&&(Sys.logger.debug(`[Baseview] The path 'metadata.visibleAfterDate' ('${t}') has prevented the row '${e.getPositionedPath()}' from rendering`),this.api.v1.model.noRender(e))}}}}onChildAdded(e,t){this.updateFutureFlag(e)}onChildRemoved(e,t){this.updateFutureFlag(e)}onRender(e,t){if(!this.isEditor&&!e.hasNodeData(!0))return void this.api.v1.model.noRender(e);if(t.get("metadata.movableContent")&&e.setFiltered("movableStyle",G.createStyle(e,"metadata.contentPosition",["desktop","mobile"])),!this.isEditor)return;const i=e.get("metadata.visibleAfterDate");if(i){const s=this.stringToDate(i);if(s){const i=(new Date).getTime();s.getTime()>i&&t.addCssStates(["hidden-on-front","has-date-restriction"]),s.setMinutes(s.getMinutes()-s.getTimezoneOffset()),e.setFiltered("visibleAfterDate",s.toISOString().slice(0,16))}}else e.get("filtered.visibleAfterDate")&&(t.resetCssState(),e.setFiltered("visibleAfterDate",null))}onSettingsPanel(){return{onSubmit:({model:e,formValues:t})=>{for(const t of this.api.v1.view.getViews(e))t.resetCssState();const i=this.stringToDate(t["metadata.visibleAfterDate"]);let s;i?s=i.toISOString():(e.setFiltered("visibleAfterDate",null),s=null),e.set("metadata.visibleAfterDate",s)}}}stringToDate(e){const t=new Date(e||"");return t instanceof Date&&Number.isFinite(t.getTime())?t:null}updateFutureFlag(e){const t=!!e.get("metadata.visibleAfterDate");let i=null;for(const t of e.getChildren()){const e=t.get("fields.published");if(e){const t=new Date(e).getTime();t>(new Date).getTime()&&t>i&&(i=t)}}i?(e.set("metadata.visibleAfterDate",new Date(i).toISOString()),this.api.v1.model.highlight.message(e,"Publish-date updated for row"),Sys.logger.debug(`[Baseview] The row '${e.getPositionedPath()}' has set publish date to '${new Date(i).toISOString()}'.`)):t&&(e.set("metadata.visibleAfterDate",null),this.api.v1.model.highlight.message(e,"Publish-date removed for row"),Sys.logger.debug(`[Baseview] The row '${e.getPositionedPath()}' has removed publish date.`))}}class ve{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor(),this.isEditor&&this.api.v1.ns.set("timeline.insertItem",(e,t,i,s)=>{this.addItem(e)})}addItem(e){const t=new Date,i=this.api.v1.model.create.view({type:"timelineItem",contentdata:{fields:{date:`${(t.getHours()<10?"0":"")+t.getHours()}.${(t.getMinutes()<10?"0":"")+t.getMinutes()}`}}});this.api.v1.model.prependChild(e,i)}}class _e{constructor(e){this.api=e,this.dateTimeHelper=new m}onRender(e,t){const i=e.get("fields.modified")||e.get("fields.published");if(null!=i){const t=new Date(1e3*i);e.setFiltered("niceDate",this.dateTimeHelper.timestampToNiceDate(i)),e.setFiltered("publishedDate",this.dateTimeHelper.utcFormat(t,`${this.api.v1.locale.get("dates.monthdayyear",{noRender:!0})} ${this.api.v1.locale.get("dates.hourminute",{noRender:!0})}`)),e.setFiltered("isoDate",t.toISOString())}}}class ke{constructor(e){this.api=e,this.baseApiUrl=this.api.v1.properties.get("front_api_url"),this.siteId=this.api.v1.properties.get("site.id"),this.cache=new Map,this.defaultMaxCount=100,this.isEditor=this.api.v1.app.mode.isEditor()}onPrepareViewHelper(e,t){const i=e.get("fields.site")||this.siteId,s=t.get("fields.maxNoticesCount")||this.defaultMaxCount,a=(e.get("fields.tags")||"").toLowerCase().split(",").filter(e=>""!==e),n=this.prepareTags(a),o=this.prepareQuery(n,!1),l=this.prepareQuery(n,!0),r=`${this.baseApiUrl}/notice?content=full&site_id=${i}&limit=${s}`;e.setFiltered("query",o),e.setFiltered("clientQuery",l),e.setFiltered("url",r)}onReady(e,t){const i=t.get("external"),s=e.get("filtered.noFetch")||!1,a=e.get("metadata.blacklist")||[],n=t.get("fields.maxNoticesCount")||this.defaultMaxCount;if(!s&&i){e.setFiltered("noFetch",!0);const t=e.get("fields.pinnedNotices_json")||[];let s=i.result;if(this.api.v1.app.mode.isEditor()){const t=this.api.v1.model.query.getModelsByType("notice",e.children);for(const e of t)this.api.v1.model.delete(e,!0,!0)}s=s.slice(0,n),s.forEach(i=>{const{attribute:s={},field:n={}}=i.notice;if(a.includes(parseInt(s.id||0,10)))return void Sys.logger.warn(`Notice with id ${s.id} is blacklisted from Livefeed and will not be displayed.`);"object"==typeof n.bodytext&&(n.bodytext="");const{title:o,bodytext:l,published:r,modified:d,published_url:g,userName:c}=n,p=[];if(i.notice.children&&i.notice.children.image){const e=Array.isArray(i.notice.children.image)?i.notice.children.image:[i.notice.children.image];for(const t of e){let e={};if(n.structure_json&&t.attribute.id)try{const i=JSON.parse(n.structure_json);for(const s of i)if("bodytext"===s.type){const i=this.getStructure(s.children||[],t.attribute.id);e=i?i.metadata:{};break}}catch(e){Sys.logger.warn(`Failed to parse structure data: ${e.toString()}`)}e.hasFullWidth={desktop:!1,mobile:!1},p.push(this.getImageData(t,e||{}))}}this.api.v1.model.insert.atPath({path:e.getPositionedPath(),data:{type:"notice",contentdata:{id:s.id,fields:{title:o,bodytext:l,published:r,modified:d,published_url:g,userName:c,pinned:t.includes(s.id)},tags:i.notice.tag?i.notice.tag.tag:""},state:{isNonPersistent:!0,editNonPersistent:!0},children:p},options:{silent:!0,index:t.includes(s.id)?0:void 0}})}),e.children.sort((e,i)=>t.includes(e.getId())?-1:t.includes(i.getId())?1:i.getId()-e.getId()),this.api.v1.app.mode.isEditor()&&(this.api.v1.model.addToRedrawQueue(e,!0),this.api.v1.app.save())}const o=this.api.v1.config.get("contentbox_settings.livefeed.updateFrequency")||[{range:[0,600],interval:10},{range:[600,1200],interval:30},{range:[1200],interval:60}];e.setFiltered("updateFrequency",JSON.stringify(o))}onRender(e,t){const i=t.get("fields.placeholder");e.setFiltered("placeholder",i||this.api.v1.locale.get("emptyState.noContentText",{noRender:!0})),e.setFiltered("initialRenderTime",(new Date).getTime()),e.setFiltered("dateStrings",JSON.stringify({now:this.api.v1.locale.get("dates.now",{noRender:!0}),monthdayyear:this.api.v1.locale.get("dates.monthdayyear",{noRender:!0}),hourminute:this.api.v1.locale.get("dates.hourminute",{noRender:!0}),durationSince:this.api.v1.locale.get("dates.durationSince",{noRender:!0}),minute:this.api.v1.locale.get("dates.minute",{noRender:!0}),minutes:this.api.v1.locale.get("dates.minutes",{noRender:!0}),hour:this.api.v1.locale.get("dates.hour",{noRender:!0}),hours:this.api.v1.locale.get("dates.hours",{noRender:!0}),day:this.api.v1.locale.get("dates.day",{noRender:!0}),days:this.api.v1.locale.get("dates.days",{noRender:!0}),ago:this.api.v1.locale.get("dates.ago",{noRender:!0})}))}onChildAdded(e,t){if(this.isEditor&&"notice"!==t.getType()){if(e.children.indexOf(t)>0)return;const i=this.api.v1.model.query.getModelsByType("notice",e.children).filter(e=>e.get("fields.pinned"));if(!i.length)return;let s=0;for(const t of i)e.children.indexOf(t)>s&&(s=e.children.indexOf(t));s>0&&this.api.v1.model.addChild(e,t,s,!1)}}prepareQuery(e,t=!1){const i=t?["(visibility_status:P OR visibility_status:H)"]:["visibility_status:P"];return e.length>0&&i.push(`(${e.join(" OR ")})`),`&query=${encodeURIComponent(i.join(" AND "))}`}prepareTags(e){return e.map(e=>{let t=e.trim();return t.indexOf(" ")>-1&&(t=`"${t}"`),`tag:${t}`})}getImageData(e,t){return this.api.v1.model.serialize.apiToView({type:"image",data:e,meta:t})}onSettingsPanel(e,t,i){const s={layout:null,container:null};return{onDisplay:({model:e,view:t,config:i,markup:a,modal:n})=>{s.layout=a.querySelector("#layout"),s.container=a.querySelector(".horizontalOptions"),s.layout&&s.container&&s.layout.addEventListener("change",e=>{"1"===s.layout.value?s.container.classList.remove("lab-hidden"):s.container.classList.add("lab-hidden")})},onHide:({model:e,view:t,config:i,markup:a,modal:n})=>{s.layout=null,s.container=null,e.setFiltered("noFetch",!1)}}}getStructure(e,t){for(const i of e){if("image"===i.type&&i.node_id==t)return i;if(i.children){const e=this.getStructure(i.children,t);if(e)return e.metadata&&!e.metadata.bodyTextIndex&&i.metadata&&i.metadata.bodyTextIndex&&(e.metadata.bodyTextIndex=i.metadata.bodyTextIndex),e}}return null}}class we{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor()}onRendered(e,t){if(!this.isEditor)return;const i=[...e.get("tags")],s=t.getMarkup().querySelector(".tags");for(const t of i){const i=s.querySelector(`[data-tag="${t}"]`);i&&this.setupTag(e,i,t)}const a=document.createElement("span");a.classList.add("labicon-pluss_slim","add-tag"),a.setAttribute("title","Add tag"),s.appendChild(a),a.addEventListener("click",async t=>{t.preventDefault();let s=null;const a=await this.api.v1.util.tags.ui({callbacks:{change:e=>{if(s){const t=e.sort();s.getMarkup().querySelector("#hidden_tags_input").value=t.join(", ")}}},tags:i});s=this.api.v1.ui.modal.dialog({container:{width:500},placeholders:[{selector:"#placeholder-tags",element:a}],content:{title:"Edit tags",formgroups:[{elements:[{label:"Selected tags. Click a tag to remove. <br>Use input field below to add new tags.",inline:!0,tag:"input",attributes:[{name:"type",value:"hidden"},{name:"name",value:"tag"},{name:"id",value:"hidden_tags_input"},{name:"value",value:i.join(", ")}]},{grid:12,placeholder:"placeholder-tags"},{grid:12,tag:"p",value:"<br><br><br><br><br>"}]}]},callbacks:{didDisplay:e=>{e.getMarkup().querySelector('input[name="tag"]').focus()},submit:t=>{const i=t.tag.trim().toLowerCase().split(",").map(e=>e.trim()).filter(e=>e.length>0);i.length&&e.set("tags",i)}},eventHandlers:[{selector:"#tag-cancel",event:"click",callback:(e,t)=>{e.close()}}],keyValidation:[{key:"tag",validator:"notEmpty"}],footer:{buttons:[{value:"Cancel",highlight:!1,id:"tag-cancel"},{value:"Save tags",type:"submit",highlight:!0}]}})})}setupTag(e,t,i){t.addEventListener("click",t=>{t.preventDefault(),console.log("Tag clicked: ",i),e.set("tags",[...e.get("tags").filter(e=>e!==i)])})}}class Se{constructor(e,t={model:"gpt-4o",provider:"openAi",integration:"openAi",featureName:"chart"}){this.api=e,this.aiSettings=t,this.isEditor=this.api.v1.app.mode.isEditor(),this.requiredFilesJS=this.api.v1.config.get("contentbox_settings.chart.require.js")||null,this.isEditor&&this.api.v1.ns.set("chart",{generate:(e,t)=>{const i=this.api.v1.bodytext.getText(this.api.v1.model.query.getModelByType("bodytext")),s=t.getMarkup();s.classList.add("lab-content-busy"),this.api.v1.ns.get("textAssistant.fetchByGroupName")("chart",this.aiSettings,{bodytext:i}).then(t=>{if(t){const i=this.cleanUpAndParseJsonString(t),{enoughData:a,title:n,type:o,beginAtZero:l,labels:r,datasets:d}=i;a?(this.setIfDefined(e,"fields.title",n),this.setIfDefined(e,"fields.chartType",o),this.setIfDefined(e,"fields.beginAtZero",l),this.setIfDefined(e,"fields.tableData",this.objectToTsv({labels:r,datasets:d}))):(s.classList.add("lab-highlight-warn"),s.querySelector(".description").insertAdjacentHTML("afterend",'<p style="color: #ff0000; text-transform: uppercase; font-weight: bold;">Not enough data to generate a chart</p>'))}}).finally(()=>{s.classList.remove("lab-content-busy")})}})}onCreated(e){this.requiredFilesJS&&this.requiredFilesJS.forEach(e=>{for(const t of this.api.v1.viewport.getContexts())this.api.v1.util.dom.addFile("js",e,t,null,null,{},!1)})}onRender(e,t){const i=e.get("fields.chartType")||"line",s=e.get("fields.beginAtZero")||!1,a=e.get("fields.tableData");let n;a&&(n=this.tsvToObject(a)),e.setFiltered("chartType",i),e.setFiltered("beginAtZero",s),e.setFiltered("chartData_json",JSON.stringify(n))}tsvToObject(e){const t=null==e?"":String(e).replace(/\r\n?/g,"\n").trim();if(!t)return{labels:[],datasets:[]};const i=t.split("\n").filter(e=>""!==e.trim()),s={labels:[],datasets:i[0].split("\t").slice(1).map(e=>({label:(null==e?"":e).trim(),data:[]}))};for(let e=1;e<i.length;e++){const t=i[e].split("\t");s.labels.push((null===t[0]||void 0===t[0]?"":t[0]).trim());for(let e=0;e<s.datasets.length;e++){const i=(null===t[e+1]||void 0===t[e+1]?"":t[e+1]).trim(),a=""===i?null:Number(i.replace(/\s+/g,""));s.datasets[e].data.push(Number.isFinite(a)?a:null)}}return s}objectToTsv(e){const t=[[""].concat(e.datasets.map(e=>e.label)).join("\t")];for(let i=0;i<e.labels.length;i++){const s=[e.labels[i]];for(let t=0;t<e.datasets.length;t++)s.push(e.datasets[t].data[i]);t.push(s.join("\t"))}return t.join("\n")}cleanUpAndParseJsonString(e){try{const t=e.trim().replace(/^```json\s*/,"").replace(/\s*```$/,"");return JSON.parse(t)}catch(e){return console.error("Error cleaning or parsing API response:",e.message),null}}setIfDefined(e,t,i){null!=i&&e.set(t,i)}}class Fe{constructor(e){this.api=e,this.sizes={large:{columns:3,rows:4},small:{columns:2,rows:1}},this.smallElementTypes=["article"],this.isEditor=this.api.v1.app.mode.isEditor(),this.removedChildren=[]}onCreated(e){if(e.getChildren().length)return;const t=this.getSize(e);for(let i=0;i<t.columns*t.rows;i++)this.createAndInsert(e)}onInserted(e){this.isEditor&&(this.api.v1.model.bindings.bind(e,"fields.columnCount",this.sizeUpdated.bind(this)),this.api.v1.model.bindings.bind(e,"fields.rowCount",this.sizeUpdated.bind(this)),this.api.v1.model.bindings.bind(e,"fields.columnCountMobile",this.sizeUpdated.bind(this)))}onChildAdded(e,t){if(!e.parent)return;const i=this.getSize(e);this.updateSize(i,t)}updateSize(e,t){t.setWidth(e.width.desktop,{viewport:"desktop"}),t.setWidth(e.width.mobile,{viewport:"mobile"})}onSettingsPanel(e,t,i){return{onWillDisplay:({model:e,view:t,config:i,template:s})=>{this.removedChildren=[],e.setFiltered("size",this.getSize(e))}}}getSize(e){const t=this.getGridCount(e),i=e.get("fields.columnCountMobile")||1,s=parseFloat((100/i).toFixed(2));return{columns:t.columns,columnsMobile:i,rows:t.rows,width:{desktop:parseFloat((100/t.columns).toFixed(2)),mobile:s}}}getGridCount(e){const t=e.parent&&this.smallElementTypes.includes(e.parent.get("type"))?this.sizes.small:this.sizes.large,i=e.get("fields.columnCount")||t.columns,s=e.get("fields.rowCount")||t.rows;return{columns:parseInt(i,10),rows:parseInt(s,10)}}sizeUpdated(e){const t=this.getSize(e),i=e.getChildren();for(const e of i)this.updateSize(t,e);if(i.length>t.columns*t.rows&&i.slice(t.columns*t.rows).forEach(e=>{this.api.v1.model.delete(e),e.get("instance_of")&&this.removedChildren.push(e)}),i.length<t.columns*t.rows)for(let s=i.length;s<t.columns*t.rows;s++)this.createAndInsert(e,this.removedChildren.shift())}createAndInsert(e,t){t?this.api.v1.model.addChild(e,lab_api.v1.model.copy(t)):this.api.v1.model.create.internal({type:"image",contentdata:{type:"image",fields:{}}},e,!0,!1)}}class Te{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor(),this.options={}}onRender(e,t){if(this.isEditor){const t=this.api.v1.config.get("contentbox_settings.vimond.playersApiUrl")||!1,i=e.get("fields.player");t&&fetch(t).then(e=>{if(!e.ok)throw new Error(`Network response was not ok: ${e.statusText}`);return e.json()}).then(t=>{const s=Array.isArray(t)?t:Object.values(t.data);if(this.options=s.map(e=>({id:e.id,name:e.name,aspectRatio:e.aspectRatio,selected:i&&e.id===i})),null==i&&this.options.length>0){const t=this.options[0];e.set("fields.player",t.id),t.selected=!0,t.aspectRatio&&(e.set("fields.aspectRatio",t.aspectRatio.replace("/","-")),e.set("fields.aspectRatioStyle",t.aspectRatio))}e.setFiltered("playersSettingsString",JSON.stringify(this.options)),e.setFiltered("playersSettings",this.options);const a=this.options.find(e=>e.id===i);a&&a.aspectRatio&&(e.set("fields.aspectRatio",a.aspectRatio.replace("/","-")),e.set("fields.aspectRatioStyle",a.aspectRatio))}).catch(e=>{Sys.logger.warn("[Vimond] There was a problem with the fetch operation:",e)}),"0"===i&&(e.set("fields.aspectRatio",null),e.set("fields.aspectRatioStyle",null))}let i="page_article"===this.api.v1.model.root.getType();if(this.api.v1.app.mode.isFront()&&!t.get("fields.caption")&&(i=!1),e.setFiltered("displayCaption",i),!this.api.v1.app.mode.isEditor()&&!0===this.api.v1.config.get("cookieConsent.enabled")){const t=this.api.v1.config.get("cookieConsent").contentboxes.filter(e=>"vimond"===e.name)[0];t&&(e.setFiltered("requiredCookieConsent",t.requiredConsent||!1),e.setFiltered("insufficientConsentMessage",t.insufficientConsentMessage||this.api.v1.config.get("cookieConsent.insufficientConsentMessage")||""))}e.get("fields.verticalVideo")?e.setFiltered("playerUrl",`${e.get("fields.playerUrl")}&aspectRatio=9:16`):e.setFiltered("playerUrl",e.get("fields.playerUrl"))}onRendered(e,t){if(this.isEditor){const e=t.getMarkup().querySelector("iframe"),i=t.getMarkup().querySelector(".video-drag-handle");e&&i&&(i.addEventListener("mouseenter",t=>{e.style.pointerEvents="none"},!1),i.addEventListener("mouseleave",t=>{e.style.pointerEvents=""},!1))}}}class Ce{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor()}onRender(e,t){let i="page_article"===this.api.v1.model.root.getType();if(this.api.v1.app.mode.isFront()&&!t.get("fields.caption")&&(i=!1),e.setFiltered("displayCaption",i),!this.api.v1.app.mode.isEditor()&&!0===this.api.v1.config.get("cookieConsent.enabled")){const t=this.api.v1.config.get("cookieConsent").contentboxes.filter(e=>"vp"===e.name)[0];t&&(e.setFiltered("requiredCookieConsent",t.requiredConsent||!1),e.setFiltered("insufficientConsentMessage",t.insufficientConsentMessage||this.api.v1.config.get("cookieConsent.insufficientConsentMessage")||""))}e.get("fields.verticalVideo")?e.setFiltered("playerUrl",`${e.get("fields.playerUrl")}&aspectRatio=9:16`):e.setFiltered("playerUrl",e.get("fields.playerUrl"))}onRendered(e,t){if(this.isEditor){const e=t.getMarkup().querySelector("iframe"),i=t.getMarkup().querySelector(".video-drag-handle");e&&i&&(i.addEventListener("mouseenter",t=>{e.style.pointerEvents="none"},!1),i.addEventListener("mouseleave",t=>{e.style.pointerEvents=""},!1))}}}class De{constructor(e){this.api=e}onRender(e,t){const i=e.get("fields.infiniteSource")||"api",s=e.get("fields.infiniteFeed");if(this.api.v1.app.mode.isEditor()){const t=[{value:"api",label:"All articles from site",selected:"api"===i},{value:"feed",label:"Articles from feed",selected:"feed"===i}];e.setFiltered("sourceOptions",t),e.setFiltered("displayFeeds","feed"===i);const a=this.api.v1.config.get("feeds"),n=[];for(const[e,t]of Object.entries(a)){const i={value:e,label:t.display_name,selected:s===e};n.push(i)}e.setFiltered("feedOptions",n),"api"===i?e.setFiltered("sourceInfo","Currently fetching all articles from this site"):"feed"===i&&e.setFiltered("sourceInfo",`Currently fetching articles from feed "${s}"`)}e.setFiltered("infiniteSource",i),e.setFiltered("infiniteFeed",s)}}class xe{constructor({path:e=null,selector:t=null,data:i={},options:s={}}={}){this.path=e,this.selector=t,this.data=i,this.options={persistentTarget:!0,intermediate:{useExisting:!0},...s}}}class $e{constructor({key:e=null,path:t=null,selector:i=null,placeholder:s=null,metadata:a={},options:{shouldInsert:n=!0,wrap:o=null,skipIfOutOfBounds:l=!1,useIndex:r=!1,useBodyTextIndex:d=!1,useBodyTextHeadingIndex:g=!1,lastBodyTextHeading:c=!1,prepend:p=!1}={}}={}){this.key=e,this.path=t,this.selector=i,this.placeholder=s,this.metadata=a,this.options={shouldInsert:n,wrap:o,skipIfOutOfBounds:l,useIndex:r,useBodyTextIndex:d,useBodyTextHeadingIndex:g,lastBodyTextHeading:c,prepend:p}}}class Me{constructor({type:e=null,contentdata:t=null,content_data:i=null,cssSettings:s={},children:a=[],metadata:n={}}={}){this.type=e,this.contentdata=t||i,this.children=a,this.metadata={...n},this.state={};const o=[];this.metadata.css&&o.push(this.metadata.css);for(const e of Object.keys(s))s[e]&&o.push(e);this.metadata.css=o.join(" ")}}class Ae{constructor(e){this.api=e,this.page=this.api.v1.model.query.getRootModel(),this.pageType=this.api.v1.model.root.getType().replace("page_",""),this.viewports=this.api.v1.viewport.getActive(),this.isEditor=this.api.v1.app.mode.isEditor(),this.cache=new Map,this.pageElements={},this.hideAds="1"===this.page.get("fields.hideAds")||!0===this.page.get("fields.hideAds"),this.hideTopBannerAd="1"===this.page.get("fields.hideTopBannerAd")||!0===this.page.get("fields.hideTopBannerAd"),this.hideSkyscraperAd="1"===this.page.get("fields.hideSkyscraperAd")||!0===this.page.get("fields.hideSkyscraperAd"),this.api.v1.util.request.hasQueryValue("lab_opts","infinitescroll")&&(this.pageType=`${this.pageType}_infinitescroll`)}hasRequiredElement(e){return void 0===this.pageElements[e]&&(this.pageElements[e]=!!this.api.v1.model.query.getModelByType(e)),this.pageElements[e]}insert(e,t=null){const i={clientSidePlacements:[]},s={},a=`insertDynamic.${this.pageType}.${e}`,n=`placements.${this.pageType}.${e}`;let o=!1;const l=(this.api.v1.config.get(n)||[]).filter(e=>!e.client||(e.requireElement&&!this.hasRequiredElement(e.requireElement)||(s[e.key]=e),!1));if(!this.cache.has(a)){const e=`insertDynamicAdditions.${this.pageType}`,t=this.api.v1.config.get(a)||[],n=this.validateConditions(this.api.v1.config.get(e)||[]).reverse();o=n.length>0;const l=[...t,...n],r=(this.isEditor?l.filter(e=>!e.dynamicDataSettings||!e.dynamicDataSettings.hideInEditMode):l).filter(e=>{if(e.placement&&e.placement.key&&s[e.placement.key]){const t={...e,placementData:s[e.placement.key]};return i.clientSidePlacements.push(t),!1}return!0});this.cache.set(a,r)}if(!this.cache.has(n)){if(o){const e=`placementsAdditions.${this.pageType}`,t=this.api.v1.config.get(e)||[];l.push(...t)}this.cache.set(n,l.map(e=>new $e(e)))}const r=this.parse(this.cache.get(a),this.cache.get(n),e,t);for(const e of r)e.selector?this.api.v1.model.insert.bySelector({selector:e.selector,data:e.data,options:e.options}):e.path&&this.api.v1.model.insert.atPath({path:e.path,data:e.data,options:e.options});return i}validateConditions(e){return e.filter(e=>{if(e.excludeDuplicates&&this.api.v1.model.query.getModelByType(e.type))return Sys.logger.debug(`[DynamicDataHelper]: Element of type "${e.type}" already exist on page. Skipping.`),!1;if(e&&e.conditions){const{conditions:t}=e;for(const i of t){const{field:t,operator:s,value:a=""}=i,n=this.page.get(t||"",void 0,!0);if(void 0!==n)switch(s){case"equals":if(n!==a)return Sys.logger.debug(`[DynamicDataHelper]: Condition for inserting element type "${e.type}" failed. Field: "${t}", operator "${s}", value: "${a}", page value: "${n}".`),!1;break;case"notEquals":if(n===a)return Sys.logger.debug(`[DynamicDataHelper]: Condition for inserting element type "${e.type}" failed. Field: "${t}", operator "${s}", value: "${a}", page value: "${n}".`),!1;break;case"contains":if(!n.includes(a))return Sys.logger.debug(`[DynamicDataHelper]: Condition for inserting element type "${e.type}" failed. Field: "${t}", operator "${s}", value: "${a}", page value: "${n}".`),!1;break;case"notContains":if(n.includes(a))return Sys.logger.debug(`[DynamicDataHelper]: Condition for inserting element type "${e.type}" failed. Field: "${t}", operator "${s}", value: "${a}", page value: "${n}".`),!1;break;default:return Sys.logger.warning(`[DynamicDataHelper]: Operator "${s}" is not valid. The condition fails and the item is not inserted onto the page.`),!1}else Sys.logger.debug(`[DynamicDataHelper]: Condition for inserting element type "${e.type}" ignored. Value of field: "${t}" is undefined.`)}return Sys.logger.debug(`[DynamicDataHelper]: All conditions (${t.length}) for inserting element type "${e.type}" accepted. Will insert.`),!0}return Sys.logger.debug(`[DynamicDataHelper]: No validation specified for inserting element type "${e.type}". Will insert.`),!0})}parse(e=[],t=[],i="desktop",s=null){const a=[];for(const n of e){const[o]=t.filter(({key:e})=>e===n.placement.key);if(o)if(this.acceptPath(o.path,s)){const t=this.create(n,o,e,i);if(null!==t&&(t.data.metadata.viewportBlacklist=this.viewports.filter(e=>e!==i),a.push(t),Number.isInteger(t.options.interval)&&Number.isInteger(t.options.index))){const{interval:s}=n.placement,{index:l}=n.placement;let r=l;const d=this.api.v1.model.query.getModelByPath(t.path);if(d){const t=d.getPersistentChildren().length;for(;r<t;){const t=JSON.parse(JSON.stringify(n));t.options.index=r,t.placement.index=r,t.type="placeholder_ad";const l=JSON.parse(JSON.stringify(o));l.selector="";const d=this.create(t,l,e,i);null!==d&&(d.data.metadata.viewportBlacklist=this.viewports.filter(e=>e!==i),a.push(d)),r+=s}}}}else Sys.logger.debug(`[DynamicDataHelper]: Path "${o.path}" not allowed. Filter: "${s}", key: "${n.placement.key}"`);else Sys.logger.debug(`[DynamicDataHelper]: No placement found with key "${n.placement.key}"`)}return a}create(e,t,i,s="desktop"){if(this.filter(e)){const i=this.assemble(e,t);t.path&&t.selector&&(this.api.v1.model.query.getModelBySelector(t.selector)||this.api.v1.model.insert.atPath({path:t.path,data:{type:"placeholder",selector:t.selector,metadata:{...t.metadata||{},key:t.key},state:{isNonPersistent:!0}},options:{index:0,useExisting:!0,prepend:!0,silent:!0}}));const a={...e.options,prepend:t.options.prepend||!1,silent:!0};let{path:n}=t,o=e.placement.index||0,l=null;if(t.selector)l=this.api.v1.model.query.getModelBySelector(t.selector);else if(t.path){const e=this.getModelsByPath(t.path,s);e.length&&(l=t.options.useBodyTextIndex||t.options.useBodyTextHeadingIndex||t.options.lastBodyTextHeading?e.find(e=>"bodytext"===e.getType()):t.options.shouldInsert?e[0].children[o]:e[o])}if(l||!t.options.skipIfOutOfBounds){if(l){o=this.api.v1.model.query.getIndex(l);let e=l.getParent();if("mobile"===s){if(o>0&&o<e.children.length){let t=e.children[o];for(;t;){const i=l.get("width",s,!0);if(void 0===i||100===i)break;t=e.children[++o]}}e.get("metadata.hasRowTitle")&&(0===o||o>=e.children.length)&&(l=e,e=l.getParent(),o=this.api.v1.model.query.getIndex(l),n=e.getPositionedPath())}t.options.useIndex&&o<e.children.length&&(a.index=o),t.options.shouldInsert||(n=e.getPositionedPath(!0))}else a.prepend=!1;return new xe({data:i,options:a,selector:t.selector,path:n})}}return null}assemble(e,t){let i=new Me(e);return t.selector||(i.metadata={...i.metadata,...t.metadata,css:t.metadata.css?`${i.metadata.css} ${t.metadata.css}`:i.metadata.css||""}),t.options.wrap&&(i=new Me({type:t.options.wrap.type,metadata:t.options.wrap.metadata,children:[i]})),t.options.skipIfOutOfBounds&&(i.metadata.skipIfOutOfBounds=!0),t.options.useBodyTextIndex?i.metadata.bodyTextIndex=e.placement.index||0:t.options.useBodyTextHeadingIndex&&(i.metadata.bodyTextHeadingIndex=e.placement.index||0),t.options.lastBodyTextHeading&&(i.metadata.lastBodyTextHeading=!0),i.metadata.options=e.options||{},i.state.isNonPersistent=!0,i}acceptPath(e,t){return!e||!t||e===t}filter(e){return"googleAd"!==e.type&&"adnuntiusAd"!==e.type||(Sys.logger.debug(`[DynamicDataHelper]: Ad insertion requested. ad unit=${e.placement.key} hideAds=${this.hideAds}, hideTopBannerAd=${this.hideTopBannerAd}, hideSkyscraperAd=${this.hideSkyscraperAd}`),"topbanner"===e.placement.key&&this.hideTopBannerAd?(Sys.logger.debug("[DynamicDataHelper]: Top banner ad is hidden. Skipping insertion."),!1):e.placement.key.includes("skyscraper_")&&this.hideSkyscraperAd?(Sys.logger.debug("[DynamicDataHelper]: Skyscraper ad is hidden. Skipping insertion."),!1):!this.hideAds)}getModelsByPath(e,t){const i=`getByPath-${e}`;return this.cache.has(i)||this.cache.set(i,this.api.v1.model.query.getModelsByPath(e,!0,!0)),this.cache.get(i)}}class Ee{constructor(e){this.api=e,this.request=this.api.v1.util.request}listen(){const e={selector:this.request.getQueryParam("lab_selector")||"contentFromPath",path:this.request.getQueryParam("lab_path"),guid:this.request.getQueryParam("lab_guid")};(e.guid||e.path)&&this.api.v1.model.on("insert",t=>{const i=e.guid?this.getModelByGuid(e.guid,t):this.getModelByPath(e.path,t);if(i)return Sys.logger.debug(`[FragmentHelper] Element found. Path: ${i.getPositionedPath()}, GUID: ${i.getGuid()}.`),i.setSelector(e.selector),"embed"===lab_api.v1.viewport.getName()?this.appendToRoot(t,i):[i]})}getModelByGuid(e){return Sys.logger.debug(`[FragmentHelper] Will filter elements by guid: "${e}".`),this.api.v1.model.query.getModelByGuid(e)}getModelByPath(e,t){Sys.logger.debug(`[FragmentHelper] Will filter elements by path: "${e}".`);const i=this.api.v1.util.string.parsePath(e);if(!i[0])return null;const s=this.api.v1.model.query.getModelsByType(i[0].base,t);return this.api.v1.model.query.getModelByPath(e,!0,!1,s)}appendToRoot(e,t){const i=e[0];return i.children=[t],[i]}}class Ie{constructor(e){this.api=e,this.paths={main:["parent","guid","type","tags"],fields:["feedId","byline","bylineImage","paywall","published","published_url","site_alias","site_id","subtitle","subtitleHTML","teaserSubtitle","somedescription","title","teaserTitle","titleHTML","seolanguage","seotitle","sometitle","kicker","teaserKicker","showcomments"],fieldsAuto:["section_tag","tags"],fieldsNative:["section"],fieldMap:{subtitle:"description",subtitleHTML:"descriptionHTML",somedescription:"someDescription",teaserSubtitle:"teaserDescription",seolanguage:"seolanguage",seotitle:"seoTitle",sometitle:"someTitle",published_url:"url",section_tag:"section"},fallback:{url:"url"}},this.frontUrl=this.api.v1.site.getSite().domain||this.api.v1.properties.get("customer_front_url"),this.imageServer=this.api.v1.properties.get("image_server")}jsonData(e){Sys.logger.debug("[PageExport] Will export page as JSON-data");const t=this.api.v1.model.serialize.model(e);return delete t.guid,{page:t,result:"page_article"===e.getType()?this.exportArticle():this.exportFront()}}oembed(e){if("page_article"!==e.getType())return Sys.logger.warn("[PageExport] Will not export current page type as oEmbed."),{};const t=(this.api.v1.util.request.getQueryParam("lab_opts")||"").split(",");let i="full";t.includes("embed_type_teaser")&&(t.splice(t.indexOf("embed_type_teaser"),1),i="teaser");const s=t.filter(e=>e.startsWith("embed_no_")),a=["embed_padding"],n=[];for(const e of s)n.push(`dac-${e.replace("embed_","").replace(/_/g,"-")}`);for(const e of a)t.includes(e)&&n.push(`dac-${e.replace("embed_","").replace(/_/g,"-")}`);return Sys.logger.debug("[PageExport] Will export page as oEmbed"),{version:"1.0",type:"rich",width:"",height:"",title:this.api.v1.util.string.sanitizeString(e.get("fields.title")||""),url:e.get("filtered.url")||"",author_name:this.api.v1.site.getSite().display_name||this.api.v1.site.getSite().alias,author_url:this.frontUrl,provider_name:"Labrador",provider_url:"http://www.labradorcms.com/",html:`<div class="labrador-cms-embed" data-lab-style="${n.join(" ")} dac-embed-${i}" data-lab-content="${i}" data-lab-id="${e.get("id")}" data-lab-site="${e.get("filtered.site.domain_no_protocol")}"><script async defer src="${this.frontUrl}/embed.js?v=335"><\/script></div>`}}exportArticle(){}exportFront(){const e=this.api.v1.model.query.getModelByType("dropZone");return this.api.v1.model.query.getModelsByType("article",[e]).map(e=>this.serialize(e)).filter(e=>!!e)}serialize(e){const t=this.api.v1.model.serialize.model(e);if(!t||!t.fields)return null;const i=!!t.fields.origin_data_json,s={images:[],width:e.getWidth("desktop"),metadata:t.metadata,isAutomatic:i,siteDomain:this.frontUrl},a=i?t.fields.origin_data_json:t.fields,n=[...this.paths.fields,...i?this.paths.fieldsAuto:this.paths.fieldsNative];for(const e of this.paths.main)s[e]=t[e]||"";for(const e of n)s[this.paths.fieldMap[e]||e]=a[e]||"";if(s.teaserSubtitle=a.teaserSubtitle||"",i){if(!s.byline){const e=(a.full_bylines||[]).shift();s.byline=e?`${e.firstname} ${e.lastname}`:"",s.bylineImage=s.bylineImage||(e||{}).imageUrl}"string"==typeof s.tags&&(s.tags=s.tags.split(",").map(e=>(e||"").trim())),s.site_alias=(this.api.v1.site.getSiteById(a.site_id)||{}).alias,s.id=parseInt(a.id,10)}else s.titleHTML=s.title,s.title=this.cleanText(s.title),s.descriptionHTML=s.description,s.description=this.cleanText(s.description),s.kickerHTML=s.kicker,s.kicker=this.cleanText(s.kicker),s.id=t.id;s.section_tag=s.section,s.url&&!s.url.startsWith("http")&&(s.url=this.frontUrl+s.url);for(const e of Object.keys(this.paths.fallback))s[e]||(s[e]=a[this.paths.fallback[e]]||"");s.full_bylines=(i?a.full_bylines:a.full_bylines_json)||[],s.full_bylines=s.full_bylines.map(e=>({firstname:e.firstname,lastname:e.lastname,description:e.description,imageUrl:this.getImageUrl(e.imageUrl)})),i&&s.byline&&s.full_bylines.unshift({firstname:s.byline,lastname:"",imageUrl:this.getImageUrl(s.bylineImage)}),!s.byline&&s.full_bylines.length&&(s.byline=`${s.full_bylines[0].firstname} ${s.full_bylines[0].lastname}`,s.bylineImage=s.full_bylines[0].imageUrl.replace(this.imageServer,""));const o=lab_api.v1.config.get("customAdapterFields.article")||[];if(o)for(const e of o)if(e){let i=t.fields[e]||"";!i&&t.fields.origin_data_json&&(i=t.fields.origin_data_json[e]||""),i&&(s[e]=i)}s.paywall="0"!==s.paywall&&!!s.paywall;const l=this.api.v1.model.query.getChildOfType(e,"image");if(l){const e=l.get("filtered.image");e&&s.images.push({url:e,jpg:`${e}&format=jpg`,webp:`${e}&format=webp`,url_size:e,default:"1",id:l.get("instance_of")})}return s}cleanText(e){return this.api.v1.util.string.sanitizeString(e).replace(/&amp;/g,"&")}getImageUrl(e){return e?e.startsWith("http")?e:this.imageServer+e:""}}class Pe{constructor(e){this.api=e}register(e,t){if(this.api.v1.app.mode.isFragmentMode())return void Sys.logger.debug("[EsiHelper] Labrador is is fragment-mode. Will not register ESI. Skipping.");if(!e)return void Sys.logger.debug("[EsiHelper] Missing model, cannot process. Skipping.");const i=this.api.v1.config.get("footer.include");if(i&&i.pageId){const t=this.getEsiUrl(i);t?"client"===i.render?e.setFiltered("renderFooter.url",t):this.insertEsi(e,t,"esi_footer"):Sys.logger.warning("[EsiHelper] Cannot prepare url for footer-fragment. Missing url.")}const s=this.api.v1.config.get("header.include"),a=this.api.v1.config.get("header.includes")||[],n=[];if(s&&s.pageId){const t=this.insertHeader(s,e);t&&n.push(t)}for(const t of a)if(t&&t.pageId){const i=this.insertHeader(t,e);i&&n.push(i)}e.setFiltered("renderHeader.urls",n.map(e=>`'${e}'`).join(", "))}getEsiUrl(e){if(!e.pageId)return null;const t=["pageId","path","structureType","start","count"],i=[];if(t.forEach(t=>{void 0!==e[t]&&""!==e[t]&&null!==e[t]&&i.push(`${t}=${e[t]}`)}),i.length===t.length){let e=this.api.v1.properties.get("front_api_url");return this.api.v1.app.mode.isEditor()&&"https:"===document.location.protocol&&(e=e.replace("http:","https:")),`${e}/fragment/structure/?${i.join("&")}`}return null}insertEsi(e,t,i){Sys.logger.debug(`[EsiHelper] Will insert fragment for selector: "${i}", url: "${t}".`),this.api.v1.model.insert.atPath({path:e.getPath(),data:{type:"esi",selector:i,contentdata:{fields:{url:t,identifier:i}},state:{isNonPersistent:!0}},options:{frontpage:!0,articlepage:!0}}),this.api.v1.app.mode.isEditor()&&this.fetchEditorEsi(t,`${i}`)}insertHeader(e,t){const i=this.getEsiUrl(e);if(i){if("client"===e.render)return Sys.logger.debug(`[EsiHelper] Found url for header-fragment to render in client: "${i}".`),i;this.insertEsi(t,i,"esi_header")}else Sys.logger.warning("[EsiHelper] Cannot prepare url for header-fragment. Missing url.");return null}fetchEditorEsi(e,t){this.api.v1.view.on("domRendered",(i,s)=>{const a=this.api.v1.model.query.getModelBySelector(t);a&&(Sys.logger.debug(`EsiHelper.fetchEditorEsi: Will fetch esi-substitute for editor. Selector: ${t}, url: ${e}`),this.api.v1.util.httpClient.get(e,{credentials:"omit",type:"text"}).then(e=>{const i=lab_api.v1.view.getView(a,s),n=document.createElement("template");if(n.innerHTML=e,Sys.logger.debug(`EsiHelper.fetchEditorEsi: Esi-substitute fetched. Selector: ${t}, element-count: ${n.content.children.length}`),i.markup){for(const e of[...n.content.children])i.markup.parentElement.insertBefore(e,i.markup);i.markup.remove()}else Sys.logger.warn(`EsiHelper.fetchEditorEsi: Element markup not found. Cannot insert dom-element(s). Selector: ${t}`)}).catch(e=>{Sys.logger.warning(`EsiHelper.fetchEditorEsi: Esi-substitute could not be fetched. Selector: ${t}, error: ${e}`)}))})}}class Oe{static mediaQueries={desktop:"(min-width:1024px)",mobile:"(max-width: 1023px)"};static createStyle({model:e,view:t,viewports:i,styleCollection:s="content_inline_spacing",mediaQueries:a=this.mediaQueries,returnArray:n=!1}){const o=[],l=`[data-element-guid="${e.getGuid()}"] .content`;for(const n of i)if(a[n]){const i=lab_api.v1.style.getStyles(e,t,s,n);i&&o.push(`@media ${a[n]} { ${l} { ${i} } }`)}return n?o:`<style>${o.join("\n")}</style>`}}const je=class{constructor(){this.name="Baseview",this.api=null,this.pageAPI=null,this.useSpacing=!1}onReady(e){if(this.api=e,Sys.logger.debug(`[Front] Running Baseview version ${this.api.v1.config.get("view_version")}, build ${this.api.v1.config.get("view_build.baseview.version")}`),"json"===this.api.v1.viewport.getName()&&"PageExport.jsonData"===this.api.v1.config.get("viewports.json.renderer")){const e=new Ie(this.api);this.api.v1.view.on("rendered",(t,i)=>[JSON.stringify(e.jsonData(this.api.v1.model.query.getRootModel()),null,4)])}if("oembed"===this.api.v1.viewport.getName()&&"PageExport.oembed"===this.api.v1.config.get("viewports.oembed.renderer")){const e=new Ie(this.api);this.api.v1.view.on("rendered",(t,i)=>[JSON.stringify(e.oembed(this.api.v1.model.query.getRootModel()),null,4)])}new Ee(this.api,this.api.v1.util.request).listen()}onAcceptContent(){const e=this.api.v1.model.query.getRootModel();if(this.useSpacing=!(!e||!e.get("fields.style_spacing")),"editor"===this.api.v1.app.mode.getSimulatedMode())return void Sys.logger.debug("[Front] Labrador is running in simulated editor-mode. Skipping DynamicDataHelper and EsiHelper.");const t=new Ae(this.api),{clientSidePlacements:i=[]}=t.insert(this.api.v1.viewport.getName());i.length>0&&!e.get("fields.hideAds")&&(e.setFiltered("clientSidePlacements",JSON.stringify(i)),e.setFiltered("clientSideResources",JSON.stringify({configObject:{viewConfig:{config:{customer:{contentbox_settings:{adnuntiusAd:this.api.v1.config.get("contentbox_settings.adnuntiusAd")||{},googleAd:this.api.v1.config.get("contentbox_settings.googleAd")||{}},adEnvironment:this.api.v1.config.get("adEnvironment")||{}}}}},site:this.api.v1.site.getSite(),device:this.api.v1.properties.get("device"),debug:this.api.v1.util.request.hasQueryParam("debug")||!1}))),new Pe(this.api).register(e,this.api.v1.site.getSite().alias),this.api.v1.util.request.hasQueryValue("lab_opts","hideHeader")&&(Sys.logger.debug("[Front] Hiding header and logo based on url param lab_opts=hideHeader ..."),e.setFiltered("pageHeaderDisplay","hideHeaderAndLogo")),this.api.v1.util.request.hasQueryValue("lab_opts","hideFooter")&&(Sys.logger.debug("[Front] Hiding footer based on url param lab_opts=hideFooter ..."),e.setFiltered("pageFooterDisplay","hideFooter")),this.api.v1.util.request.hasQueryValue("lab_opts","hideComments")&&(Sys.logger.debug("[Front] Hiding Hyvor comments based on url param lab_opts=hideComments ..."),e.setFiltered("pageCommentsDisplay","hideComments"))}onRender(e,t){this.useSpacing&&e.setFiltered("styleSheets",Oe.createStyle({model:e,view:t,viewports:["desktop","mobile"],returnArray:!1}))}onMapData(e){if("text_title"===e.type||"text_subtitle"===e.type){if(!e.contentdata||!e.contentdata.fields)return;const t={...e};return t.type="text_singleline",t.contentdata.fields.text=t.contentdata.fields.title||t.contentdata.fields.subtitle,"text_subtitle"===e.type?(t.contentdata.fields.elementType={value:"h3"},delete t.contentdata.fields.subtitle):(t.contentdata.fields.elementType={value:"h2"},lab_api.v1.util.object.set("attributes.text_size.vp.desktop",lab_api.v1.util.object.get("attributes.text_size.vp.desktop",t.contentdata.fields.text)||44,t.contentdata.fields.text),delete t.contentdata.fields.title),t.lab_internal_format=!0,t}}};(labradorView=void 0===labradorView?{}:labradorView).baseview=t})();