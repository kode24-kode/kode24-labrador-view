var labradorView;(()=>{"use strict";var e={d:(t,i)=>{for(var s in i)e.o(i,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:i[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{Entry:()=>Ee,behaviours:()=>i});var i={};e.r(i),e.d(i,{adnuntiusAd:()=>y,apsis_submit:()=>v,article:()=>F,articleCalendar:()=>S,articleFooter:()=>T,articleHeader:()=>C,articleList:()=>x,articleMeta:()=>D,articlesByTag:()=>$,articlescroller:()=>I,bodytext:()=>E,byline:()=>A,changelog:()=>P,chart:()=>ke,comments:()=>O,factbox:()=>j,frontContent:()=>q,front_rows:()=>L,globalChangelog:()=>z,googleAd:()=>N,googleCSE:()=>H,graphic:()=>W,grid:()=>we,image:()=>B,jwplayer:()=>pe,labradorSearch:()=>V,livefeed:()=>ve,markup:()=>G,mobiltests:()=>Q,motortests:()=>K,newsletter_submit:()=>Z,notice:()=>ye,noticeHeader:()=>_e,page_article:()=>h,page_front:()=>f,page_notice:()=>b,parallax:()=>X,remoteproduction:()=>ue,row:()=>me,scrollbox:()=>fe,simplestream:()=>ee,slideshow:()=>te,tablebox:()=>se,tagboard:()=>ae,text_multiline:()=>ne,timeline:()=>be,tips_box:()=>oe,topcomments:()=>he,toplist:()=>re,tvguide:()=>le,twitter:()=>de,userFeedback:()=>ce,vimond:()=>Fe,youtube:()=>ge});class s{static getSiteStyles(e,t=[]){const i=lab_api.v1.config.get(`site_styles.${e}`)||t;return Sys.logger.debug(`ViewSupport: Found ${Array.isArray(i)?i.length:0} stylesheet(s) for site "${e}".`),i}static getSiteStylesWithFallback(e,t=[]){const i=this.getSiteStyles(e,null);if(null===i){t.push(e);const i=lab_api.v1.config.get("lab_fallback_site",{site:e});if(i&&!t.includes(i))return this.getSiteStylesWithFallback(i,t)}return i||[]}static getSiteScripts(e,t,i){const s=this.filterScriptListByPageType(lab_api.v1.config.get(`site_scripts.${e}`)||[],t,i);return Sys.logger.debug(`ViewSupport: Found ${s.length} script-path(s) for site "${e}".`),s}static getSiteScriptsWithFallback(e,t,i,s=[]){let a=this.getSiteScripts(e,t,i);if(s.length&&(a=this.removeWithInheritFalse(a)),!a.length){s.push(e);const a=lab_api.v1.config.get("lab_fallback_site",{site:e});if(a&&!s.includes(a))return this.getSiteScriptsWithFallback(a,t,i,s).filter((e=>!1!==e.inherit))}return a}static getCommonScripts(e,t,i=!1){const s=this.filterScriptListByPageType(lab_api.v1.config.get("site_scripts_common")||[],e,t,i);return Sys.logger.debug(`ViewSupport: Found ${s.length} common ${i?"script-path(s)":"JS modules"}`),s}static filterScriptListByPageType(e,t,i,s=!1){return e.filter((e=>(!e.isModule&&!s||e.isModule&&s)&&(!e.pageType||e.pageType===t)&&(!i||i&&!e.skipEditor)))}static removeWithInheritFalse(e){return Array.isArray(e)&&e.length>0?e.filter((e=>!1!==e.inherit)):e}static getSiteFilesForContentboxes(e,t,i,s=[]){const a=[],n=lab_api.v1.model.query.getModelTypes();Sys.logger.debug(`ViewSupport sitefiles: Will register ${i}-file(s) for contentbox-types ${n.join(", ")}.`);for(const e of n){const t=lab_api.v1.config.get(`contentbox_settings.${e}.require.${i}`);if(Array.isArray(t))for(const n of t)a.includes(n)||s.includes(n)||(Sys.logger.debug(`ViewSupport sitefiles: Will include ${i}-file "${n}" for contentbox "${e}".`),a.push(n))}return Sys.logger.debug(`ViewSupport sitefiles: Finished registering ${i}-file(s). Found ${a.length} file(s).`),a}}class a{constructor(e){this.api=e,this.pageType=this.api.v1.model.root.getType()}get media(){return{getLogo:(e=this.api.v1.viewport.getName())=>{const t=this.api.v1.config.get("logo")||{},i=t.uploadedFileUrl?{src:t.uploadedFileUrl,href:t.default.href,type:"img",size:{width:t.logoWidth},title:t.default.title,isCustom:!0}:t[e]||t.default||null;return i&&("img"===i.type?i.is_img=!0:"svg"===i.type&&(i.is_svg=!0)),{current:i,sm:t.uploadedFileUrl?{src:t.uploadedFileUrl,href:t.default.href,size:{width:t.logoWidth},title:t.default.title,isCustom:!0}:t.standalone||t.mailmojo||null,mm:t.uploadedMailmojoFileUrl?{src:t.uploadedMailmojoFileUrl,href:t.default.href,size:{width:t.mailmojoLogoWidth},title:t.default.title,isCustom:!0}:t.mailmojo||t.standalone||null}}}}get menus(){return{get:({section:e,defaultSection:t}={},i)=>{const s={},a=Object.values(this.api.v1.config.get("menus")||{});if(a.length<1)return null;const n=i=>{i.forEach((i=>{i.selected=i.section===e||i.section===t,"target"in i||(i.target="_self"),"selector"in i||(i.selector=""),"children"in i||(i.children=[]),i.children.length>0&&(i.hasChildren=!0,n(i.children))}))};return a.forEach((e=>{n(e.menuItems);const t=e.type||e.menuName;s[t]={items:e.menuItems,type:e.type,selector:e.selector||""}})),i?s[i]:s}}}get misc(){return{}}get resources(){const e={required:[],getProgressReader:()=>(e.required.push({url:"/view-resources/public/common/ReadProgress.js",requireDom:!1}),{active:!0,minElementCount:lab_api.v1.config.get("displayReadProgress.minElementCount")||25}),getSiteFiles(t,i,a,n,o){const r=s.getSiteScriptsWithFallback(a,n,o),l=s.getCommonScripts(n,o);return e.required.push(...r,...l),{js:s.getSiteFilesForContentboxes(t,i,"js",e.required.map((e=>e.url))),css:s.getSiteFilesForContentboxes(t,i,"css")}},getModules:(e,t,i,a,n)=>s.getCommonScripts(a,n,!0)},t={get:e=>{const i=(lab_api.v1.config.get("analytics.kilkaya")||[]).map((e=>{const t={...e};return t.id&&"string"==typeof t.id&&t.id.trim().endsWith(".js")&&(t.url=t.id),t}));let s=this.api.v1.config.get("analytics.adnuntiusConnect");s&&"object"==typeof s&&!Array.isArray(s)&&Object.keys(s).length&&(s=new Array(s));const a={google:this.api.v1.config.get("analytics.google.tracking_id"),google_gtm:this.api.v1.config.get("analytics.google.gtm"),comscore:this.api.v1.config.get("analytics.comscore.comscore_id"),adnuntiusConnect:s,adnuntiusConnectCMP:this.api.v1.config.get("analytics.adnuntiusConnectCMP"),kilkaya:i,kilkayaSettings:this.api.v1.config.get("analytics.kilkayaSettings"),io:this.api.v1.config.get("analytics.io.tracking_id")},n=t.getDataLayer(e);return n.dataLayer&&(a.dataLayer=n.dataLayer),n.usesJWTCookieData&&(a.usesJWTCookieData=n.usesJWTCookieData),a},getDataLayer:e=>{const t=this.api.v1.config.get("analytics.google.dataLayer");let i=!1;if(t&&Array.isArray(t)&&t.length){t.forEach((t=>{let s=null;switch(t.source){case"fixed":s=(t.value||"").trim();break;case"config":s=this.api.v1.properties.get(t.value);break;case"jwtcookie":t.isJWTCookie=!0,s=t.value,i=!0;break;case"article_authors":s=`${(e.bylinesStringCommaSeparated||"").replace(/"/g,"")}`;break;case this.pageType.replace("page_",""):s=this.api.v1.model.query.getRootModel().get(t.value);break;default:Sys.logger.warn(`Unsupported dataLayer source: "${t.source}"`)}t.value=null===s?"":s.toString()}));const s=t.map((e=>e.value.length>0)).lastIndexOf(!0);t[s]&&(t[s].last=!0)}return{dataLayer:t,usesJWTCookieData:i}}};return{scripts:e,analytics:t}}get settings(){return{get:(e={})=>{const t=this.api.v1.config.get(`page_settings.${e.pageType}.social.display`)||{},i=this.api.v1.model.query.getRootModel().get("fields.show_social_bodytext_before"),s=this.api.v1.model.query.getRootModel().get("fields.show_social_bodytext_after"),a=this.api.v1.model.query.getRootModel().get("fields.show_social_header");null!==i&&(t.bodytext_before=!!i),null!==s&&(t.bodytext_after=!!s),null!==a&&(t.header=!!a);const n=this.api.v1.config.get(`page_settings.${e.pageType}.social.items`)||{},o=this.api.v1.config.get(`page_settings.${e.pageType}.showTags`),r=Object.keys(n).filter((e=>!!n[e].display)).map((t=>({name:t,icon:n[t].icon||"",url:e.socialLinks[t]||"",shareText:n[t].shareText||"",isButton:n[t].isButton||!1})));return{page_type:e.pageType,social:{display:{bodytext_before:r.length>0&&!!t.bodytext_before,bodytext_after:r.length>0&&!!t.bodytext_after,header:r.length>0&&!!t.header},items:r},showTags:!1!==o}}}}}class n{static getStyleDefinitions(e){const t=e.v1.properties.get("site.alias"),i=e.v1.config.get("style_definitions",t),s=[];(i.rules||[]).forEach((e=>s.push(e))),(i.fontface||[]).forEach((e=>{const t=`.font-${e.family.replace(/ /g,"")}`;s.push(n.getFamilyDefinition(t,e.family));const i={light:{keys:["light","200","100","300"],used:!1},normal:{keys:["regular","normal","400","500"],used:!1},bold:{keys:["bold","600","700"],used:!1},black:{keys:["black","800","900"],used:!1}};e.variants.forEach((e=>{for(const a of Object.keys(i)){const o=i[a];o&&!o.used&&o.keys.indexOf(e)>-1&&(s.push(n.getWeightDefinition(t,e,a)),o.used=!0)}}))}));const a={fontface:i.fontface||[],parsedRules:n.CSSRuleParser(s)};return a.hasRules=!!a.parsedRules.length,a}static getFamilyDefinition(e,t){return{selector:e,declarations:[{key:"font-family",value:`"${t}" !important`}]}}static getWeightDefinition(e,t,i){let s=t;return"regular"===t&&(s="normal"),{selector:`${e}.font-weight-${i}`,declarations:[{key:"font-weight",value:`${s} !important`}]}}static CSSRuleParser(e){const t=[];return e.forEach((e=>{let i,s,a=`${e.selector} { `;e.declarations.forEach((e=>{"font-size-desktop"===e.key?"default"!==e.value&&(a+=`font-size: ${e.value.slice(0,-2)/16}rem; `):"font-size-mobile"===e.key?"default"!==e.value&&(i=`calc(0.262vw * ${e.value.slice(0,-2)})`):"line-height-desktop"===e.key?"default"!==e.value&&(a+=`line-height: ${e.value}; `):"line-height-mobile"===e.key?"default"!==e.value&&(s=e.value):"font-family"===e.key?e.value.includes("!important")?a+=`${e.key}: ${e.value}; `:a+=`${e.key}: "${e.value}"; `:a+=`${e.key}: ${e.value}; `})),a+="}",(i||s)&&(a+=`@media (max-width: 767px) { .resp_fonts ${e.selector} {`,i&&(a+=`font-size: ${i}; `),s&&(a+=`line-height: ${s}; `),a+="} }"),t.push(a)})),t}static getInlineCSS(e,t){return[{key:"custom_properties",value:e.v1.config.get("css_build.custom_properties",{site:t})||""},{key:"background_colors",value:e.v1.config.get("css_build.background_colors",{site:t})||""},{key:"background_colors_opacity",value:e.v1.config.get("css_build.background_colors_opacity",{site:t})||""},{key:"border_colors",value:e.v1.config.get("css_build.border_colors",{site:t})||""},{key:"font_colors",value:e.v1.config.get("css_build.font_colors",{site:t})||""},{key:"image_gradient",value:e.v1.config.get("css_build.image_gradient",{site:t})||""}]}static getCssVariables(e){const t=e.v1.config.get("custom_css_variables")||{},i={no_viewport:[],desktop:[],mobile:[]};for(const e of Object.keys(t))for(const s of Object.keys(t[e]))i[s].push({key:e,value:(t[e][s]||{}).value});return i}}const o={sunday:{en:"sunday",sv:"söndag",dk:"søndag",no:"søndag",nl:"zondag",kl:"sapaat"},monday:{en:"monday",sv:"måndag",dk:"mandag",no:"mandag",nl:"maandag",kl:"ataasinngorneq"},tuesday:{en:"tuesday",sv:"tisdag",dk:"tirsdag",no:"tirsdag",nl:"dinsdag",kl:"marlunngorneq"},wednesday:{en:"wednesday",sv:"onsdag",dk:"onsdag",no:"onsdag",nl:"woensdag",kl:"pingasunngorneq"},thursday:{en:"thursday",sv:"torsdag",dk:"torsdag",no:"torsdag",nl:"donderdag",kl:"sisamanngorneq"},friday:{en:"friday",sv:"fredag",dk:"fredag",no:"fredag",nl:"vrijdag",kl:"tallimanngorneq"},saturday:{en:"saturday",sv:"lördag",dk:"lørdag",no:"lørdag",nl:"zaterdag",kl:"arfininngorneq"},january:{en:"January",sv:"januari",dk:"januar",no:"januar",nl:"januari",kl:"ukiortaarsiorneq"},february:{en:"February",sv:"februari",dk:"februar",no:"februar",nl:"februari",kl:"ukiortaami"},mars:{en:"March",sv:"mars",dk:"marts",no:"mars",nl:"maart",kl:"marsi"},april:{en:"April",sv:"april",dk:"april",no:"april",nl:"april",kl:"apriili"},may:{en:"May",sv:"maj",dk:"maj",no:"mai",nl:"mei",kl:"maajii"},june:{en:"June",sv:"juni",dk:"juni",no:"juni",nl:"juni",kl:"juuni"},july:{en:"July",sv:"juli",dk:"juli",no:"juli",nl:"juli",kl:"juuli"},august:{en:"August",sv:"augusti",dk:"august",no:"august",nl:"augustus",kl:"aggusti"},september:{en:"September",sv:"september",dk:"september",no:"september",nl:"september",kl:"septembari"},october:{en:"October",sv:"oktober",dk:"oktober",no:"oktober",nl:"oktober",kl:"oktobari"},november:{en:"November",sv:"november",dk:"november",no:"november",nl:"november",kl:"novembari"},december:{en:"December",sv:"december",dk:"december",no:"desember",nl:"december",kl:"decembari"},ago:{en:"ago",sv:"sedan",dk:"siden",no:"siden",nl:"geleden",kl:"matuma siorna"},now:{en:"now",sv:"nu",dk:"nu",no:"nå",nl:"nu",kl:"maanna"},min:{en:"min"},minutes:{en:"minutes",sv:"minuter",dk:"minutter",no:"minutter",nl:"minuten",kl:"minutsi"},hour:{en:"hour",sv:"timme",dk:"time",no:"time",nl:"uur",kl:"akunnera"},hours:{en:"hours",sv:"timmar",dk:"timer",no:"timer",nl:"uren",kl:"akunnerit"},day:{en:"day",sv:"dag",dk:"dag",no:"dag",nl:"dag",kl:"ulloq"},days:{en:"days",sv:"dagar",dk:"dage",no:"dager",nl:"dagen",kl:"ullut"},monthdayyear:{en:"{{MMMM}} {{DD}}. {{YYYY}}",sv:"{{DD}}/{{MM}} {{YYYY}}",dk:"{{DD}}/{{MM}} {{YYYY}}",no:"{{DD}}/{{MM}} {{YYYY}}",nl:"{{DD}}/{{MM}} {{YYYY}}"},hourminute:{en:"{{HH}}:{{mm}}"}};class r{constructor(e="en",t="en"){this.fallbackLanguage=t,this.language=e||t,this.words=o,this.timezone=this.getTimezone()}getTimezone(){const e=lab_api.v1.config.get("timezone");return void 0===e||Number.isNaN(e)||Number.isNaN(parseFloat(e))?1:parseInt(e,10)}str(e){let{language:t}=this;return e in this.words?(t in this.words[e]||(t=this.fallbackLanguage),t in this.words[e]?this.words[e][t]:null):null}format(e,t){return Mustache.render(t,{YYYY:()=>e.getFullYear(),YY:()=>`${e.getFullYear()}`.slice(-2),MM:()=>(e.getMonth()<9?"0":"")+(e.getMonth()+1),M:()=>e.getMonth()+1,D:()=>e.getDate(),DD:()=>(e.getDate()<10?"0":"")+e.getDate(),H:()=>e.getHours(),HH:()=>(e.getHours()<10?"0":"")+e.getHours(),m:()=>e.getMinutes(),mm:()=>(e.getMinutes()<10?"0":"")+e.getMinutes(),s:()=>e.getSeconds(),ss:()=>(e.getSeconds()<10?"0":"")+e.getSeconds(),dddd:()=>this.weekday(e,!1),ddd:()=>this.weekday(e,!1,3),MMMM:()=>this.monthName(e,!1),MMM:()=>this.monthName(e,!1,3),W:()=>this.weekNumber(e,!0,!0),WW:()=>this.weekNumber(e,!0,!1)})}utcFormat(e,t){const i=this.correctDate(e);return Mustache.render(t,{YYYY:()=>i.getUTCFullYear(),YY:()=>`${i.getUTCFullYear()}`.slice(-2),MM:()=>(i.getUTCMonth()<9?"0":"")+(i.getUTCMonth()+1),M:()=>i.getUTCMonth()+1,D:()=>i.getUTCDate(),DD:()=>(i.getUTCDate()<10?"0":"")+i.getUTCDate(),H:()=>i.getUTCHours(),HH:()=>(i.getUTCHours()<10?"0":"")+i.getUTCHours(),m:()=>i.getUTCMinutes(),mm:()=>(i.getUTCMinutes()<10?"0":"")+i.getUTCMinutes(),s:()=>i.getUTCSeconds(),ss:()=>(i.getUTCSeconds()<10?"0":"")+i.getUTCSeconds(),dddd:()=>this.weekday(i,!0),ddd:()=>this.weekday(i,!0,3),MMMM:()=>this.monthName(i,!0),MMM:()=>this.monthName(i,!0,3),W:()=>this.weekNumber(i,!0,!0),WW:()=>this.weekNumber(i,!0,!1)})}formattedDate(e,t,i=!0,s=!0){let a=t||"";return a=a.replace("Y",e.getFullYear()),a=a.replace("m",(i&&e.getMonth()<9?"0":"")+(e.getMonth()+1)),a=a.replace("d",(i&&e.getDate()<10?"0":"")+e.getDate()),a=a.replace("H",(s&&e.getHours()<10?"0":"")+e.getHours()),a=a.replace("i",(s&&e.getMinutes()<10?"0":"")+e.getMinutes()),a=a.replace("s",e.getSeconds()),a=a.replace("l",this.weekday(e,!1)),a=a.replace("D",this.weekday(e,!1,3)),a=a.replace("F",this.monthName(e,!1)),a=a.replace("M",this.monthName(e,!1,3)),a}formattedUtcDate(e,t,i=!0,s=!0){const a=this.correctDate(e);let n=t||"";return n=n.replace("Y",a.getUTCFullYear()),n=n.replace("m",(i&&a.getUTCMonth()<9?"0":"")+(a.getUTCMonth()+1)),n=n.replace("d",(i&&a.getUTCDate()<10?"0":"")+a.getUTCDate()),n=n.replace("H",(s&&a.getUTCHours()<10?"0":"")+a.getUTCHours()),n=n.replace("i",(s&&a.getUTCMinutes()<10?"0":"")+a.getUTCMinutes()),n=n.replace("s",a.getUTCSeconds()),n=n.replace("l",this.weekday(a,!0)),n=n.replace("D",this.weekday(a,!0,3)),n=n.replace("F",this.monthName(a,!0)),n=n.replace("M",this.monthName(a,!0,3)),n}correctDate(e){return this.manipulateTime(e,this.isSummerTime(e)?this.timezone+1:this.timezone)}utcDate(e){return this.unmanipulateTime(e,this.isSummerTime(e)?this.timezone+1:this.timezone)}timestampToDate(e){return new Date(1e3*e)}toTimestamp(e){return Math.round(e.getTime()/1e3)}parseDate(e){const t=e.substr(0,4),i=e.substr(4,2)-1,s=e.substr(6,2),a=new Date(t,i,s),n=a.getFullYear()==t,o=a.getMonth()==i,r=a.getDate()==s;return n&&o&&r?a:"invalid date"}weekday(e,t=!1,i=9){return([this.str("sunday"),this.str("monday"),this.str("tuesday"),this.str("wednesday"),this.str("thursday"),this.str("friday"),this.str("saturday")][t?e.getUTCDay():e.getDay()]||"").substr(0,i)}monthName(e,t=!1,i=10){return([this.str("january"),this.str("february"),this.str("mars"),this.str("april"),this.str("may"),this.str("june"),this.str("july"),this.str("august"),this.str("september"),this.str("october"),this.str("november"),this.str("december")][t?e.getUTCMonth():e.getMonth()]||"").substr(0,i)}weekNumber(e,t=!1,i=!0){const s=new Date(e.valueOf()),a=((t?e.getUTCDay():e.getDay())+6)%7;s.setDate(s.getDate()-a+3);const n=s.valueOf();s.setMonth(0,1),4!==s.getDay()&&s.setMonth(0,1+(4-s.getDay()+7)%7);const o=1+Math.ceil((n-s)/6048e5);return(!i&&o<10?"0":"")+o}timestampToNiceDate(e,t=!1){const i={ago:t?"":this.str("ago"),now:this.str("now"),minute:t?this.str("min"):this.str("minutes"),minutes:t?this.str("min"):this.str("minutes"),hour:this.str("hour"),hours:this.str("hours"),day:this.str("day"),days:this.str("days")},s=(new Date).getTime(),a=new Date(1e3*e).getTime()-0,n=parseInt((s-a)/1e3/60,10);return n<60?n<1?i.now:1==n?`1 ${i.minute} ${i.ago}`:`${n} ${i.minutes} ${i.ago}`:n<1440?1==parseInt(n/60,10)?`1 ${i.hour} ${i.ago}`:`${parseInt(n/60,10)} ${i.hours} ${i.ago}`:parseInt(n/1440,10)<30?1==parseInt(n/1440,10)?`1 ${i.day} ${i.ago}`:`${parseInt(n/1440,10)} ${i.days} ${i.ago}`:this.format(this.timestampToDate(e),this.str("monthdayyear"))}isSummerTime(e){function t(e,t){const i=new Date,s=new Date(Date.UTC(t||i.getFullYear(),e+1,0)),a=s.getDay();return new Date(Date.UTC(s.getFullYear(),s.getMonth(),s.getDate()-a))}const i=e||new Date,s=t(2,i.getFullYear());s.setHours(1);const a=t(9,i.getFullYear());return s.setHours(1),i.getTime()>=s.getTime()&&i.getTime()<a.getTime()}manipulateTime(e,t){return new Date(e.getTime()+60*t*60*1e3)}unmanipulateTime(e,t){return new Date(e.getTime()-60*t*60*1e3)}}class l{static getAdnuntiusSettings(e,t,i,s,a,n=!1,o=!1){const l=(e.v1.config.get("contentbox_settings.adnuntiusAd.bidding")||{}).enabled||!1;function d(e,t){let i="";return l&&e.prebidConfig&&(i=JSON.parse(e.prebidConfig),Array.isArray(i)&&([i]=i),i=JSON.stringify(i)),{...e,prebidConfig:i,metadata:t.metadata||[]}}const c=e.v1.config.get("contentbox_settings.adnuntiusAd.formats")||[],g=e.v1.config.getView(`insertDynamic.${e.v1.model.root.getType().replace("page_","")}.${i.getViewport()}`,a.alias)||[],p=e.v1.model.query.getChildrenOfType(t,"adnuntiusAd",!0,!0),u=[];for(const e of g){const[t]=c.filter((t=>e.content_data.fields.format===t.format));t&&(!1===e.placement.key.includes("skyscraper_")&&"topbanner"!==e.placement.key||e.placement.key.includes("skyscraper_")&&!n||"topbanner"===e.placement.key&&!o)&&u.push(d(t,e))}for(const e of p){const[t]=c.filter((t=>e.get("fields.format")===t.format));t&&u.push(d(t,e))}const h=(new r).utcFormat(new Date,"&tag=week_{{ W }}_{{ YYYY }}");return{enabled:c.length>0,lazyload:e.v1.config.get("contentbox_settings.adnuntiusAd.lazyload")||!1,adUnits:u,spacingTop:e.v1.config.get("contentbox_settings.adnuntiusAd.spacingTop")||120,fetchMarginPercent:s.fetchMarginPercent||150,renderMarginPercent:s.renderMarginPercent||150,bidding:{enabled:l},hideOnTabletWidth:s.hideOnTabletWidth||1316,refreshdelay:e.v1.config.get("contentbox_settings.adnuntiusAd.refreshdelay")||5,refreshcount:e.v1.config.get("contentbox_settings.adnuntiusAd.refreshcount")||1,connectLoading:e.v1.config.get("contentbox_settings.adnuntiusAd.connectLoading")||!1,contkitEnabled:e.v1.config.get("contentbox_settings.adnuntiusAd.contkitEnabled")||!1,newsletter:{targeting:h}}}static getGoogleSettings(e,t,i,s,a,n=!1,o=!1){function r(e,t){const{sizes:i=[]}=e;return{...e,sizesString:`[${i.map((e=>`[${e.width},${e.height}]`)).join(", ")}]`,metadata:t.metadata||[]}}const l=e.v1.config.get("contentbox_settings.googleAd.formats")||[],d=e.v1.config.get("contentbox_settings.googleAd.anchor")||{enabled:!1,code:"",type:"TOP_ANCHOR"},c=e.v1.config.getView(`insertDynamic.${e.v1.model.root.getType().replace("page_","")}.${i.getViewport()}`,a.alias)||[],g=e.v1.model.query.getChildrenOfType(t,"googleAd",!0,!0),p=[];for(const e of c){const[t]=l.filter((t=>e.content_data.fields.format===t.format));t&&(!1===e.placement.key.includes("skyscraper_")&&"topbanner"!==e.placement.key||e.placement.key.includes("skyscraper_")&&!n||"topbanner"===e.placement.key&&!o)&&p.push(r(t,e))}for(const e of g){const[t]=l.filter((t=>e.get("fields.format")===t.format));t&&p.push(r(t,e))}return{enabled:l.length>0,lazyload:s.lazyload||!1,spacingTop:e.v1.config.get("contentbox_settings.googleAd.spacingTop")||120,fetchMarginPercent:s.fetchMarginPercent||150,renderMarginPercent:s.renderMarginPercent||150,adUnits:p,anchor:d,dfpid:s.dfpid||!1,debugmode:s.debugmode||!1,disableInitialLoad:s.disableInitialLoad||!1,bidding:s.bidding,hideOnTabletWidth:s.hideOnTabletWidth||1316}}}class d{constructor({pageType:e="",canonical:t="",isTagpage:i=!1,isTagpageWithFrontpage:s=!1,tagpagePath:a="/tag/"}={}){this.settings={pageType:e,canonical:t,isTagpage:i,isTagpageWithFrontpage:s,tagpagePath:a},this.cache={seoData:null}}getStructuredData(e){return e.get("fields.jsonld_json")?e.get("fields.custom_jsonld"):"front"===this.settings.pageType?this.generateFrontData(e):"article"===this.settings.pageType||"notice"===this.settings.pageType?this.generateArticleData(e):null}generateSiteData(e){return{"@context":"http://schema.org","@type":"WebSite",name:lab_api.v1.properties.get("site.display_name"),url:lab_api.v1.properties.get("site.domain")||""}}generateFrontData(e){const t=this.getSEOData(e);return{"@context":"https://schema.org","@type":"WebPage",name:t.title,description:t.description}}generateArticleData(e){const t=this.getSEOData(e),i={"@context":"https://schema.org","@type":"NewsArticle",headline:t.title||e.get("fields.title"),description:t.description,availableLanguage:[{"@type":"Language",alternateName:t.language}],images:lab_api.v1.model.query.getChildrenOfType(e,"image",!0).map((e=>(e.get("fields.imageurl")||"").includes("width=")?`${e.get("fields.imageurl")}1200`:`${e.get("fields.imageurl")}&width=1200`)),author:lab_api.v1.model.query.getChildrenOfType(e,"byline",!0).map((e=>{let t=e.get("fields.firstname");"Byline first name"===t&&(t="");let i=e.get("fields.lastname");"Byline last name"===i&&(i="");const s={"@type":"Person",name:`${t} ${i}`},a=e.get("fields.public_url");a&&(s.url=a);const n=(e.children||[]).filter((e=>"image"===e.type))[0];n&&(s.image={"@type":"ImageObject",url:`${n.get("fields.imageurl")}&width=250`});const o=e.get("fields.public_email");return o&&(s.email=o),s})),publisher:{"@type":"Organization",name:lab_api.v1.properties.get("site.display_name"),logo:{"@type":"ImageObject",url:lab_api.v1.config.get("logo.default.src")}}};return e.get("fields.published")&&(i.datePublished=new Date(1e3*parseInt(e.get("fields.published"),10)).toISOString()),e.get("fields.modified")&&(i.dateModified=new Date(1e3*parseInt(e.get("fields.modified"),10)).toISOString()),"1"===e.get("fields.paywall")&&(i.isAccessibleForFree=!0,i.hasPart={"@type":"WebPageElement",isAccessibleForFree:!1,cssSelector:".teaserContent"}),i}getSEOData(e){if(this.cache.seoData)return this.cache.seoData;let t,i,s;if("article"===this.settings.pageType||"notice"===this.settings.pageType)i=lab_api.v1.util.string.sanitizeString(e.get("fields.seotitle")||e.get("fields.title")||""),s=lab_api.v1.util.string.sanitizeString(e.get("fields.seodescription")||e.get("fields.subtitle")||""),t=e.get("fields.seolanguage")||lab_api.v1.config.get("contentLanguage");else{if(this.settings.isTagpage&&!this.settings.isTagpageWithFrontpage){const e=this.settings.tagpagePath.replace(/\//g,""),t=(this.settings.canonical.split(this.settings.tagpagePath)[1]||"").split("/").filter((e=>!!e)),s={tag:t[t.length-1],tags:t,tagPath:e};i=lab_api.v1.locale.get("tags.title_text",{data:s})}else i=lab_api.v1.util.string.sanitizeString(e.get("fields.seotitle")||e.get("fields.name")||"");s=lab_api.v1.util.string.sanitizeString(e.get("fields.seodescription")||"")}return this.cache.seoData={title:i.charAt(0).toUpperCase()+i.slice(1),description:s,language:t},this.cache.seoData}}class c{static prepareForTemplate(e,t,i){const s={meta:{head_top:[],head_bottom:[]},script:{head_top:[],head_bottom:[],body_top:[],body_bottom:[]},style:{head_top:[],head_bottom:[]},link:{head_top:[],head_bottom:[]}},a=e.filter((e=>!(e.pageType&&e.pageType!==t||e.skipEditor&&i)));for(const e of Object.keys(s))for(const t of Object.keys(s[e]))s.meta[t]=a.filter((e=>"meta"===e.tag)).filter((e=>e.placement===t)).map((e=>this.createCustomTag(e))),s.script[t]=a.filter((e=>"script"===e.tag)).filter((e=>e.placement===t)).map((e=>this.createCustomTag(e))),s.style[t]=a.filter((e=>"style"===e.tag)).filter((e=>e.placement===t)).map((e=>this.createCustomTag(e))),s.link[t]=a.filter((e=>"link"===e.tag)).filter((e=>e.placement===t)).map((e=>this.createCustomTag(e)));return console.log(s),s}static createCustomTag(e){switch(e.tag){case"link":return this.createLinkTag(e);case"script":return this.createScriptTag(e);case"style":return this.createStyleTag(e);default:return this.createMetaTag(e)}}static fetchDynamicAttribute(e){return lab_api.v1.view.render({model:lab_api.v1.model.query.getRootModel(),template:e})||null}static parseAttributes(e){return e.filter((e=>!!e.key)).map((e=>e.value?`${e.key}="${e.value.match(/\{\{.*\}\}/g)?this.fetchDynamicAttribute(e.value):e.value}"`:e.key)).join(" ")}static parseVariables(e){return e.replace(/\{\{\{?.*?\}\}\}?/g,this.fetchDynamicAttribute)}static createLinkTag(e){return`<link ${this.parseAttributes(e.attributes)}>`}static createScriptTag(e){return`<script ${this.parseAttributes(e.attributes)}>${e.value?this.parseVariables(e.value):""}<\/script>`}static createMetaTag(e){return`<meta ${this.parseAttributes(e.attributes)}>`}static createStyleTag(e){return`<style ${this.parseAttributes(e.attributes)}>${e.value?this.parseVariables(e.value):""}</style>`}}class g{static buildConfig(e){return{viewConfig:{config:{customer:{paywall:{label:lab_api.v1.config.get("paywall.label")||{}},image:{defaultAspectRatio:lab_api.v1.config.get("image.defaultAspectRatio")||void 0}}}}}}}class p{constructor(e,t){this.api=e,this.page=t}set(e,t){const i=this.export(e,t);for(const t of Object.keys(i))e.setFiltered(t,i[t])}export(e,t){const i={},a=new Date,o=t.get("type").replace("page_",""),r=t.get("id"),p=this.api.v1.site.getSite().domain||this.api.v1.properties.get("customer_front_url"),u=p+t.get("fields.published_url"),h=encodeURIComponent(u),f=this.api.v1.properties.get("image_server"),m=this.api.v1.app.mode.isEditor(),b=this.getCanonicalUrl(e,o,r,p),y=this.api.v1.config.get("tagPagePath")||"/tag/",v="front"===o&&(u.endsWith(y.slice(0,-1))||u.indexOf(y)>-1),_=v&&!u.endsWith(y.slice(0,-1));i.customer_front_url=p,i.isEditMode=m,i.url=u,i.urlEncoded=h,i.specificUrl=b,i.image_server=f,i.pageType=o,i.pageId=r,i.is_article="article"===o,i.is_notice="notice"===o,i.is_front="front"===o,i.section=t.get("primaryTags.section")||t.get("fields.defaultsection"),i.device=this.api.v1.viewport.getName(),i.cmsVersion=this.api.v1.properties.get("app.version"),i.front_api_url=this.api.v1.properties.get("front_api_url"),i.xUaDevice=this.api.v1.properties.get("xUaDevice"),i.favicons=this.api.v1.config.get("favicons"),i.faviconList=this.api.v1.config.get("faviconList"),i.skipDefaultFont=this.api.v1.config.get("skipDefaultFont"),i.isDebug=this.api.v1.util.request.hasQueryParam("debug"),i.staticUrl=this.getStaticUrl(e,o,r,p),i.customMetatags=this.getCustomMetatags(),i.customTags=c.prepareForTemplate(this.api.v1.config.get("customTags")||[],o,m),i.footerSettings=this.api.v1.config.get("page_settings.footer"),i.rssDescriptionPrefix=this.api.v1.config.get("viewports.rss.descriptionPrefix"),i.is_tagpage=v,i.contentLanguage=lab_api.v1.config.get("contentLanguage");const k=this.page.media.getLogo(t.getViewport());i.logo=k.current,i.logo_sm=k.sm,i.logo_mm=k.mm,i.misc=this.api.v1.config.get("misc");const w={active:!1,lang:this.api.v1.config.get("google_translate")};w.lang&&Array.isArray(w.lang)&&w.lang.length&&(w.active=!0),i.google_translate=w;const F=new d({pageType:o,canonical:b,isTagpage:v,isTagpageWithFrontpage:_,tagpagePath:y}),S=F.generateSiteData(e),T=F.getStructuredData(e);i.jsonld=JSON.stringify([S,T]);const C=F.getSEOData(e);if(i.seotitle=C.title,i.seodescription=C.description,i.seolanguage=C.language,"article"===o||"notice"===o){const t=e.get("fields.sometitle")||e.get("fields.teaserTitle")||e.get("fields.title");t&&(i.sometitle=this.api.v1.util.string.stripTags(t));const s=e.get("fields.somedescription")||e.get("fields.teaserSubtitle")||e.get("fields.subtitle");if(s&&s.length>0)i.somedescription=this.api.v1.util.string.stripTags(s);else{let t=e.get("fields.bodytext")||"";t=this.api.v1.util.string.stripTags(t),i.somedescription=`${t.substring(0,100)} ...`}}else if("front"===o){const t=e.get("fields.someimage");null!=t&&""!==t&&(i.someimage=`${f}/${t}.webp?width=1200&height=630`),i.sometitle=e.get("fields.sometitle")||e.get("fields.name"),i.somedescription=e.get("fields.somedescription")||""}if(i.social={facebook:`https://www.facebook.com/sharer.php?u=${h}`,twitter:`https://twitter.com/intent/tweet?url=${h}`,mail:`mailto:?subject=${encodeURIComponent(this.api.v1.util.string.stripTags(t.get("fields.title")))}&body=${encodeURIComponent(this.api.v1.util.string.stripTags(t.get("fields.subtitle")))}%0D${h}`,linkedin:`https://www.linkedin.com/sharing/share-offsite/?url=${h}`,threads:`https://threads.net/intent/post?text=${h}`,copyLink:`navigator.clipboard.writeText("${u}");`,glimta:`https://glimta.com/unlock?link=${h}`,talandeWebb:"ReachDeck.panel.toggleBar();",bluesky:`https://bsky.app/intent/compose?text=${encodeURIComponent(`${i.sometitle}\n`)}${h}`},"article"===o){const t=this.api.v1.config.get("page_settings.article.ignoredTags")||[],s=this.api.v1.config.get("page_settings.article.ignoredTagPrefix")||[],a=(e.get("tags")||[]).filter((e=>!t.includes(e))).filter((e=>{for(const t of s)if(e.startsWith(t))return!1;return!0}));i.tagsString=a.toString();let n="";a.forEach(((e,t)=>{n+=`"${e.replace('"',"'")}"`,t<a.length-1&&(n+=", ")})),i.tagsStringCommaSeparated=n;const o=this.api.v1.model.query.getChildrenOfType(e,"byline",!0);if(o){const e=o.map((e=>`"${e.get("fields.firstname")} ${e.get("fields.lastname")}"`)).join(", ");i.bylinesStringCommaSeparated=e}}"article"===o&&e.get("fields.published")&&(i.published=new Date(1e3*parseInt(e.get("fields.published"),10)).toISOString(),i.publishedTimestamp=e.get("fields.published")),i.site=this.api.v1.site.getSite(),i.siteJSON=JSON.stringify(i.site),i["site.domain_no_protocol"]=i.site.domain.split("://").pop(),i.siteAlias=i.site.alias,i.fullUrl=i.site.domain,i[`site_is_${i.siteAlias}`]=!0;const x=this.page.resources;if(!m&&i.is_article&&this.api.v1.config.get("displayReadProgress.active")&&t.get("fields.displayReadProgress")&&(i.readProgress=x.scripts.getProgressReader()),i.siteStylesheetList=s.getSiteStylesWithFallback(i.siteAlias),Sys.logger.debug(`ViewSupport: Will include ${i.siteStylesheetList.length} configured stylesheet(s): "${i.siteStylesheetList.join(", ")}".`),i.siteFiles=x.scripts.getSiteFiles(e,t,i.siteAlias,o,m),i.modules=x.scripts.getModules(e,t,i.siteAlias,o,m),!m){i.analytics=x.analytics.get(i),i.widgets={strossle:this.api.v1.config.get("widgets.strossle.strossle_id")},i.consent={cookieconsent:this.api.v1.config.get("consent.cookieconsent.show"),cookieconsent_culture:this.api.v1.config.get("consent.cookieconsent.culture")||"NB"},this.api.v1.config.get("cookieConsent.enabled")&&x.scripts.required.push({url:"/view-resources/public/common/cookieConsent.js",requireDom:!1}),"desktop"===this.api.v1.viewport.getName()&&t.get("fields.style_slidein")&&(i.style_slidein=!0,x.scripts.required.push({url:"/view-resources/public/common/SlideIn/SlideIn.js",requireDom:!1}));const s=this.api.v1.config.get("adEnvironment")||{},a="1"===t.get("fields.hideAds"),n="1"===t.get("fields.hideSkyscraperAds")||!1,o="1"===t.get("fields.hideTopBannerAd")||!1;if(!a&&s&&"adnuntius"===s.name)try{i.adnuntius=l.getAdnuntiusSettings(this.api,e,t,s,i.site,n,o)}catch(e){Sys.logger.warn(`[PageData] Failed to prepare Adnuntius ads: ${e.toString()}`)}if(!a&&s&&"google"===s.name)try{i.googleAds=l.getGoogleSettings(this.api,e,t,s,i.site,n,o)}catch(e){Sys.logger.warn(`[PageData] Failed to prepare Google ads: ${e.toString()}`)}}if(this.api.v1.util.request.hasQueryParam("fontpreview")&&(i.fontpreview=this.api.v1.util.request.getQueryParam("fontpreview"),i.analytics=null),i.page_settings=this.page.settings.get({pageType:"notice"===o?"article":o,socialLinks:i.social}),"article"===o){const s=this.api.v1.config.get("comments_provider.hideCommentsIfPaywall")||!1,a=this.api.v1.properties.get("paywall")||{},n=lab_api.v1.app.mode.isFront()&&a.active&&!a.hasAccess&&s,l=!1===m&&!1===n;if(t.get("fields.showcomments")&&!n){if(this.api.v1.config.get("comments_provider.facebook")){const e=this.api.v1.config.get("comments_provider.facebook.app_id");e&&(i.facebook={display:l,displayPlaceholder:m,appId:e,pageId:r,url:i.fullUrl+("article"===o?`/a/${r}`:"")},i.displayComments=!0)}if(this.api.v1.config.get("comments_provider.disqus")){const e=this.api.v1.config.get("comments_provider.disqus.enable"),t=this.api.v1.config.get("comments_provider.disqus.script");e&&(i.disqus={display:l,displayPlaceholder:m,canonical:b,pageId:r,script:t},i.displayComments=!0)}const t=this.api.v1.config.get("comments_provider.commento");t&&t.enable&&(i.commento={display:l,displayPlaceholder:m,canonical:b,usePageId:t.usePageId,pageId:r,script:t.script,cssOverride:t.cssOverride,descriptionText:t.descriptionText},i.displayComments=!0);const s=lab_api.v1.config.get("comments_provider.hyvor");if(s&&s.websiteId){const t=e.get("fields.published")||0;i.hyvor={display:l,displayPlaceholder:m,websiteId:s.websiteId,pageId:t>1646908200&&r},s.hidePageIdBeforeDate&&t<s.hidePageIdBeforeDate&&(i.hyvor.pageId=""),i.displayComments=!0}const a=lab_api.v1.config.get("comments_provider.ifragasatt");a&&(i.ifragasatt={display:l,displayPlaceholder:m,customerId:a.customer_id,articleId:`article${r}`},i.displayComments=!0)}}i.menus=this.page.menus.get({defaultSection:t.get("fields.defaultsection"),section:t.get("primaryTags.section")}),i.style_definitions=n.getStyleDefinitions(this.api),i.css_build=n.getInlineCSS(this.api),i.css_variables=n.getCssVariables(this.api),i.contact=this.api.v1.config.get("contact");const D=!!t.get("fields.norobots"),$=t.get("fields.hidefromfp_time"),I=Math.round(a.getTime()/1e3);if(i.norobots=D||$&&$<=I||!1,"article"===o&&this.api.v1.config.get("embeddable.active")&&(i.embeddable={active:!0,display:!!t.get("fields.displayEmbedButton")&&"embed"!==i.device,aboveBodytext:!!t.get("fields.displayEmbedButtonAboveBodytext")&&"embed"!==i.device,isFullContent:this.api.v1.util.request.getQueryString().indexOf("lab_content=full")>-1,hasParallax:this.api.v1.model.query.hasChildOfType(e,"parallax",!0)}),Sys.logger.debug(`ViewSupport: Will include ${x.scripts.required.length} configured script(s): "${x.scripts.required.map((e=>e.url)).join(", ")}".`),x.scripts.required.forEach((e=>{if(!e.placeholderKey&&e.requireDom&&(e.placeholderKey="requireDom"),e.placeholderKey){const{placeholderKey:t}=e;e.placeholderKey={},e.placeholderKey[t]=!0}})),i.siteScriptList=x.scripts.required,i.paywall=this.getPaywallInfo(e,m),i.simplestreamEnabled=lab_api.v1.config.get("contentbox_settings.simplestream")||!1,"mailmojo"===i.device&&this.setDefaultMailmojoData(e,t),"article"===o){const t=lab_api.v1.config.get("page_settings.article.ageWarnings");if(Array.isArray(t)){const i=e.get("fields.published");if(i){const s=this.getAgeWarningItem(i,t);s&&e.setFiltered("ageWarning",s)}}}return i.featureFlags={responsive_mobile_fonts:!lab_api.v1.util.featureFlags.enabled("Disable responsive mobile fonts",o)},i.clientSideConfig=JSON.stringify(g.buildConfig(this.api)),i}getAgeWarningItem(e,t){const i=Object.values(t).filter((e=>!!e.years&&!!e.label)).sort(((e,t)=>t.years-e.years)),s=new Date(1e3*e),a=Date.now()-s,n=new Date(a),o=Math.abs(n.getUTCFullYear()-1970);for(const e of i)if(o>=e.years)return e;return null}setDefaultMailmojoData(e,t){const i=lab_api.v1.config.get("lang")||"no";e.setFiltered("lang",i)}getCanonicalUrl(e,t,i,s){const a=e.get("fields.lab_canonical");if(a)return a;if("front"===t){const t=e.get("fields.hostpath");if(t)return`${s}/${"index"===t?"":t}`}return`${s+e.get("fields.published_url")}`}getStaticUrl(e,t,i,s){if("front"===t){const t=lab_api.v1.util.request.getHeader("X-Labrador-404-Referer");if(t)return`${s}${t}`;const i=e.get("fields.hostpath");return i?`${s}/${"index"===i?"":i}`:`${s+e.get("fields.published_url")}`}return`${lab_api.v1.properties.get("site").domain}/a/${i}`}getCustomMetatags(){const e=lab_api.v1.config.get("customMetatags")||[],t=lab_api.v1.config.get("customMetatagsKeyVal")||[],i=[];for(const t of e){const e=Object.keys(t).map((e=>({key:e,value:t[e]})));i.push(e)}for(const e of t)e.length&&i.push(e);return i}getPaywallInfo(e,t){const i=lab_api.v1.properties.get("paywall"),s=!t&&"1"===e.get("fields.paywall"),a=lab_api.v1.config.get("paywall.provider",{site:lab_api.v1.site.getSite().alias})||"internal",n=(!t&&e.get("fields.paywallSalesImage"),!t&&s&&i.hasAccess&&"1"===e.get("fields.paywallShareable"));let o;if("1"===e.get("fields.paywallShareable")){o=lab_api.v1.config.getConfig("pages.localisation.data.items.paywall.items.shareableArticle.items")||{};for(const e of Object.keys(o))o[e]=lab_api.v1.locale.get(`paywall.shareableArticle.${e}`)||""}return{enabled:s,settings:i,provider:a,shareable:n,shareableArticle:o,hasAccess:!s||!i.active||i.hasAccess,hidePaywallOffers:this.api.v1.util.request.hasQueryValue("lab_opts","paywall_loginonly"),paywallSalesImage:e.get("fields.paywallSalesImage"),paywallSalesPitchContent:e.get("fields.paywallSalesPitchContent"),paywallSalesPitchTitle:e.get("fields.paywallSalesPitchTitle"),paywallLayoutType:e.get("fields.paywallPreview.paywallLayoutType"),requiredProducts:JSON.stringify(this.api.v1.properties.get("app.paywall.requiredProducts")||[])}}}class u{static parseCss(e,t="filtered.autodata"){const i=e.get(t);if(i&&"object"==typeof i)return[Object.values(i.cssObject||{}).join(" "),i.cssString||"",(i.cssArray||[]).join(" ")].join(" ").trim()}static parseAttributes(e){const t=e.get("filtered.autodata.attributesObject");if(t&&"object"==typeof t)return Object.keys(t).map((e=>({key:e,value:t[e]})))}static parseCustomData(e){const t=e.get("filtered.autodata.custom");if(!t||"object"!=typeof t)return;const i={};for(const e of Object.keys(t))i[e]=Object.keys(t[e]).map((i=>({key:i,value:t[e][i]})));return i}static parseCustomDataFromFeed(e,t){const i=lab_api.v1.config.get(`${t}.autodata.mapping`)||{};if(!i||"object"!=typeof i)return;const s={labels:[]};if(i.labels)for(const t of Object.keys(i.labels))e[i.labels[t]]&&s.labels.push({key:t,value:e[i.labels[t]]});return s}}class h{constructor(e){this.api=e,this.pageData=new p(this.api,new a(this.api))}onReady(e,t){this.pageData.set(e,t),e.setFiltered("autodata_css",u.parseCss(e)),e.setFiltered("autodata_attributes",u.parseAttributes(e)),e.setFiltered("autodata_custom",u.parseCustomData(e))}}class f{constructor(e){this.api=e,this.pageData=new p(this.api,new a(this.api))}onReady(e,t){this.pageData.set(e,t)}}class m extends r{constructor({languageCode:e}={}){super("en"),this.languageCode=e||lab_api.v1.config.get("contentLanguage")}str(e,{data:t,noRender:i}={}){return lab_api.v1.locale.get(`dates.${e}`,{data:t,noRender:i})}timestampToNiceDate(e,t=!1){const i=(new Date).getTime(),s=new Date(1e3*e).getTime()-0,a=parseInt((i-s)/1e3/60,10);if(a<60)return a<1?this.str("now"):this.str("durationSince",{data:{count:a,period:t?this.str("min"):1===a?this.str("minute"):this.str("minutes"),ago:t?"":this.str("ago")}});if(a<1440){const e=parseInt(a/60,10);return this.str("durationSince",{data:{count:e,period:1===e?this.str("hour"):this.str("hours"),ago:t?"":this.str("ago")}})}if(parseInt(a/1440,10)<30){const e=parseInt(a/1440,10);return this.str("durationSince",{data:{count:e,period:1===e?this.str("day"):this.str("days"),ago:t?"":this.str("ago")}})}return this.format(this.timestampToDate(e),this.str("monthdayyear",{noRender:!0}))}}class b{constructor(e){this.api=e,this.pageData=new p(this.api,new a(this.api)),this.dateTimeHelper=new m}onReady(e,t){this.pageData.set(e,t);const i=e.get("fields.modified"),s=e.get("fields.published"),a=i||s;if(null!=a){const t=new Date(1e3*a);e.setFiltered("niceDate",this.dateTimeHelper.timestampToNiceDate(a)),e.setFiltered("publishedDate",this.dateTimeHelper.utcFormat(t,`${this.api.v1.locale.get("dates.monthdayyear",{noRender:!0})} ${this.api.v1.locale.get("dates.hourminute",{noRender:!0})}`)),e.setFiltered("isoDate",t.toISOString()),e.setFiltered("date",{published:{isoDate:s?new Date(1e3*s).toISOString():null},modified:{isoDate:i?new Date(1e3*i).toISOString():null}})}if(e.setFiltered("tagPagePath",this.api.v1.config.get("tagPagePath")||"/tag/"),e.get("filtered.hasInsertedRelatedContent"))return;const n=e.get("tags")||[],o={type:"text_singleline",contentdata:{fields:{text:this.api.v1.locale.get("notice.relatedContent.header"),elementType:"h2"}}};this.api.v1.model.insert.atPath({path:"dropZone/",data:{type:"row",metadata:{spaceOutsideTop:"large",spaceOutsideBottom:"medium"},children:[o,{type:"livefeed",contentdata:{id:122,fields:{tags:n.join(","),maxNoticesCount:20}},metadata:{blacklist:[e.get("id")]},width:66.66},{type:"frontContent",contentdata:{fields:{organizer:"RowsAndColumns",source:"lab-api-site",tags_allow:!0,tags_useOr:!0,tags_string:n.join(","),hide_kicker:!0,hide_subtitle:!0,layout_rowCount:"20",layout_columnCount:"1",size_active:!0,size_title:24}},width:33.33}],state:{isNonPersistent:!0}}}),e.setFiltered("hasInsertedRelatedContent",!0)}}class y{constructor(e){this.api=e}onRender(e,t){const i=this.api.v1.config.get("contentbox_settings.adnuntiusAd.formats")||[],s=e.get("fields.format"),a=i.filter((e=>e.format===s))[0]||{};if(e.setFiltered("adData",a),e.setFiltered("isDebug",this.api.v1.util.request.hasQueryParam("debug")||e.get("metadata.isDebug")),!this.api.v1.app.mode.isEditor()){const t=e.parent&&!0===e.parent.get("metadata.hideOnTablet")&&"tablet"===this.api.v1.config.get("xUaDevice");e.setFiltered("hideOnTablet",t)}if(this.api.v1.app.mode.isEditor()){const t=this.api.v1.model.root.getType().replace("page_",""),a=[];i.forEach((e=>{if(e.selectable&&e.selectable.indexOf(t)>-1||e.selectableOn&&!0===e.selectableOn[t])if(e.format===s){const t={...e};t.selected=!0,a.push(t)}else a.push(e)})),e.setFiltered("formatConfigKeys",a)}const n=this.api.v1.config.get("contentbox_settings.adnuntiusAd.label")||"Annonse",o=e.get("fields.label")||n;if(e.setFiltered("label",o),e.setFiltered("displayLabel",o&&(e.get("metadata.css")||"").includes("display-label")),(e.get("metadata.css")||"").includes("sticky")){const t=`top: ${this.api.v1.config.get("contentbox_settings.adnuntiusAd.spacingTop")||120}px;`;e.setFiltered("spacingTop",t)}}}class v{constructor(e){this.api=e}onRender(e){const t=this.api.v1.config.get("contentbox_settings.apsis_submit");t&&e.setFiltered("apsis",t)}}class _{static textElements(e,t){const i={top:[],floating:[],bottom:[],positions:{kicker:"",title:""}};let s="",a="";if(e.get("metadata.showKicker")&&(t||e.get("fields.kicker")||e.get("fields.origin_data_json.teaserKicker")||e.get("fields.origin_data_json.kicker"))&&(e.get("metadata.floatingKicker")?(i.floating.push("kicker"),i.positions.kicker="floating",s="floating"):e.get("metadata.kickerBelowImage")?(i.bottom.push("kicker"),i.positions.kicker="below",s="bottom"):(i.top.push("kicker"),i.positions.kicker="above",s="top")),e.get("metadata.hideTitle")||!t&&!e.get("fields.title")||(e.get("metadata.floatingTitle")?(i.floating.push("title"),i.positions.title="floating",a="floating"):e.get("metadata.titleAboveImage")?(i.top.push("title"),i.positions.title="above",a="top"):(i.bottom.push("title"),i.positions.title="below",a="bottom")),e.get("metadata.kickerBelowTitle")&&e.get("metadata.showKicker")&&a){if(s){const e=i[s].indexOf("kicker");-1!==e&&i[s].splice(e,1)}const e=i[a],t=e.indexOf("title");-1!==t?e.splice(t+1,0,"kicker"):e.push("kicker"),i.positions.kicker="belowTitle",s=a}return!e.get("metadata.hidesubtitle")&&(t||e.get("fields.subtitle")||e.get("fields.origin_data_json.teaserSubtitle"))&&(e.get("metadata.floatingSubtitle")?i.floating.push("subtitle"):e.get("metadata.subtitleAboveImage")?i.top.push("subtitle"):i.bottom.push("subtitle")),i}}class k{static convertToIso639(e){let t="";return e&&(t=3===e.length?e.toLowerCase():e.includes("-")?e.split("-")[0].toLowerCase():e.toLowerCase()),t}}class w{static autoSizeText(e,t){const i={1:100,2:70,3:50,4:45,5:40,6:35,7:30,8:26,9:22,10:20,11:18,12:17,13:16,14:15,15:14,16:13,17:12,18:11,19:10,20:9,21:8,22:7,23:6,24:5,25:4},s=e.innerHTML.replace(/&nbsp;/,"");if(e.querySelector("br")||e.querySelector(".auto-font-size-line-br")){const t=this.handleBreaks(s);e.innerHTML="",t.forEach(((i,s)=>{e.innerHTML+=`<span class="auto-font-size-line${s<t.length?" auto-font-size-line-br":""}">${i} </span>`}))}else{const i=this.removeHTMLTags(s),a=this.splitSentence(i,t,"default");e.innerHTML="";for(const t of a)e.innerHTML+=`<span class="auto-font-size-line">${t} </span>`}const a=e.querySelectorAll(".auto-font-size-line"),n=e.clientWidth;for(const e of a){const t=i[e.innerText.length]||5;e.clientWidth<n?this.enlargeTitle(e,n,t):e.clientWidth>n&&this.shrinkTitle(e,n,t)}return e.innerHTML}static handleBreaks(e){let t=this.removeHTMLTags(e).split(/<br\s*[^>]*>/gi);return t=t.filter((e=>e.trim().length>0)),t}static removeFontSize(e){const t=e.innerHTML;return this.removeHTMLTags(t)}static removeHTMLTags(e){let t=e.replace(/<span class="auto-font-size-hyphen">-<\/span>\s?/g,"");return t=t.replace(/<span class="[^"]*\bauto-font-size-line-br\b[^"]*"[^>]*>(.*?)<\/span>/g,"$1<br>"),t=t.replace(/<span class="[^"]*\bauto-font-size-line\b[^"]*"[^>]*>(.*?)<\/span>/g,"$1"),t=t.replace(/<span[^>]*>([^<]*)<\/span>/g,"$1"),t=t.replace(/(\r\n|\n|\r)/g,""),t}static enlargeTitle(e,t,i,s=100){let a=i;for(;e.clientWidth<t&&a<=s;)a+=1,e.style.setProperty("--lab-auto-font-size",`${a}cqi`);for(;e.clientWidth>=t||a>s;)a-=.1,e.style.setProperty("--lab-auto-font-size",`${a}cqi`)}static shrinkTitle(e,t,i){let s=i;for(;e.clientWidth>t;)s-=.1,e.style.setProperty("--lab-auto-font-size",`${s}cqi`)}static splitSentence(e,t,i){const{length:s}=e,a=this.findRules(t,i),n=this.findNumberOfLines(a.ranges,s)||1,o=a.maxWordLength||null,r=a.minLineLength||null;return this.splitTextEvenly(e,n,o,r,t.regex)||[]}static findRules(e,t){return{...e.formats[t]}}static findNumberOfLines(e,t){const i={maxLineLength:20,numberOfLines:1};for(const s of e)if(t<=s.maxCharacters){i.numberOfLines=s.numberOfLines,i.maxLineLength=s.maxCharacters/s.numberOfLines;break}return i}static checkRegex(e,t,i){let s=t;const a=[];return Array.from(Object.entries(e),(([,e])=>e)).forEach((e=>{const t=new RegExp(e,"g"),i=s.match(t);i&&a.push(...i)})),a.forEach((e=>{const t=e.replace(/ /g,i);s=s.replace(e,t)})),s}static splitStringIntoParts(e,t,i,s,a){const n=this.checkRegex(i,e,"___").split(" "),o=[];let r="";return n.forEach((e=>{const i=e.trim().replace(new RegExp("___","g")," ");if(i.includes("-"))r.length+i.length+1>t?(o.push(r),r=i):r+=(r.length>0?" ":"")+i;else{const e=this.splitWord(i,s);e.forEach(((i,s)=>{r.length+i.length+1>t?(o.push(r),r=i):r+=(r.length>0?" ":"")+i,s<e.length-1&&(r+='<span class="auto-font-size-hyphen">-</span>')}))}})),r.length>0&&o.push(r),o}static splitWord(e,t){const i=[];let s=e;for(;s.length>t;)i.push(s.substring(0,t)),s=s.substring(t);return s.length>0&&i.push(s),i}static splitTextEvenly(e,t,i,s,a){const n=e.trim(),o=Math.ceil(n.length/t.numberOfLines);let r=this.splitStringIntoParts(n,o,a,i,t.numberOfLines);if(s&&(r=this.mergeShortLines(r,s)),r.length>t.numberOfLines){const e=/<span class="auto-font-size-hyphen">-<\/span>$/,t=r.pop();e.test(r[r.length-1])?r[r.length-1]=r[r.length-1].replace(e,"")+t:r[r.length-1]+=` ${t}`}return r}static mergeShortLines(e,t){const i=[];for(let s=0;s<e.length;s++){let a=e[s].trim();a.length<t&&s<e.length-1&&(a+=` ${e[s+1]}`,s++),i.push(a)}if(i.length>1){const e=i[i.length-1];e.length<t&&(i[i.length-2]+=` ${e}`,i.pop())}return i}}class F{constructor(e){this.api=e,this.imageServer=this.api.v1.properties.get("image_server"),this.rootModel=this.api.v1.model.query.getRootModel(),this.domain=this.api.v1.site.getSite().domain||this.api.v1.properties.get("customer_front_url"),this.fallbackLanguage=this.api.v1.config.get("contentLanguage")||"",this.autoFontSizeConfig=this.api.v1.config.get("autoFontSize")||[],this.autoFontSizePageSettings=Boolean(!!this.rootModel&&this.rootModel.get("fields.autoFontSize")),this.hasAutoFontSize=this.autoFontSizePageSettings&&this.autoFontSizeConfig.enabled,this.autoFontSizeDone=!1,this.dateTimeHelper=new r(this.api.v1.config.get("lang")||void 0)}onInserted(e){if(this.api.v1.app.mode.isEditor()&&this.hasAutoFontSize){e.set("state.autoFontSizeReRender",!0,{notify:!1});const t=(e,t,i)=>{e.get("fields.title")===e.get("state.title")?e.set("state.autoFontSizeReRender",!1,{notify:!1}):(e.set("state.autoFontSizeReRender",!0,{notify:!1}),e.set("metadata.autoFontSizeDone",!1,{notify:!1}))};this.api.v1.model.bindings.bind(e,"fields.title",t)}}onReady(e,t){e.setFiltered("layout",_.textElements(t,this.api.v1.app.mode.isEditor()));let i=e.get("fields.published_url")||"";!/^https?/.test(i)&&i&&(i=this.domain+i),e.setFiltered("published_url",i),e.setFiltered("published_url_rss",i.replace(/&/g,"&amp;"))}onRender(e,t){const i=e.get("instance_of")||e.get("fields.origin_data_json.id"),s=e.get("fields.published")||e.get("fields.origin_data_json.published"),a=e.get("fields.origin_data_json.teaserTitle")||t.get("fields.title")||"",n=e.get("fields.origin_data_json.teaserSubtitle")||t.get("fields.subtitle")||"",o=e.get("fields.origin_data_json.published")||e.get("fields.published"),r=e.get("fields.origin_data_json.teaserKicker")||e.get("fields.origin_data_json.kicker")||t.get("fields.kicker"),l=e.get("fields.site_id")||e.get("fields.origin_data_json.site_id"),d=e.get("fields.origin_data_json.seolanguage")||e.get("fields.seolanguage")||this.fallbackLanguage,c=e.get("fields.origin_data_json.teaserAudio")||e.get("fields.audio"),g=e.get("fields.origin_data_json.teaserAudio_style_json")||e.get("fields.audioInfo")||{},p=e.get("fields.origin_data_json.addRelNoFollow")||e.get("fields.addRelNoFollow")||!1,h=e.get("fields.origin_data_json.addRelSponsored")||e.get("fields.addRelSponsored")||!1,f=e.get("fields.origin_data_json.addRelUgc")||e.get("fields.addRelUgc")||!1;e.setFiltered("published",s),e.setFiltered("title",a),e.setFiltered("kicker",r),e.setFiltered("subtitle",n),e.setFiltered("articleId",i),e.setFiltered("section",e.get("fields.origin_data_json.section_tag")||e.get("fields.section")||""),e.setFiltered("base_url",this.domain),e.setFiltered("published_sitemap",o),e.setFiltered("canonical_url",`${this.getSiteDomain(l)}/a/${i}`),e.setFiltered("tags",e.get("tags")||[]),e.setFiltered("languageIso639",k.convertToIso639(d));const m=(new Date).getTime()-1728e5;if(e.setFiltered("articleOutOfDate_sitemap",m>Math.floor(new Date(o).getTime())),e.setFiltered("addRelNoFollow",p),e.setFiltered("addRelSponsored",h),e.setFiltered("addRelUgc",f),!this.api.v1.config.get("showHiddenTagsOnFront")){const t=(this.api.v1.config.get("tagsToHide")||"").split(",").map((e=>e.trim()))||[],i=(e.get("tags")||[]).filter((e=>!t.includes(e)));e.setFiltered("tags",i)}if(l){const t=this.api.v1.site.getSiteById(l);t&&e.setFiltered("site_alias",t.alias)}if(c){const t={url:c};if(g){const e=JSON.parse(g);t.title=e.title||null,t.fileType=e.fileType||null,t.playTime=e.playTime||null}e.setFiltered("audio",t)}const b=e.get("fields.origin_data_json.showbylineonfp")||t.get("fields.displayByline")||!1;if(b){const i=t.get("fields.byline")||e.get("fields.origin_data_json.byline"),s=t.get("fields.bylineImage")||e.get("fields.origin_data_json.bylineImage"),a=(e.get("fields.origin_data_json.full_bylines")||e.get("fields.full_bylines_json")||[]).map((e=>({firstname:e.firstname,lastname:e.lastname,description:e.description,imageUrl:e.imageUrl?this.getImageUrl(`${e.imageUrl}&width=90&height=90`):""})));a.length||!i&&!s||a.push({firstname:i,lastname:"",imageUrl:s?this.getImageUrl(`${s}&width=90&height=90`):""}),e.setFiltered("bylines",a),s&&e.setFiltered("bylineImage",`${s}&width=90&height=90`)}e.setFiltered("displayByline",b);const y=t.get("fields.displayPublishedDate")||!1,v=this.api.v1.locale.get("dates.monthdayyear",{noRender:!0});if(e.setFiltered("displayPublishedDate",y),y)if(this.api.v1.app.mode.isEditor()&&!s)e.setFiltered("publishedDate",v);else if(this.api.v1.app.mode.isEditor()||s){const t=new Date(s),i=this.dateTimeHelper.format(t,v);e.setFiltered("publishedDate",i)}else e.setFiltered("displayPublishedDate",!1);let _=e.get("fields.origin_data_json.paywall")||e.get("fields.paywall")||!1;if(_=1===_||"1"===_||!0===_||null,_){const i={display:!0,displayInNewsletter:!0,...this.api.v1.config.get("paywall.label")},s=this.api.v1.config.get("paywall.label.text.content"),a=this.api.v1.config.get("paywall.label.icon.content"),n={text:{content:null==s?"Plus":this.api.v1.config.get("paywall.label.text.content")},icon:{content:null==a?"fi-plus":this.api.v1.config.get("paywall.label.icon.content")}};if(Object.assign(i,n),i.display){i.layout={noImage:!0,float:null};const s=this.api.v1.model.query.getChildOfType(e,"image")||this.api.v1.model.query.getChildOfType(e,"graphic");if(s&&s.get("instance_of")){const e=this.api.v1.view.getView(s,t.getViewport());i.layout.float=this.api.v1.config.get("paywall.label.labelPosition")||e.get("fields.float"),i.layout.noImage=!!t.get("metadata.hideimage")}e.setFiltered("paywallLabel",i)}}else e.setFiltered("paywallLabel",null);e.setFiltered("paywall",_);const w=e.get("metadata.tagPlacement")||"underImage";e.setFiltered("tagPlacement.underImage","underImage"===w),e.setFiltered("tagPlacement.underText","underText"===w);const F=e.get("metadata.sectionPlacement")||"floating";e.setFiltered("sectionPlacement.floating","floating"===F),e.setFiltered("sectionPlacement.underImage","underImage"===F),e.setFiltered("sectionPlacement.underText","underText"===F),e.setFiltered("articleWidth",t.getPixelWidth()),e.setFiltered("autodata_css",u.parseCss(e)),e.setFiltered("autodata_content_css",u.parseCss(e,"filtered.autodata_content")),e.setFiltered("autodata_attributes",u.parseAttributes(e)),e.setFiltered("autodata_custom",u.parseCustomData(e)),this.autoFontSizeConfig.enabled&&(this.autoFontSizeDone=e.get("metadata.autoFontSizeDone"))}onRendered(e,t){if(this.api.v1.app.mode.isEditor()&&this.autoFontSizeConfig.enabled){const i=()=>{const e=t.getMarkup().querySelector(".headline");w.removeFontSize(e),this.api.v1.tool.off("ended",i)};if("desktop"===t.viewport&&this.hasAutoFontSize&&e.get("metadata.autoFontSizeEnabled")&&(this.api.v1.tool.on("started",(t=>{"fields.title"===t.key&&t.model===e&&i()})),e.get("state.autoFontSizeReRender")&&e.get("fields.title")&&!this.autoFontSizeDone&&e.get("metadata.autoFontSizeEnabled"))){const i=t.getMarkup().querySelector(".headline"),s=w.autoSizeText(i,this.autoFontSizeConfig);e.set("state.autoFontSizeReRender",!1,{notify:!1}),e.set("state.title",s,{notify:!1}),e.set("metadata.autoFontSizeDone",!0,{notify:!1}),e.set("fields.title",s)}}}onCreated(e){this.hasAutoFontSize&&null===e.get("metadata.autoFontSizeEnabled")&&e.set("metadata.autoFontSizeEnabled",!0,{notify:!1})}getSiteDomain(e){if(!e)return"";const t=this.api.v1.site.getSiteById(e);return t?t.domain:""}getImageUrl(e){return e?e.startsWith("http")?e:this.imageServer+e:""}}class S{constructor(e){this.api=e}onViewHelper(e){const t=e.get("fields.site_id")||null,i=e.get("fields.articleCount")||6,s=`${(new r).formattedUtcDate(new Date,"Y-m-d")}T00:00:00Z`,a=`${this.api.v1.properties.get("front_api_url")}/api/v1/article/?`,n={orderBy:"calendar_start_date",order:"asc",site_id:t,limit:i,htmlText:1},o={visibility_status:"P",published:"[*%20NOW]",calendar_start_date:`[${s}%20TO%20*]`},l=[];for(const e in n)n[e]&&l.push(`${e}=${n[e]}`);const d=[];for(const e in o)o[e]&&d.push(`${e}:${o[e]}`);l.push(`query=${d.join("%20AND%20")}`);const c=a+l.join("&");e.setFiltered("url",c)}onRender(e,t){const i=t.get("external"),s=e.get("fields.site_id")||"",a=e.get("fields.displayImage"),n=e.get("fields.displayTitle")||null,o=e.get("fields.displaySubtitle"),r=this.api.v1.properties.get("image_server"),l=this.api.v1.config.get("contentbox_settings.articleCalendar.imageAspectRatio")||this.api.v1.config.get("image.defaultAspectRatio"),d=["width=420",`height=${Math.floor(420*l)}`,`format=${this.api.v1.image.getPreferredImageFormat()}`];if(this.api.v1.app.mode.isEditor()){const t={displayImage:!!a,displayTitle:null===n||!!n,displaySubtitle:!!o},i=[{value:"",name:"Any site"}];this.api.v1.site.getSites().forEach((e=>{i.push({value:e.id,name:e.display_name,selected:s&&e.id===parseInt(s,10)})})),t.site_ids=i,e.setFiltered("options",t)}if(i){const t=[];i.result.forEach((e=>{const i={url:e.published_url};n&&(i.title=e.teaserTitle||e.title),o&&(i.subtitle=e.teaserSubtitle||e.subtitle),a&&e.frontCropUrl&&(i.calendarimage=`${r}/${e.frontCropUrl}&${d.join("&")}`),t.push(i)})),e.setFiltered("data",t)}}}class T{constructor(e){this.api=e,this.ignoredTags=this.api.v1.config.get("page_settings.article.ignoredTags")||[],this.ignoredTagPrefix=this.api.v1.config.get("page_settings.article.ignoredTagPrefix")||[],this.adminIgnoredTags=this.api.v1.config.get("showHiddenTagsOnArticle")?[]:(this.api.v1.config.get("tagsToHide")||"").split(",").map((e=>e.trim()))}onRender(e,t){const i=[...new Set([...this.ignoredTags,...this.adminIgnoredTags])],s=(this.api.v1.model.query.getRootModel().get("tags")||[]).filter((e=>!i.includes(e))).filter((e=>{for(const t of this.ignoredTagPrefix)if(e.startsWith(t))return!1;return!0}));e.setFiltered("tags",s),e.setFiltered("tagPagePath",this.api.v1.config.get("tagPagePath")||"/tag/")}}class C{constructor(e){this.api=e}onInserted(e){e.get("metadata.hidecaption")&&(e.set("fields.displayCaption",!1,{save:!1}),e.set("metadata.hidecaption",null,{save:!1}))}onRender(e,t){const i=_.textElements(t,this.api.v1.app.mode.isEditor());if(e.setFiltered("layout",i),e.setFiltered("hasFloatingText",i.floating.length>0),this.api.v1.app.mode.isFront()){const t=e.get("fields.kicker");e.setFiltered("hideKicker",!t||t.includes("Click to add kicker"))}}async onChildAdded(e,t){"image"===t.getType()&&this.api.v1.article.frontcrop.get().then((e=>{if(e)return;const i=t.get("instance_of");i?this.setFrontCrop(i):this.api.v1.model.bindings.bind(t,"instance_of",((e,t,i)=>{this.setFrontCrop(i)}))})).catch((e=>{Sys.logger.warn(`[ArticleHeader] Failed to get front-crop: "${e.toString()}"`)}))}setFrontCrop(e){const t={type:"image",contentdata:{instance_of:e,fields:{croph:100,cropw:100,x:0,y:0}}};this.api.v1.article.frontcrop.set({pano:t,height:t}).then((()=>{Sys.logger.debug("[ArticleHeader] Front-crop successfully set.")})).catch((e=>{Sys.logger.warn(`[ArticleHeader] Failed to set front-crop: "${e.toString()}"`)}))}}class x{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor()}onRender(e,t){const i=t.getAbsoluteGridWidths(),s=e.get("fields.columnsDesktop")||this.getFallbackColumns(i.desktop||12),a=e.get("fields.columnsMobile")||1;if(e.setFiltered("columns",{desktop:s,mobile:a}),!this.isEditor)return;const n=e.get("fields.layout"),o=[{value:"default",label:"Horizontal",selected:"default"===n},{value:"vertical",label:"Vertical",selected:"vertical"===n}],r=e.get("fields.imageLayout"),l=[{value:"full",label:"100% width",selected:"full"===r},{value:"left",label:"Align Left",selected:"left"===r},{value:"right",label:"Align Right",selected:"right"===r}];e.setFiltered("layoutOptions",o),e.setFiltered("imageLayoutOptions",l)}getFallbackColumns(e){return e>=10?4:e>=7?3:e>=5?2:1}}class D{constructor(e){this.api=e}onRender(e,t){const i=lab_api.v1.config.get("contentLanguage")||"no",s={publishedLabel:"Publisert",unpublishedLabel:"(upublisert) Opprettet",modifiedLabel:"Sist oppdatert",readTimeLabel:"Lesetid",unifiedLabel:"",languageCode:i,niceDates:!1,dateFormat:"l d. F Y - H:i",dateFormatPrependZero:!0,timeFormatPrependZero:!0,template:"{{dddd}} {{DD}}. {{MMMM}} {{YYYY}} - {{HH}}:{{mm}}",useOldFormat:!1};"en"===i&&(s.publishedLabel="Published",s.unpublishedLabel="(unpublished) Created",s.modifiedLabel="Last updated",s.readTimeLabel="Read time",s.languageCode="en");const a=this.api.v1.config.get("contentbox_settings.articleMeta.date");if(a){for(const e in a)e&&void 0!==s[e]&&(s[e]=a[e]);"dateFormat"in a&&!("template"in a)&&(s.useOldFormat=!0)}const n=this.api.v1.locale.get("dates.dateTime",{noRender:!0,fallbackValue:null});n&&(s.template=n);const o=new m(s.languageCode);let r=s.publishedLabel,l=e.get("fields.published");const d=e.get("fields.modified")>=l?e.get("fields.modified"):null;e.setFiltered("unpublished",!1),l||(r=s.unpublishedLabel,e.setFiltered("unpublished",!0),l=e.get("fields.created"));let c=this.api.v1.config.get("contentbox_settings.articleMeta.hideModifiedDate");c||(c=e.get("fields.hidePublishedDate"));const g=e.get("fields.hidePublishedDate"),p=new Date(1e3*l),u=d?new Date(1e3*d):null,h={isoDate:p.toISOString(),label:r,timestamp:l,hide:g,formatted:""},f={isoDate:u?u.toISOString():"",label:s.modifiedLabel,timestamp:d,hide:c,formatted:""},b={hide:!0};this.api.v1.config.get("contentbox_settings.articleMeta.displayUnifiedDate")&&(b.hide=!1,b.isoDate=(u||p).toISOString(),b.timestamp=d||l,b.label=s.unifiedLabel,b.formatted="",h.hide=!0,f.hide=!0),s.niceDates?(h.hide||(h.formatted=o.timestampToNiceDate(o.toTimestamp(p))),u&&!f.hide&&(f.formatted=o.timestampToNiceDate(o.toTimestamp(u))),b.hide||(b.formatted=o.timestampToNiceDate(o.toTimestamp(u||p)))):s.useOldFormat?(h.hide||(h.formatted=o.formattedUtcDate(p,s.dateFormat,s.dateFormatPrependZero,s.timeFormatPrependZero)),u&&!f.hide&&(f.formatted=o.formattedUtcDate(u,s.dateFormat,s.dateFormatPrependZero,s.timeFormatPrependZero)),b.hide||(b.formatted=o.formattedUtcDate(u||p,s.dateFormat,s.dateFormatPrependZero,s.timeFormatPrependZero))):(h.hide||(h.formatted=o.utcFormat(p,s.template)),u&&!f.hide&&(f.formatted=o.utcFormat(u,s.template)),b.hide||(b.formatted=o.utcFormat(u||p,s.template))),e.setFiltered("date",{published:h,modified:f,unified:b});const y=e.get("fields.readTime")||.5,{readTimeLabel:v}=s;e.setFiltered("readTime",y<1?"< 1 min":`${y} min`),e.setFiltered("readTimeLabel",v)}onInserted(e){}}class ${constructor(e){this.api=e,this.rootModel=this.api.v1.model.query.getRootModel(),this.isEditor=this.api.v1.app.mode.isEditor(),this.boundIds={},this.config=this.api.v1.config.get("contentbox_settings.articlesByTag")||{niceDates:!0,dateFormat:"{{ HH }}:{{ mm }} - {{ DD }}.{{ MM }}.{{ YYYY }}"},this.preferredImageFormat=lab_api.v1.image.getPreferredImageFormat()}onViewHelper(e,t){const i={image:!1,kicker:!1,title:!0,subtitle:!0,published:!1},s=[],a=e.get("fields.displayOptions_json")||{};for(const e of Object.keys(i))void 0!==a[e]&&(i[e]=!!a[e]);const n=e.get("fields.query_json")||{},o=void 0===n.site_id?this.api.v1.site.getSite().id:n.site_id,r=lab_api.v1.config.get("contentbox_settings.articlesByTag.imageAspectRatio")||lab_api.v1.config.get("image.defaultAspectRatio"),l=["width=200",`height=${Math.floor(200*r)}`];this.preferredImageFormat&&"jpg"!==this.preferredImageFormat&&l.push(`format=${this.preferredImageFormat}`),e.setFiltered("site_id",o),e.setFiltered("displayOptions",i),e.setFiltered("imageServer",this.api.v1.properties.get("image_server")),e.setFiltered("imgArgs",l.join("&")),e.setFiltered("orderBy","published"),e.setFiltered("tagPagePath",lab_api.v1.config.get("tagPagePath")||"/tag/"),e.setFiltered("limit",n.limit||10);const d=(e,t,i)=>{const s=[];Array.isArray(t)&&t.forEach((e=>{let t=e;t=t.replace(/([\(\)\s+])/g,"\\$1"),t=t.toLowerCase(),s.push(t)}));const a=this.rootModel.get("id");let n;if(e.get("fields.useApiQuery")&&e.get("fields.apiQuery")){const t=e.get("fields.apiQuery").replace(/\b(AND|OR|NOT)\b/g,"__$1__").toLowerCase().replace(/__and__/g,"AND").replace(/__or__/g,"OR").replace(/__not__/g,"NOT");n=t.length?`(${t}) AND published:[* TO NOW] AND NOT id:${a}`:`published:[* TO NOW] AND NOT id:${a}`,n=n.replace(/""+/g,'"')}else n=s.length?`(tag:"${s.join('" OR tag:"')}") AND published:[* TO NOW] AND NOT id:${a}`:`published:[* TO NOW] AND NOT id:${a}`,n=n.replace(/""+/g,'"');"edit"===i&&(e.set("fields.query",n,{save:!1}),e.setFiltered("query",encodeURIComponent(n)),e.set("fields.selectedTags_json",t,{save:!1})),"published"===i&&(e.setFiltered("query",encodeURIComponent(n)),e.set("fields.selectedTags_json",t,{save:!1}))};if(!this.isEditor){e.setFiltered("lazyloadImages",lab_api.v1.config.get("imageLoading.lazy")||!1);const t=this.rootModel.get("primaryTags.section");let i=[];i=(this.rootModel.get("tags")||[]).filter((e=>e!==t)),e.get("fields.usePageTags")?d(e,i,"published"):e.get("fields.useApiQuery")&&e.get("fields.apiQuery")?d(e,"","published"):e.setFiltered("query",encodeURIComponent(e.get("fields.query")))}if(this.isEditor){for(const e of Object.keys(i))s.push({name:e,value:i[e]});const t=[{value:"",name:"Any site"}];this.api.v1.site.getSites().forEach((e=>{t.push({value:e.id,name:e.display_name,selected:e.id==o})})),e.setFiltered("siteOptions",t),e.setFiltered("editDisplayOptions",s);const a=()=>{if(e.get("fields.useApiQuery"))d(e,"","edit");else{let t=[];if(e.get("fields.usePageTags")){const e=this.rootModel.get("primaryTags.section");t=(this.rootModel.get("tags")||[]).filter((t=>t!==e))}else(e.get("fields.tagsString")||"").split(",").forEach((e=>{const i=e.trim();i&&t.push(i)}));d(e,t,"edit")}},n=()=>{e.set("fields.usePageTags",!1),a()},r=e.getGuid();this.boundIds[r]||(this.boundIds[r]=!0,this.api.v1.model.bindings.bind(this.rootModel,"tags",a),this.api.v1.model.bindings.bind(e,"fields.usePageTags",a),this.api.v1.model.bindings.bind(e,"fields.usePageTags",a),this.api.v1.model.bindings.bind(e,"fields.tagsString",n)),a()}}onRender(e,t){const i=t.get("fields.placeholder");e.setFiltered("placeholder",i||this.api.v1.locale.get("emptyState.noContentText",{noRender:!0}));const s=this.api.v1.config.get("lang")||"no",a=new r(s),n=t.get("external"),o=[];n&&n.result&&n.result.forEach((e=>{if("article"===e.type){const t=e.published||null,i=new Date(t);o.push({kicker:e.kicker,title:e.title,subtitle:e.subtitle,published_url:e.published_url,frontCropUrl:e.frontCropUrl,published:t,formatted:t&&this.config.niceDates?a.timestampToNiceDate(a.toTimestamp(i)):a.format(i,this.config.dateFormat)})}})),e.setFiltered("templateData",o)}onSettingsPanel(e,t,i){return{onDisplay:e=>{const t=e.markup.querySelector(".advancedToggle"),i=e.markup.querySelector(".advanced");t&&i&&t.addEventListener("click",(e=>{const s=i.classList.contains("lab-hidden");i.classList.toggle("lab-hidden"),s?(t.classList.remove("labicon-pluss_slim"),t.classList.add("labicon-minus_slim")):(t.classList.remove("labicon-minus_slim"),t.classList.add("labicon-pluss_slim"))}),!1)}}}}class I{constructor(e){this.api=e,this.front_api_url=this.api.v1.properties.get("front_api_url"),this.integration_url=this.api.v1.properties.get("integration_url"),this.config=this.api.v1.config.get("contentbox_settings.articlescroller")||{sources:{all:{src:`${this.front_api_url}/api/v1/article/?orderBy=published&query=visibility_status:P%20AND%20published:[*%20NOW]%20AND%20showonfp:1&site_id={{ data.site_id }}&limit={{ data.articleCount }}`,data_type:"labrador",is_default:!0}},imageAspectRatio:.5,visibleArticleCount:4,visibleArticleCountMobile:1},this.preferredImageFormat=lab_api.v1.image.getPreferredImageFormat(),this.isEditor=this.api.v1.app.mode.isEditor(),this.sourceList=this.getSourceList(),this.domain=this.api.v1.site.getSite().domain||this.api.v1.properties.get("customer_front_url")}onViewHelper(e){const t=e.get("fields.source")||this.getDefaultSource(this.sourceList),i=e.get("fields.site_id"),s=e.get("fields.articleCount")||10;let a=this.sourceList[t]&&this.sourceList[t].src?this.sourceList[t]:null;const n=e.get("fields.customSource");if(n&&(Sys.logger.debug("ArticleScroller: Will use custom source."),a=n),a&&a.src){let t=null;if(a.defaultsiteAlias){const e=this.api.v1.site.getSite(a.defaultsiteAlias);e&&(t=e.id)}const n=e.get("fields.dateLimitFrom"),o=e.get("fields.dateLimitTo"),l=(new r).formattedUtcDate(new Date,"Y-m-d");let d="";"today"===n&&(d=`calendar_start_date:[${l}T00:00:00Z%20TO%20*]%20AND%20`),"today"===o&&(d+=`calendar_end_date:[*%20TO%20${l}T23:59:59Z]%20AND%20`);const c={site_id:i||t,front_api_url:this.front_api_url,articleCount:s,dateQuery:d},g=Mustache.render(this.handleUrlVariables(a.src),{data:c});e.setFiltered("url",g)}else Sys.logger.warning(`ArticleScroller: Missing config for source "${t}". Cannot fetch data. Check config.`)}onRender(e,t){const i=e.get("fields.source")||this.getDefaultSource(this.sourceList),s={text:{content:"Pluss"},icon:{content:"fi-plus"},display:!0,...this.api.v1.config.get("paywall.label")};s.display&&e.setFiltered("paywallLabel",s);let a=e.get("fields.visibleArticleCount")||this.api.v1.config.get("contentbox_settings.articlescroller.visibleArticleCount")||4;const n=e.get("fields.visibleArticleCountMobile")||this.api.v1.config.get("contentbox_settings.articlescroller.visibleArticleCountMobile")||2,o=a,r=n,l=this.config.restrictHeight||!1,d=!!e.get("fields.hideImages"),c=!!e.get("fields.showAuthor"),g=!!e.get("fields.showPublishedDate"),p=!!e.get("fields.hideNavigation"),u=e.get("fields.transitionDuration")||4e3,h=(u/1e3/100*(e.get("fields.transitionStep")||15)).toFixed(2);"mobile"===t.viewport&&(a=n);let f=this.api.v1.view.getPixelDensityFactor();t.get("metadata.hasFullWidth")&&(f+=.2);const m={};m.aspectRatio=e.get("fields.aspectRatio")||this.api.v1.config.get("contentbox_settings.articlescroller.imageAspectRatio")||this.api.v1.config.get("image.defaultAspectRatio"),m.width=Math.ceil(this.api.v1.viewport.getWidth(t.viewport)/a),m.height=Math.floor(m.width*m.aspectRatio);const b=t.get("external"),y=e.get("fields.articleCount")||10,v=this.config.externalMappers||{},_=e.get("fields.customSource")||this.sourceList[i]||{};let k=this.mapExternalData(b,_.data_type,{aspectRatio:m.aspectRatio,imageServer:this.api.v1.properties.get("image_server"),width:Math.floor(m.width*f),height:Math.floor(m.height*f),baseUrl:_.baseUrl||"",hideImages:d,showAuthor:c,showPublishedDate:g},v);if(Array.isArray(k)&&k.length>0&&(k=k.slice(0,y)),a>k.length&&(a=k.length),a<1&&(a=1),e.setFiltered("useNavigation",!p&&k.length>a),e.setFiltered("visibleArticleCount",a),e.setFiltered("maxVisibleArticleCount",o),e.setFiltered("maxVisibleArticleCountMobile",r),e.setFiltered("restrictHeight",l),e.setFiltered("hideImages",d),e.setFiltered("showAuthor",c),e.setFiltered("showPublishedDate",g),e.setFiltered("transitionDuration",u),e.setFiltered("transitionStep",h),e.setFiltered("data",k),e.setFiltered("width",m.width),e.setFiltered("height",m.height),e.setFiltered("labels",this.config.labels||{buttonLeft:"Rull til venstre",buttonRight:"Rull til høyre"}),this.isEditor&&e.setFiltered("transitionDurationSeconds",u/1e3),this.isEditor){if(_.src){const t={},s=[];for(const e of Object.keys(this.sourceList))s.push({value:e,name:this.sourceList[e].display_name||e,selected:e===i});t.sources=s;const a=[{value:"",name:"Any site"}],n=parseInt(e.get("fields.site_id")||this.getSiteIdFromAlias(i),10);this.api.v1.site.getSites().forEach((e=>{a.push({value:e.id,name:e.display_name,selected:e.id===n})})),t.site_ids=a;const o=e.get("fields.dateLimitFrom"),r=e.get("fields.dateLimitTo");t.dateLimit={from:[{value:"today",name:"Today",selected:"today"===o}],to:[{value:"today",name:"Today",selected:"today"===r}]};const l=e.get("fields.layoutAlign");t.layout={align:[{value:"left",name:"Align Left",selected:"left"===l},{value:"centered",name:"Align centered",selected:"centered"===l},{value:"right",name:"Align right",selected:"right"===l}]};const d=this.api.v1.config.get("contentbox_settings.articlescroller.layout")||!1;d&&d.forEach((e=>{e&&void 0!==e.value&&(e.selected=e.value===l,e.value===l?e.selected=!0:e.selected=!1),t.layout.align.push(e)})),t.aspectRatio=m.aspectRatio,e.setFiltered("options",t)}}else e.setFiltered("lazyloadImages",this.api.v1.config.get("imageLoading.lazy")||!1)}onCreated(e){e.set("fields.skipLeadText",!0)}handleUrlVariables(e){return e.replace(/\{\{api\}\}/g,this.front_api_url).replace(/\{\{int\}\}/g,this.integration_url)}getSourceList(){const e={};for(const t of Object.keys(this.config.sources||{}))e[t]=this.config.sources[t];const t=this.api.v1.config.get("feeds")||{};for(const i of Object.keys(t))if("json"===t[i].format&&t[i].labrador_json){let s;try{s=new URL(t[i].url)}catch(e){s=null}const a=s?s.origin:this.domain;e[i]={src:t[i].url,data_type:(t[i].url||"").startsWith("{{api}}")?"labrador":"labrador_json",is_default:!1,baseUrl:a,display_name:t[i].display_name}}return e}getDefaultSource(e){for(const t of Object.keys(e))if(e[t].is_default)return t;const[t=null]=Object.keys(e)||[];return t}getSiteIdFromAlias(e){if(this.sourceList[e].defaultsiteAlias){const t=this.api.v1.site.getSite(this.sourceList[e].defaultsiteAlias);if(t)return t.id}return null}mapExternalData(e,t,i,s){switch(t){case"ntb":return this.mapNtb(e,i);case"advokatjobb":return this.mapAdvokatjobb(e,i);case"labrador_json":return this.mapLabradorJson(e,i);case"labrador_compliant":return this.mapLabradorCompliant(e,i);default:try{if(Object.keys(s).includes(t)){const a=s[t].split(".");let n=window;for(let e=0;e<a.length;e+=1)n=n[a[e]];let o=null;if(n&&(o=n(e,i),o))return o}}catch(e){Sys.logger.warning("Faulty extraMapper function.")}return this.mapLabrador(e,i)}}mapNtb(e,t){const i=[];return e.releases?(e.releases.forEach((e=>{let s=!1,a=null;!t.hideImages&&e.images.length&&(s=e.images[0].thumbnail_16_9||!1),e.logos.length&&(a=e.logos[0].thumbnail_original||!1),t.hideImages||s||!e.logos.length||(s=e.logos[0].thumbnail_16_9||!1);const n={url:`https://www.ntbinfo.no${e.url}`,title:e.title,subtitle:e.leadtext,image:s,iconImage:a};i.push(n)})),i):i}mapAdvokatjobb(e,t){const i=[];return e.Jobs?(e.Jobs.forEach((e=>{let s=!1,a="";e.Company&&(!t.hideImages&&e.Company.Logo&&(s=t.baseUrl+e.Company.Logo),e.Company.Name&&(a=`${e.Company.Name} - `));const n={url:t.baseUrl+e.Url,title:a+e.Title,subtitle:`${e.Location} - ${e.DueDate}`,image:s,iconImage:null};i.push(n)})),i):i}mapLabradorJson(e,t){const i=[];if(!e||!e.result)return i;const s=[`width=${t.width}`,`height=${t.height}`];return e.result.forEach((e=>{const a=u.parseCustomDataFromFeed(e,"contentbox_settings.articlescroller");let n="";e.url&&(n=0===e.url.indexOf("http")||0===e.url.indexOf("//")?e.url:t.baseUrl+e.url);const o={url:n,title:e.teaserTitle?e.teaserTitle:e.title,kicker:e.kicker||e.teaserKicker||"",subtitle:e.teaserSubtitle?e.teaserSubtitle:e.description,image:!(t.hideImages||!e.images||!e.images.length)&&`${e.images[0].url}${e.images[0].url.includes("?")?"&":"?"}${s.join("&")}`,autodata:a||"",section:e.section||"",paywall:!!e.paywall,author:e.byline||"",publishedDate:e.published};i.push(o)})),i}mapLabrador(e,t){const i=[];if(!e||!e.result)return i;const s=[`width=${t.width}`,`height=${t.height}`];this.preferredImageFormat&&"jpg"!==this.preferredImageFormat&&s.push(`format=${this.preferredImageFormat}`);const a=this.api.v1.locale.get("dates.articleScrollerPublishedFormat",{noRender:!0}),n=this.api.v1.locale.get("dates.articleScrollerPublishedDatePrefix",{fallbackValue:""}),o=new r(this.api.v1.config.get("lang")||void 0);return e.result.forEach((e=>{const r=u.parseCustomDataFromFeed(e,"contentbox_settings.articlescroller"),l=o.format(new Date(e.published),a),d=n?`${n} ${l}`:l,c={url:e.siteDomain+e.published_url,title:e.title,kicker:e.kicker||e.teaserKicker||"",subtitle:e.subtitle,image:!(t.hideImages||!e.frontCropUrl)&&`${t.imageServer}/${e.frontCropUrl}&${s.join("&")}`,autodata:r||"",section:e.section||"",paywall:!!e.paywall,author:e.byline||"",publishedDate:d};i.push(c)})),i}mapLabradorCompliant(e,t){const i=[];if(!e||!e.result)return i;const s=[`width=${t.width}`,`height=${t.height}`];return e.result.forEach((e=>{let a=!1;!t.hideImages&&e.images&&Array.isArray(e.images)&&e.images.length>0&&(a=`${t.imageServer}/?imageUrl=${e.images[0].url}&${s.join("&")}`);const n={url:e.url,title:e.title,kicker:e.kicker||"",subtitle:e.subtitle,section:e.section||"",image:a,paywall:!!e.paywall,author:e.byline||""};i.push(n)})),i}}class M{static defaultLineIndex=3;static filterBodytext(e,t){let i=lab_api.v1.config.get("paywall.bodytext.lineCount");null!==i&&!1!==i||(i=this.defaultLineIndex);const s=e.get("filtered.lineData");let{bodytext:a}=s;const n=s.indexRegister.reverse();return n.length<=i&&(i=n.length-1),n[i]&&(a=a.substring(0,n[i].charIndex)),a}static iterasPaywall(e,t){const i={id:e.id,offersTitle:e.offersTitle,alreadySubscribedText:e.alreadySubscribedText,alreadySubscribedLink:e.alreadySubscribedLink,offers:e.offers,offerButtonLink:e.offerButtonLink,offerButtonText:e.offerButtonText,offersSalesText:e.offersSalesText},s=e.extraPaywalls.find((e=>t.includes(e.triggerTag)))||null;return s&&(i.id=s.id,i.offersTitle=s.offersTitle,i.alreadySubscribedText=s.alreadySubscribedText,i.alreadySubscribedLink=s.alreadySubscribedLink,i.offers=s.offers,i.offerButtonLink=s.offerButtonLink,i.offerButtonText=s.offerButtonText,i.offersSalesText=s.offersSalesText),i}}class E{constructor(e){this.api=e,this.isFront=this.api.v1.app.mode.isFront(),this.internal=this.api.v1.properties.get("paywall")||{};const t=this.api.v1.config.get("paywall")||{};this.provider=t.provider||"internal",this.displaySalesPosters=!1!==t.displaySalesPosters}onRender(e,t){const i={displaySalesPosters:this.displaySalesPosters,isInternal:"internal"===this.provider&&this.internal.active,active:this.isFront&&("internal"===this.provider?this.internal.active:!!e.get("fields.paywall")),access:!("internal"!==this.provider||!this.internal.active)&&this.internal.hasAccess,provider:this.provider,intro:"internal"!==this.provider?M.filterBodytext(e,t):void 0,bodytext:"internal"!==this.provider?e.get("filtered.bodytext"):void 0};if(i.active&&!i.access&&("internal"===this.provider?e.setFiltered("bodytext",M.filterBodytext(e,t)):e.setFiltered("bodytext","")),"iteras"===this.provider&&i.active){const t=this.api.v1.config.get("iteras")||{},s=e.get("tags")||[];i.iteras=M.iterasPaywall(t,s)}e.setFiltered("paywall",i)}onRendered(e,t){if(!this.isFront){const i=t.getMarkup();if(i.children.length&&"P"!==i.children[i.children.length-1].tagName){const e=document.createElement("p");i.appendChild(e)}this.markCustomIndex(e.getPersistentChildren())}}markCustomIndex(e){for(const t of e){const e=t.getRaw("metadata.bodyTextIndex")||{};Object.values(e.vp||{}).filter((e=>Number.isInteger(e))).length>1&&this.markCustomIndexForModel(t)}}markCustomIndexForModel(e){for(const t of this.api.v1.viewport.getActive()){const i=this.api.v1.view.getView(e,t);if(!i.getExtraElement("customIndexElement")){const t=i.setExtraElement("customIndexElement",this.getCustomIndexElement(e,i));i.getMarkup().appendChild(t)}}}getCustomIndexElement(e,t){const i=document.createElement("span"),s=i=>{i&&(i.stopPropagation(),i.preventDefault()),this.removeCustomIndexElement(e),e.getParent()&&this.api.v1.model.addToRedrawQueue(e.getParent()),e.set("metadata.bodyTextIndex",void 0,{viewport:"mobile"}),this.api.v1.viewport.align(e,t)};i.addEventListener("click",s,!1),i.classList.add("labicon-line_index","is-customindex"),i.setAttribute("title",`${e.getType()} has custom placement. Click to remove on mobile`);const a=(t,n,o)=>{t.getParent()&&"bodytext"!==t.getParent().getType()&&(s(),i.remove(),this.api.v1.model.bindings.unbind(e,"path",a))};return this.api.v1.model.bindings.bind(e,"path",a),i}removeCustomIndexElement(e){for(const t of this.api.v1.view.getViews(e))t.unsetExtraElement("customIndexElement")}}class A{constructor(e){this.api=e}onId(e){const t=lab_api.v1.user.getField("favouriteBylineIds")||[],i=e.get("instance_of");i&&!t.includes(i)&&(t.unshift(i),lab_api.v1.user.setField("favouriteBylineIds",t.slice(0,5)))}onReady(e,t){const i=this.api.v1.model.query.getChildOfType(e,"image");i&&i.get("fields.width")&&i.set("fields.width",null,{save:!1,undoable:!1})}onRender(e,t){const i=this.api.v1.app.mode.isEditor(),s=this.api.v1.config.get("contentbox_settings.byline")||{},a=s.template||[],n={public_email:t.get("fields.public_email"),public_url:t.get("fields.public_url"),public_phone:t.get("fields.public_phone"),firstname:t.get("fields.firstname"),lastname:t.get("fields.lastname"),description:t.get("fields.description"),description2:t.get("fields.description2")};i||(n.firstname&&n.firstname.match(/^byline first name$/i)&&(n.firstname=""),n.lastname&&n.lastname.match(/^byline last name$/i)&&(n.lastname=""));const o={items:[],imageAbove:!!s.imageAbove,imageBelow:!s.imageAbove&&!!s.imageBelow};a.forEach((e=>{const t={url:null,parts:[]};if((e.keys||[]).forEach((e=>{if(n[e]&&n[e]!==`Click to edit ${e}`||i){let i,a=n[e];"description"===e&&s.enableDescriptionLength&&n[e]&&n[e].length>=s.descriptionLength&&(i=n[e],a=`${n[e].substring(0,s.descriptionLength)}...`),t.parts.push({key:e,value:a,title:i})}})),e.url){Array.isArray(e.url)||(e.url=[e.url]);for(let i of Object.keys(e.url))if(i=e.url[i],n[i]){let e=n[i];"public_email"===i&&(e=`mailto:${e}`),t.url=e;break}}t.parts.length&&o.items.push(t)})),e.setFiltered("default_color",s.default_color||""),e.setFiltered("data",o)}}class P{constructor(e){this.api=e}onRender(e,t){const i=this.api.v1.model.query.getRootModel(),s=i.get("filtered.contentLanguage"),a=i.get("fields.lab_changelog_json");if(a&&a.length>0){let t;t="string"==typeof a?JSON.parse(a):[...a],e.setFiltered("changelogHasContent",!0);const i=[];t.forEach((e=>{const t={time:new Date(1e3*e.time).toLocaleDateString(s),changelog:this.convertNewLines(e.changelog)};i.push(t)})),e.setFiltered("changelog",i)}}convertNewLines(e){return`<p>${e=(e=e.replace(/\n\n/g,"</p><p>")).replace(/\n/g,"<br>")}</p>`}}class O{constructor(e){this.api=e,this.dateTimeHelper=new r(this.api.v1.config.get("lang")),this.sources={disqus_most_popular:{source:"disqus",url:`${lab_api.v1.properties.get("integration_url")}/feed/disqus/?site=${lab_api.v1.properties.get("site.alias")}&action=popular`,name:"Most commented articles",description:""},hyvor_most_popular:{source:"hyvor",url:`${lab_api.v1.properties.get("integration_url")}/feed/hyvor/?site=${lab_api.v1.properties.get("site.alias")}&action=popular`,name:"Most commented articles",description:""},hyvor_recent:{source:"hyvor",url:`${lab_api.v1.properties.get("integration_url")}/feed/hyvor/?site=${lab_api.v1.properties.get("site.alias")}&action=recent`,name:"Recent comments",description:""}}}getSourceConfig(e,t){const i=lab_api.v1.config.get("comments_provider")||{},s=Object.keys(i).shift();let a;a="hyvor"===s?"hyvor_most_popular":"disqus_most_popular";const n=e.get("fields.source")||a,o=e.get("fields.title"),r=e.get("fields.description"),l=Math.min(parseInt(e.get("fields.limit")||"5",10),30),d=(lab_api.v1.config.get("contentbox_settings.comments.sources")||[]).filter((e=>void 0!==this.sources[e.type]&&this.sources[e.type].source===s)),c=lab_api.v1.app.mode.isEditor();if(!d.length)return Sys.logger.warning(`comments: Missing required config "contentbox_settings.comments.sources". Options (type): ${Object.keys(this.sources).join(", ")}`),c&&e.setFiltered("error","Missing required source(s)."),null;const g={...this.sources[n],...d.filter((e=>e.type===n)).pop()};return g.url+=`&limit=${l}`,o&&(g.name=o),r&&(g.description=r),g}onViewHelper(e,t){const i=this.getSourceConfig(e,t);i&&e.setFiltered("url",i.url)}onRender(e,t){const i=this.getSourceConfig(e,t);if(!i)return;const s=lab_api.v1.app.mode.isEditor(),a=lab_api.v1.config.get("comments_provider")||{},n=Object.keys(a).shift(),o="hyvor"===n?"hyvor_most_popular":"disqus_most_popular",r=e.get("fields.source")||o,l=e.get("fields.maxCharLength"),d=Math.min(parseInt(e.get("fields.limit")||"5",10),30),c=t.get("external"),g=c&&"string"==typeof c;g?(e.setFiltered("error","Error fetching data"),Sys.logger.warn(`Comments: Error fetching data from url: ${i.url}`)):e.setFiltered("error",null);const p=e=>{const t=e||"";return l?`${t.substring(0,l)} ${t.length>l?"...":""}`:t};if(c&&!g){let t=c;if("disqus_most_popular"===i.type&&(t=c.response.map((e=>({link:e.link,title:p(e.title)})))),"hyvor_most_popular"===i.type&&(t=c.data.map((e=>({link:e.url,title:p(e.title)})))),"hyvor_recent"===i.type){const e=i.items||{},s=e.date||{};t=c.data.map((t=>t.page&&t.page.url?{link:`${t.page.url}?ht-comment-id=${t.id}`,title:(e.titlePrefix||"")+p(t.page.title),user:t.user?t.user.name:"",date:this.dateTimeHelper.format(new Date(1e3*t.created_at),s.template||"")}:{}))}e.setFiltered("data",t)}for(const t of Object.keys(this.sources))e.setFiltered(`is_${t}`,t===r);if(e.setFiltered("url",i.url),e.setFiltered("source",i),!s)return;const u=(lab_api.v1.config.get("contentbox_settings.comments.sources")||[]).filter((e=>void 0!==this.sources[e.type]&&this.sources[e.type].source===n)).map((e=>({name:e.type,selected:e.type===r})));e.setFiltered("sourceList",u),e.setFiltered("limit",d)}}class R{static run(e){const t=e.options||lab_api.v1.config.get(e.configPath)||{},i=lab_api.v1.util.object.merge({kicker:null,kicker_editable:!1,expandable:{mobile:!0,desktop:!0},collapsable:{mobile:!0,desktop:!0},collapsedState:{mobile:!0,desktop:!1},needJs:!1,style:"fade"},t),s=[`style-${i.style}`];for(const e in i.expandable)i.expandable[e]&&s.push(`expandable-${e}`);for(const e in i.collapsable)i.collapsable[e]&&s.push(`collapsable-${e}`);return i.needJs=s.length>0,i.cssString=s.join(" "),i}}class j{constructor(e){this.api=e}onRender(e,t){e.setFiltered("options",R.run({configPath:"contentbox_settings.factbox"})),e.setFiltered("noContent",lab_api.v1.app.mode.isFront()&&!e.get("fields.title")&&!e.get("fields.bodytext"))}}class L{constructor(e){this.api=e}onSettingsPanel(){function e(e,t){const i=lab_api.v1.model.query.getRootModel().getId();return lab_api.v1.ui.element.getPageSelector({value:t?parseInt(t,10):null,siteId:e?parseInt(e,10):0,attributes:[{name:"name",value:"pageId"},{name:"id",value:"frontrows_pageId"}],pages:lab_api.v1.pages.front.getAll().filter((e=>e.nodeid!==i))})}return{onDisplay:({model:t,view:i,config:s,markup:a})=>{const n=t.get("fields.fragment_json")||{},o={siteselector:a.querySelector('[data-element="siteselector"]'),pageselector:a.querySelector('[data-element="pageselector"]')},r=lab_api.v1.ui.element.getSiteSelector({value:n.siteId?parseInt(n.siteId,10):null,attributes:[{name:"name",value:"siteId"},{name:"id",value:"frontrows_siteId"}]});let l=e(n.siteId||r.value,n.pageId);o.siteselector.appendChild(r),o.pageselector.appendChild(l),r.addEventListener("change",(t=>{l.remove(),l=e(r.value),o.pageselector.appendChild(l)}),!1)},onSubmit:({model:e,view:t,settings:i,markup:s,formValues:a})=>{e.resetExternalResource(),e.set("fields.fragment_json",a)}}}}class q{constructor(e){this.api=e}onRender(e,t){const i=this.api.v1.config.get("contentbox_settings.frontContent")||{},s=this.api.v1.properties.get("integration_url"),a=this.api.v1.properties.get("front_api_url"),n=Object.values(this.api.v1.config.get("feeds")||{}).filter((e=>!!e.labrador_json)).map((e=>({identifier:e.display_name,name:e.display_name,type:e.url.includes("lab_viewport=json")?"DachserJson":"LabradorApi",url:e.url.replace("{{int}}",s).replace("{{api}}",a)}))),o=(i.sources||[]).concat(n),r=e.get("fields.source"),l={...o.filter((e=>e.identifier===r)).shift()||{}},d=e.get("fields.organizer"),c=this.api.v1.app.mode.isEditor(),g=e.get("fields.overrideUrlByTagsCookie",!0),p=void 0===g?!!i.overrideUrlByTagsCookie:!!g,u=((e,t)=>{const i=(e.get("fields.tags_string")||"").split(",").map((e=>e.trim())).filter((e=>!!e));return i.length?i:t.map((e=>e.tag))})(e,i.tagsArray||[]),h=((e,t)=>{const i={};for(const e of t)i[e.tag]=e.description;return e.map((e=>({tag:e,description:i[e]||e})))})(u,i.tagsArray||[]),f=e.get("fields.articleCount")||24,m={columnCount:parseFloat(e.get("fields.layout_columnCount")||3),rowCount:parseFloat(e.get("fields.layout_rowCount")||10),maxRowSize:parseFloat(e.get("fields.layout_maxRowSize")||3),minRowSize:parseFloat(e.get("fields.layout_minRowSize")||1),imageAspectRatio:parseFloat(e.get("fields.layout_imageAspectRatio")||.45),gridsize:parseFloat(e.get("fields.layout_gridsize")||12),hide_items:[]};e.get("fields.hide_title")&&m.hide_items.push("title"),e.get("fields.hide_subtitle")&&m.hide_items.push("subtitle"),e.get("fields.hide_image")&&m.hide_items.push("image"),e.get("fields.hide_kicker")&&m.hide_items.push("kicker");const b=[];e.get("fields.filterExisting")&&b.push({path:"contentdata.id",values:this.api.v1.model.query.getModelsByType("article").filter((e=>!!e.get("instance_of"))).map((e=>String(e.get("instance_of"))))});let y=f;["RandomRows"].includes(d)||(y=m.columnCount*m.rowCount||f);const v=e.get("fields.articleFetchCount")||y;e.setFiltered("source",l),e.setFiltered("articleCount",y),e.setFiltered("articleFetchCount",v),e.setFiltered("articleFilterList",JSON.stringify(b)),e.setFiltered("isDebug",this.api.v1.util.request.hasQueryParam("debug")),e.setFiltered("isEditor",c),e.setFiltered("isConfigured",y&&d&&l.identifier&&l.url&&l.type),e.setFiltered("viewport",this.api.v1.viewport.getName()),e.setFiltered("imageServer",this.api.v1.properties.get("image_server")),e.setFiltered("layout",JSON.stringify(m)),e.setFiltered("cookieOptions",{allow:p,cookieName:i.cookieName||"dachserFrontContentTags",tagsArray:h,tagsArrayString:JSON.stringify(h)}),e.setFiltered("tagOptions",{allow:!!e.get("fields.tags_allow")&&"LabradorApi"===l.type,useOr:!!e.get("fields.tags_useOr"),tags:u,tags_string:u.join(", "),tagsString:JSON.stringify(u)});const _=[];e.get("fields.size_active")&&(e.get("fields.size_title")&&_.push({path:"contentdata.fields.title.attributes.text_size.value",value:parseInt(e.get("fields.size_title"),10)}),e.get("fields.size_subtitle")&&_.push({path:"contentdata.fields.subtitle.attributes.text_size.value",value:parseInt(e.get("fields.size_subtitle"),10)}),e.get("fields.size_kicker")&&_.push({path:"contentdata.fields.kicker.attributes.text_size.value",value:parseInt(e.get("fields.size_kicker"),10)})),e.setFiltered("styleString",JSON.stringify(_)),c&&(l.url&&"LPStream"!==l.type&&(l.url=`${this.api.v1.properties.get("proxy")}?query=${encodeURIComponent(l.url)}`,e.setFiltered("source",l)),e.setFiltered("sourcesConfig",o))}}class z{constructor(e){this.api=e}onViewHelper(e,t){const i=this.api.v1.site.getSite().id;e.setFiltered("siteID",i)}onRender(e,t){const i=this.api.v1.model.query.getRootModel().get("filtered.contentLanguage"),s=t.get("external"),a=[];s&&s.result&&s.result.forEach((e=>{if("article"===e.type){let t;const s=e.lab_changelog_json||null;if("string"==typeof s){const e=this.stripJSON(s);e&&this.isValidJSON(e)&&(t=JSON.parse(e))}else t=s;t&&t.forEach((e=>{const t=new Date(1e3*e.time);e.time=t.toLocaleDateString(i),e.changelog=this.convertNewLines(e.changelog)})),a.push({title:e.title,published_url:e.published_url,changelog:t})}})),e.setFiltered("templateData",a)}stripJSON(e){return e.replace(/\\n/g,"\\n").replace(/\\'/g,"'").replace(/\\"/g,'"').replace(/\\&/g,"&").replace(/\\r/g,"\r").replace(/\\t/g,"\t").replace(/\\b/g,"\b").replace(/\\f/g,"\f")}isValidJSON(e){try{JSON.parse(e)}catch(e){return!1}return!0}convertNewLines(e){return`<p>${e=(e=e.replace(/\\n\\n/g,"</p><p>")).replace(/\\n/g,"<br>")}</p>`}}class N{constructor(e){this.api=e}onRender(e,t){const i=this.api.v1.model.query.getRootModel(),s=this.api.v1.config.get("contentbox_settings.googleAd.formats")||[],a=e.get("fields.format"),n=this.api.v1.config.get("adEnvironment")||{},o={bidding:n.bidding,hideOnTabletWidth:n.hideOnTabletWidth||1316,fetchMarginPercent:n.fetchMarginPercent||150,renderMarginPercent:n.renderMarginPercent||150};e.setFiltered("googleAds",o);const r=((e,t)=>{for(let i=0;i<t.length;i++)if(t[i].format===e)return{...t[i]};return{}})(a,s);if(r.key=e.get("metadata.key")||"row",o.bidding&&o.bidding.enabled&&o.bidding.provider&&o.bidding.provider.name&&"livewrapped"===o.bidding.provider.name){const e=()=>{const e=()=>(65536*(1+Math.random())|0).toString(16).substring(1);return`${e()+e()}-${e()}-${e()}-${e()}-${e()}${e()}${e()}`};r.code&&r.code.endsWith("-1")&&(r.code+=`_${e()}`)}"mpu_top"===r.code&&(r.isMpuTop=!0),e.setFiltered("adData",r),e.setFiltered("isDebug",this.api.v1.util.request.hasQueryParam("debug")||e.get("metadata.isDebug"));const l=this.api.v1.config.get("contentbox_settings.googleAd.label")||"Annonse",d=e.get("fields.label")||l;if(e.setFiltered("label",d),!this.api.v1.app.mode.isEditor()){const t=e.parent&&!0===e.parent.get("metadata.hideOnTablet")&&"tablet"===this.api.v1.properties.get("xUaDevice");e.setFiltered("hideOnTablet",t)}if(this.api.v1.app.mode.isEditor()){const t=i.get("type").replace("page_",""),a=[];s.forEach((e=>{(e.selectable&&e.selectable.indexOf(t)>-1||e.selectableOn&&!0===e.selectableOn[t])&&a.push(e)})),e.setFiltered("formatConfigKeys",a)}if((e.get("metadata.css")||"").includes("sticky")){const t=`top: ${this.api.v1.config.get("contentbox_settings.googleAd.spacingTop")||120}px;`;e.setFiltered("spacingTop",t)}}}class H{constructor(e){this.api=e}onRender(e,t){e.setFiltered("cse_id",e.get("fields.cse_id")||this.api.v1.config.get("contentbox_settings.googleCSE.cse_id"))}}class U{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor(),this.isFragmentMode=this.api.v1.app.mode.isFragmentMode(),this.lazyloadImages=!this.isEditor&&!!this.api.v1.config.get("imageLoading.lazy")}check(e,t){if(!this.lazyloadImages||t.getProperty("image.noLazy"))return!1;const i=lab_api.v1.model.query.getParentOfType(e,"row");return!(i&&!this.isFragmentMode&&i.getModelIndex()<5)}}class B{constructor(e){this.api=e,this.lazyloadHelper=new U(e),this.api.v1.app.mode.isEditor()&&(this.cropIds=[],this.rootModel=this.api.v1.model.query.getRootModel(),this.frontcropBinding=this.frontCropChanged.bind(this),this.api.v1.model.bindings.bind(this.rootModel,"frontCrop",this.frontcropBinding),this.frontcropBinding(this.rootModel,"frontCrop",this.rootModel.get("frontCrop")),this.api.v1.ns.set("imageFilter.preview",this.prepareVisualFilters)),this.isFragmentMode=this.api.v1.app.mode.isFragmentMode()}onViewHelper(e,t){if(e.parent){this.prepareForSlideshow(e,t);const i=t.getViewport();if(this.api.v1.view.getView(e.parent,i).get("metadata.hasFullWidth")){const t="mobile"===i?600:1800;e.setFiltered(`width.${i}`,t)}else e.setFiltered(`width.${i}`,null);e.setFiltered("allowFullwidth","image"!==e.parent.getType())}}onRender(e,t){this.setVisualFilters(e,t),e.setFiltered("lazyloadImages",this.lazyloadHelper.check(e,t)),this.setCaptionOptions(e.getParent(),e,t);const i=t.get("fields.float");e.setFiltered("hasFloat",!!i&&"floatNone"!==i)}onRendered(e,t){if(!this.api.v1.app.mode.isEditor()||!this.cropIds.length)return;const i=parseInt(e.get("instance_of"),10);this.cropIds.includes(i)&&this.markFrontCrop(t,i)}setVisualFilters(e,t){e.setFiltered("filters",this.prepareVisualFilters(e,t))}prepareVisualFilters(e,t,i=!1){const s=[],a=e.get("metadata.filter_blur_active")?e.get("metadata.filter_blur_value")||0:null,n=e.get("metadata.filter_sepia_active")?e.get("metadata.filter_sepia_value")||0:null,o=e.get("metadata.filter_saturate_active")?e.get("metadata.filter_saturate_value")||1:null,r=e.get("metadata.filter_brightness_active")?e.get("metadata.filter_brightness_value")||1:null,l=e.get("metadata.filter_contrast_active")?e.get("metadata.filter_contrast_value")||1:null;return null!==a&&s.push(`blur(${a}px)`),null!==n&&s.push(`sepia(${n})`),null!==o&&s.push(`saturate(${o})`),null!==r&&s.push(`brightness(${r})`),null!==l&&s.push(`contrast(${l})`),i?{filter:s.join(" ")}:s.length?`filter: ${s.join(" ")};`:null}markFrontCrop(e,t){const i=document.createElement("span");i.classList.add("labicon-imgFrontCrop","is-frontcrop"),i.setAttribute("title","Image used as front crop. Click to edit"),i.addEventListener("click",(e=>{e.stopPropagation(),e.preventDefault(),this.api.v1.apps.start("ArticleSettings")}),!1),e.getMarkup().appendChild(i)}frontCropChanged(e,t,i){let s=this.getImages(this.cropIds);this.cropIds=[],this.updateImages(s),i&&(i.pano&&i.pano.instance_of&&this.cropIds.push(i.pano.instance_of),i.height&&i.height.instance_of&&!this.cropIds.includes(i.height.instance_of)&&this.cropIds.push(i.height.instance_of),s=this.getImages(this.cropIds),this.updateImages(s))}getImages(e){const t=[];for(const i of e)t.push(...this.api.v1.model.query.getModelsByKeyAndValue("instance_of",i));return t}updateImages(e){for(const t of e)this.api.v1.model.addToRedrawQueue(t)}setCaptionOptions(e,t,i){const s=e?this.api.v1.view.getView(e,i.getViewport()):null,a=(e,t,i)=>{if(e){const t=e.get(i);if(!t&&null!==t)return!1;if(t)return!0}return!!t.get(i)};let n=a(s,i,"fields.displayCaption"),o=n||null===i.get("fields.displayCaption")&&!i.get("metadata.hidecaption");!this.api.v1.app.mode.isFront()||t.get("fields.imageCaption")||t.get("fields.byline")||(n=!1,o=!1);const r=a(s,i,"fields.expandableCaption"),l=a(s,i,"fields.truncateCaption");let d=t.get("fields.imageCaption");!t.parent||i.getProperty("image.useCaptionForTitle")&&d||(d=t.parent.get("fields.title")||"");const c={title:d,display:n,displayDefault:o,truncate:l,expandable:r||l};t.setFiltered("captionOptions",c)}prepareForSlideshow(e,t){if(!e.parent||"slideshow"!==e.parent.getType())return;if(t.get("fields.whRatio"))return void e.setFiltered("whRatio",null);const i=e.get("fields.originalWidth"),s=e.get("fields.originalHeight");if(s&&i){const t=s/i;e.setFiltered("whRatio",t)}}}class W{constructor(e){this.api=e,this.lazyloadHelper=new U(e)}onRender(e,t){e.setFiltered("lazyloadImages",this.lazyloadHelper.check(e,t))}}class V{constructor(e){this.api=e}onRender(e,t){const i=lab_api.v1.properties.get("sites"),s=[],a=e.get("fields.allowedSites_json")||{},n=[];if(i.forEach((e=>{const t={alias:e.alias,id:e.id,displayName:e.display_name,selected:!1};s.push(t),a[e.alias]===`${e.id}`&&(t.selected=!0,n.push(t))})),0===n.length){const e=lab_api.v1.properties.get("site");s.forEach((t=>{t.id===e.id&&(t.selected=!0,n.push(t))}))}const o=t.get("fields.orderBy")||"published",r=[{value:"published",label:"Published"},{value:"score",label:"Score"}];r.forEach((e=>{o&&o===e.value&&(e.selected=!0)}));const l=parseInt(e.get("fields.desktopWidth")||100,10);e.setFiltered("desktopWidth",[100,50,33,25].map((e=>({key:e,value:e,selected:e===l})))),e.setFiltered("desktopWidth",[{key:"100% - 1 column",value:100,selected:100===l},{key:"50% - 2 columns",value:50,selected:50===l},{key:"33% - 3 columns",value:33,selected:33===l},{key:"25% - 4 columns",value:25,selected:25===l}]),e.setFiltered("sites",s),e.setFiltered("allowedSites",n),e.setFiltered("allowedSitesString",JSON.stringify(n||[])),e.setFiltered("orderByOptions",r)}}class J{static mediaQueries={desktop:"(min-width:1024px)",mobile:"(max-width: 1023px)"};static createStyle(e,t,i,s=this.mediaQueries){const a=[];for(const n of i){const i=s[n]?e.get(t,n):null;i&&a.push(`@media ${s[n]} { ${i.selector} { transform: translate(${i.x}px, ${i.y}px); } }`)}return`<style>${a.join("\n")}</style>`}}class Y{validate(e=""){return new Promise(((t,i)=>{try{const i=document.createElement("template");i.innerHTML=e.trim(),t(i.innerHTML.trim())}catch(e){i(e)}}))}createElements(e){return[...document.createRange().createContextualFragment(e).children]}}class G{constructor(e){this.api=e,this.validation={suggestedMarkup:null,isUnvalid:!1,error:""}}onRender(e,t){if(t.get("metadata.movableContent")&&e.setFiltered("movableStyle",J.createStyle(e,"metadata.contentPosition",["desktop","mobile"])),!this.api.v1.app.mode.isEditor()&&!0===this.api.v1.config.get("cookieConsent.enabled")){e.setFiltered("requiredCookieConsent",t.get("metadata.requiredCookieConsent")||!1);let i=t.get("fields.markup")||"";i=i.replace(/<\/script>/g,"<\\/script>"),e.setFiltered("markup_escaped",i)}}onSettingsPanel(e,t,i){return{onDisplay:i=>{const s=i.markup.querySelector("textarea");if(!s)return;const a=i.markup.querySelector('input[name="doValidate"]');if(a&&(a.addEventListener("change",(t=>{e.set("fields.skipValidation",!t.target.checked||null)}),!1),a.checked=!e.get("fields.skipValidation")),s.value=t.get("fields.markup"),this.validation.suggestedMarkup){s.value=this.validation.suggestedMarkup;const e=document.createElement("p");this.validation.isUnvalid?e.innerHTML=`<span style="color: red;">Markup is invalid. Please correct the markup and try again.</span><br>${this.validation.error}`:e.innerHTML="Validator has modified markup. Please review the suggested markup below.",s.before(e),this.validation.suggestedMarkup=null,this.validation.isUnvalid=!1,this.validation.error=""}i.markup.querySelector("textarea").focus(),s.addEventListener("keydown",(e=>{if("Tab"===e.key){e.preventDefault();const[t,i]=[s.selectionStart,s.selectionEnd];s.setRangeText("    ",t,i,"end")}}),!1)},onSubmit:({model:e,view:t,config:i,markup:s,modal:a,formValues:n})=>{n.doValidate?(new Y).validate(n["fields.markup"]).then((s=>{if(n["fields.markup"].trim()!==s){this.validation.suggestedMarkup=s,this.validation.isUnvalid=!1;const a={...i};return a.defaultButtons=!1,a.container.state.warning=!0,void this.api.v1.ui.modal.panel(e,t,a)}t.set("fields.markup",s)})).catch((s=>{this.validation.suggestedMarkup=n["fields.markup"],this.validation.isUnvalid=!0,this.validation.error=s.message;const a={...i};a.defaultButtons=!1,a.container.state.error=!0,this.api.v1.ui.modal.panel(e,t,a)})):t.set("fields.markup",n["fields.markup"])}}}}class Q{constructor(e,t){this.api=e,this.rootModel=e.v1.model.query.getRootModel()}onViewHelper(e,t){const i=this.api.v1.site.getSite();e.setFiltered("siteId",i.id),e.setFiltered("testId",e.get("fields.testId"));const s={0:"Score + pros/cons",1:"Score + pros/cons + specs",2:"Score + specs",3:"Pros/cons + specs",4:"Score",5:"Pros/cons",6:"Specs"},a=e.get("fields.layoutOption")||"0",n={score:"0"===a||"1"===a||"2"===a||"4"===a,prosCons:"0"===a||"1"===a||"3"===a||"5"===a,specs:"1"===a||"2"===a||"3"===a||"6"===a};e.setFiltered("visible",n),e.setFiltered("isDebug",this.api.v1.util.request.hasQueryParam("debug"));const o=[];for(const e of Object.keys(s))o.push({key:e,value:s[e],selected:e===a});if(e.setFiltered("layoutOptions",o),e.setFiltered("apiEndpoint",s[a]),e.setFiltered("topScore","on"===e.get("fields.topScore")),e.setFiltered("recommended","on"===e.get("fields.recommended")),e.setFiltered("titleWithGrade","on"===e.get("fields.titleWithGrade")),e.setFiltered("titleWithFacts","on"===e.get("fields.titleWithFacts")),this.api.v1.app.mode.isEditor()){const t=[];let i=e.get("fields.score")||"0";i=parseInt(i,10);for(let e=1;e<11;e++)t.push({value:e,selected:i===e?"selected":""});e.setFiltered("scoreOptions",t)}}onRender(e,t){const i=t.get("external");if(!i)return;e.setFiltered("productName",i.namn?i.namn:""),e.setFiltered("pros",i.plus?i.plus:[]),e.setFiltered("cons",i.minus?i.minus:[]),e.setFiltered("structuredData",i.struktureradData?JSON.stringify(i.struktureradData):"");const s=[];i.betyg&&i.betyg.length&&i.betyg.forEach((e=>{let t=!1,i=!1,a=!1;e.v&&(t=e.v,parseInt(e.v,10)<11?a=`${e.v}0`:(a=e.v,i=!0)),s.push({key:e.n,score:t,scoreIsPercent:i,percent:a})})),e.setFiltered("score",s),e.setFiltered("recommended","Ja"===i.braköp||"on"===e.get("fields.recommended")),e.setFiltered("topScore","Ja"===i.toppbetyg||"on"===e.get("fields.topScore")),e.setFiltered("specifications",i.spec?i.spec:[])}onSettingsPanel(e){return this.model=e,{onDisplay:e=>{this.api.v1.apps.start("TextEdit").then((t=>{this.setupRichTextEditing(t,e.markup,this.model)})).catch((e=>{console.log(`Error loading TextEdit-app: ${e}`)}))}}}setupRichTextEditing(e,t,i){for(const s of t.querySelectorAll("div.lab-input-text"))if(s&&s instanceof HTMLElement){const a=s.getAttribute("data-input-key")||"no-key";this.setupRichTextEditingForElement(e,t,s,a,i)}}setupRichTextEditingForElement(e,t,i,s,a){const n={};lab_api.v1.util.object.set(s,a.get(s),n),e.register({element:i,simulatedData:{type:"article",path:"",contentdata:n},toolSettings:{key:s,inlineOnly:!0,displayCharCount:!1,displaySelectionLength:!1,displayWordCount:!1,selectTextOnStart:!1,placeholder:"",attributes:{text_size:{active:!1}}},callbacks:{ended:(e,t)=>{this.model.set(e,t)}},menuSettings:{container:t,items:{bold:{group:"g2",icon:"labicon-text_bold",callback:"toggleAttribute",key:"font_weight",attributes:{class:"font-weight-bold"},value:!1,onValue:"font-weight-bold",offValue:!1,bindToSelection:"font_weight",title:"Font weight - Bold",hotkeys:[{key:"B",controlkeys:["labCtrlKey"],preventDefault:!0,overrideDisable:!0}]},italic:{group:"g2",icon:"labicon-text_italic",callback:"toggleAttribute",key:"italic",attributes:{class:"italic"},value:!1,onValue:"italic",offValue:!1,bindToSelection:"italic",title:"Italic",hotkeys:[{key:"i",controlkeys:["labCtrlKey"],preventDefault:!0,overrideDisable:!0}]},reset:{group:"g4",icon:"labicon-reset_style",callback:"reset",title:"Remove textformatting in selection for viewport"}}}})}}class K{constructor(e){this.api=e}onViewHelper(e,t){const i=this.api.v1.site.getSite();e.setFiltered("siteId",i.id),e.setFiltered("testId",e.get("fields.testId"));const s={summerTire:"tiresummertests",winterTire:"tirewintertests",food:"foodtests",hotel:"hoteltests",vehicle:"vehicletests"},a=e.get("fields.testType")||"vehicle",n="horizontal"===e.get("fields.displayDirection")?"horizontal":"vertical";e.setFiltered("displayDirection",n),e.setFiltered("displayDirectionOptions",[{value:"horizontal",selected:"horizontal"===n},{value:"vertical",selected:"vertical"===n}]),e.setFiltered("needSlider","horizontal"===n),e.setFiltered("isDebug",this.api.v1.util.request.hasQueryParam("debug"));const o=[];for(const e of Object.keys(s))o.push({value:e,selected:e===a});e.setFiltered("typeOptions",o),e.setFiltered("apiEndpoint",s[a])}onRender(e,t){const i=t.get("external");if(!i)return;const s=e.get("fields.testType")||"vehicle",a={vehicle:{comfort:"Komfort",design:"Design",driveability:"Kjøreegenskaper",environment:"Miljø og forbruk",equipment:"Utstyr",practicality:"Praktisk",price:"Pris",runningCosts:"Driftskostnader",security:"Sikkerhet",value:"Annenhåndsverdi"},food:{firstImpression:"Førsteinntrykk",menu:"Meny",taste:"Smak",price:"Pris",service:"Service",familyFriendly:"Barnevennlig",homemade:"Hjemmelaget",drinks:"Drikke",cleaning:"Renhold",lavatories:"Toaletter"},hotel:{location:"Beliggenhet",rooms:"Rom",standard:"Standard",beds:"Senger",breakfast:"Frokost",bathroom:"Bad",commonAreas:"Fellesområder",cleaning:"Renhold",value:"Valuta for pengene"},summerTire:{asphalt:"Tørr asfalt",asphaltWet:"Våt asfalt",grip:"Grep",breaking:"Bremselengde",driveability:"Kjøreegenskaper",aquaplaning:"Vannplaning",aquaplaningSwing:"Vannplaning sving",comfort:"Komfort",fuelConsumption:"Forbruk",noise:"Støy",other:"Annet"},winterTire:{snow:"Snø",ice:"Is",asphalt:"Tørr asfalt",asphaltWet:"Våt asfalt",breaking:"Bremselengde",driveability:"Kjøreegenskaper",aquaplaning:"Vannplaning",aquaplaningSwing:"Vannplaning sving",comfort:"Komfort",fuelConsumption:"Forbruk",noise:"Støy",grip:"Grep",acceleration:"Akselerasjon",other:"Annet",spikes:"Pigger",count:"Antall",spikeLengthBefore:"Piggutstikk etter innkjøring (mm)",spikeLengthAfter:"Piggutstikk etter snø/istest (mm)",weightKg:"Vekt",installationDescription:"Montering"}},n=[];if(s.indexOf("Tire")>0){const e=new r(this.api.v1.config.get("lang")),t=new Date(i.production.date),o=Number.isNaN(t.getTime())?i.production.date:e.formattedDate(t,"d/m Y");let l="";"winterTire"===s&&(l=`<span class="test-key-value"><span class="test-key">Pigger:</span><span class="test-value">${i.spikes&&i.spikes.isSpikes?i.spikes.count:"nei"}</span></span>`),i.description&&"string"==typeof i.description&&(i.description=i.description.replace(/\n/g,"<br>")),n.push({title:"Fakta",description:`\n                    <span class="test-key-value"><span class="test-key">Produksjonsland:</span><span class="test-value">${i.production.country||""}</span></span>\n                    <span class="test-key-value"><span class="test-key">Produksjonsdato:</span><span class="test-value">${o||""}</span></span>\n                    ${l}\n                    <p>${i.description||""}</p>\n                `}),i.description="",i.loadSpeedRating&&i.loadSpeedRating.length&&(i.description+=`<span class="test-key-value"><span class="test-key">Last- og hastighetsindeks:</span><span class="test-value">${i.loadSpeedRating}</span></span>`),i.shore&&i.shore.length&&(i.description+=`<span class="test-key-value"><span class="test-key">Hardhetstall</span><span class="test-value">${i.shore}</span></span>`),i.installationDescription&&i.installationDescription.length&&(i.description+=`<span class="test-key-value"><span class="test-key">Montering:</span><span class="test-value">${i.installationDescription}</span></span>`),Object.keys(a[s]).forEach((e=>{if(i[e]&&"object"==typeof i[e]&&Array.isArray(Object.keys(i[e]))&&Object.keys(i[e]).length>0){if("spikes"===e&&!i.spikes.isSpikes)return;let t="";Object.keys(i[e]).forEach((n=>{i[e][n]>0&&a[s][n]&&(t+=`<span class="test-key-value"><span class="test-key">${a[s][n]}:</span><span class="test-value">${i[e][n]}</span></span> `)})),n.push({title:a[s][e],description:t})}}))}else Object.keys(a[s]).forEach((e=>{if(i[e]){const t={title:a[s][e],score:i[e].score,description:i[e].description};n.push(t)}}));e.setFiltered("testSubject",i.name?i.name:null),e.setFiltered("totalScore",i.score?i.score:null),e.setFiltered("introduction",i.description?i.description:null),e.setFiltered("mappedCategories",n)}}class Z{constructor(e){this.api=e,this.signupText=e.v1.locale.get("newsletter.generic.signup"),this.yourEmailText=e.v1.locale.get("newsletter.generic.yourEmail"),this.subscribeButton=e.v1.locale.get("newsletter.generic.subscribeButton"),this.hiddenValue=e.v1.locale.get("newsletter.generic.hiddenValue")}onRender(e,t){const i=this.api.v1.config.get("contentbox_settings.newsletter_submit")||{},s=e.get("fields.newsletterDataAction")||("MAILMOJO_LENKE"===i.action?"":i.action)||"",a=e.get("fields.newsletterDataTitle"),n=e.get("fields.newsletterDataDescription"),o=e.get("fields.newsletterButtonText")||this.subscribeButton,r=e.get("fields.newsletterPlaceholder")||this.yourEmailText,l={provider:i.provider?i.provider:"mailmojo",title:a||(i.title?i.title:this.signupText),description:n||i.description||"",action:s,buttonText:o,placeholder:r,elements:i.elements?i.elements:[{type:"hidden",name:"tagsadditional",value:this.hiddenValue,class:"",placeholder:""},{type:"email",name:"email",value:"",class:"",placeholder:r},{type:"submit",name:"submit",value:o,class:"bg-secondary",placeholder:""}]};this.api.v1.app.mode.isFront()&&!l.action?e.setFiltered("newsletter_data",null):e.setFiltered("newsletter_data",l)}}class X{constructor(e){this.api=e}onRender(e,t){const i=this.api.v1.config.get("grid.total_grid_spans"),s=[];let a=!1;if(e.getChildren().forEach(((e,n)=>{const o=[],r=[],l=this.api.v1.view.getView(e,t.getViewport()),d=l.get("metadata.parallax")||{};["scale","rotate","opacity","blur","sepia","brightness"].forEach((e=>{const t=d[e]||{};t.active&&(a=!0,o.push(JSON.stringify({name:e.replace(".","_"),startValue:t.startValue||0,endValue:t.endValue||100,startScrollPosition:t.startScrollPosition||0,endScrollPosition:t.endScrollPosition||100})))})),["perspective"].forEach((e=>{const t=d[e]||{};t.active&&(a=!0,r.push(JSON.stringify({name:e,value:t.value||0})))}));const c=[this.api.v1.style.getStyle(e,l,"background_color"),this.api.v1.style.getStyle(e,l,"background_opacity")];s.push({index:n,type:e.getType(),sticky:!!d.sticky,fullwidth:!!d.fullwidth,height:d.height||"100",spaceBelow:d.spaceBelow||"0",position:d.position,horizontalAlign:d.horizontalAlign,verticalAlign:d.verticalAlign||"top",verticalPosition:d.verticalPosition||"auto",css:c.join(" "),grid:{desktop:this.api.v1.grid.percentToGrid(l.get("width",!1,"desktop"),i),mobile:this.api.v1.grid.percentToGrid(l.get("width",!1,"mobile"),i)},selector:`[data-parallax-layer="${n}"]`,hasAnimations:o.length>0||r.length>0,animations:o,staticAttributes:r})})),e.setFiltered("layers",s),e.setFiltered("elementCount",e.children.length),e.setFiltered("requireJs",a),e.setFiltered("isDebug",this.api.v1.util.request.hasQueryParam("debug")),!this.api.v1.app.mode.isEditor())return;e.setFiltered("displayNoContent",0===s.length),e.setFiltered("useReflow",!0);const n=Object.keys(t.getProperty("droppable.drop.sourceType")||{});e.setFiltered("supportedContentTypes",n)}}class ee{constructor(e){this.api=e}onRender(e,t){function i(e,t,i,s,a,n){return r(function(e,t){return e<<t|e>>>32-t}(r(r(t,e),r(s,n)),a),i)}function s(e,t,s,a,n,o,r){return i(t&s|~t&a,e,t,n,o,r)}function a(e,t,s,a,n,o,r){return i(t&a|s&~a,e,t,n,o,r)}function n(e,t,s,a,n,o,r){return i(t^s^a,e,t,n,o,r)}function o(e,t,s,a,n,o,r){return i(s^(t|~a),e,t,n,o,r)}function r(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}"page_article"===this.api.v1.model.query.getRootModel().getType()&&(this.api.v1.app.mode.isFront()&&!e.get("fields.caption")?e.setFiltered("displayCaption",!1):e.setFiltered("displayCaption",!0));const l=e.get("fields.uvid");let d=new Date;var c,g;d.setHours(d.getHours()+4),d=Math.floor(d.getTime()/1e3),e.setFiltered("dataAttributes",{type:e.get("fields.videoType")||"vod",id:e.get("fields.idString")||"GB001",token:(c=`${l}${d}boqCnvdBXwZTAaa7tMvKkte3MqaufjIZ`,g=function(e){for(var t,i="0123456789ABCDEF",s="",a=0;a<e.length;a++)t=e.charCodeAt(a),s+=i.charAt(t>>>4&15)+i.charAt(15&t);return s}(function(e){for(var t="",i=0;i<32*e.length;i+=8)t+=String.fromCharCode(e[i>>5]>>>i%32&255);return t}(function(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var i=1732584193,l=-271733879,d=-1732584194,c=271733878,g=0;g<e.length;g+=16){var p=i,u=l,h=d,f=c;l=o(l=o(l=o(l=o(l=n(l=n(l=n(l=n(l=a(l=a(l=a(l=a(l=s(l=s(l=s(l=s(l,d=s(d,c=s(c,i=s(i,l,d,c,e[g+0],7,-680876936),l,d,e[g+1],12,-389564586),i,l,e[g+2],17,606105819),c,i,e[g+3],22,-1044525330),d=s(d,c=s(c,i=s(i,l,d,c,e[g+4],7,-176418897),l,d,e[g+5],12,1200080426),i,l,e[g+6],17,-1473231341),c,i,e[g+7],22,-45705983),d=s(d,c=s(c,i=s(i,l,d,c,e[g+8],7,1770035416),l,d,e[g+9],12,-1958414417),i,l,e[g+10],17,-42063),c,i,e[g+11],22,-1990404162),d=s(d,c=s(c,i=s(i,l,d,c,e[g+12],7,1804603682),l,d,e[g+13],12,-40341101),i,l,e[g+14],17,-1502002290),c,i,e[g+15],22,1236535329),d=a(d,c=a(c,i=a(i,l,d,c,e[g+1],5,-165796510),l,d,e[g+6],9,-1069501632),i,l,e[g+11],14,643717713),c,i,e[g+0],20,-373897302),d=a(d,c=a(c,i=a(i,l,d,c,e[g+5],5,-701558691),l,d,e[g+10],9,38016083),i,l,e[g+15],14,-660478335),c,i,e[g+4],20,-405537848),d=a(d,c=a(c,i=a(i,l,d,c,e[g+9],5,568446438),l,d,e[g+14],9,-1019803690),i,l,e[g+3],14,-187363961),c,i,e[g+8],20,1163531501),d=a(d,c=a(c,i=a(i,l,d,c,e[g+13],5,-1444681467),l,d,e[g+2],9,-51403784),i,l,e[g+7],14,1735328473),c,i,e[g+12],20,-1926607734),d=n(d,c=n(c,i=n(i,l,d,c,e[g+5],4,-378558),l,d,e[g+8],11,-2022574463),i,l,e[g+11],16,1839030562),c,i,e[g+14],23,-35309556),d=n(d,c=n(c,i=n(i,l,d,c,e[g+1],4,-1530992060),l,d,e[g+4],11,1272893353),i,l,e[g+7],16,-155497632),c,i,e[g+10],23,-1094730640),d=n(d,c=n(c,i=n(i,l,d,c,e[g+13],4,681279174),l,d,e[g+0],11,-358537222),i,l,e[g+3],16,-722521979),c,i,e[g+6],23,76029189),d=n(d,c=n(c,i=n(i,l,d,c,e[g+9],4,-640364487),l,d,e[g+12],11,-421815835),i,l,e[g+15],16,530742520),c,i,e[g+2],23,-995338651),d=o(d,c=o(c,i=o(i,l,d,c,e[g+0],6,-198630844),l,d,e[g+7],10,1126891415),i,l,e[g+14],15,-1416354905),c,i,e[g+5],21,-57434055),d=o(d,c=o(c,i=o(i,l,d,c,e[g+12],6,1700485571),l,d,e[g+3],10,-1894986606),i,l,e[g+10],15,-1051523),c,i,e[g+1],21,-2054922799),d=o(d,c=o(c,i=o(i,l,d,c,e[g+8],6,1873313359),l,d,e[g+15],10,-30611744),i,l,e[g+6],15,-1560198380),c,i,e[g+13],21,1309151649),d=o(d,c=o(c,i=o(i,l,d,c,e[g+4],6,-145523070),l,d,e[g+11],10,-1120210379),i,l,e[g+2],15,718787259),c,i,e[g+9],21,-343485551),i=r(i,p),l=r(l,u),d=r(d,h),c=r(c,f)}return Array(i,l,d,c)}(function(e){for(var t=Array(e.length>>2),i=0;i<t.length;i++)t[i]=0;for(i=0;i<8*e.length;i+=8)t[i>>5]|=(255&e.charCodeAt(i/8))<<i%32;return t}(c),8*c.length))),g.toLowerCase()),expire:d})}}class te{constructor(e){this.api=e}onRender(e,t){const i=t.get("fields.aspectRatio")||t.getProperty("image.defaultAspectRatio")||this.api.v1.config.get("image.defaultAspectRatio")||.5;e.setFiltered("aspectRatio",100*i)}}class ie{static tsvStringToTable(e){return e.split("\n").map((e=>e.split("\t").map((e=>e.trim()))))}static tableToTSVString(e){return e?e.map((e=>e.join("\t"))).join("\n"):null}static getMaxRowLength(e){const t=e.map((e=>e.filter((e=>-1===e.indexOf("|*"))).length));return Math.max.apply(null,t)}static newCell(e){const t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return e?{style:e,content:t}:{content:t}}static newRow(e,t){return e?{style:e,row:t}:{row:t}}static tableToTemplateBody(e){const t=ie.getMaxRowLength(e);return e.filter((e=>""!==e.join("").trim())).map((e=>{let i=e.map((e=>{if(e.indexOf("|")>-1){const t=e.split("|");return ie.newCell(t[0],t[1])}return ie.newCell(null,e)}));const s="*"===i[i.length-1].content?i[i.length-1].style:null;for(s&&(i=i.slice(0,i.length-1));i.length<t;)i.push(ie.newCell());return ie.newRow(s,i)}))}static templateTableBodyToHeader(e,t){if(!e)return null;const i=e.shift();if(t)for(let t=0;t<i.row.length;t++){const s=e.map((e=>e[t])).filter((e=>/^[0-9, ]+$/.test(e))).length,a=e.map((e=>e[t])).filter((e=>Date.parse(e))).length,n=e.length;i.row[t].sortBy=s===n?"number":a===n?"date":"string"}return i}}class se{constructor(e){this.api=e}onRender(e,t){const i=e.get("fields.tabledata"),s=e.get("fields.tableheader"),a=e.get("fields.tableheadersort");if((null==i||0===i.length)&&this.api.v1.app.mode.isEditor())return void e.setFiltered("missingData","Missing Data");const n=ie.tsvStringToTable(i),o=ie.tableToTemplateBody(n);e.setFiltered("missingData",!1),e.setFiltered("tabledata",ie.tableToTSVString(n)),e.setFiltered("header",s?ie.templateTableBodyToHeader(o,a):null),e.setFiltered("table",o)}}class ae{constructor(e){this.api=e}onRender(e,t){const i=this.api.v1.config.get("contentbox_settings.tagboard")||{},s=this.api.v1.app.mode.isEditor(),a={tagGroup1_label:e.get("fields.tagGroup1_label")||"",tagGroup1_tags:e.get("fields.tagGroup1_tags")||"",tagGroup2_label:e.get("fields.tagGroup2_label")||"",tagGroup2_tags:e.get("fields.tagGroup2_tags")||"",tagGroup3_label:e.get("fields.tagGroup3_label")||"",tagGroup3_tags:e.get("fields.tagGroup3_tags")||""},n=((e={})=>{const t=[],i=(e="")=>e.split(",").map((e=>e.trim().toLowerCase())).filter((e=>!!e));for(let s=1;s<=3;s++)e[`tagGroup${s}_tags`]&&t.push({label:e[`tagGroup${s}_label`],tags:i(e[`tagGroup${s}_tags`])});return t})(a);n.length&&Array.isArray(n)||Sys.logger.warning('tagboard: Missing required config "contentbox_settings.tagboard.tagGroups" (array). End user will not be able to filter results.');let o=e.get("fields.tagsGroupsDefaultVisible");null===o&&(o=this.api.v1.config.get("contentbox_settings.tagboard.tagsOptions.tagsGroupsDefaultVisible"));let r=e.get("fields.hideHitsPerTag");null===r&&(r=this.api.v1.config.get("contentbox_settings.tagboard.tagsOptions.hideHitsPerTag"));let l=e.get("fields.tagGroupInRows");null===l&&(l=this.api.v1.config.get("contentbox_settings.tagboard.tagsOptions.tagGroupInRows"));let d=e.get("fields.overrideUrlByTagsCookie");null===d&&(d=this.api.v1.config.get("contentbox_settings.tagboard.cookieOptions.allow"));const c=n.map((e=>e.tags)),g=[].concat(...c),p=this.api.v1.properties.get("integration_url"),u=this.api.v1.properties.get("front_api_url"),h=Object.values(this.api.v1.config.get("feeds")||{}).filter((e=>!!e.labrador_json)).map((e=>({identifier:e.display_name,name:e.display_name,type:e.url.includes("lab_viewport=json")?"DachserJson":"LabradorApi",url:e.url.replace("{{int}}",p).replace("{{api}}",u)}))),f=(i.sources||[]).concat(h),m=e.get("fields.source"),b={...f.filter((e=>e.identifier===m)).shift()||{}},y=e.get("fields.organizer"),v={columnCount:parseFloat(e.get("fields.layout_columnCount")||3),rowCount:parseFloat(e.get("fields.layout_rowCount")||10),maxRowSize:parseFloat(e.get("fields.layout_maxRowSize")||3),minRowSize:parseFloat(e.get("fields.layout_minRowSize")||1),imageAspectRatio:parseFloat(e.get("fields.layout_imageAspectRatio")||.45),gridsize:parseFloat(e.get("fields.layout_gridsize")||12),hide_items:[]};e.get("fields.hide_title")&&v.hide_items.push("title"),e.get("fields.hide_subtitle")&&v.hide_items.push("subtitle"),e.get("fields.hide_image")&&v.hide_items.push("image"),e.get("fields.hide_kicker")&&v.hide_items.push("kicker");const _=e.get("fields.articleCount")||24;let k=_;["RandomRows"].includes(y)||(k=v.columnCount*v.rowCount||_);const w=e.get("fields.articleFetchCount")||k,F=[];e.get("fields.filterExisting")&&F.push({path:"contentdata.id",values:this.api.v1.model.query.getModelsByType("article").filter((e=>!!e.get("instance_of"))).map((e=>String(e.get("instance_of"))))}),e.setFiltered("articleCount",k),e.setFiltered("articleFetchCount",w),e.setFiltered("articleFilterList",JSON.stringify(F)),e.setFiltered("tagArrayGroups",JSON.stringify(c)),e.setFiltered("tagGroups",n),e.setFiltered("tagGroupsObject",a),e.setFiltered("tagsGroupsDefaultVisible",o),e.setFiltered("hideHitsPerTag",r),e.setFiltered("tagGroupInRows",l),e.setFiltered("layout",JSON.stringify(v)),e.setFiltered("isConfigured",y&&b.identifier&&b.url&&b.type),e.setFiltered("source",b),e.setFiltered("isDebug",!0),e.setFiltered("siteId",e.get("fields.siteId")||""),e.setFiltered("viewport",this.api.v1.properties.get("device")),e.setFiltered("imageServer",this.api.v1.properties.get("image_server")),e.setFiltered("cookieOptions",{allow:d}),e.setFiltered("tagOptions",{allow:!0,tags:g,tags_string:g.join(", "),tagsString:JSON.stringify(g)});const S=[];e.get("fields.size_active")&&(e.get("fields.size_title")&&S.push({path:"contentdata.fields.title.attributes.text_size.value",value:parseInt(e.get("fields.size_title"),10)}),e.get("fields.size_subtitle")&&S.push({path:"contentdata.fields.subtitle.attributes.text_size.value",value:parseInt(e.get("fields.size_subtitle"),10)}),e.get("fields.size_kicker")&&S.push({path:"contentdata.fields.kicker.attributes.text_size.value",value:parseInt(e.get("fields.size_kicker"),10)})),e.setFiltered("styleString",JSON.stringify(S)),e.setFiltered("imageWidth",e.get("fields.imageWidth")||100),s&&e.setFiltered("sourcesConfig",f)}}class ne{constructor(e){this.api=e}onRender(e,t){const i="center"===t.get("metadata.text_align");e.setFiltered("textCentered",i)}}class oe{constructor(e){this.api=e}onRender(e,t){const i={tips:{cssClass:"tips_version",title:"Tips og innlegg",text:"Vi synes det er viktig med dine meninger",buttons:{tips:"Tips oss",debate:"Send innlegg"}},debate:{cssClass:"debate_version",title:"Har du noe på hjertet?",text:"Send oss et debattinnlegg, en kronikk eller en meningsytring. Alle innlegg signeres med fullt navn og tittel.",buttons:{tips:null,debate:"Send innlegg"}}},s=this.api.v1.config.get("contact.email")||{},a={tips:e.get("fields.email_tips"),debate:e.get("fields.email_debate"),version:e.get("fields.version")};a.tips&&(s.tips=a.tips),a.debate&&(s.debate=a.debate),e.setFiltered("content","tips"===a.version?i.tips:i.debate),e.setFiltered("version_is_tips","tips"===a.version),e.setFiltered("emails",s)}}class re{constructor(e){this.api=e}onViewHelper(e,t){let i=e.get("fields.domain")||this.api.v1.properties.get("site.domain");i=i.replace(/^https?:\/\//,"");const s=e.get("fields.limit")||5;e.setFiltered("domain",i),e.setFiltered("limit",s)}onRender(e,t){const i=t.get("fields.placeholder");e.setFiltered("placeholder",i||this.api.v1.locale.get("emptyState.noContentText",{noRender:!0}));const s=t.get("external"),a=!!e.get("fields.displayImages"),n=!e.get("fields.hideDate"),o=e.get("fields.limit")||5,r=e.get("filtered.domain"),l=[],d=s&&"object"==typeof s?s:(e=>{const t=[];for(let i=0;i<e;i++)t.push({fields:{cssClass:"dac-placeholder-text",type:"article"}});return{data:t}})(o),c=new m;if(d.data.forEach((e=>{if("article"===e.fields.type){const i=e.fields.published||null;l.push({title:e.fields.title||"[no title]",url:e.fields.srcUrl,section:e.fields.section||"",pageviews:e.fields.pageviews,published:i,niceDate:n&&i?c.timestampToNiceDate(c.toTimestamp(new Date(i))):"",cssClass:e.fields.cssClass||null,imageUrl:a?(t=e.fields.image,t?`${t.replace(/^https?:\/\//,"//")}${t.includes("?")?"&":"?"}width=200&height=140`:null):null})}var t})),e.setFiltered("result",l),!this.api.v1.app.mode.isEditor())return;const g={domains:[],layout:[]};this.api.v1.site.getSites().forEach((e=>{if(!e.domain)return;const t=e.domain.replace(/^https?:\/\//,""),i={name:e.display_name,value:t,selected:t===r};g.domains.push(i)}));for(const e of["horizontal","vertical"])g.layout.push({name:e,value:e,selected:e===t.get("fields.layout")});e.setFiltered("adminView",g)}}class le{constructor(e){this.api=e}onRender(e,t){const i=t.get("external.tv");if(!i||!i.length)return;const s=i[0],a=new r(lab_api.v1.config.get("lang")),n=(e,t="d/m Y H:i")=>{const i=new Date(e);return a.formattedUtcDate(i,t)},o=e=>e.replace("00000+","00.000+"),l=e=>a.isSummerTime(e)?a.manipulateTime(e,1):e,d=e=>{const t=new Date(e);return`${t.getUTCFullYear()}${`0${t.getUTCMonth()+1}`.slice(-2)}${`0${t.getUTCDate()}`.slice(-2)}`},c=s.programme.filter((e=>{let t=new Date(o(e.start));return t=l(t),!(new Date(t.toUTCString().split(" ").slice(0,4).join(" "))<new Date((new Date).toUTCString().split(" ").slice(0,4).join(" ")))})).map((e=>{const t=l(new Date(o(e.start))).toUTCString();return{start:n(t,"H:i"),icon:e.icon[0].src,title:e.title[0]._,desc:e.desc[0]._,date:d(t)}})),g={};for(const e of c){if(!g[e.date]){const t=a.parseDate(e.date);g[e.date]={date:a.formattedDate(t,"d/m Y"),items:[]}}g[e.date].items.push(e)}e.setFiltered("tvguide",Object.values(g))}}class de{constructor(e){this.api=e}onViewHelper(e,t){const i=e.get("fields.lang")||lab_api.v1.config.get("lang")||"no";e.setFiltered("lang",i)}}class ce{constructor(e){this.api=e}onRender(e,t){const i=this.api.v1.config.get("contact.email")||{},s=e.get("fields.email")||i.tips||"",a=e.get("fields.url")||"";e.setFiltered("email",s),e.setFiltered("url",a)}}class ge{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor()}onRender(e,t){let i="page_article"===this.api.v1.model.root.getType();if((this.api.v1.app.mode.isFront()&&!t.get("fields.caption")||e.getParent()&&!1===e.getParent().get("fields.displayCaption"))&&(i=!1),e.setFiltered("displayCaption",i),!this.api.v1.app.mode.isEditor()&&!0===this.api.v1.config.get("cookieConsent.enabled")){const t=this.api.v1.config.get("cookieConsent").contentboxes.filter((e=>"youtube"===e.name))[0];t&&(e.setFiltered("requiredCookieConsent",t.requiredConsent||!1),e.setFiltered("insufficientConsentMessage",t.insufficientConsentMessage||this.api.v1.config.get("cookieConsent.insufficientConsentMessage")||""))}const s=[],a=e.get("fields.video_start"),n=e.get("fields.video_end");a&&s.push(`start=${Math.round(a)}`),n&&s.push(`end=${Math.round(n)}`),s.length&&e.setFiltered("startstop",`?${s.join("&")}`)}onRendered(e,t){if(this.isEditor){const e=t.getMarkup().querySelector("iframe"),i=t.getMarkup().querySelector(".youtube-drag-handle");e&&i&&(i.addEventListener("mouseenter",(t=>{e.style.pointerEvents="none"}),!1),i.addEventListener("mouseleave",(t=>{e.style.pointerEvents=""}),!1))}}}class pe{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor()}onRender(e,t){let i="page_article"===this.api.v1.model.root.getType();if(this.api.v1.app.mode.isFront()&&!t.get("fields.caption")&&(i=!1),e.setFiltered("displayCaption",i),!this.api.v1.app.mode.isEditor()&&!0===this.api.v1.config.get("cookieConsent.enabled")){const t=this.api.v1.config.get("cookieConsent").contentboxes.filter((e=>"jwplayer"===e.name))[0];t&&(e.setFiltered("requiredCookieConsent",t.requiredConsent||!1),e.setFiltered("insufficientConsentMessage",t.insufficientConsentMessage||this.api.v1.config.get("cookieConsent.insufficientConsentMessage")||""))}}onRendered(e,t){if(this.isEditor){const e=t.getMarkup().querySelector("iframe"),i=t.getMarkup().querySelector(".jwplayer-drag-handle");e&&i&&(i.addEventListener("mouseenter",(t=>{e.style.pointerEvents="none"}),!1),i.addEventListener("mouseleave",(t=>{e.style.pointerEvents=""}),!1))}}}class ue{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor()}onRender(e,t){let i="page_article"===this.api.v1.model.root.getType();if(this.api.v1.app.mode.isFront()&&!t.get("fields.caption")&&(i=!1),e.setFiltered("displayCaption",i),!this.api.v1.app.mode.isEditor()&&!0===this.api.v1.config.get("cookieConsent.enabled")){const t=this.api.v1.config.get("cookieConsent").contentboxes.filter((e=>"remoteproduction"===e.name))[0];t&&(e.setFiltered("requiredCookieConsent",t.requiredConsent||!1),e.setFiltered("insufficientConsentMessage",t.insufficientConsentMessage||this.api.v1.config.get("cookieConsent.insufficientConsentMessage")||""))}}onRendered(e,t){if(this.isEditor){const e=t.getMarkup().querySelector("iframe"),i=t.getMarkup().querySelector(".remoteproduction-drag-handle");e&&i&&(i.addEventListener("mouseenter",(t=>{e.style.pointerEvents="none"}),!1),i.addEventListener("mouseleave",(t=>{e.style.pointerEvents=""}),!1))}}}class he{constructor(e){this.api=e,this.domain=this.api.v1.site.getSite().domain||this.api.v1.properties.get("customer_front_url")}onViewHelper(e,t){e.setFiltered("domain",e.get("fields.domain")||this.domain.replace("https://",""))}onRender(e,t){const i=t.get("fields.placeholder");e.setFiltered("placeholder",i||this.api.v1.locale.get("emptyState.noContentText",{noRender:!0}));const s=t.get("external");if(!s)return;const a=new r(lab_api.v1.config.get("lang")),n=this.api.v1.config.get("contentbox_settings.topcomments.dateTemplate"),o=lab_api.v1.properties.get("image_server"),l=[],d=lab_api.v1.util.object.clone(s,!0);for(const e of d.mostRead||[]){const t=new Date(e.fields.published);e.fields.image&&(e.fields.image=e.fields.image.replace("http://","https://"),e.resizedImage=`${e.fields.image}&width=63&height=63`),e.fields.readableDate=a.utcFormat(t,n),l.push(e)}e.setFiltered("mostRead",l);const c=[];for(const e of d.latest||[]){const t=new Date(e.published);e.readableDate=a.utcFormat(t,n),e.extId?e.disqusId=e.extId.replace("khrono-","node/"):e.disqusId=e.id,e.frontCropUrl&&(e.resizedImage=`${o}/${e.frontCropUrl}&width=63&height=63`),c.push(e)}e.setFiltered("latest",c);let g=e.get("fields.selectedTab")||"latest";"mobile"===lab_api.v1.viewport.getName()&&e.get("fields.hideResultOnMobile")&&(g="");const p={};["mostRead","topComments","latest"].forEach((e=>{p[e]=e===g})),e.setFiltered("selectedTabs",p),e.setFiltered("isDebug",this.api.v1.util.request.hasQueryParam("debug"))}}class fe{constructor(e){this.api=e}onChildAdded(e,t){if("article"!==t.getType())return;const i=(e,t,i)=>{if(t)for(const s of Object.keys(t))s.includes("viewports_json")||(t[s]&&"object"==typeof t[s]?e.setRaw((i||"")+s,t[s]):e.set((i||"")+s,t[s]))};i(t,this.api.v1.config.get("contentbox_settings.scrollbox.dataForAddedChild.article.metadata"),"metadata."),i(t,this.api.v1.config.get("contentbox_settings.scrollbox.dataForAddedChild.article.contentdata")),t.children.length&&"image"===t.children[0].getType()&&i(t.children[0],this.api.v1.config.get("contentbox_settings.scrollbox.dataForAddedChild.article.children.image.contentdata"))}}class me{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor()}onInserted(e){if(!this.isEditor){const t=e.get("metadata.visibleAfterDate");if(t){const i=this.stringToDate(t);if(i){const s=(new Date).getTime();i.getTime()>s&&(Sys.logger.debug(`[Baseview] The path 'metadata.visibleAfterDate' ('${t}') has prevented the row '${e.getPositionedPath()}' from rendering`),this.api.v1.model.noRender(e))}}}}onChildAdded(e,t){this.updateFutureFlag(e)}onChildRemoved(e,t){this.updateFutureFlag(e)}onRender(e,t){if(!this.isEditor&&!e.hasNodeData(!0))return void this.api.v1.model.noRender(e);if(t.get("metadata.movableContent")&&e.setFiltered("movableStyle",J.createStyle(e,"metadata.contentPosition",["desktop","mobile"])),!this.isEditor)return;const i=e.get("metadata.visibleAfterDate");if(i){const s=this.stringToDate(i);if(s){const i=(new Date).getTime();s.getTime()>i&&t.addCssStates(["hidden-on-front","has-date-restriction"]),s.setMinutes(s.getMinutes()-s.getTimezoneOffset()),e.setFiltered("visibleAfterDate",s.toISOString().slice(0,16))}}else e.get("filtered.visibleAfterDate")&&(t.resetCssState(),e.setFiltered("visibleAfterDate",null))}onSettingsPanel(){return{onSubmit:({model:e,formValues:t})=>{for(const t of this.api.v1.view.getViews(e))t.resetCssState();const i=this.stringToDate(t["metadata.visibleAfterDate"]);let s;i?s=i.toISOString():(e.setFiltered("visibleAfterDate",null),s=null),e.set("metadata.visibleAfterDate",s)}}}stringToDate(e){const t=new Date(e||"");return t instanceof Date&&Number.isFinite(t.getTime())?t:null}updateFutureFlag(e){const t=!!e.get("metadata.visibleAfterDate");let i=null;for(const t of e.getChildren()){const e=t.get("fields.published");if(e){const t=new Date(e).getTime();t>(new Date).getTime()&&t>i&&(i=t)}}i?(e.set("metadata.visibleAfterDate",new Date(i).toISOString()),this.api.v1.model.highlight.message(e,"Publish-date updated for row"),Sys.logger.debug(`[Baseview] The row '${e.getPositionedPath()}' has set publish date to '${new Date(i).toISOString()}'.`)):t&&(e.set("metadata.visibleAfterDate",null),this.api.v1.model.highlight.message(e,"Publish-date removed for row"),Sys.logger.debug(`[Baseview] The row '${e.getPositionedPath()}' has removed publish date.`))}}class be{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor(),this.isEditor&&this.api.v1.ns.set("timeline.insertItem",((e,t,i,s)=>{this.addItem(e)}))}addItem(e){const t=new Date,i=this.api.v1.model.create.view({type:"timelineItem",contentdata:{fields:{date:`${(t.getHours()<10?"0":"")+t.getHours()}.${(t.getMinutes()<10?"0":"")+t.getMinutes()}`}}});this.api.v1.model.prependChild(e,i)}}class ye{constructor(e){this.api=e,this.dateTimeHelper=new m}onRender(e,t){const i=e.get("fields.modified")||e.get("fields.published");if(null!=i){const t=new Date(1e3*i);e.setFiltered("niceDate",this.dateTimeHelper.timestampToNiceDate(i)),e.setFiltered("publishedDate",this.dateTimeHelper.utcFormat(t,`${this.api.v1.locale.get("dates.monthdayyear",{noRender:!0})} ${this.api.v1.locale.get("dates.hourminute",{noRender:!0})}`)),e.setFiltered("isoDate",t.toISOString())}}}class ve{constructor(e){this.api=e,this.baseApiUrl=this.api.v1.properties.get("front_api_url"),this.siteId=this.api.v1.properties.get("site.id"),this.cache=new Map,this.defaultMaxCount=100,this.isEditor=this.api.v1.app.mode.isEditor()}onPrepareViewHelper(e,t){const i=e.get("fields.site")||this.siteId,s=t.get("fields.maxNoticesCount")||this.defaultMaxCount,a=(e.get("fields.tags")||"").toLowerCase().split(",").filter((e=>""!==e)),n=this.prepareTags(a),o=this.prepareQuery(n,!1),r=this.prepareQuery(n,!0),l=`${this.baseApiUrl}/notice?content=full&site_id=${i}&limit=${s}`;e.setFiltered("query",o),e.setFiltered("clientQuery",r),e.setFiltered("url",l)}onReady(e,t){const i=t.get("external"),s=e.get("filtered.noFetch")||!1,a=e.get("metadata.blacklist")||[],n=t.get("fields.maxNoticesCount")||this.defaultMaxCount;if(!s&&i){e.setFiltered("noFetch",!0);const t=e.get("fields.pinnedNotices_json")||[];let s=i.result;if(this.api.v1.app.mode.isEditor()){const t=this.api.v1.model.query.getModelsByType("notice",e.children);for(const e of t)this.api.v1.model.delete(e,!0,!0)}s=s.slice(0,n),s.forEach((i=>{const{attribute:s={},field:n={}}=i.notice;if(a.includes(parseInt(s.id||0,10)))return void Sys.logger.warn(`Notice with id ${s.id} is blacklisted from Livefeed and will not be displayed.`);"object"==typeof n.bodytext&&(n.bodytext="");const{title:o,bodytext:r,published:l,modified:d,published_url:c,userName:g}=n,p=[];if(i.notice.children&&i.notice.children.image){const e=Array.isArray(i.notice.children.image)?i.notice.children.image:[i.notice.children.image];for(const t of e){let e={};if(n.structure_json&&t.attribute.id)try{const i=JSON.parse(n.structure_json);for(const s of i)if("bodytext"===s.type){const i=this.getStructure(s.children||[],t.attribute.id);e=i?i.metadata:{};break}}catch(e){Sys.logger.warn(`Failed to parse structure data: ${e.toString()}`)}e.hasFullWidth={desktop:!1,mobile:!1},p.push(this.getImageData(t,e||{}))}}this.api.v1.model.insert.atPath({path:e.getPositionedPath(),data:{type:"notice",contentdata:{id:s.id,fields:{title:o,bodytext:r,published:l,modified:d,published_url:c,userName:g,pinned:t.includes(s.id)},tags:i.notice.tag?i.notice.tag.tag:""},state:{isNonPersistent:!0,editNonPersistent:!0},children:p},options:{silent:!0,index:t.includes(s.id)?0:void 0}})})),e.children.sort(((e,i)=>t.includes(e.getId())?-1:t.includes(i.getId())?1:i.getId()-e.getId())),this.api.v1.app.mode.isEditor()&&(this.api.v1.model.addToRedrawQueue(e,!0),this.api.v1.app.save())}const o=this.api.v1.config.get("contentbox_settings.livefeed.updateFrequency")||[{range:[0,600],interval:10},{range:[600,1200],interval:30},{range:[1200],interval:60}];e.setFiltered("updateFrequency",JSON.stringify(o))}onRender(e,t){const i=t.get("fields.placeholder");e.setFiltered("placeholder",i||this.api.v1.locale.get("emptyState.noContentText",{noRender:!0})),e.setFiltered("initialRenderTime",(new Date).getTime()),e.setFiltered("dateStrings",JSON.stringify({now:this.api.v1.locale.get("dates.now",{noRender:!0}),monthdayyear:this.api.v1.locale.get("dates.monthdayyear",{noRender:!0}),hourminute:this.api.v1.locale.get("dates.hourminute",{noRender:!0}),durationSince:this.api.v1.locale.get("dates.durationSince",{noRender:!0}),minute:this.api.v1.locale.get("dates.minute",{noRender:!0}),minutes:this.api.v1.locale.get("dates.minutes",{noRender:!0}),hour:this.api.v1.locale.get("dates.hour",{noRender:!0}),hours:this.api.v1.locale.get("dates.hours",{noRender:!0}),day:this.api.v1.locale.get("dates.day",{noRender:!0}),days:this.api.v1.locale.get("dates.days",{noRender:!0}),ago:this.api.v1.locale.get("dates.ago",{noRender:!0})}))}onChildAdded(e,t){if(this.isEditor&&"notice"!==t.getType()){if(e.children.indexOf(t)>0)return;const i=this.api.v1.model.query.getModelsByType("notice",e.children).filter((e=>e.get("fields.pinned")));if(!i.length)return;let s=0;for(const t of i)e.children.indexOf(t)>s&&(s=e.children.indexOf(t));s>0&&this.api.v1.model.addChild(e,t,s,!1)}}prepareQuery(e,t=!1){const i=t?["(visibility_status:P OR visibility_status:H)"]:["visibility_status:P"];return e.length>0&&i.push(`(${e.join(" OR ")})`),`&query=${encodeURIComponent(i.join(" AND "))}`}prepareTags(e){return e.map((e=>{let t=e.trim();return t.indexOf(" ")>-1&&(t=`"${t}"`),`tag:${t}`}))}getImageData(e,t){return this.api.v1.model.serialize.apiToView({type:"image",data:e,meta:t})}onSettingsPanel(e,t,i){const s={layout:null,container:null};return{onDisplay:({model:e,view:t,config:i,markup:a,modal:n})=>{s.layout=a.querySelector("#layout"),s.container=a.querySelector(".horizontalOptions"),s.layout&&s.container&&s.layout.addEventListener("change",(e=>{"1"===s.layout.value?s.container.classList.remove("lab-hidden"):s.container.classList.add("lab-hidden")}))},onHide:({model:e,view:t,config:i,markup:a,modal:n})=>{s.layout=null,s.container=null,e.setFiltered("noFetch",!1)}}}getStructure(e,t){for(const i of e){if("image"===i.type&&i.node_id==t)return i;if(i.children){const e=this.getStructure(i.children,t);if(e)return e.metadata&&!e.metadata.bodyTextIndex&&i.metadata&&i.metadata.bodyTextIndex&&(e.metadata.bodyTextIndex=i.metadata.bodyTextIndex),e}}return null}}class _e{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor()}onRendered(e,t){if(!this.isEditor)return;const i=[...e.get("tags")],s=t.getMarkup().querySelector(".tags");for(const t of i){const i=s.querySelector(`[data-tag="${t}"]`);i&&this.setupTag(e,i,t)}const a=document.createElement("span");a.classList.add("labicon-pluss_slim","add-tag"),a.setAttribute("title","Add tag"),s.appendChild(a),a.addEventListener("click",(async t=>{t.preventDefault();let s=null;const a=await this.api.v1.util.tags.ui({callbacks:{change:e=>{if(s){const t=e.sort();s.getMarkup().querySelector("#hidden_tags_input").value=t.join(", ")}}},tags:i});s=this.api.v1.ui.modal.dialog({container:{width:500},placeholders:[{selector:"#placeholder-tags",element:a}],content:{title:"Edit tags",formgroups:[{elements:[{label:"Selected tags. Click a tag to remove. <br>Use input field below to add new tags.",inline:!0,tag:"input",attributes:[{name:"type",value:"hidden"},{name:"name",value:"tag"},{name:"id",value:"hidden_tags_input"},{name:"value",value:i.join(", ")}]},{grid:12,placeholder:"placeholder-tags"},{grid:12,tag:"p",value:"<br><br><br><br><br>"}]}]},callbacks:{didDisplay:e=>{e.getMarkup().querySelector('input[name="tag"]').focus()},submit:t=>{const i=t.tag.trim().toLowerCase().split(",").map((e=>e.trim())).filter((e=>e.length>0));i.length&&e.set("tags",i)}},eventHandlers:[{selector:"#tag-cancel",event:"click",callback:(e,t)=>{e.close()}}],keyValidation:[{key:"tag",validator:"notEmpty"}],footer:{buttons:[{value:"Cancel",highlight:!1,id:"tag-cancel"},{value:"Save tags",type:"submit",highlight:!0}]}})}))}setupTag(e,t,i){t.addEventListener("click",(t=>{t.preventDefault(),console.log("Tag clicked: ",i),e.set("tags",[...e.get("tags").filter((e=>e!==i))])}))}}class ke{constructor(e,t={model:"gpt-4o",provider:"openAi",integration:"openAi"}){this.api=e,this.aiSettings=t,this.isEditor=this.api.v1.app.mode.isEditor(),this.requiredFilesJS=this.api.v1.config.get("contentbox_settings.chart.require.js")||null,this.isEditor&&this.api.v1.ns.set("chart",{generate:(e,t)=>{const i=this.api.v1.bodytext.getText(this.api.v1.model.query.getModelByType("bodytext")),s=t.getMarkup();s.classList.add("lab-content-busy"),this.api.v1.ns.get("textAssistant.fetchByGroupName")("chart",this.aiSettings,{bodytext:i}).then((t=>{if(t){const i=this.cleanUpAndParseJsonString(t),{enoughData:a,title:n,type:o,beginAtZero:r,labels:l,datasets:d}=i;a?(this.setIfDefined(e,"fields.title",n),this.setIfDefined(e,"fields.chartType",o),this.setIfDefined(e,"fields.beginAtZero",r),this.setIfDefined(e,"fields.tableData",this.objectToTsv({labels:l,datasets:d}))):(s.classList.add("lab-highlight-warn"),s.querySelector(".description").insertAdjacentHTML("afterend",'<p style="color: #ff0000; text-transform: uppercase; font-weight: bold;">Not enough data to generate a chart</p>'))}})).finally((()=>{s.classList.remove("lab-content-busy")}))}})}onCreated(e){this.requiredFilesJS&&this.requiredFilesJS.forEach((e=>{for(const t of this.api.v1.viewport.getContexts())this.api.v1.util.dom.addFile("js",e,t,null,null,{},!1)}))}onRender(e,t){const i=e.get("fields.chartType")||"line",s=e.get("fields.beginAtZero")||!1,a=e.get("fields.tableData");let n;a&&(n=this.tsvToObject(a)),e.setFiltered("chartType",i),e.setFiltered("beginAtZero",s),e.setFiltered("chartData_json",JSON.stringify(n))}tsvToObject(e){const t=e.trim().split("\n"),i=t[0].split("\t"),s={labels:[],datasets:[]};for(let e=""===i[0]?1:0;e<i.length;e++)s.datasets.push({label:i[e],data:[]});for(let e=1;e<t.length;e++){const i=t[e].split("\t");s.labels.push(i[0]);for(let e=1;e<i.length;e++){const t=i[e].replace(/\s+/g,"");s.datasets[e-1].data.push(parseFloat(t))}}return s}objectToTsv(e){const t=[[""].concat(e.datasets.map((e=>e.label))).join("\t")];for(let i=0;i<e.labels.length;i++){const s=[e.labels[i]];for(let t=0;t<e.datasets.length;t++)s.push(e.datasets[t].data[i]);t.push(s.join("\t"))}return t.join("\n")}cleanUpAndParseJsonString(e){try{const t=e.trim().replace(/^```json\s*/,"").replace(/\s*```$/,"");return JSON.parse(t)}catch(e){return console.error("Error cleaning or parsing API response:",e.message),null}}setIfDefined(e,t,i){null!=i&&e.set(t,i)}}class we{constructor(e){this.api=e,this.sizes={large:{columns:3,rows:4},small:{columns:2,rows:1}},this.smallElementTypes=["article"],this.isEditor=this.api.v1.app.mode.isEditor(),this.removedChildren=[]}onCreated(e){if(e.getChildren().length)return;const t=this.getSize(e);for(let i=0;i<t.columns*t.rows;i++)this.createAndInsert(e)}onInserted(e){this.isEditor&&(this.api.v1.model.bindings.bind(e,"fields.columnCount",this.sizeUpdated.bind(this)),this.api.v1.model.bindings.bind(e,"fields.rowCount",this.sizeUpdated.bind(this)),this.api.v1.model.bindings.bind(e,"fields.columnCountMobile",this.sizeUpdated.bind(this)))}onChildAdded(e,t){if(!e.parent)return;const i=this.getSize(e);this.updateSize(i,t)}updateSize(e,t){t.setWidth(e.width.desktop,{viewport:"desktop"}),t.setWidth(e.width.mobile,{viewport:"mobile"})}onSettingsPanel(e,t,i){return{onWillDisplay:({model:e,view:t,config:i,template:s})=>{this.removedChildren=[],e.setFiltered("size",this.getSize(e))}}}getSize(e){const t=this.getGridCount(e),i=e.get("fields.columnCountMobile")||1,s=parseFloat((100/i).toFixed(2));return{columns:t.columns,columnsMobile:i,rows:t.rows,width:{desktop:parseFloat((100/t.columns).toFixed(2)),mobile:s}}}getGridCount(e){const t=e.parent&&this.smallElementTypes.includes(e.parent.get("type"))?this.sizes.small:this.sizes.large,i=e.get("fields.columnCount")||t.columns,s=e.get("fields.rowCount")||t.rows;return{columns:parseInt(i,10),rows:parseInt(s,10)}}sizeUpdated(e){const t=this.getSize(e),i=e.getChildren();for(const e of i)this.updateSize(t,e);if(i.length>t.columns*t.rows&&i.slice(t.columns*t.rows).forEach((e=>{this.api.v1.model.delete(e),e.get("instance_of")&&this.removedChildren.push(e)})),i.length<t.columns*t.rows)for(let s=i.length;s<t.columns*t.rows;s++)this.createAndInsert(e,this.removedChildren.shift())}createAndInsert(e,t){t?this.api.v1.model.addChild(e,lab_api.v1.model.copy(t)):this.api.v1.model.create.internal({type:"image",contentdata:{type:"image",fields:{}}},e,!0,!1)}}class Fe{constructor(e){this.api=e,this.isEditor=this.api.v1.app.mode.isEditor()}onRender(e,t){let i="page_article"===this.api.v1.model.root.getType();if(this.api.v1.app.mode.isFront()&&!t.get("fields.caption")&&(i=!1),e.setFiltered("displayCaption",i),!this.api.v1.app.mode.isEditor()&&!0===this.api.v1.config.get("cookieConsent.enabled")){const t=this.api.v1.config.get("cookieConsent").contentboxes.filter((e=>"vimond"===e.name))[0];t&&(e.setFiltered("requiredCookieConsent",t.requiredConsent||!1),e.setFiltered("insufficientConsentMessage",t.insufficientConsentMessage||this.api.v1.config.get("cookieConsent.insufficientConsentMessage")||""))}}onRendered(e,t){if(this.isEditor){const e=t.getMarkup().querySelector("iframe"),i=t.getMarkup().querySelector(".video-drag-handle");e&&i&&(i.addEventListener("mouseenter",(t=>{e.style.pointerEvents="none"}),!1),i.addEventListener("mouseleave",(t=>{e.style.pointerEvents=""}),!1))}}}class Se{constructor({path:e=null,selector:t=null,data:i={},options:s={}}={}){this.path=e,this.selector=t,this.data=i,this.options={persistentTarget:!0,intermediate:{useExisting:!0},...s}}}class Te{constructor({key:e=null,path:t=null,selector:i=null,placeholder:s=null,metadata:a={},options:{shouldInsert:n=!0,wrap:o=null,skipIfOutOfBounds:r=!1,useIndex:l=!1,useBodyTextIndex:d=!1,useBodyTextHeadingIndex:c=!1,lastBodyTextHeading:g=!1}={}}={}){this.key=e,this.path=t,this.selector=i,this.placeholder=s,this.metadata=a,this.options={shouldInsert:n,wrap:o,skipIfOutOfBounds:r,useIndex:l,useBodyTextIndex:d,useBodyTextHeadingIndex:c,lastBodyTextHeading:g}}}class Ce{constructor({type:e=null,contentdata:t=null,content_data:i=null,cssSettings:s={},children:a=[],metadata:n={}}={}){this.type=e,this.contentdata=t||i,this.children=a,this.metadata={...n},this.state={};const o=[];this.metadata.css&&o.push(this.metadata.css);for(const e of Object.keys(s))s[e]&&o.push(e);this.metadata.css=o.join(" ")}}class xe{constructor(e){this.api=e,this.page=this.api.v1.model.query.getRootModel(),this.pageType=this.api.v1.model.root.getType().replace("page_",""),this.viewports=this.api.v1.viewport.getActive(),this.isEditor=this.api.v1.app.mode.isEditor(),this.cache=new Map,this.pageElements={},this.hideAds="1"===this.page.get("fields.hideAds")||!0===this.page.get("fields.hideAds")}hasRequiredElement(e){return void 0===this.pageElements[e]&&(this.pageElements[e]=!!this.api.v1.model.query.getModelByType(e)),this.pageElements[e]}insert(e,t=null){const i=[],s={},a=`insertDynamic.${this.pageType}.${e}`,n=`placements.${this.pageType}.${e}`;let o=!1;const r=(this.api.v1.config.get(n)||[]).filter((e=>!e.client||(e.requireElement&&!this.hasRequiredElement(e.requireElement)||(s[e.key]=e),!1)));if(!this.cache.has(a)){const e=`insertDynamicAdditions.${this.pageType}`,t=this.api.v1.config.get(a)||[],n=this.validateConditions(this.api.v1.config.get(e)||[]).reverse();o=n.length>0;const r=[...t,...n],l=(this.isEditor?r.filter((e=>!e.dynamicDataSettings||!e.dynamicDataSettings.hideInEditMode)):r).filter((e=>{if(e.placement&&e.placement.key&&s[e.placement.key]){const t={...e,placementData:s[e.placement.key]};return i.push(t),!1}return!0}));this.cache.set(a,l)}if(!this.cache.has(n)){if(o){const e=`placementsAdditions.${this.pageType}`,t=this.api.v1.config.get(e)||[];r.push(...t)}this.cache.set(n,r.map((e=>new Te(e))))}const l=this.parse(this.cache.get(a),this.cache.get(n),e,t);for(const e of l)e.selector?this.api.v1.model.insert.bySelector({selector:e.selector,data:e.data,options:e.options}):e.path&&this.api.v1.model.insert.atPath({path:e.path,data:e.data,options:e.options});return i}validateConditions(e){return e.filter((e=>{if(e.excludeDuplicates&&this.api.v1.model.query.getModelByType(e.type))return Sys.logger.debug(`[DynamicDataHelper]: Element of type "${e.type}" already exist on page. Skipping.`),!1;if(e&&e.conditions){const{conditions:t}=e;for(const i of t){const{field:t,operator:s,value:a=""}=i,n=this.page.get(t||"",void 0,!0);if(void 0!==n)switch(s){case"equals":if(n!==a)return Sys.logger.debug(`[DynamicDataHelper]: Condition for inserting element type "${e.type}" failed. Field: "${t}", operator "${s}", value: "${a}", page value: "${n}".`),!1;break;case"notEquals":if(n===a)return Sys.logger.debug(`[DynamicDataHelper]: Condition for inserting element type "${e.type}" failed. Field: "${t}", operator "${s}", value: "${a}", page value: "${n}".`),!1;break;case"contains":if(!n.includes(a))return Sys.logger.debug(`[DynamicDataHelper]: Condition for inserting element type "${e.type}" failed. Field: "${t}", operator "${s}", value: "${a}", page value: "${n}".`),!1;break;case"notContains":if(n.includes(a))return Sys.logger.debug(`[DynamicDataHelper]: Condition for inserting element type "${e.type}" failed. Field: "${t}", operator "${s}", value: "${a}", page value: "${n}".`),!1;break;default:return Sys.logger.warning(`[DynamicDataHelper]: Operator "${s}" is not valid. The condition fails and the item is not inserted onto the page.`),!1}else Sys.logger.debug(`[DynamicDataHelper]: Condition for inserting element type "${e.type}" ignored. Value of field: "${t}" is undefined.`)}return Sys.logger.debug(`[DynamicDataHelper]: All conditions (${t.length}) for inserting element type "${e.type}" accepted. Will insert.`),!0}return Sys.logger.debug(`[DynamicDataHelper]: No validation specified for inserting element type "${e.type}". Will insert.`),!0}))}parse(e=[],t=[],i="desktop",s=null){const a=[];for(const n of e){const[o]=t.filter((({key:e})=>e===n.placement.key));if(o)if(this.acceptPath(o.path,s)){const t=this.create(n,o,e,i);null!==t&&(t.data.metadata.viewportBlacklist=this.viewports.filter((e=>e!==i)),a.unshift(t))}else Sys.logger.debug(`[DynamicDataHelper]: Path "${o.path}" not allowed. Filter: "${s}", key: "${n.placement.key}"`);else Sys.logger.debug(`[DynamicDataHelper]: No placement found with key "${n.placement.key}"`)}return a}create(e,t,i,s="desktop"){if(this.filter(e)){const a=this.assemble(e,t);t.path&&t.selector&&(this.api.v1.model.query.getModelBySelector(t.selector)||this.api.v1.model.insert.atPath({path:t.path,data:{type:"placeholder",selector:t.selector,metadata:{...t.metadata||{},key:t.key},state:{isNonPersistent:!0}},options:{index:0,useExisting:!0,prepend:!0,silent:!0}}));const n={...e.options,prepend:!0,silent:!0};let{path:o}=t,r=e.placement.index||0,l=null;if(t.selector)l=this.api.v1.model.query.getModelBySelector(t.selector);else if(t.path){const e=this.getModelsByPath(t.path,s);e.length&&(l=t.options.useBodyTextIndex||t.options.useBodyTextHeadingIndex||t.options.lastBodyTextHeading?e.find((e=>"bodytext"===e.getType())):t.options.shouldInsert?e[0].children[r]:e[r])}if(l||!t.options.skipIfOutOfBounds){if(l){r=this.api.v1.model.query.getIndex(l);let e=l.getParent();if("mobile"===s){if(r>0&&r<e.children.length){let t=e.children[r];for(;t;){const i=l.get("width",s,!0);if(void 0===i||100===i)break;t=e.children[++r]}}e.get("metadata.hasRowTitle")&&(0===r||r>=e.children.length)&&(l=e,e=l.getParent(),r=this.api.v1.model.query.getIndex(l),o=e.getPositionedPath())}if(t.options.useIndex&&r<e.children.length)if(e.children[r-1]&&e.children[r-1].getNoRenderState()){if(i[r+1]&&i[r+1].placement.index===r+1)return null;n.index=r+1}else n.index=r;t.options.shouldInsert||(o=e.getPositionedPath())}else n.prepend=!1;return new Se({data:a,options:n,selector:t.selector,path:o})}}return null}assemble(e,t){let i=new Ce(e);return t.selector||(i.metadata={...i.metadata,...t.metadata,css:t.metadata.css?`${i.metadata.css} ${t.metadata.css}`:i.metadata.css||""}),t.options.wrap&&(i=new Ce({type:t.options.wrap.type,metadata:t.options.wrap.metadata,children:[i]})),t.options.skipIfOutOfBounds&&(i.metadata.skipIfOutOfBounds=!0),t.options.useBodyTextIndex?i.metadata.bodyTextIndex=e.placement.index||0:t.options.useBodyTextHeadingIndex&&(i.metadata.bodyTextHeadingIndex=e.placement.index||0),t.options.lastBodyTextHeading&&(i.metadata.lastBodyTextHeading=!0),i.state.isNonPersistent=!0,i}acceptPath(e,t){return!e||!t||e===t}filter(e){return"googleAd"!==e.type&&"adnuntiusAd"!==e.type||!this.hideAds}getModelsByPath(e,t){const i=`getByPath-${e}`;return this.cache.has(i)||this.cache.set(i,(this.api.v1.model.query.getModelsByPath(e)||[]).filter((e=>!e.get("metadata.hideViewport",t)&&!e.isNonPersistent()))),this.cache.get(i)}}class De{constructor(e){this.api=e,this.request=this.api.v1.util.request}listen(){const e={selector:this.request.getQueryParam("lab_selector")||"contentFromPath",path:this.request.getQueryParam("lab_path"),guid:this.request.getQueryParam("lab_guid")};(e.guid||e.path)&&this.api.v1.model.on("insert",(t=>{const i=e.guid?this.getModelByGuid(e.guid,t):this.getModelByPath(e.path,t);if(i)return Sys.logger.debug(`[FragmentHelper] Element found. Path: ${i.getPositionedPath()}, GUID: ${i.getGuid()}.`),i.setSelector(e.selector),"embed"===lab_api.v1.viewport.getName()?this.appendToRoot(t,i):[i]}))}getModelByGuid(e){return Sys.logger.debug(`[FragmentHelper] Will filter elements by guid: "${e}".`),this.api.v1.model.query.getModelByGuid(e)}getModelByPath(e,t){Sys.logger.debug(`[FragmentHelper] Will filter elements by path: "${e}".`);const i=this.api.v1.util.string.parsePath(e);if(!i[0])return null;const s=this.api.v1.model.query.getModelsByType(i[0].base,t);return this.api.v1.model.query.getModelByPath(e,!0,!1,s)}appendToRoot(e,t){const i=e[0];return i.children=[t],[i]}}class $e{constructor(e){this.api=e,this.paths={main:["parent","guid","type","tags"],fields:["feedId","byline","bylineImage","paywall","published","published_url","site_alias","site_id","subtitle","subtitleHTML","teaserSubtitle","somedescription","title","teaserTitle","titleHTML","seolanguage","seotitle","sometitle","kicker","teaserKicker","showcomments"],fieldsAuto:["section_tag","tags"],fieldsNative:["section"],fieldMap:{subtitle:"description",subtitleHTML:"descriptionHTML",somedescription:"someDescription",teaserSubtitle:"teaserDescription",seolanguage:"seolanguage",seotitle:"seoTitle",sometitle:"someTitle",published_url:"url",section_tag:"section"},fallback:{url:"url"}},this.frontUrl=this.api.v1.site.getSite().domain||this.api.v1.properties.get("customer_front_url"),this.imageServer=this.api.v1.properties.get("image_server")}jsonData(e){Sys.logger.debug("[PageExport] Will export page as JSON-data");const t=this.api.v1.model.serialize.model(e);return delete t.guid,{page:t,result:"page_article"===e.getType()?this.exportArticle():this.exportFront()}}oembed(e){return"page_article"!==e.getType()?(Sys.logger.warn("[PageExport] Will not export current page type as oEmbed."),{}):(Sys.logger.debug("[PageExport] Will export page as oEmbed"),{version:"1.0",type:"rich",width:"",height:"",title:this.api.v1.util.string.sanitizeString(e.get("fields.title")||""),url:e.get("filtered.url")||"",author_name:this.api.v1.site.getSite().display_name||this.api.v1.site.getSite().alias,author_url:this.frontUrl,provider_name:"Labrador",provider_url:"http://www.labradorcms.com/",html:`<div class="labrador-cms-embed" data-lab-style="dac-no-sitelink dac-no-sitelink-logo dac-no-poweredby dac-embed-full" data-lab-content="full" data-lab-id="${e.get("id")}" data-lab-site="${e.get("filtered.site.domain_no_protocol")}"><script async defer src="${this.frontUrl}/embed.js?v=335"><\/script></div>`})}exportArticle(){}exportFront(){const e=this.api.v1.model.query.getModelByType("dropZone");return this.api.v1.model.query.getModelsByType("article",[e]).map((e=>this.serialize(e))).filter((e=>!!e))}serialize(e){const t=this.api.v1.model.serialize.model(e);if(!t||!t.fields)return null;const i=!!t.fields.origin_data_json,s={images:[],width:e.getWidth("desktop"),metadata:t.metadata,isAutomatic:i,siteDomain:this.frontUrl},a=i?t.fields.origin_data_json:t.fields,n=[...this.paths.fields,...i?this.paths.fieldsAuto:this.paths.fieldsNative];for(const e of this.paths.main)s[e]=t[e]||"";for(const e of n)s[this.paths.fieldMap[e]||e]=a[e]||"";if(s.teaserSubtitle=a.teaserSubtitle||"",i){if(!s.byline){const e=(a.full_bylines||[]).shift();s.byline=e?`${e.firstname} ${e.lastname}`:"",s.bylineImage=s.bylineImage||(e||{}).imageUrl}"string"==typeof s.tags&&(s.tags=s.tags.split(",").map((e=>(e||"").trim()))),s.site_alias=(this.api.v1.site.getSiteById(a.site_id)||{}).alias,s.id=parseInt(a.id,10)}else s.titleHTML=s.title,s.title=this.cleanText(s.title),s.descriptionHTML=s.description,s.description=this.cleanText(s.description),s.kickerHTML=s.kicker,s.kicker=this.cleanText(s.kicker),s.id=t.id;s.section_tag=s.section,s.url&&!s.url.startsWith("http")&&(s.url=this.frontUrl+s.url);for(const e of Object.keys(this.paths.fallback))s[e]||(s[e]=a[this.paths.fallback[e]]||"");s.full_bylines=(i?a.full_bylines:a.full_bylines_json)||[],s.full_bylines=s.full_bylines.map((e=>({firstname:e.firstname,lastname:e.lastname,description:e.description,imageUrl:this.getImageUrl(e.imageUrl)}))),i&&s.byline&&s.full_bylines.unshift({firstname:s.byline,lastname:"",imageUrl:this.getImageUrl(s.bylineImage)}),!s.byline&&s.full_bylines.length&&(s.byline=`${s.full_bylines[0].firstname} ${s.full_bylines[0].lastname}`,s.bylineImage=s.full_bylines[0].imageUrl.replace(this.imageServer,""));const o=lab_api.v1.config.get("customAdapterFields.article")||[];if(o)for(const e of o)if(e){let i=t.fields[e]||"";!i&&t.fields.origin_data_json&&(i=t.fields.origin_data_json[e]||""),i&&(s[e]=i)}s.paywall="0"!==s.paywall&&!!s.paywall;const r=this.api.v1.model.query.getChildOfType(e,"image");if(r){const e=r.get("filtered.image");e&&s.images.push({url:e,jpg:`${e}&format=jpg`,webp:`${e}&format=webp`,url_size:e,default:"1",id:r.get("instance_of")})}return s}cleanText(e){return this.api.v1.util.string.sanitizeString(e).replace(/&amp;/g,"&")}getImageUrl(e){return e?e.startsWith("http")?e:this.imageServer+e:""}}class Ie{constructor(e){this.api=e}register(e,t){if(this.api.v1.app.mode.isFragmentMode())return void Sys.logger.debug("[EsiHelper] Labrador is is fragment-mode. Will not register ESI. Skipping.");if(!e)return void Sys.logger.debug("[EsiHelper] Missing model, cannot process. Skipping.");const i=this.api.v1.config.get("footer.include");if(i&&i.pageId){const t=this.getEsiUrl(i);t?"client"===i.render?e.setFiltered("renderFooter.url",t):this.insertEsi(e,t,"esi_footer"):Sys.logger.warning("[EsiHelper] Cannot prepare url for footer-fragment. Missing url.")}const s=this.api.v1.config.get("header.include"),a=this.api.v1.config.get("header.includes")||[],n=[];if(s&&s.pageId){const t=this.insertHeader(s,e);t&&n.push(t)}for(const t of a)if(t&&t.pageId){const i=this.insertHeader(t,e);i&&n.push(i)}e.setFiltered("renderHeader.urls",n.map((e=>`'${e}'`)).join(", "))}getEsiUrl(e){if(!e.pageId)return null;const t=["pageId","path","structureType","start","count"],i=[];if(t.forEach((t=>{void 0!==e[t]&&""!==e[t]&&null!==e[t]&&i.push(`${t}=${e[t]}`)})),i.length===t.length){let e=this.api.v1.properties.get("front_api_url");return this.api.v1.app.mode.isEditor()&&"https:"===document.location.protocol&&(e=e.replace("http:","https:")),`${e}/fragment/structure/?${i.join("&")}`}return null}insertEsi(e,t,i){Sys.logger.debug(`[EsiHelper] Will insert fragment for selector: "${i}", url: "${t}".`),this.api.v1.model.insert.atPath({path:e.getPath(),data:{type:"esi",selector:i,contentdata:{fields:{url:t,identifier:i}},state:{isNonPersistent:!0}},options:{frontpage:!0,articlepage:!0}}),this.api.v1.app.mode.isEditor()&&this.fetchEditorEsi(t,`${i}`)}insertHeader(e,t){const i=this.getEsiUrl(e);if(i){if("client"===e.render)return Sys.logger.debug(`[EsiHelper] Found url for header-fragment to render in client: "${i}".`),i;this.insertEsi(t,i,"esi_header")}else Sys.logger.warning("[EsiHelper] Cannot prepare url for header-fragment. Missing url.");return null}fetchEditorEsi(e,t){this.api.v1.view.on("domRendered",((i,s)=>{const a=this.api.v1.model.query.getModelBySelector(t);a&&(Sys.logger.debug(`EsiHelper.fetchEditorEsi: Will fetch esi-substitute for editor. Selector: ${t}, url: ${e}`),this.api.v1.util.httpClient.get(e,{credentials:"omit",type:"text"}).then((e=>{const i=lab_api.v1.view.getView(a,s),n=document.createElement("template");if(n.innerHTML=e,Sys.logger.debug(`EsiHelper.fetchEditorEsi: Esi-substitute fetched. Selector: ${t}, element-count: ${n.content.children.length}`),i.markup){for(const e of[...n.content.children])i.markup.parentElement.insertBefore(e,i.markup);i.markup.remove()}else Sys.logger.warn(`EsiHelper.fetchEditorEsi: Element markup not found. Cannot insert dom-element(s). Selector: ${t}`)})).catch((e=>{Sys.logger.warning(`EsiHelper.fetchEditorEsi: Esi-substitute could not be fetched. Selector: ${t}, error: ${e}`)})))}))}}class Me{static mediaQueries={desktop:"(min-width:1024px)",mobile:"(max-width: 1023px)"};static createStyle({model:e,view:t,viewports:i,styleCollection:s="content_inline_spacing",mediaQueries:a=this.mediaQueries,returnArray:n=!1}){const o=[],r=`[data-element-guid="${e.getGuid()}"] .content`;for(const n of i)if(a[n]){const i=lab_api.v1.style.getStyles(e,t,s,n);i&&o.push(`@media ${a[n]} { ${r} { ${i} } }`)}return n?o:`<style>${o.join("\n")}</style>`}}const Ee=class{constructor(){this.name="Baseview",this.api=null,this.pageAPI=null,this.useSpacing=!1}onReady(e){if(this.api=e,Sys.logger.debug(`[Front] Running Baseview version ${this.api.v1.config.get("view_version")}, build ${this.api.v1.config.get("view_build.baseview.version")}`),"json"===this.api.v1.viewport.getName()&&"PageExport.jsonData"===this.api.v1.config.get("viewports.json.renderer")){const e=new $e(this.api);this.api.v1.view.on("rendered",((t,i)=>[JSON.stringify(e.jsonData(this.api.v1.model.query.getRootModel()),null,4)]))}if("oembed"===this.api.v1.viewport.getName()&&"PageExport.oembed"===this.api.v1.config.get("viewports.oembed.renderer")){const e=new $e(this.api);this.api.v1.view.on("rendered",((t,i)=>[JSON.stringify(e.oembed(this.api.v1.model.query.getRootModel()),null,4)]))}new De(this.api,this.api.v1.util.request).listen()}onAcceptContent(){const e=this.api.v1.model.query.getRootModel();if(this.useSpacing=!(!e||!e.get("fields.style_spacing")),"editor"===this.api.v1.app.mode.getSimulatedMode())return void Sys.logger.debug("[Front] Labrador is running in simulated editor-mode. Skipping DynamicDataHelper and EsiHelper.");const t=new xe(this.api).insert(this.api.v1.viewport.getName());t.length>0&&!e.get("fields.hideAds")&&(e.setFiltered("clientSidePlacements",JSON.stringify(t)),e.setFiltered("clientSideResources",JSON.stringify({configObject:{viewConfig:{config:{customer:{contentbox_settings:{adnuntiusAd:this.api.v1.config.get("contentbox_settings.adnuntiusAd")||{},googleAd:this.api.v1.config.get("contentbox_settings.googleAd")||{}},adEnvironment:this.api.v1.config.get("adEnvironment")||{}}}}},site:this.api.v1.site.getSite(),device:this.api.v1.properties.get("device"),debug:this.api.v1.util.request.hasQueryParam("debug")||!1}))),new Ie(this.api).register(e,this.api.v1.site.getSite().alias),this.api.v1.util.request.hasQueryValue("lab_opts","hideHeader")&&(Sys.logger.debug("[Front] Hiding header and logo based on url param lab_opts=hideHeader ..."),e.setFiltered("pageHeaderDisplay","hideHeaderAndLogo")),this.api.v1.util.request.hasQueryValue("lab_opts","hideFooter")&&(Sys.logger.debug("[Front] Hiding footer based on url param lab_opts=hideFooter ..."),e.setFiltered("pageFooterDisplay","hideFooter")),this.api.v1.util.request.hasQueryValue("lab_opts","hideComments")&&(Sys.logger.debug("[Front] Hiding Hyvor comments based on url param lab_opts=hideComments ..."),e.setFiltered("pageCommentsDisplay","hideComments"))}onRender(e,t){this.useSpacing&&e.setFiltered("styleSheets",Me.createStyle({model:e,view:t,viewports:["desktop","mobile"],returnArray:!1}))}onMapData(e){if("text_title"===e.type||"text_subtitle"===e.type){if(!e.contentdata||!e.contentdata.fields)return;const t={...e};return t.type="text_singleline",t.contentdata.fields.text=t.contentdata.fields.title||t.contentdata.fields.subtitle,"text_subtitle"===e.type?(t.contentdata.fields.elementType={value:"h3"},delete t.contentdata.fields.subtitle):(t.contentdata.fields.elementType={value:"h2"},lab_api.v1.util.object.set("attributes.text_size.vp.desktop",lab_api.v1.util.object.get("attributes.text_size.vp.desktop",t.contentdata.fields.text)||44,t.contentdata.fields.text),delete t.contentdata.fields.title),t.lab_internal_format=!0,t}}};(labradorView=void 0===labradorView?{}:labradorView).baseview=t})();